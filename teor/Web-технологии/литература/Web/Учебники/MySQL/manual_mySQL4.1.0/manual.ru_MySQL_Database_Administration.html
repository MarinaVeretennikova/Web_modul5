  <HTML>
  <HEAD>
  
  <TITLE>Справочное руководство по MySQL версии 4.1.0-alpha. - 4  Администрирование баз данных</TITLE>
   <style> code {color:purple} tt {color:green} samp {color:navy} pre {color:maroon} </style> <meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
  </HEAD>
  <BODY BGCOLOR=white TEXT=#000000 LINK=#101090 VLINK=#7030B0>
Go to the <A HREF="manual.ru_Introduction.html">first</A>, <A HREF="manual.ru_Tutorial.html">previous</A>, <A HREF="manual.ru_MySQL_Optimisation.html">next</A>, <A HREF="manual.ru_Concept_Index.html">last</A> section, <A HREF="manual.ru_toc.html">table of contents</A>.
<P><HR><P>


<H1><A NAME="MySQL_Database_Administration" HREF="manual.ru_toc.html#MySQL_Database_Administration">4  Администрирование баз данных</A></H1>



<H2><A NAME="Configuring_MySQL" HREF="manual.ru_toc.html#Configuring_MySQL">4.1  Конфигурирование MySQL</A></H2>



<H3><A NAME="Command-line_options" HREF="manual.ru_toc.html#Command-line_options">4.1.1  Параметры командной строки <code>mysqld</code></A></H3>

<P>
<A NAME="IDX432"></A>
<A NAME="IDX433"></A>
<A NAME="IDX434"></A>

</P>
<P>
В большинстве случаев управление параметрами mysqld осуществляется при
помощи файлов параметров (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>).

</P>
<P>
<code>mysqld</code> и <code>mysqld.server</code> считывают параметры из групп <code>mysqld</code> и <code>server</code>.
<code>mysqld_safe</code> считывает параметры из групп <code>mysqld</code>, <code>server</code>, <code>mysqld_safe</code> и
<code>safe_mysqld</code>. Встроенный сервер MySQL обычно считывает параметры из <code>server</code>,
<code>embedded</code> и  <code>xxxxx_SERVER</code>, где <code>xxxxx</code> - имя приложения.

</P>
<P>
mysqld принимает следующие параметры командной строки (для получения полного
списка выполните <code>mysqld --help</code>):

</P>
<DL COMPACT>

<DT><code>--ansi</code>
<DD>
Использовать синтаксис ANSI SQL вместо синтаксиса MySQL (see section <A HREF="manual.ru_Introduction.html#ANSI_mode">1.9.2  Запуск MySQL в режиме ANSI</A>).

<DT><code>-b, --basedir=path</code>
<DD>
Путь к каталогу установки. Все остальные пути обычно определяются
относительно этого пути.

<DT><code>--big-tables</code>
<DD>
Позволяет использовать наборы результатов большого объема за счет
сохранения всех временных файлов в одном. Данный параметр позволяет
устранить большинство ошибок 'table full' (таблица переполнена), но
замедляет обработку запросов, для которых было бы достаточно таблиц,
расположенных в памяти. Начиная с версии 3.23.2 в MySQL эта проблема
решается автоматически: память используется для небольших временных
таблиц, а при необходимости происходит переключение на таблицы,
расположенные на диске.

<DT><code>--bind-address=IP</code>
<DD>
IP-адрес, с которым необходимо установить связь.

<DT><code>--console</code>
<DD>
Писать журнал сообщений/ошибок в stderr/stdout даже если <code>--log-error</code> указана.
На Windows mysqld просто не будет закрывать консольное окно если указана эта
опция. 

<DT><code>--character-sets-dir=path</code>
<DD>
Каталог, в  котором  расположены  наборы  символов (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Character_sets">4.6.1  Набор символов, применяющийся для записи данных и сортировки</A>).

<DT><code>--chroot=path</code>
<DD>
Изменяет корневой каталог программы mysqld во время запуска.
Рекомендуемая мера безопасности для MySQL 4.0 (MySQL 3.23 не вполне в состоянии предоставить
100% измененную среду запуска). Эта опция некоторым образом ограничивает
использование функций <code>LOAD DATA INFILE</code> и <code>SELECT ... INTO OUTFILE</code>.

<DT><code>--core-file</code>
<DD>
Записывает файл ядра, если происходит аварийное прекращение работы <code>mysqld</code>.
В некоторых системах также необходимо указать <code>--core-file-size</code> для
safe_mysqld (see section <A HREF="manual.ru_MySQL_Database_Administration.html#safe_mysqld">4.7.2  <code>safe_mysqld</code>, оболочка <code>mysqld</code></A>). Обратите
внимание на то, что в некоторых системах, таких как Solaris, не удастся
записать файл ядра, если используется параметр <code>--user</code>.

<DT><code>-h, --datadir=path</code>
<DD>
Путь к корневому каталогу базы данных.

<DT><code>--debug[...]=</code>
<DD>
Если MySQL настроен при помощи <code>--with-debug</code>, то этот параметр позволяет
получить файл трассировки, в котором отражена работа <code>mysqld</code> (see section <A HREF="manual.ru_Porting.html#Making_trace_files">E.1.2  Создание трассировочных файлов</A>).

<DT><code>--default-character-set=charset</code>
<DD>
Задает набор символов, принятый по умолчанию (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Character_sets">4.6.1  Набор символов, применяющийся для записи данных и сортировки</A>).

<DT><code>--default-table-type=type</code>
<DD>
Задает тип таблиц, принятый по умолчанию (see section <A HREF="manual.ru_Table_types.html#Table_types">7  Типы  таблиц MySQL</A>).

<DT><code>--delay-key-write[= OFF | ON | ALL]</code>
<DD>
Указывает, как на MyISAM <code>DELAYED KEYS</code> должен обрабатываться. 
See section <A HREF="manual.ru_MySQL_Optimisation.html#Server_parameters">5.5.2  Настройка параметров сервера</A>.

<DT><code>--delay-key-write-for-all-tables; В MySQL 4.0.3 следует использовать <code>--delay-key-write=ALL</code>.</code>
<DD>
Отмена сброса на диск ключевых буферов для всех таблиц <code>MyISAM</code> между
записями. See section <A HREF="manual.ru_MySQL_Optimisation.html#Server_parameters">5.5.2  Настройка параметров сервера</A>.

<DT><code>--des-key-file=filename</code>
<DD>
Задает считывание из файла filename принятых по умолчанию ключей, которые
используются для <code>DES_ENCRYPT()</code> и <code>DES_DECRYPT()</code>.

<DT><code>--enable-external-locking (было --enable-locking)</code>
<DD>
Включает блокировку доступа к системе. Обратите внимание на то, что если
этот параметр используется в системе, где функция <code>lockd</code> полностью не
работает (например, в Linux), это может привести к зависанию mysqld.

<DT><code>--enable-named-pipe</code>
<DD>
Включает поддержку для именованных каналов (только в NT/Win2000/XP).

<DT><code>-T, --exit-info</code>
<DD>
Побитовое маскирование различных флагов, которое применяется для отладки
сервера mysqld; не следует использовать этот параметр, если вы хорошо не
разбираетесь в том, что именно он делает!

<DT><code>--flush</code>
<DD>
Задает сброс на диск всех изменений после каждой команды SQL. Обычно MySQL
только направляет все изменения на диск после каждой команды SQL,
делегируя управление синхронизацией записи на диск операционной системе
(see section <A HREF="manual.ru_Problems.html#Crashing">A.4.1  Что делать, если работа MySQL сопровождается постоянными сбоями</A>).

<DT><code>-?, --help</code>
<DD>
Вывод сокращенной справки и завершение выполнения.

<DT><code>--init-file=file</code>
<DD>
Задает считывание команды SQL из файла file при запуске.

<DT><code>-L, --language=...</code>
<DD>
Вывод сообщений об ошибках клиента на указанном языке. Может быть задан в
виде полного пути (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Languages">4.6.2  Сообщения об ошибках на языках, отличных от английского</A>).

<DT><code>-l, --log[=file]</code>
<DD>
Задает занесение в файл журнала соединений и запросов (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Query_log">4.9.2  Общий журнал запросов</A>).

<DT><code>--log-bin=[file]</code>
<DD>
Двоичный журнал обновлений. Сохранение всех запросов, изменяющих данные, в
файл. Используется для архивного копирования и репликации. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Binary_log">4.9.4  Бинарный журнал обновлений</A>.

<DT><code>--log-bin-index[=file]</code>
<DD>
Имя индексного файла для двоичного журнала обновлений. 
See section <A HREF="manual.ru_MySQL_Database_Administration.html#Binary_log">4.9.4  Бинарный журнал обновлений</A>.

<DT><code>--log-error[=file]</code>
<DD>
Писать ошибки и сообщения в этот файл. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Error_log">4.9.1  Журнал ошибок</A>.

<DT><code>--log-isam[=file]</code>
<DD>
Заносит в файл журнала все изменения <code>ISAM</code>/<code>MyISAM</code> (используется только при
отладке <code>ISAM</code>/<code>MyISAM</code>).

<DT><code>--log-slow-queries[=file]</code>
<DD>
Заносит в файл журнала все запросы, выполнение которых заняло больше, чем
<code>long_query_time</code> секунд (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Slow_query_log">4.9.5  Журнал медленных запросов</A>).

<DT><code>--log-update[=file]</code>
<DD>
Заносит в файл журнала обновления <code>file.#</code> где <code>#</code> представляет собой уникальный
номер, если он не был задан (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Update_log">4.9.3  Журнал обновлений (update)</A>).

<DT><code>--log-long-format</code>
<DD>
Заносит в файл журнала обновлений некоторую дополнительную информацию.
Если задано <code>--log-slow-queries</code>, то запросы, не использующие индексов,
будут заноситься в журнал медленных запросов.

<DT><code>--low-priority-updates</code>
<DD>
Операциям по изменению таблиц (<code>INSERT</code>/<code>DELETE</code>/<code>UPDATE</code>) будет назначен более
низкий приоритет, чем операциям выбора. Это также можно реализовать при
помощи <code>{INSERT | REPLACE | UPDATE | DELETE} LOW_PRIORITY ...</code>, чтобы
понизить приоритет только одного запроса, или через <code>SET 
LOW_PRIORITY_UPDATES=1</code>, чтобы изменить приоритет в одном потоке (see section <A HREF="manual.ru_MySQL_Optimisation.html#Table_locking">5.3.2  Вопросы блокирования таблиц</A>).

<DT><code>--memlock</code>
<DD>
Фиксирует процесс <code>mysqld</code> в памяти. Этот параметр работает только в том
случае, если ваша система поддерживает системный вызов <code>mlockall()</code>,
например Solaris. Такая мера может быть полезной, если операционная
система записывает <code>mysqld</code> в файл подкачки на диск.

<DT><code>--myisam-recover [=параметр[,параметр...]]]</code>
<DD>
Параметр - это любое сочетание <code>DEFAULT</code>, <code>BACKUP</code>, <code>FORCE</code> или <code>QUICK</code>. Если
необходимо отключить данную функцию, укажите вместо набора параметров явно
<code>""</code>. Если эта функция используется, <code>mysqld</code> проверит таблицу на предмет
того, была ли она отмечена как сбойная или не была закрыта надлежащим
образом (последний вариант действует только в том случае, если был включен
параметр <code>--skip-external-locking</code>). В любом из этих случаев <code>mysqld</code> произведет полную
проверку таблицы. Если таблица была повреждена, <code>mysqld</code> попытается ее
восстановить. Приведенные ниже параметры влияют на работу процесса
восстановления.

<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Параметр</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD>DEFAULT </TD><TD> Аналогично отсутствию каких-либо параметров для функции
		    <code>--myisam-recover</code>.                                      
</TD></TR>
<TR><TD>BACKUP </TD><TD> Если во время восстановления таблица данных была изменена,
                   сохраняется резервная копия файла данных <tt>`table_name.MYD'</tt> под
		   именем <tt>`table_name-datetime.BAK'</tt>.     
</TD></TR>
<TR><TD>FORCE </TD><TD> Запуск восстановления, даже если будет утрачено более одной
		   строки из файла <tt>`.MYD'</tt>.                            
</TD></TR>
<TR><TD>QUICK </TD><TD> Не проверять строки в таблице, в которых отсутствуют удаленные блоки.
</TD></TR>
</TABLE>

Перед автоматическим восстановлением таблицы MySQL добавит запись об этом
в журнал ошибок. Если необходимо, чтобы восстановление после большинства
ошибок осуществлялось без вмешательства пользователя, следует установить
параметры <code>BACKUP</code> и <code>FORCE</code>. Тогда восстановление будет производиться даже в
случае, если некоторые строки будут удалены, но файл данных будет
сохраняться в виде резервной копии, поэтому впоследствии всегда можно
будет определить, что произошло.

<DT><code>--pid-file=path</code>
<DD>
Путь к pid-файлу используется функцией <code>safe_mysqld</code>.

<DT><code>-P, --port=...</code>
<DD>
Номер порта для прослушивания соединений TCP/IP.

<DT><code>-o, --old-protocol</code>
<DD>
Использовать протокол 3.20 для совместимости с некоторыми очень старыми
клиентами (see section <A HREF="manual.ru_Installing.html#Upgrading-from-3.20">2.5.5  Модернизация с версии 3.20 до версии 3.21</A>).

<DT><code>--one-thread</code>
<DD>
Использовать только один поток (для отладки в системе Linux) (see section <A HREF="manual.ru_Porting.html#Debugging_server">E.1  Отладка сервера MySQL</A>).

<DT><code>-O, --set-variable var=option</code>
<DD>
Задает значение для переменной. <code>--help</code> - выводит список переменных.
Подробное описание всех переменных можно найти в разделе <code>SHOW VARIABLES</code>
этого руководства (see section <A HREF="manual.ru_MySQL_Database_Administration.html#SHOW_VARIABLES">4.5.6.4  <code>SHOW VARIABLES</code></A>). 

Обратите внимание, <code>--set-variable</code> морально устарела с версии MySQL 4.0. Просто используйте
<code>--var=option</code>. See section <A HREF="manual.ru_MySQL_Optimisation.html#Server_parameters">5.5.2  Настройка параметров сервера</A>.

В MySQL 4.0.2 вы можете устанавливать переменную непосредственно с помощью
<code>--variable-name=option</code>, и <code>set-variable</code> больше не нужна в файлах
опций. 

Если вы хотите ограничить максимальное значение, в которое может быть установлена
пемеременная при помощи <code>SET</code>, определите это значение с помощью опции <code>--maximum-variable-name</code> 
See section <A HREF="manual.ru_MySQL_Optimisation.html#SET_OPTION">5.5.6  Синтаксис команды <code>SET</code></A>.

Когда переменная будет устанавливаться в какое-либо значение, MySQL
автоматически будет корректировать его, чтобы оно оставалось в указананных
рамках; также MySQL может немного корректировать установленное значение с тем,
чтобы эффективнее использовались внутренние алгоритмы. 

Раздел по настройке
параметров сервера включает информацию по их оптимизации (see section <A HREF="manual.ru_MySQL_Optimisation.html#Server_parameters">5.5.2  Настройка параметров сервера</A>).

<DT><code>--safe-mode</code>
<DD>
Пропуск некоторых этапов оптимизации. 

<DT><code>--safe-show-database</code>
<DD>
При использовании этого параметра команда <code>SHOW DATABASES</code> выдает только те
базы данных, для которых у пользователя есть какие-либо привилегии.
Начиная с версии 4.0.2 этот параметр является недействительным и больше ни
на что не влияет (его значение установлено по умолчанию), так как в новой
версии появилась привилегия <code>SHOW DATABASES</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#GRANT">4.3.1  Синтаксис команд <code>GRANT</code> и <code>REVOKE</code></A>).

<DT><code>--safe-user-create</code>
<DD>
Когда этот параметр включен, пользователь не может создавать новых
пользователей при помощи команды <code>GRANT</code>, если он не имеет привилегии <code>INSERT</code>
для таблицы <code>mysql.user</code> или для любого столбца этой таблицы.

<DT><code>--skip-bdb</code>
<DD>
Запретить использование таблиц BDB. Это сэкономит память и может ускорить работу.

<DT><code>--skip-concurrent-insert</code>
<DD>
Отключает возможность одновременного выбора и вставки данных для таблиц
<code>MyISAM</code> (используется только в том случае, если в этой функции найдена
ошибка).

<DT><code>--skip-delay-key-write; в MySQL 4.0.3 следует использовать --delay-key-write=OFF</code>
<DD>
Игнорирует  параметр  <code>DELAY_KEY_WRITE</code>  для  всех  таблиц (see section <A HREF="manual.ru_MySQL_Optimisation.html#Server_parameters">5.5.2  Настройка параметров сервера</A>).

<DT><code>--skip-grant-tables</code>
<DD>
Включение данного параметра приводит к тому, что сервер совсем не
использует систему привилегий - таким образом полный доступ ко всем базам
данных получают все! (Можно дать серверу команду снова использовать
таблицы доступа, запустив <code>mysqladmin flush-privileges</code> или <code>mysqladmin
reload</code>.)

<DT><code>--skip-host-cache</code>
<DD>
Никогда не использовать кэш имени главного компьютера для быстрого
разрешения соответствий имен и IP-адресов, а вместо этого всегда
запрашивать DNS-сервер по каждому соединению (see section <A HREF="manual.ru_MySQL_Optimisation.html#DNS">5.5.5  Как MySQL использует DNS</A>).

<DT><code>--skip-innodb</code>
<DD>
Запретить использование таблиц InnoDB. Это сэкономит память и может ускорить работу. 

<DT><code>--skip-external-locking (было --skip-locking)</code>
<DD>
Не использовать средства системных блокировок. Чтобы воспользоваться функциями
<code>isamchk</code> или <code>myisamchk</code>, необходимо выключить сервер
(see section <A HREF="manual.ru_Introduction.html#Stability">1.4.3  Насколько стабильным является MySQL?</A>). Обратите внимание на то, что в MySQL версии 3.23 для
восстановления или проверки таблиц <code>MyISAM</code> можно использовать
<code>REPAIR</code> и <code>CHECK</code>.

<DT><code>--skip-name-resolve</code>
<DD>
Не производится разрешения имен хостов. Все значения в столбце Host в
таблицах привилегий должны быть IP-адресами или значениями localhost (see section <A HREF="manual.ru_MySQL_Optimisation.html#DNS">5.5.5  Как MySQL использует DNS</A>).

<DT><code>--skip-networking</code>
<DD>
Прослушивание соединений TCP/IP не производится. Связь с <code>mysqld</code> должна
осуществляться через сокеты Unix. Этот параметр рекомендуется для систем,
в которых разрешены только локальные запросы (see section <A HREF="manual.ru_MySQL_Optimisation.html#DNS">5.5.5  Как MySQL использует DNS</A>).

<DT><code>--skip-new</code>
<DD>
Не использовать новые (возможно, неправильные) операции. 

<DT><code>--skip-symlink</code>
<DD>
Не удалять и не переименовывать файлы, на которые указывает файл <code>symlinked</code>
в каталоге данных.

<DT><code>--skip-safemalloc</code>
<DD>
Если MySQL настроен при помощи <code>--with-debug=full</code>, все программы будут
проверять память на наличие выхода за границы области памяти при каждом
заполнении и освобождении памяти. Поскольку такая проверка осуществляется
довольно медленно, от нее можно отказаться, воспользовавшись этим
параметром.

<DT><code>--skip-show-database</code>
<DD>
Не позволяет использовать команду <code>SHOW DATABASES</code>, если пользователь не
имеет привилегии <code>SHOW DATABASES</code>. Начиная с версии 4.0.2 этот параметр
больше не нужен, поскольку доступ теперь может быть разрешен при помощи
привилегии <code>SHOW DATABASES</code>.

<DT><code>--skip-stack-trace</code>
<DD>
Не записывать трассировку стеков. Этот параметр может оказаться полезным,
когда <code>mysqld</code> запущен под отладчиком. В некоторых системах данный параметр
также необходимо использовать для получения файла ядра (see section <A HREF="manual.ru_Porting.html#Debugging_server">E.1  Отладка сервера MySQL</A>).

<DT><code>--skip-thread-priority</code>
<DD>
Отключает использование приоритетов потока, чтобы уменьшить время ожидания
ответа.

<DT><code>--socket=path</code>
<DD>
Файл канала, который используется для локального соединения вместо файла,
принятого по умолчанию, <code>/tmp/mysql.sock</code>.

<DT><code>--sql-mode=параметр[,параметр[,параметр...]]</code>
<DD>
Параметр  может  представлять  собой  любое  сочетание  из: <code>REAL_AS_FLOAT</code>,
<code>PIPES_AS_CONCAT</code>, <code>ANSI_QUOTES</code>, <code>IGNORE_SPACE</code>, <code>SERIALIZE</code>, <code>ONLY_FULL_GROUP_BY</code>.
Если нужно произвести сброс значения, параметр может быть пустым (<code>"")</code>.
Указание всех приведенных выше параметров аналогично использованию <code>--ansi</code>.
При помощи этого параметра можно включать только необходимые режимы SQL
(see section <A HREF="manual.ru_Introduction.html#ANSI_mode">1.9.2  Запуск MySQL в режиме ANSI</A>).

<DT><code>--temp-pool</code>
<DD>
При указании данного параметра для создаваемых временных файлов будет
использоваться ограниченный набор имен вместо создания уникального имени
для каждого нового файла. Данная функция предназначена для устранения
проблемы ядра Linux, возникающей при создании большого количества новых
файлов с разными именами. По старой схеме в Linux как бы происходит
'утечка' памяти, так как она распределяется для кэша каталогов вместо
дискового кэша.

<DT><code>--transaction-isolation= { READ-UNCOMMITTED | READ-COMMITTED |</code>
<DD>
REPEATABLE-READ | SERIALIZABLE }
Задает принятый по умолчанию уровень изоляции транзакции (see section <A HREF="manual.ru_Reference.html#SET_TRANSACTION">6.7.3  Синтаксис команды <code>SET TRANSACTION</code></A>).

<DT><code>-t, --tmpdir=path</code>
<DD>
Путь для временных файлов. Может быть полезен, если принятый по умолчанию
каталог <code>/tmp</code> расположен на слишком маленьком диске и не может вместить все
временные таблицы.
Начиная с MySQL 4.1, эта опция поддержает указание нескольких путей, разделенных 
двоеточием <code>:</code> (на Windows - точкой с запятой <code>;</code>). Эти пути будут использованы в 
ротации. 

<DT><code>-u, --user= [user_name | userid]</code>
<DD>
Запуск демона  <code>mysqld</code> от имени пользователя <code>user_name</code> или <code>userid</code> (число).
Этот параметр является <strong>обязательным</strong> при запуске <code>mysqld</code> в качестве главной
программы.

Начиная с MySQL 3.23.56 и 4.0.12:

Для того, чтобы избежать возможного пробоя в безопасности когда пользователь 
добавляет опцию <code>--user=root</code> в один из файлов <tt>`my.cnf'</tt>, <code>mysqld</code>
лишь только будет использовать первую указанную опцию <code>--user</code> и давать предупреждение
если указано множество таких опций.
Имейте в виду, что <tt>`/etc/my.cnf'</tt> и <tt>`datadir/my.cnf'</tt> могут перекрыть опцию командной строки - 
таким образом, рекомендовано указывать эту опцию именно в <tt>`/etc/my.cnf'</tt>. 

<DT><code>-V, --version</code>
<DD>
Вывод информации по версии программы и завершение выполнения.

<DT><code>-W, --log-warnings (было --warnings)</code>
<DD>
Задает  запись  таких  предупреждений, как <code>Aborted connection...</code>  в 
файл  <tt>`.err'</tt> (see section <A HREF="manual.ru_Problems.html#Communication_errors">A.2.9  Коммуникационные ошибки / Оборванные соединения</A>.
</DL>

<P>
Большая часть значений может быть изменена в процессе работы сервера
с помощью команды <code>SET</code>. See section <A HREF="manual.ru_MySQL_Optimisation.html#SET_OPTION">5.5.6  Синтаксис команды <code>SET</code></A>.

</P>


<H3><A NAME="Option_files" HREF="manual.ru_toc.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A></H3>

<P>
<A NAME="IDX435"></A>
<A NAME="IDX436"></A>
<A NAME="IDX437"></A>
<A NAME="IDX438"></A>

</P>
<P>
Начиная с версии 3.22 MySQL может считывать принятые по умолчанию
параметры запуска для сервера и клиентов из файлов параметров.

</P>
<P>
В Unix считывание принятых по умолчанию параметров MySQL производится из
следующих файлов:

</P>
<P>
<A NAME="IDX439"></A>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Имя файла</strong> </TD><TD> <strong>Назначение</strong>
</TD></TR>
<TR><TD><code>/etc/my.cnf</code> </TD><TD> Общие параметры
</TD></TR>
<TR><TD><code>DATADIR/my.cnf</code> </TD><TD> Параметры для сервера
</TD></TR>
<TR><TD><code>defaults-extra-file</code> </TD><TD> Файл, указанный при помощи -defaults-extra-file=#
</TD></TR>
<TR><TD><code>~/.my.cnf</code> </TD><TD> Параметры для пользователя
</TD></TR>
</TABLE>

</P>
<P>
<code>DATADIR</code> является каталогом данных MySQL (обычно <tt>`/usr/local/mysql/data'</tt> для
бинарной установки или <tt>`/usr/local/var'</tt> для установки из исходных текстов).
Обратите внимание, что это тот каталог, который был задан во время
настройки, а не указанный при помощи <code>--datadir</code> при запуске <code>mysqld</code>!
(<code>--datadir</code> не оказывает влияния на просмотр файлов параметров сервером,
так как их просмотр происходит до обработки аргументов командной строки).

</P>
<P>
В Windows считывание принятых по умолчанию параметров MySQL производится
из следующих файлов:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Имя файла</strong> </TD><TD> <strong>Назначение</strong>
</TD></TR>
<TR><TD><code>windows-system-directory\my.ini</code> </TD><TD> Общие параметры
</TD></TR>
<TR><TD><code>C:\my.cnf</code> </TD><TD> Общие параметры
</TD></TR>
</TABLE>

<P>
Обратите внимание на то, что в Windows все пути необходимо указывать при
помощи <code>/</code> вместо <code>\.</code> Если необходимо использовать <code>\,</code> то его нужно указать
дважды, так как <code>\</code> является знаком перехода в MySQL.

</P>
<P>
<A NAME="IDX440"></A>
MySQL пытается прочитать файлы параметров в указанном выше порядке. Если
существует несколько таких файлов, то параметр, указанный в файле, идущем
позже, имеет преимущество над таким же параметром, указанным в файле,
расположенном ранее. Параметры, указанные в командной строке, обладают
более высоким приоритетом по отношению к параметрам, указанным в любом из
файлов параметров. Некоторые параметры можно задавать при помощи
переменных окружения. Параметры, указанные в командной строке или в файлах
параметров, обладают преимуществом по отношению к переменным окружения
(see section <A HREF="manual.ru_Environment_variables.html#Environment_variables">F  Переменные окружения</A>).

</P>
<P>
Приводим список программ, поддерживающих файлы параметров: <code>mysql</code>,
<code>mysqladmin</code>, <code>mysqld</code>, <code>mysqld_safe</code>, <code>mysql.server</code>, <code>mysqldump</code>, <code>mysqlimport</code>,
<code>mysqlshow</code>, <code>mysqlcheck</code>, <code>myisamchk</code> и <code>myisampack</code>.

</P>
<P>
Любой параметр, который может быть задан в командной строке при запуске
программы MySQL, может быть также задан в файле параметров (без
предваряющего двойного слэша). Чтобы получить список доступных параметров,
следует запустить программу с параметром <code>--help</code>.

</P>
<P>
Файлы параметров могут содержать строки следующего вида:

</P>
<DL COMPACT>

<DT><code>#comment</code>
<DD>
Строки комментариев начинаются с символа <samp>`#'</samp> или <samp>`;'</samp>. Пустые строки
игнорируются.

<DT><code>[group]</code>
<DD>
группа представляет собой имя программы или группы, для которой необходимо
задать параметры. Любые параметры или строки, задающие значения
переменных, которые указаны после строки группы, будут относиться к
названной группе, пока не закончится файл параметров или же не будет
указана другая строка группы.

<DT><code>option</code>
<DD>
Эквивалент <code>--option</code> в командной строке.

<DT><code>option=value</code>
<DD>
Эквивалент <code>--option=value</code> в командной строке.

<DT><code>set-variable = variable=value</code>
<DD>
Эквивалент <code>--set-variable variable=value</code> в командной строке. Данный
синтаксис необходимо использовать для задания переменных <code>mysqld</code>.
Заметьте, <code>--set-variable</code> не используется с MySQL 4.0. Просто используйте
<code>--variable=value</code>.

</DL>

<P>
Группа <code>client</code> обеспечивает возможность задавать параметры, относящиеся ко
всем клиентам MySQL (кроме самого <code>mysqld</code>). Эта группа великолепно подходит
для указания пароля, используемого при подсоединении к серверу (но при
этом следует убедиться, что разрешение на чтение и запись этого файла есть
только у вас).

</P>
<P>
Обратите внимание на то, что для параметров и значений все введенные перед
ними и после них пробелы автоматически удаляются. В строках значений можно
использовать такие экранирующие секвенции: <samp>`\b'</samp>, <samp>`\t'</samp>, <samp>`\n'</samp>, <samp>`\r'</samp>, <samp>`\\'</samp> и
<samp>`\s'</samp> (<samp>`\s'</samp> - это пробел).

</P>
<P>
Пример типичного глобального файла параметров:

</P>

<pre>
[client]
port=3306
socket=/tmp/mysql.sock

[mysqld]
port=3306
socket=/tmp/mysql.sock
set-variable = key_buffer_size=16M
set-variable = max_allowed_packet=1M

[mysqldump]
quick
</pre>

<P>
Пример типичного файла параметров пользователя:

</P>

<pre>
[client]
# Указанный пароль будет направлен всем стандартным клиентам MySQL
password=my_password

[mysql]
no-auto-rehash
set-variable = connect_timeout=2

[mysqlhotcopy]
interactive-timeout
</pre>

<P>
<A NAME="IDX441"></A>
Если у вас дистрибутив исходного кода, то примеры конфигурационных файлов
с именами <tt>`my-xxxx.cnf'</tt> можно найти в каталоге <tt>`support-files'</tt>. В случае
бинарного дистрибутива следует обратиться к каталогу <tt>`DIR/support-files'</tt>,
где <code>DIR</code> - имя каталога установки MySQL (обычно <tt>`/usr/local/mysql'</tt>). На
данный момент там приведены примеры файлов конфигурации для малых,
средних, больших и очень больших систем. Чтобы поэкспериментировать с
файлом, можно скопировать <tt>`my-xxxx.cnf'</tt> в свой домашний каталог
(переименуйте копию в <tt>`.my.cnf'</tt>).

</P>
<P>
Все поддерживающие файлы параметров клиенты MySQL принимают следующие
параметры:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Параметр</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD>--no-defaults </TD><TD> Не читать информацию из файлов параметров.
</TD></TR>
<TR><TD>--print-defaults </TD><TD> Вывести имя программы и все параметры, которые ей передаются.
</TD></TR>
<TR><TD>--defaults-file=full-path-to-default-file </TD><TD> Использовать только указанный файл конфигурации.
</TD></TR>
<TR><TD>--defaults-extra-file=full-path-to-default-file </TD><TD> Прочитать этот файл конфигурации после глобального файла конфигурации, но перед файлом конфигурации пользователя.
</TD></TR>
</TABLE>

<P>
Обратите внимание на то, что указанные выше параметры должны идти первыми
в командной строке! Однако параметр <code>--print-defaults</code> может использоваться
сразу после команд <code>--defaults-xxx-file</code>.

</P>
<P>
Примечание для разработчиков: обработка файла параметров происходит
следующим образом: все совпадающие параметры (т.е. параметры в
соответствующих группах) обрабатываются перед любыми аргументами командной
строки. Этот алгоритм хорошо подходит для программ, которые в случае, если
один и тот же параметр указывается несколько раз, используют последний
экземпляр параметра. Если же вы работаете со старой программой, которая
считывает заданные несколько раз параметры указанным образом, но не читает
файлы параметров, необходимо добавить только две строки, чтобы у нее
появилась эта возможность. Чтобы увидеть, как это делается, достаточно
ознакомиться с исходным кодом любого стандартного клиента MySQL.

</P>
<P>
В скриптах оболочки для анализа файлов <code>config</code> можно использовать команду
<tt>`my_print_defaults'</tt>:

</P>

<pre>
shell&#62; my_print_defaults client mysql
--port=3306
--socket=/tmp/mysql.sock
--no-auto-rehash
</pre>

<P>
Приведенные выше выходные данные содержат все параметры для групп <code>client</code> и
<code>mysql</code>.

</P>


<H3><A NAME="Installing_many_servers" HREF="manual.ru_toc.html#Installing_many_servers">4.1.3  Установка нескольких серверов на один компьютер</A></H3>

<P>
<A NAME="IDX442"></A>
<A NAME="IDX443"></A>
<A NAME="IDX444"></A>
<A NAME="IDX445"></A>

</P>
<P>
В некоторых случаях необходимо, чтобы на одном компьютере работало
несколько различных серверов <code>mysqld</code>: например, если нужно  запустить для
тестирования новую версию MySQL совместно со старой версией, которая
находится в работе, или когда разным пользователям нужно предоставить
доступ к различным серверам <code>mysqld</code>, с которыми они умеют обращаться
самостоятельно.

</P>
<P>
Один из способов запустить новый сервер -- указать ему другой канал и
порт, например, таким образом:

</P>
<P>
<A NAME="IDX446"></A>
<A NAME="IDX447"></A>
<A NAME="IDX448"></A>
<A NAME="IDX449"></A>

<pre>
shell&#62; MYSQL_UNIX_PORT=/tmp/mysqld-new.sock
shell&#62; MYSQL_TCP_PORT=3307
shell&#62; export MYSQL_UNIX_PORT MYSQL_TCP_PORT
shell&#62; scripts/mysql_install_db
shell&#62; bin/safe_mysqld &#38;
</pre>

<P>
Приложение, в котором описаны переменные окружения, включает список других
переменных окружения, которые можно использовать для управления <code>mysqld</code>
(see section <A HREF="manual.ru_Environment_variables.html#Environment_variables">F  Переменные окружения</A>).

</P>
<P>
В приведенном выше примере представлен грубый быстрый метод, который
обычно применяется для тестирования. Преимуществом данного метода является
то, что все соединения, которые устанавливаются в указанной выше оболочке,
автоматически направляются на новый запущенный сервер!

</P>
<P>
Если работать с несколькими серверами необходимо постоянно, то нужно
создать файл параметров для каждого сервера (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>). В скрипте запуска, который выполняется при каждой загрузке,
следует указать оба сервера:

</P>
<P>
<code>safe_mysqld --defaults-file=path-to-option-file</code>

</P>
<P>
Для серверов должны быть различными по крайней мере следующие параметры:

</P>

<ul>
<LI>port=#

<LI>socket=path

<LI>pid-file=path

</ul>

<P>
Приведенные ниже параметры, если они используются, также должны
различаться:

</P>

<ul>
<LI>log=path

<LI>log-bin=path

<LI>log-update=path

<LI>log-isam=path

<LI>bdb-logdir=path

<LI>shared-memory-base-name (Новое в MySQL 4.1)

</ul>

<P>
Если требуется увеличить производительность, необходимо также задать
разные значения для следующих параметров:

</P>

<ul>
<LI>tmpdir=path

<LI>bdb-tmpdir=path

</ul>

<P>
See section <A HREF="manual.ru_MySQL_Database_Administration.html#Command-line_options">4.1.1  Параметры командной строки <code>mysqld</code></A>.
Начиная с MySQL 4.1, в <code>tmpdir</code> могут быть указаны несколько путей, разделенных
двоеточием <code>:</code> (точкой с запятой на Windows <code>;</code>). Эти пути будут 
использованы в ротации. Эта функция может быть использована для того, чтобы распределить
данные между разными физическими дисками. 

</P>
<P>
Если производится установка бинарной версии MySQL (файлы .tar), которая
запускается из <code>./bin/safe_mysqld</code>, то в большинстве случаев единственными
параметрами, которые необходимо добавить/изменить, являются аргументы
<code>socket</code> и <code>port</code> для <code>safe_mysqld</code>.

</P>
<P>
See section <A HREF="manual.ru_MySQL_Database_Administration.html#Multiple_servers">4.1.4  Запуск нескольких серверов MySQL на одном компьютере</A>.

</P>


<H3><A NAME="Multiple_servers" HREF="manual.ru_toc.html#Multiple_servers">4.1.4  Запуск нескольких серверов MySQL на одном компьютере</A></H3>

<P>
<A NAME="IDX450"></A>
<A NAME="IDX451"></A>
<A NAME="IDX452"></A>

</P>
<P>
Иногда возникают обстоятельства, когда необходимо запустить несколько
серверов на одном компьютере. Например, может понадобиться произвести
тестирование новой версии MySQL, не изменяя текущей установки программы.
Или еще вариант: вы являетесь поставщиком услуг Internet, который хочет
предоставить независимые установки MySQL для различных клиентов.

</P>
<P>
Если необходимо запустить несколько серверов, то проще всего
скомпилировать серверы с различными портами TCP/IP и файлами сокетов (see section <A HREF="manual.ru_MySQL_Database_Administration.html#mysqld_multi">4.7.3  <code>Mysqld_multi</code>, программа для управления множеством серверов MySQL</A>).

</P>
<P>
Предположим, что существующий сервер настроен на принятые по умолчанию
номер порта и файл сокета. Настроим новый сервер при помощи команды
<code>configure</code> следующим образом:

</P>

<pre>
shell&#62; ./configure --with-tcp-port=port_number \
             --with-unix-socket-path=file_name \
             --prefix=/usr/local/mysql-3.22.9
</pre>

<P>
Здесь <code>port_number</code> и <code>file_name</code> должны отличаться от принятого по умолчанию
номера порта и пути файла сокета, а значение <code>--prefix</code> должно указывать
каталог установки, который отличается от того, в котором установлен
текущий MySQL.

</P>
<P>
Проверить сокет, используемый установленным на данный момент сервером
MySQL, можно при помощи следующей команды:

</P>

<pre>
shell&#62; mysqladmin -h hostname --port=port_number variables
</pre>

<P>
Обратите внимание: если указать ``<code>localhost</code>'' как имя удаленного компьютера,
<code>mysqladmin</code> по умолчанию будет использовать сокеты Unix вместо TCP/IP.

</P>
<P>
В MySQL 4.1  вы также можете указать протокол, который надлежит использовать с помощью опции 
<code>--protocol=(TCP | SOCKET | PIPE | MEMORY)</code>.

</P>
<P>
Если на используемом порту находится сервер MySQL, то будет выдан список
самых важных настраиваемых переменных в MySQL, включая имя сокета.

</P>
<P>
Повторно компилировать новый сервер MySQL нет необходимости, его просто
нужно запустить с другими параметрами для порта и сокета. Используемые
порт и сокет можно изменить, указав их как параметры запуска для
<code>safe_mysqld</code>:

</P>

<pre>
shell&#62; /path/to/safe_mysqld --socket=file_name --port=port_number
</pre>

<P>
Модуль <code>mysqld_multi</code> может также в качестве аргумента принимать <code>safe_mysqld</code>
(или <code>mysqld</code>) и передавать параметры из файла конфигурации для <code>safe_mysqld</code>
и дальше для <code>mysqld</code>.

</P>
<P>
Если новый сервер запускается на том же каталоге базы данных, что и другой
сервер с включенной записью в журналы, необходимо также указать имена
файлов журналов для <code>safe_mysqld</code> при помощи параметров <code>--log</code>, <code>--log-update</code> 
или <code>--log-slow-queries</code>. Иначе оба сервера могут попытаться осуществить
запись в один и тот же файл журнала.

</P>
<P>
<strong>Предупреждение</strong>: обычно нельзя допускать, чтобы два сервера одновременно
заносили данные в одну и ту же базу данных! Если ваша операционная система
не поддерживает безотказную блокировку доступа, это может привести к
возникновению неприятных сюрпризов!

</P>
<P>
Если для второго сервера понадобится использовать другой каталог базы
данных, можно воспользоваться параметром <code>--datadir=path</code> для <code>safe_mysqld</code>.

</P>
<P>
<strong>Обратите внимание</strong>: запуск нескольких серверов MySQL (<code>mysqlds</code>) на различных
компьютерах с доступом к одному каталогу данных через сетевую файловую
систему обычно  не приводит ни к чему хорошему! Проблема состоит в том,
что сетевая файловая система становится узким местом для передачи данных.
Она не предназначена для такого использования. И даже в этом случае
придется искать решение, которое позволит обеспечить отсутствие конфликтов
между двумя или более модулями <code>mysqld</code>. На данный момент не существует
платформы, которая обеспечивает на 100% надежную блокировку доступа к
файлам (обычно демон <code>lockd</code>) во всех возможных ситуациях. Кроме того,
существует еще одна опасность при использовании сетевой файловой системы:
эта система может еще больше усложнить работу программы <code>lockd</code>. Поэтому
лучше смотреть на вещи проще и забыть об этой идее. Оптимальным решением
будет использование одного компьютера с несколькими центральными
процессорами и с операционной системой, которая эффективно управляет
потоками.

</P>
<P>
Если нужно подсоединиться к серверу MySQL, который работает с портом,
отличным от того, с которым откомпилирован ваш клиент, можно
воспользоваться одним из следующих методов:

</P>

<ul>
<LI>

Запустите клиент с параметрами <code>--host 'hostname' --port=port_number</code>,
чтобы подсоединиться через TCP/IP, или <code>[--host localhost
--socket=file_name]</code>, чтобы подсоединиться через сокет Unix.

<LI>

Запускайте ваш клиент с <code>--protocol=tcp</code> для подключения по TCP/IP и 
<code>--protocol=socket</code> для подключения через сокет Unix. 

<LI>

В своей программе на языке C или Perl можно задать аргументы порта или
сокета при подсоединении к серверу MySQL.

<LI>

При использовании модуля Perl <code>DBD::mysql</code> можно прочитать параметры из
файлов параметров MySQL (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>).


<pre>
$dsn = "DBI:mysql:test;mysql_read_default_group=client;
mysql_read_default_file=/usr/local/mysql/data/my.cnf"
$dbh = DBI-&#62;connect($dsn, $user, $password);
</pre>

<A NAME="IDX453"></A>
<A NAME="IDX454"></A>
<A NAME="IDX455"></A>
<A NAME="IDX456"></A>
<LI>

Задайте переменные окружения <code>MYSQL_UNIX_PORT</code> и <code>MYSQL_TCP_PORT</code>, чтобы
указать на сокет Unix и порт TCP/IP до запуска клиентов. Если обычно
используются конкретные сокет или порт, команды для задания этих
переменных окружения необходимо поместить в свой файл <tt>`.login'</tt> (see section <A HREF="manual.ru_Environment_variables.html#Environment_variables">F  Переменные окружения</A>).

<LI>

<A NAME="IDX457"></A>
Укажите принятые по умолчанию сокет и порт TCP/IP в файле <tt>`.my.cnf'</tt> в своем
домашнем каталоге (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>).
</ul>



<H2><A NAME="Privilege_system" HREF="manual.ru_toc.html#Privilege_system">4.2  Общие проблемы безопасности и система привилегий доступа MySQL</A></H2>

<P>
<A NAME="IDX458"></A>
<A NAME="IDX459"></A>
<A NAME="IDX460"></A>
<A NAME="IDX461"></A>
<A NAME="IDX462"></A>
<A NAME="IDX463"></A>
<A NAME="IDX464"></A>

</P>
<P>
MySQL имеет развитую, но нестандартную систему обеспечения безопасности и
привилегий доступа. В этом разделе дается описание ее работы.

</P>



<H3><A NAME="General_security" HREF="manual.ru_toc.html#General_security">4.2.1  Общие принципы обеспечения безопасности</A></H3>

<P>
С данным разделом должны ознакомиться все, кто использует MySQL на
компьютерах, подключенных к Internet, - чтобы избежать наиболее
распространенных ошибок, приводящих к нарушению безопасности системы.

</P>
<P>
При обсуждении вопросов безопасности мы акцентируем внимание на
необходимости защиты всего серверного хоста (а не одного лишь сервера
MySQL) от всех возможных типов атак: перехвата, внесения изменений,
считывания и отказа в обслуживании. Данный раздел не охватывает всех
аспектов готовности к работе и отказоустойчивости.

</P>
<P>
Используемая в MySQL система безопасности для всех подключений, запросов и
иных операций, которые может пытаться выполнить пользователь, базируется
на списках контроля доступа ACLs (Access Control Lists). Обеспечивается
также некоторая поддержка SSL-соединений между клиентами и серверами
MySQL. Многие из рассматриваемых здесь концепций не относятся
исключительно к MySQL; те же общие соображения применимы практически ко
всем приложениям.

</P>
<P>
При работе в MySQL старайтесь следовать приведенным ниже инструкциям:

</P>

<ul>
<LI>

<strong>Не предоставляйте никому (за исключением пользователя <code>mysql</code> под именем
<code>root</code>) доступа к таблице <code>user</code> в базе данных <code>mysql</code>! Это чрезвычайно
важно</strong>. <strong>В MySQL зашифрованный пароль является реальным паролем</strong>. Узнав
пароль, занесенный в таблицу <code>user</code>, и имея доступ к удаленному
компьютеру, занесенному в соответствующую учетную запись, <strong>войти в
систему под именем зарегистрированного владельца пароля  легко может
кто угодно</strong>.

<LI>

Изучите систему прав доступа MySQL. Для управления доступом к MySQL
служат команды <code>GRANT</code> и <code>REVOKE</code>. Предоставляйте ровно столько прав,
сколько необходимо, и не больше. Никогда не предоставляйте права всем
хостам. Полезно проводить следующие контрольные проверки:


<ul>
<LI>

Выполните команду <code>mysql -u root</code>. Если удается успешно установить
соединение с сервером без получения запроса пароля, значит, у вас
имеются проблемы. Это означает, что кто угодно может
подсоединиться к вашему серверу MySQL как клиент MySQL под именем
<code>root</code>, получая таким образом право неограниченного доступа!
Проанализируйте инструкцию по инсталляции MySQL, обращая особое
внимание на ту часть, которая касается задания пароля
пользователя <code>root</code>.

<LI>

С помощью команды <code>SHOW GRANTS</code> проверьте, кто и к каким ресурсам
имеет доступ. Воспользуйтесь командой <code>REVOKE</code>, отмените права
доступа, которые не являются необходимыми.
</ul>

<LI>

Не храните в базе данных незашифрованных паролей. Если злоумышленнику
удастся получить доступ на ваш компьютер, то в его руках окажется
полный список паролей, которыми он может воспользоваться. Применяйте
для шифрования <code>MD5()</code>, <code>SHA1()</code> или другие односторонние хеш-функции.

<LI>

Не используйте в качестве пароля слова из словарей. Для взлома такого
рода паролей имеются специальные программы. Даже слова типа
``xfish98'' - это очень плохие пароли. Куда лучше ``duag98'': здесь
используется то же слово ``fish'', но при этом буквы в нем заменены
ближайшими к ним слева буквами клавиатуры QWERTY. Еще один метод -
составить парольное слово из первых букв слов какого либо
словосочетания, например ``Mhall'' - по фразе ``Mary had a little
lamb.'' Такой пароль легко запоминается и его легко вводить. А вот
разгадать его тому, кто не знает ключевой фразы, будет непросто.

<LI>

Приобретите брандмауэр. Эта мера обеспечит защиту как минимум от
половины всех видов несанкционированного использования любого ПО, с
которым вы работаете. Разместите MySQL за брандмауэром или в
демилитаризованной зоне (demilitarised zone - DMZ). Полезно проводить
следующие контрольные проверки:

<LI>

Попробуйте просканировать ваши порты из Internet с помощью
утилиты типа <code>nmap</code>. MySQL использует по умолчанию порт 3306. Этот
порт должен быть недоступен с неблагонадежных компьютеров. Еще
один простой способ проверить, открыт или нет ваш MySQL-порт, -
попытаться выполнить с какой либо удаленной машины следующую
команду, где <code>server_host</code> - имя хоста, на котором установлен ваш
сервер MySQL:


<pre>
shell&#62; telnet server_host 3306
</pre>

Если соединение будет установлено, и вы получите какие-либо бессмысленные
символы, это будет означать, что порт открыт, и его нужно закрыть на
брандмауэре или маршрутизаторе (если, конечно, нет действительно веских
причин держать его открытым). Если же <code>telnet</code> просто зависнет или в
подсоединении будет отказано, тогда все в порядке: порт заблокирован.

<LI>

Не доверяйте никаким данным, которые вводят пользователи. Возможны
попытки перехитрить вашу программу путем ввода последовательностей
специальных или экранированных символов в веб-формы, URL-ы или любое
приложение, созданное вами. Убедитесь, что защита вашего приложения не
будет нарушена, если пользователь введет что-нибудь типа "<code>'; DROP
DATABASE mysql;</code>''. Это крайний случай, но действия хакеров,
использующих подобную технологию, могут привести к потере информации и
появлению брешей в системе безопасности, если вы не готовы к ним. Не
следует также забывать о необходимости проверки цифровых данных
(распространенной ошибкой является защита только строк). Некоторые
полагают, что если в базе данных хранятся только открытые данные, то в
ее защите нет необходимости. Это неверно. Такие базы могут стать
объектом успешных атак типа отказа от обслуживания. Простейший способ
защиты от взломов такого типа - заключать числовые константы в
кавычки: <code>SELECT * FROM table WHERE ID='234'</code>, а не <code>SELECT * FROM table
WHERE ID=23</code>4. MySQL автоматически преобразует эту строку в число и
выбросит из нее все нецифровые символы. Полезно проводить следующие
контрольные проверки:


<ul>
<LI>

Для всех веб-приложений:

<ul>
<LI>

Попробуйте ввести во все ваши веб-формы одинарные и двойные
кавычки - <samp>`''</samp> и <samp>`"'</samp>. Если MySQL выдаст любое сообщение об
ошибке, немедленно разберитесь, в чем дело.

<LI>

Попробуйте видоизменять динамические URL, добавляя в них <code>%22</code> 
(<samp>`"'</samp>), <code>%23</code> (<samp>`#'</samp>), и <code>%27</code> (<samp>`''</samp>).

<LI>

Попробуйте модифицировать типы данных в динамических URL -
замените числовые на символьные, используя символы из
предыдущих примеров. Ваше приложение должно быть устойчиво к
подобного рода атакам.

<LI>

Попробуйте вводить в числовые поля вместо цифр буквы,
пробелы и специальные символы. Ваше приложение должно либо
удалять их до передачи в MySQL, либо выдавать сообщение об
ошибке. Пропускать в MySQL значения без проверки очень
опасно!

<LI>

Проверяйте размер данных перед тем, как они будут переданы в
MySQL.

<LI>

При подключении приложения к базе данных лучше использовать
имя пользователя, отличное от того, которое вы используете
для целей администрирования. Не предоставляйте своим
приложениям больше прав доступа, чем это необходимо.
</ul>

<LI>

Пользователям PHP:

<ul>
<LI>Проверьте функцию <code>addslashes()</code>. Что касается PHP 4.0.3, то в

нем имеется функция <code>mysql_escape_string()</code>, базирующаяся на
функции с тем же именем из MySQL C API.
</ul>

<LI>

Пользователям MySQL C API:

<ul>
<LI>Проверьте API-вызов  <code>mysql_real_escape_string()</code>.

</ul>

<LI>

Пользователям MySQL++:

<ul>
<LI>Проверьте такие модификаторы, как <code>escape</code> и <code>quote</code>, - для

потоков запросов.
</ul>

<LI>

Пользователям Perl DBI:

<ul>
<LI>Проверьте метод <code>quote()</code> или используйте для проверки

заполнители.
</ul>

<LI>

Пользователям Java JDBC:

<ul>
<LI>Используйте для проверки объект <code>PreparedStatement</code> и

символы-заполнители.
</ul>

</ul>

<LI>

Не передавайте по Internet открытые (незашифрованные) данные. Они
могут оказаться у кого угодно, имеющего достаточно времени и
возможностей для того, чтобы перехватить их и использовать в своих
целях. Используйте вместо этого протоколы с шифрованием данных, такие
как SSL и SSH. MySQL, начиная с версии 4.0.0, поддерживает собственные
SSL-соединения. Пересылка по SSH (SSH Port Forwarding) может быть
использована для создания туннеля передачи данных с шифрованием и
сжатием.

<LI>

Научитесь пользоваться утилитами <code>tcpdump</code> и <code>strings</code>. В большинстве
случаев проверить, являются ли потоки данных MySQL зашифрованными,
можно с помощью команды, подобной той, которая приведена ниже:


<pre>
shell&#62; tcpdump -l -i eth0 -w - src or dst port 3306 | strings
</pre>

(Она работает под Linux, и будет, с незначительными изменениями, работать
под другими системами.) Предупреждение: если вы не видите данных, это еще
не гарантирует того, что они зашифрованы. Если требуется высокий уровень
безопасности, обратитесь к экспертам в этой области.
</ul>



<H3><A NAME="Security" HREF="manual.ru_toc.html#Security">4.2.2  Как обезопасить MySQL от хакеров</A></H3>

<P>
<A NAME="IDX465"></A>
<A NAME="IDX466"></A>

</P>
<P>
При подключении к серверу MySQL используется, как правило, пароль. По
линии связи пароль не передается в виде открытого текста, но алгоритм
шифрования не очень сложный. Толковый хакер, если ему удастся перехватить
трафик между клиентом и сервером, при определенной настойчивости может
взломать пароль. Поэтому если связь между клиентом и сервером
осуществляется по ненадежной сети, для шифрования связи следует
использовать SSH-туннель.

</P>
<P>
Вся остальная информация передается в текстовом виде и может быть
прочитана кем угодно, кто в состоянии отлеживать подключение. Если это вас
беспокоит, можно воспользоваться протоколом со сжатием данных (в MySQL
3.22 и последующих версиях), что значительно затруднит подобные действия.
Чтобы еще более повысить безопасность связи, следует использовать протокол
<code>ssh</code>. <code>Open source</code>-клиент <code>ssh</code> доступен на веб-сайте <a HREF="http://www.openssh.org/">http://www.openssh.org/</a>,
а коммерческий <code>ssh</code>-клиент можно получить на веб-сайте 
<a HREF="http://www.ssh.com/">http://www.ssh.com/</a>. С помощью такого протокола можно обеспечить
зашифрованную связь по протоколу TCP/IP между сервером MySQL и клиентом
MySQL.

</P>
<P>
Если вы используете MySQL 4.0, то можете также использовать
предусмотренную в этой версии поддержку протокола OpenSSL. Обратитесь  к 
разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Secure_connections">4.3.9  Использование безопасных соединений</A>.

</P>
<P>
Для обеспечения безопасности MySQL-системы необходимо строго
придерживаться следующих рекомендаций:

</P>

<ul>
<LI>

У всех пользователей MySQL должны быть пароли. Для приложений
клиент/сервер является общепринятым, что клиент может указывать любое
имя пользователя, но если для <code>other_user</code> не задан пароль, то кто
угодно может зайти под любым именем, просто введя <code>mysql -u other_user
db_name</code>. Чтобы этого избежать, можно изменить пароль для всех
пользователей, отредактировав скрипт <code>mysql_install_db</code> перед запуском
приложения, или только пароль для <code>root</code>-пользователя MySQL, как это
показано ниже:


<pre>
shell&#62; mysql -u root mysql
mysql&#62; UPDATE user SET Password=PASSWORD('new_password')
		   WHERE user='root';
mysql&#62; FLUSH PRIVILEGES;
</pre>

<LI>

Не запускайте демон MySQL от имени пользователя Unix <code>root</code>. Это очень
опасно, потому что любой пользователь, имеющий привилегию <code>FILE</code>, будет
в состоянии создавать файлы как пользователь <code>root</code> (например
<code>~root/.bashrc</code>). Чтобы предотвратить это, <code>mysqld</code> откажется запускаться
от имени пользователя <code>root</code>, если это не будет задано напрямую с
помощью опции <code>--user=root</code>. В то же время <code>mysqld</code> может быть запущена от
имени обычного непривилегированного пользователя. Можно также, в целях
еще большего укрепления безопасности, создать новый аккаунт
Unix-пользователя <code>mysql</code>. При запуске <code>mysqld</code> от имени другого
пользователя Unix у вас отпадает необходимость заменять имя
пользователя <code>root</code> в таблице <code>user</code>, так как имена пользователя в MySQL
не имеют ничего общего с аккаунтами пользователей Unix. Для запуска
<code>mysqld</code> от имени другого пользователя Unix добавьте в группу <code>[mysqld]</code> 
файла опций <tt>`/etc/my.cnf'</tt> или файла опций <tt>`my.cnf'</tt>, находящегося в
каталоге данных сервера, строку <code>user</code>, задающую имя пользователя.
Например:


<pre>
[mysqld]
user=mysql
</pre>

В результате сервер будет запущен от имени назначенного пользователя,
независимо от того, производится запуск вручную или посредством
<code>safe_mysqld</code> или <code>mysql.server</code>. Для получения дополнительной информации
обратитесь к разделу See section <A HREF="manual.ru_Problems.html#Changing_MySQL_user">A.3.2  Запуск MySQL от обычного пользователя</A>.

<LI>

Откажитесь от поддержки символических ссылок на таблицы (ее можно
запретить с помощью опции <code>--skip-symlink</code>). Это особенно важно в том
случае, если вы запускаете <code>mysqld</code> от имени пользователя <code>root</code>,
поскольку у того, кто имеет право доступа для записи в каталоги данных
<code>mysqld</code>, появляется возможность стереть любой файл в системе!
Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Optimisation.html#Symbolic_links_to_tables">5.6.1.2  Использование символических ссылок для таблиц</A>.

<LI>

Удостоверьтесь, что пользователь Unix, от имени которого запускается
mysqld, является единственным пользователем, имеющим привилегии
чтения/записи в директории базы данных.

<LI>

Не предоставляйте привилегии <code>PROCESS</code> всем пользователям. Команда
<code>mysqladmin processlist</code> выводит текст запросов, обрабатываемых в данный
момент. Следовательно, любой пользователь, имеющий право на выполнение
этой команды, получает возможность прочитать, например, такой запрос
другого пользователя, как <code>UPDATE</code> user <code>SET
password=PASSWORD('not_secure')</code>. <code>mysqld</code> резервирует добавочное
подключение для пользователей, имеющих привилегию <code>PROCESS</code>, так что
пользователь MySQL под именем <code>root</code> может подключиться и осуществлять
контроль даже в том случае, когда все обычные подключения заняты.

<LI>

Не предоставляйте привилегии <code>FILE</code> всем пользователям. Любой
пользователь, имеющий такую привилегию, может записать в любом месте
файловой системы файл с привилегиями демона <code>mysqld</code>! Чтобы обеспечить
здесь хоть минимальную защиту, все файлы создаваемые с помощью команды
<code>SELECT ... INTO OUTFILE</code>, сделаны общедоступными для записи, но
перезаписать существующие файлы нельзя. 

Привилегия <code>FILE</code> может быть
также использована для чтения любого файла, доступного пользователю
Unix, от имени которого запускается сервер. 

Можно также прочитать любой файл в текущую базу данных.  Это может быть
использовано в корыстных целях. Возможно, например, с помощью команды
<code>LOAD DATA</code> загрузить <tt>`/etc/passwd'</tt> в таблицу и прочесть ее позже с
помощью <code>SELECT</code>.

<LI>

Если вы не доверяете своему DNS-серверу, используйте в таблицах
привилегий вместо имен хостов IP-адреса. В любом случае следует очень
осторожно относиться к внесению в таблицы привилегий записей, в
которых значения имени хоста содержат шаблонные символы!

<LI>

Чтобы ограничить число подключений, доступных для отдельного
пользователя, можно в <code>mysqld</code> задать значение переменной
<code>max_user_connections</code>.
</ul>



<H3><A NAME="Privileges_options" HREF="manual.ru_toc.html#Privileges_options">4.2.3  Опции запуска <code>mysqld</code>, относящиеся к безопасности</A></H3>

<P>
К безопасности имеют отношение следующие опции <code>mysqld</code>:

</P>
<DL COMPACT>

<DT><code>--local-infile[=(0|1)]</code>
<DD>
При установке опции <code>--local-infile=0</code> теряется возможность выполнять
команду <code>LOAD DATA LOCAL INFILE</code>.

<DT><code>--safe-show-database</code>
<DD>
Если установлена эта опция, команда <code>SHOW DATABASES</code> возвращает только те
базы данных, для которых пользователь имеет какую-либо привилегию. Начиная
с версии 4.0.2 эта опция отменена и не служит ни для чего (она включена по
умолчанию), т.к. сейчас у нас имеется привилегия <code>SHOW DATABASES</code>.
Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#GRANT">4.3.1  Синтаксис команд <code>GRANT</code> и <code>REVOKE</code></A>.

<DT><code>--safe-user-create</code>
<DD>
При установке этой опции пользователь не может создавать новых
пользователей с помощью команды <code>GRANT</code>, если у него отсутствует привилегия
<code>INSERT</code> для таблицы <code>mysql.user</code>. Чтобы предоставить пользователю доступ
именно для создания новых пользователей с теми привилегиями, которые он
имеет право предоставлять, для этого пользователя следует установить
следующую привилегию:


<pre>
mysql&#62; GRANT INSERT(user) ON mysql.user TO 'user''hostname';
</pre>

Задание такой привилегии гарантирует, что этот пользователь не сможет
непосредственно вносить изменения ни в одном из столбцов привилегий, а для
предоставления привилегий другим пользователям должен будет использовать
команду <code>GRANT</code>.

<DT><code>--skip-grant-tables</code>
<DD>
Установка этой опции запрещает серверу вообще использовать систему
привилегий. Это открывает кому бы то ни было полный доступ ко всем базам
данных! (После запуска сервера можно заставить его снова использовать
таблицы привилегий с помощью команды mysqladmin <code>flush-privileges</code> или
<code>mysqladmin reload</code>.)

<DT><code>--skip-name-resolve</code>
<DD>
При установке данной опции имена хостов не разрешены. Все значения в
столбцах <code>Host</code> таблиц привилегий должны быть либо IP-адресами, либо
<code>localhost</code>.

<DT><code>--skip-networking</code>
<DD>
Не разрешает осуществлять подсоединений по протоколу TCP/IP через сеть
(данная опция запрещает такие подсоединения). Все подсоединения к <code>mysqld</code>
должны осуществляться посредством сокетов Unix. Для MySQL старше 3.23.27 эта опция 
непригодна для систем, в которых используются MIT-потоки, так как MIT-потоки на тот
момент не поддерживали сокеты Unix.

<DT><code>--skip-show-database</code>
<DD>
Разрешает выполнение команды <code>SHOW DATABASES</code> только в том случае, если
пользователь имеет привилегию <code>SHOW DATABASES</code>. Начиная с версии 4.0.2 в
этой опции больше нет необходимости, т.к. теперь доступ может
предоставляться избирательно с помощью привилегии <code>SHOW DATABASES</code>.
</DL>



<H3><A NAME="LOAD_DATA_LOCAL" HREF="manual.ru_toc.html#LOAD_DATA_LOCAL">4.2.4  Вопросы безопасности, относящиеся к команде LOAD DATA LOCAL</A></H3>

<P>
Чтобы решить проблемы безопасности, которые могут возникнуть при
использовании команды <code>LOAD DATA LOCAL</code>,в MySQL 3.23.49 и MySQL 4.0.2 были
добавлены новые опции.

</P>
<P>
При поддержке этой команды могут возникнуть две проблемы:

</P>
<P>
Первая: поскольку чтение файла инициируется сервером, теоретически имеется
возможность создать ``доработанный'' при помощи патча сервер MySQL,
способный читать любые файлы на клиентской машине, к которой текущий
пользователь имеет доступ для чтения, в то время, когда клиент направляет
запрос к таблице.

</P>
<P>
Вторая: в веб-среде, в которой подсоединение клиентов осуществляется с
веб-сервера, пользователь может использовать команду <code>LOAD DATA LOCAL</code> для
чтения любых файлов, к которым процесс веб-сервера имеет доступ для чтения
(если предположить, что пользователь может выполнять на сервере SQL любые
команды).

</P>
<P>
Эти проблемы решаются с помощью двух следующих исправлений:

</P>
<P>
Если вы конфигурируете MySQL без опции <code>--enable-local-infile</code>, то команда
<code>LOAD DATA LOCAL</code> будет запрещена для всех клиентов, если, конечно, они не
будут вызывать <code>mysql_options (... MYSQL_OPT_LOCAL_INFILE, 0)</code>. Обратитесь
к разделу See section <A HREF="manual.ru_Clients.html#mysql_options">8.4.3.163  <code>mysql_options()</code></A>.

</P>
<P>
В случае клиента mysql, <code>LOAD DATA LOCAL</code> может быть разблокирована заданием
опции <code>--local-infile[=1]</code> или заблокирована с помощью опции
<code>--local-infile=0</code>.

</P>
<P>
По умолчанию все MySQL-клиенты и библиотеки компилируются с опцией
<code>--enable-local-infile</code> для обеспечения совместимости с MySQL 3.23.48 и
более старыми версиями.

</P>
<P>
Блокировку всех команд <code>LOAD DATA LOCAL</code> на MySQL-сервере можно осуществить
путем запуска <code>mysqld</code> с опцией <code>--local-infile=0</code>.

</P>
<P>
В случае, если команда <code>LOAD DATA LOCAL INFILE</code> заблокирована на сервере или
клиенте, вы получите следующее сообщение об ошибке (1148):

</P>

<pre>
The used command is not allowed with this MySQL version
</pre>



<H3><A NAME="What_Privileges" HREF="manual.ru_toc.html#What_Privileges">4.2.5  Функции, выполняемые системой привилегий</A></H3>

<P>
<A NAME="IDX467"></A>
<A NAME="IDX468"></A>
<A NAME="IDX469"></A>
<A NAME="IDX470"></A>

</P>
<P>
Основной функцией системы привилегий MySQL является аутентификация
пользователя, подключающегося с указанного хоста, и ассоциирование его с
привилегиями базы данных, такими как <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code> и <code>DELETE</code>.

</P>
<P>
К дополнительным функциональным возможностям системы привилегий относятся
следующие: возможность обслуживания анонимного пользователя и
предоставление привилегий для таких специфических для MySQL функций, как
<code>LOAD DATA INFILE</code> и функции администрирования.

</P>


<H3><A NAME="Privileges" HREF="manual.ru_toc.html#Privileges">4.2.6  Как работает система привилегий</A></H3>

<P>
<A NAME="IDX471"></A>

</P>
<P>
Система привилегий MySQL обеспечивает пользователям возможность выполнять
только те действия, которые им разрешены в соответствии с их
обязанностями. Когда вы подсоединяетесь к серверу MySQL, ваша личность
устанавливается по имени <strong>хоста, с которого вы подсоединяетесь</strong>, и <strong>имени
пользователя, которое вы указываете</strong>. Система предоставляет привилегии в
соответствии с вашей личностью и <strong>тем, что вы хотите делать</strong>.

</P>
<P>
MySQL идентифицирует пользователя как по имени хоста, так и по имени
пользователя, т.к. нет оснований полагать что данное имя пользователя
принадлежит во всей Сети единственному человеку. Например, пользователь
<code>joe</code>, устанавливающий соединение с <code>office.com</code>, вовсе не обязательно один и
тот же человек, что и пользователь <code>joe</code>, подсоединяющийся с <code>elsewhere.com</code>.
MySQL решает эту проблему, обеспечивая возможность различать
пользователей, подсоединяющихся с различных хостов под одним и тем же
именем пользователя: вы можете предоставлять <code>joe</code> один набор привилегий,
если он подсоединяется с <code>office.com</code>, и другой набор привилегий, если <code>joe</code>
подсоединяется с <code>elsewhere.com</code>.

</P>
<P>
Управление доступом в MySQL осуществляется в два этапа:

</P>

<ul>
<LI>

Этап 1: сервер проверяет, имеется ли у вас вообще разрешение на
подсоединение.

2item
Этап 2: если таковое имеется, сервер проверяет каждый из ваших
запросов, чтобы убедиться в том, что у вас имеется достаточно
привилегий для его выполнения. Например, если вы пытаетесь выбрать
строки в таблице базы данных или удалить таблицу из базы данных,
сервер в первом случае проверяет, имеется ли у вас для этой таблицы
привилегия <code>SELECT</code>, а во втором - имеется ли у вас для этой базы данных
привилегия <code>DROP</code>.
</ul>

<P>
На обеих стадиях управления доступом сервер использует таблицы <code>user</code>, <code>db</code> и 
<code>host</code> из базы данных <code>mysql</code>. Ниже перечислены поля этих таблиц привилегий:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Имя таблицы</strong> </TD><TD> <code>user</code> </TD><TD> <code>db</code> </TD><TD> <code>host</code>

</TD></TR>
<TR><TD><strong>Поля контекста</strong> </TD><TD> <code>Host</code> </TD><TD> <code>Host</code> </TD><TD> <code>Host</code>
</TD></TR>
<TR><TD></TD><TD> <code>User</code> </TD><TD> <code>Db</code> </TD><TD> <code>Db</code>
</TD></TR>
<TR><TD></TD><TD> <code>Password</code> </TD><TD> <code>User</code> </TD><TD>

</TD></TR>
<TR><TD><strong>Поля привилегий</strong> </TD><TD> <code>Select_priv</code> </TD><TD> <code>Select_priv</code> </TD><TD> <code>Select_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>Insert_priv</code> </TD><TD> <code>Insert_priv</code> </TD><TD> <code>Insert_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>Update_priv</code> </TD><TD> <code>Update_priv</code> </TD><TD> <code>Update_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>Delete_priv</code> </TD><TD> <code>Delete_priv</code> </TD><TD> <code>Delete_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>Index_priv</code> </TD><TD> <code>Index_priv</code> </TD><TD> <code>Index_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>Alter_priv</code> </TD><TD> <code>Alter_priv</code> </TD><TD> <code>Alter_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>Create_priv</code> </TD><TD> <code>Create_priv</code> </TD><TD> <code>Create_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>Drop_priv</code> </TD><TD> <code>Drop_priv</code> </TD><TD> <code>Drop_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>Grant_priv</code> </TD><TD> <code>Grant_priv</code> </TD><TD> <code>Grant_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>References_priv</code> </TD><TD> </TD><TD> 
</TD></TR>
<TR><TD></TD><TD> <code>Reload_priv</code> </TD><TD> </TD><TD> 
</TD></TR>
<TR><TD></TD><TD> <code>Shutdown_priv</code> </TD><TD> </TD><TD> 
</TD></TR>
<TR><TD></TD><TD> <code>Process_priv</code> </TD><TD> </TD><TD> 
</TD></TR>
<TR><TD></TD><TD> <code>File_priv</code> </TD><TD> </TD><TD> 
</TD></TR>
</TABLE>

<P>
На втором этапе управления доступом (верификация запросов) сервер может (в
случае, если запрос относится к таблицам базы данных) дополнительно
обратиться к таблицам <code>tables_priv</code> и <code>columns_priv</code>. Поля этих таблиц
привилегий перечислены ниже:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Имя  таблицы</strong> </TD><TD> <code>tables_priv</code> </TD><TD> <code>columns_priv</code>

</TD></TR>
<TR><TD><strong>Поля контекста</strong> </TD><TD> <code>Host</code> </TD><TD> <code>Host</code>
</TD></TR>
<TR><TD></TD><TD> <code>Db</code> </TD><TD> <code>Db</code>
</TD></TR>
<TR><TD></TD><TD> <code>User</code> </TD><TD> <code>User</code>
</TD></TR>
<TR><TD></TD><TD> <code>Table_name</code> </TD><TD> <code>Table_name</code>
</TD></TR>
<TR><TD></TD><TD> </TD><TD> <code>Column_name</code>

</TD></TR>
<TR><TD><strong>Поля привилегий</strong> </TD><TD> <code>Table_priv</code> </TD><TD> <code>Column_priv</code>
</TD></TR>
<TR><TD></TD><TD> <code>Column_priv</code> </TD><TD>

</TD></TR>
<TR><TD><strong>Иные  поля</strong> </TD><TD> <code>Timestamp</code> </TD><TD> <code>Timestamp</code>
</TD></TR>
<TR><TD></TD><TD> <code>Grantor</code> </TD><TD>
</TD></TR>
</TABLE>

<P>
Каждая таблица привилегий включает в себя поля контекста и поля
привилегий.

</P>
<P>
Поля контекста определяют область действия каждой из записей в таблицах,
т.е. контекст, к которому имеет отношение та или иная запись. Например,
запись в таблице <code>user</code>, в полях <code>Host</code> и <code>User</code> которой указаны значения
<code>'thomas.loc.gov'</code>  <code>'bob'</code>, предназначена для аутентификации подсоединений к
серверу с хоста <code>thomas.loc.gov</code> под именем пользователя <code>bob</code>. Аналогично
запись в таблице <code>db</code>, в полях <code>Host</code>, <code>User</code> и <code>Db</code> которой указаны значения
<code>'thomas.loc.gov'</code>, <code>'bob'</code> и <code>'reports'</code>,  будет использоваться при попытке
пользователя по именем <code>bob</code> подсоединиться с хоста <code>thomas.loc.gov</code> и
получить доступ к базе данных <code>reports</code>. В полях контекста в таблицах
<code>tables_priv</code> и <code>columns_priv</code> указаны таблицы или комбинации таблиц/столбцов,
к которым применяется каждая запись.

</P>
<P>
<A NAME="IDX472"></A>
При контроле доступа сравнение значений в полях <code>Host</code> осуществляется без
учета регистра. Значения в полях <code>User</code>, <code>Password</code>, <code>Db</code> и <code>Table_name</code> также
являются независимыми от регистра символов. Значения в поле <code>Column_name</code>
являются независимыми от регистра символов, начиная с MySQL 3.22.12.

</P>
<P>
В полях привилегий указываются привилегии, предоставляемые записью в
таблице, т.е. то, какие операции разрешено выполнять. Сервер формирует
полное описание привилегий пользователя, комбинируя информацию, хранящуюся
в разных таблицах привилегий. Это осуществляется по правилам, которые
описаны в разделе See section <A HREF="manual.ru_MySQL_Database_Administration.html#Request_access">4.2.10  Управление доступом, этап 2: верификация запросов</A>.

</P>
<P>
Поля контекста - это строковые значения, объявленные, как показано ниже;
устанавливаемым по умолчанию значением для каждого из них является пустая
строка:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Имя поля</strong> </TD><TD> <strong>Тип</strong> </TD><TD> <strong>Примечания</strong>
</TD></TR>
<TR><TD><code>Host</code> </TD><TD> <code>CHAR(60)</code> </TD><TD>
</TD></TR>
<TR><TD><code>User</code> </TD><TD> <code>CHAR(16)</code> </TD><TD>
</TD></TR>
<TR><TD><code>Password</code> </TD><TD> <code>CHAR(16)</code> </TD><TD>
</TD></TR>
<TR><TD><code>Db</code> </TD><TD> <code>CHAR(64)</code> </TD><TD> (<code>CHAR(60)</code> для  таблиц
<code>tables_priv</code> и <code>columns_priv</code> tables)
</TD></TR>
<TR><TD><code>Table_name</code> </TD><TD> <code>CHAR(60)</code> </TD><TD>
</TD></TR>
<TR><TD><code>Column_name</code> </TD><TD> <code>CHAR(60)</code> </TD><TD>
</TD></TR>
</TABLE>

<P>
В таблицах <code>user</code>, <code>db</code> и <code>host</code> все поля привилегий имеют объявленный тип
<code>ENUM('N','Y')</code>, т.е. возможно одно из двух значений - <code>'N'</code> и <code>'Y'</code>, а
устанавливаемым по умолчанию является <code>'N'</code>.

</P>
<P>
В таблицах <code>tables_priv</code> and <code>columns_priv</code> поля привилегий объявляются как
<code>SET</code>:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Имя таблицы</strong>
 </TD><TD> <strong>Имя поля</strong>
 </TD><TD> <strong>Допустимые элементы набора</strong>
</TD></TR>
<TR><TD><code>tables_priv</code>
 </TD><TD> <code>Table_priv</code>
 </TD><TD> <code>'Select', 'Insert', 'Update', 'Delete', 'Create', 'Drop', 'Grant', 'References', 'Index', 'Alter'</code>
</TD></TR>
<TR><TD><code>tables_priv</code>
 </TD><TD> <code>Column_priv</code>
 </TD><TD> <code>'Select', 'Insert', 'Update', 'References'</code>
</TD></TR>
<TR><TD><code>columns_priv</code>
 </TD><TD> <code>Column_priv</code>
 </TD><TD> <code>'Select', 'Insert', 'Update', 'References'</code>
</TD></TR>
</TABLE>

<P>
Если кратко, то сервер использует таблицы привилегий следующим образом:

</P>

<ul>
<LI>

Поля контекста таблицы <code>user</code> определяют, разрешить входящее
подсоединение или отказать в нем. Для разрешенных подсоединений любые
привилегии, предоставленные в таблице <code>user</code>, означают глобальные
привилегии пользователя (привилегии суперпользователя). Эти привилегии
распространяются на все базы данных, размещенные на сервере.

<LI>

Таблицы <code>db</code> и <code>host</code> используются совместно:


<ul>
<LI>

Поля контекста таблицы <code>db</code> определяют, каким пользователям, при
подсоединении с каких хостов разрешен доступ к каким базам
данных. Поля привилегий определяют разрешенные операции.

<LI>

Таблица <code>host</code> используется в качестве расширения таблицы <code>db</code> в
случае, если необходимо применить некоторую запись из таблицы db
к разным хостам. Например, если вы хотите предоставить
пользователю возможность обращаться к базе данных с различных
хостов сети, оставьте пустым поле в записи этого пользователя в
таблице <code>db</code>, а затем внесите в таблицу <code>host</code> запись для каждого из
этих хостов. Более подробно данный механизм описан в разделе
See section <A HREF="manual.ru_MySQL_Database_Administration.html#Request_access">4.2.10  Управление доступом, этап 2: верификация запросов</A>.
</ul>

<LI>

Таблицы <code>tables_priv</code> и <code>columns_priv</code> подобны таблице <code>db</code>, но областью их
действия является уже уровень таблиц и столбцов, а не баз данных.
</ul>

<P>
Заметим, что привилегии администрирования (<code>RELOAD</code>, <code>SHUTDOWN</code> и т.д..)
задаются только в таблице <code>user</code>. Это связано с тем, что операции
администрирования являются операциями над самим сервером, а не над базами
данных, поэтому не смысла перечислять такие привилегии в других таблицах
привилегий. Фактически для того, чтобы выяснить, имеете ли вы привилегии
выполнять операции администрирования, достаточно обратиться только к
таблице <code>user</code>.

</P>
<P>
Привилегия <code>FILE</code> также задается только в таблице <code>user</code>. Она не является
привилегией администрирования как таковой, но возможность производить
чтение или запись файлов на серверном хосте не связана с базой данных, к
которой вы получаете доступ.

</P>
<P>
Сервер <code>mysqld</code> считывает содержимое таблиц привилегий единожды, при его
запуске. О том, каким образом изменения, вносимые в таблицы привилегий,
вступают в силу, рассказывается в разделе See section <A HREF="manual.ru_MySQL_Database_Administration.html#Privilege_changes">4.3.3  Когда изменения в привилегиях вступают в силу</A>.

</P>
<P>
При внесении изменений в таблицы привилегий стоит убедиться в том, что
ваши изменения задают привилегии именно так, как задумано вами. Помощь по
диагностике проблем вы найдете в разделе See section <A HREF="manual.ru_MySQL_Database_Administration.html#Access_denied">4.2.11  Причины появления ошибок <code>Access denied</code> ("в доступе отказано")</A>. По вопросам, связанным с безопасностью, следует обращаться к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Security">4.2.2  Как обезопасить MySQL от хакеров</A>.

</P>
<P>
Полезным диагностическим инструментом является скрипт <code>mysqlaccess</code>,
которым Ив Карлье (Yves Carlier) укомплектовал дистрибутив MySQL.
Запустите <code>mysqlaccess</code> с опцией <code>--help</code> чтобы посмотреть, как он работает.
Заметим, что <code>mysqlaccess</code> контролирует доступ, используя только таблицы
<code>user</code>, <code>db</code> и <code>host</code>. Он не проверяет привилегии на уровне таблиц или
столбцов.

</P>


<H3><A NAME="Privileges_provided" HREF="manual.ru_toc.html#Privileges_provided">4.2.7  Привилегии, предоставляемые MySQL</A></H3>

<P>
<A NAME="IDX473"></A>

</P>
<P>
Информация о привилегиях пользователя хранится в таблицах <code>user</code>, <code>db</code>, <code>host</code>,
<code>tables_priv</code> и <code>columns_priv</code> базы данных <code>mysql</code> (т.е. в базе данных с именем
mysql). Сервер MySQL считывает содержимое этих таблиц во время запуска, и
в случаях, указанных в разделе See section <A HREF="manual.ru_MySQL_Database_Administration.html#Privilege_changes">4.3.3  Когда изменения в привилегиях вступают в силу</A>.

</P>
<P>
Ниже приведены имена, используемые в данном руководстве для ссылок на
привилегии, предоставляемые в MySQL 4.0.2. Здесь же указаны имена
табличных столбцов, ассоциированных с каждой из привилегий в таблицах
привилегий, наряду с контекстом, в котором эти привилегии имеют силу:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Привилегия</strong> </TD><TD> <strong>Столбец</strong> </TD><TD> <strong>Контекст</strong>
</TD></TR>
<TR><TD><code>ALTER</code> </TD><TD> <code>Alter_priv</code> </TD><TD> таблицы
</TD></TR>
<TR><TD><code>DELETE</code> </TD><TD> <code>Delete_priv</code> </TD><TD> таблицы
</TD></TR>
<TR><TD><code>INDEX</code> </TD><TD> <code>Index_priv</code> </TD><TD> таблицы
</TD></TR>
<TR><TD><code>INSERT</code> </TD><TD> <code>Insert_priv</code> </TD><TD> таблицы
</TD></TR>
<TR><TD><code>SELECT</code> </TD><TD> <code>Select_priv</code> </TD><TD> таблицы
</TD></TR>
<TR><TD><code>UPDATE</code> </TD><TD> <code>Update_priv</code> </TD><TD> таблицы
</TD></TR>
<TR><TD><code>CREATE</code> </TD><TD> <code>Create_priv</code> </TD><TD> базы данных, таблицы или индексы
</TD></TR>
<TR><TD><code>DROP</code> </TD><TD> <code>Drop_priv</code> </TD><TD> базы данных или таблицы
</TD></TR>
<TR><TD><code>GRANT</code> </TD><TD> <code>Grant_priv</code> </TD><TD> базы данных или таблицы
</TD></TR>
<TR><TD><code>REFERENCES</code> </TD><TD> <code>References_priv</code> </TD><TD> базы данных или таблицы
</TD></TR>
<TR><TD><code>CREATE TEMPORARY TABLES</code> </TD><TD> <code>Create_tmp_table_priv</code> </TD><TD> администрирование сервера
</TD></TR>
<TR><TD><code>EXECUTE</code> </TD><TD> <code>Execute_priv</code> </TD><TD> администрирование сервера
</TD></TR>
<TR><TD><code>FILE</code> </TD><TD> <code>File_priv</code> </TD><TD> доступ к файлам на сервере
</TD></TR>
<TR><TD><code>LOCK TABLES</code> </TD><TD> <code>Lock_tables_priv</code> </TD><TD> администрирование сервера
</TD></TR>
<TR><TD><code>PROCESS</code> </TD><TD> <code>Process_priv</code> </TD><TD> администрирование сервера
</TD></TR>
<TR><TD><code>RELOAD</code> </TD><TD> <code>Reload_priv</code> </TD><TD> администрирование сервера
</TD></TR>
<TR><TD><code>REPLICATION CLIENT</code> </TD><TD> <code>Repl_client_priv</code> </TD><TD> администрирование сервера
</TD></TR>
<TR><TD><code>REPLICATION SLAVE</code> </TD><TD> <code>Repl_slave_priv</code> </TD><TD> администрирование сервера
</TD></TR>
<TR><TD><code>SHOW DATABASES</code> </TD><TD> <code>Show_db_priv</code> </TD><TD> администрирование сервера
</TD></TR>
<TR><TD><code>SHUTDOWN</code> </TD><TD> <code>Shutdown_priv</code> </TD><TD> администрирование сервера
</TD></TR>
<TR><TD><code>SUPER</code> </TD><TD> <code>Super_priv</code> </TD><TD> администрирование сервера
</TD></TR>
</TABLE>

<P>
Привилегии <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code> и  <code>DELETE</code> позволяют выполнять операции
над строками таблиц баз данных.

</P>
<P>
Для операторов <code>SELECT</code> привилегия <code>SELECT</code> требуется только в том случае,
если они действительно извлекают строки из таблицы.. В ряде случае можно
выполнять операторы <code>SELECT</code>, даже не имея разрешения на доступ ни к одной
базе данных на сервере. Например: клиент <code>mysql</code> вы можете использовать в
качестве обычного калькулятора:

</P>

<pre>
mysql&#62; SELECT 1+1;
mysql&#62; SELECT PI()*2;
</pre>

<P>
Привилегия <code>INDEX</code> позволяет создавать или уничтожать (удалять) индексы.

</P>
<P>
Привилегия <code>ALTER</code> позволяет использовать команду <code>ALTER TABLE</code>.

</P>
<P>
Привилегии <code>CREATE</code> и <code>DROP</code> позволяют создавать новые базы данных и таблицы
или уничтожать (удалять) существующие базы данных и таблицы.

</P>
<P>
Заметим, что в случае, если пользователю предоставляется привилегия <code>DROP</code>
по отношению к базе данных <code>mysql</code>, он может уничтожить базу данных, в
которой хранятся привилегии доступа в MySQL!

</P>
<P>
Привилегия <code>GRANT</code> позволяет вам предоставлять другим пользователям
привилегии, которыми обладаете вы сами.

</P>
<P>
Привилегия <code>FILE</code> дает вам право читать и записывать файлы на сервере с
помощью операторов <code>LOAD DATA INFILE</code> и <code>SELECT ... INTO OUTFILE</code>. Любой
пользователь, которому предоставлена такая привилегия, имеет право
прочитать или записать любой файл, который может прочитать или записать
сервер MySQL. Пользователь также может прочитать любой файл в каталоге текущей базы данных. 
Однако существующие файлы перезаписывать нельзя.

</P>
<P>
Остальные привилегии используются для операций администрирования,
выполняемых с помощью программы <code>mysqladmin</code>. В таблице, приведенной ниже,
для каждой из привилегий администрирования показано, какие команды
<code>mysqladmin</code> она позволяет выполнять.

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Привилегия</strong> </TD><TD> <strong>Команды, разрешенные обладателю привилегии</strong>
</TD></TR>
<TR><TD><code>RELOAD</code> </TD><TD> <code>reload</code>, <code>refresh</code>,
<code>flush-privileges</code>, <code>flush-hosts</code>, <code>flush-logs</code>, and
<code>flush-tables</code>
</TD></TR>
<TR><TD><code>SHUTDOWN</code> </TD><TD> <code>shutdown</code>
</TD></TR>
<TR><TD><code>PROCESS</code> </TD><TD> <code>processlist</code>
</TD></TR>
<TR><TD><code>SUPER</code> </TD><TD> <code>kill</code>
</TD></TR>
</TABLE>

<P>
Команда <code>reload</code> заставляет сервер перечитать таблицы привилегий. Команда
<code>refresh</code> очищает все таблицы, а также открывает и закрывает файлы журналов.
<code>flush-privileges</code> является синонимом <code>reload</code>. Остальные команды <code>flush-*</code> 
выполняют функции, аналогичные функциям команды <code>refresh</code>, но с более узкой
областью действия. В некоторых случаях такие команды могут оказаться более
предпочтительными. Например, если вы хотите очистить только системные
журналы, команда <code>flush-logs</code> лучше, чем <code>refresh</code>.

</P>
<P>
Команда <code>shutdown</code> завершает работу сервера.

</P>
<P>
Команда <code>processlist</code> выводит информацию о задачах, выполняющихся на
сервере. Команда <code>kill</code> уничтожает серверные потоки. Собственные потоки
всегда можно просмотреть или уничтожить, но для отображения потоков,
запущенных другими пользователями, нужна привилегия <code>PROCESS</code>,а для
уничтожения потоков, запущенных другими пользователями, потребуется
привилегия <code>SUPER</code>. Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#KILL">4.5.5  Синтаксис команды <code>KILL</code></A>. 

</P>
<P>
В общем случае идея предоставлять привилегии только тем пользователям,
которым они необходимы, хорошая, но к предоставлению некоторых из них
следует относиться особенно внимательно:

</P>

<ul>
<LI>

Привилегия <code>GRANT</code> позволяет пользователям передавать свои привилегии
другим пользователям. Два пользователя с неодинаковыми привилегиями,
имея привилегию <code>GRANT</code>, способны объединить свои привилегии.

<LI>

Привилегия <code>ALTER</code> может быть использована для переименования таблиц и
разрушения таким образом всей системы привилегий.

<LI>

Привилегия <code>FILE</code> может использоваться злонамеренно для считывания
любого доступного файла, хранящегося на сервере, или любого файла в каталоге
текущей базы данных в таблицу, к содержимому которой можно затем получить
доступ с помощью команды <code>SELECT</code>. 

<LI>

Привилегия <code>SHUTDOWN</code> может использоваться злонамеренно для полного
прекращения работы сервера и, таким образом, полного запрещения
обслуживания других пользователей.

<LI>

Привилегия <code>PROCESS</code> может быть использована для просмотра открытого
текста запросов выполняющихся в данный момент, включая запросы на
установку или изменение паролей.

<LI>

Привилегии доступа к базе данных <code>mysql</code> могут быть использованы для
изменения паролей и другой информации, относящейся к привилегиям
доступа. (Пароли хранятся в зашифрованном виде, поэтому злоумышленник
не сможет просто прочесть их, чтобы получить пароли в виде обычного
текста). Получив доступ к столбцу паролей <code>mysql.user</code>, любой
пользователь может войти на сервер MySQL под именем другого
пользователя (имея достаточные привилегии, тот же самый пользователь
может заменить пароль на другой).
</ul>

<P>
Есть вещи, которые система привилегий MySQL делать не может:

</P>

<ul>
<LI>

Нельзя явно указать, что данному пользователю должен быть закрыт
доступ. Т.е. вы не можете явно выбрать пользователя и затем отказать
ему в подключении.

<LI>

Нельзя указать, что некий пользователь имеет привилегии создавать или
удалять таблицы в базе данных, но не имеет привилегий создавать или
удалять саму базу данных.
</ul>



<H3><A NAME="Connecting" HREF="manual.ru_toc.html#Connecting">4.2.8  Соединение с сервером MySQL</A></H3>

<P>
<A NAME="IDX474"></A>
<A NAME="IDX475"></A>
<A NAME="IDX476"></A>
<A NAME="IDX477"></A>

</P>
<P>
Обычно для получения доступа к серверу MySQL необходимо сообщить
клиентской программе параметры подсоединения: указать хост, с которым вы
хотите соединиться, ваши имя пользователя и пароль. Например, клиент <code>mysql</code>
можно запустить следующим образом (необязательные аргументы заключены в
квадратные скобки <samp>`['</samp> и <samp>`]'</samp>):

</P>

<pre>
shell&#62; mysql [-h host_name] [-u user_name] [-pyour_pass]
</pre>

<P>
Альтернативной  формой  опций  <code>-h</code>, <code>-u</code>, и  <code>-p</code>  являются  <code>--host=host_name</code>,
<code>--user=user_name</code> и <code>--password=your_pass</code>. Заметим, что между <code>-p</code> или
<code>--password=</code> и следующим за ними паролем <em>пробела нет</em>.

</P>
<P>
<strong>Внимание</strong>: Указывать пароль в командной строке небезопасно! Любой
пользователь в вашей системе может впоследствии отыскать ваш пароль, введя
команду типа <code>ps auxww</code>. Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>.

</P>
<P>
В <code>mysql</code> используются следующие значения по умолчанию для параметров
подсоединения, пропущенных в командной строке:

</P>

<ul>
<LI>

Значением по умолчанию для имени хоста является <code>localhost</code>.

<LI>

Значением по умолчанию для имени пользователя является ваш
Unix-аккаунт.

<LI>

При отсутствии префикса <code>-p</code> никакого пароля не указывается.
</ul>

<P>
Таким образом, для Unix-пользователя <code>joe</code> следующие команды являются
эквивалентными:

</P>

<pre>
shell&#62; mysql -h localhost -u joe
shell&#62; mysql -h localhost
shell&#62; mysql -u joe
shell&#62; mysql
</pre>

<P>
Другие клиенты MySQL ведут себя подобным же образом.

</P>
<P>
В Unix-системах можно задавать различные значения по умолчанию, которые
будут использоваться при соединении с сервером, чтобы избавиться от
необходимости каждый раз при вызове клиентской программы вводить их в
командной строке. Это можно сделать двумя способами:

</P>

<ul>
<LI>

Параметры подсоединения можно задать в разделе <code>[client]</code> файла
конфигурации <tt>`my.cnf'</tt>, который находится в вашей домашней директории.
Соответствующий раздел этого файла может иметь следующий вид:


<pre>
[client]
host=host_name
user=user_name
password=your_pass
</pre>

Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>.
<LI>

<A NAME="IDX478"></A>
<A NAME="IDX479"></A>
<A NAME="IDX480"></A>
<A NAME="IDX481"></A>
<A NAME="IDX482"></A>
<A NAME="IDX483"></A>
Параметры соединения можно задавать через переменные окружения. Для
<code>mysql</code> можно задать хост при помощи <code>MYSQL_HOST</code>. Для задания имени
пользователя для MySQL можно использовать <code>USER</code> (это относится только к
ОС Windows). Пароль может быть задан с помощью <code>MYSQL_PWD</code> (но это
небезопасно, см. следующий раздел). Обратитесь к разделу See section <A HREF="manual.ru_Environment_variables.html#Environment_variables">F  Переменные окружения</A>.
</ul>



<H3><A NAME="Connection_access" HREF="manual.ru_toc.html#Connection_access">4.2.9  Управление доступом, этап 1: верификация подсоединения</A></H3>

<P>
<A NAME="IDX484"></A>
<A NAME="IDX485"></A>
<A NAME="IDX486"></A>
<A NAME="IDX487"></A>

</P>
<P>
При попытке соединения с сервером MySQL он либо устанавливает соединение,
либо отказывает в нем - на основе данных о вашей личности и того, можете
ли вы подтвердить их соответствующим паролем. Если нет, сервер полностью
отказывает вам в доступе. В противном случае сервер устанавливает
соединение, затем переходит ко второму этапу и ожидает запросов.

</P>
<P>
Личность задается двумя порциями информации:

</P>

<ul>
<LI>

хостом, с которого вы подсоединяетесь

<LI>

вашим именем пользователя MySQL
</ul>

<P>
Проверка личности осуществляется с помощью трех полей контекста таблицы
<code>user</code> (<code>Host</code>, <code>User</code> и <code>Password</code>). Сервер устанавливает соединение только в том
случае, если находит в таблице <code>user</code> запись, в которой имя хоста и имя
пользователя совпадают с введенными вами, и вы указываете правильный
пароль.

</P>
<P>
Значения в полях контекста таблицы <code>user</code> могут задаваться следующим
образом:

</P>

<ul>
<LI>

В поле <code>Host</code> может указываться имя хоста, либо его IP-адрес, либо
<code>'localhost'</code> для обозначения локального хоста.

<LI>

В поле Host разрешается использовать шаблонные символы <samp>`%'</samp> и <samp>`_'</samp>.

<LI>

Значение <code>'%'</code> в поле <code>Host</code> означает любое имя хоста.

<LI>

Пустое значение в поле <code>Host</code> означает, что к этой привилегии должна
быть добавлена запись в таблице <code>host</code>, совпадающая с заданным именем
хоста. Дополнительную информацию по данной теме вы найдете в следующем
разделе.

<A NAME="IDX488"></A>
<LI>

Начиная с версии MySQL 3.23 для значений в поле в поле <code>Host</code>,
определенных в виде IP-адресов, можно задавать сетевую маску,
указывающую, сколько разрядов адреса будет использоваться для указания
номера сети. Например:


<pre>
mysql&#62; GRANT ALL PRIVILEGES ON db.*
    -&#62; TO david'192.58.197.0/255.255.255.0';
</pre>

В этом случае все IP-адреса, для которых выполняется следующее условие:


<pre>
user_ip &#38; netmask = host_ip.
</pre>

являются разрешенными для подсоединения. В предыдущем примере все
IP-адреса в диапазоне от 192.58.197.0 до 192.58.197.255 являются
разрешенными для подсоединения к серверу MySQL.

<LI>

<A NAME="IDX489"></A>
В поле <code>User</code> запрещено использовать шаблонные символы, но пустое
значение разрешено, и оно соответствует любому имени. Если запись в
таблице <code>user</code>, соответствующая входящему подсоединению, содержит пустое
имя пользователя, данный пользователь считается анонимным
пользователем (пользователем без имени), а заданное клиентом имя
пользователя игнорируется. Это означает, что при всех последующих
проверках доступа, осуществляемых на протяжении данного соединения
(т.е. на этапе 2), будет использоваться пустое имя пользователя.

<LI>

Поле <code>Password</code> может быть пустым. Это не означает, что в данном случае
подходит любой пароль. Если поле пароля пусто, пользователь должен
быть подсоединен без указания какого либо пароля.
</ul>

<P>
<A NAME="IDX490"></A>
Непустые значения в поле <code>Password</code> представляют собой зашифрованные пароли.
В MySQL пароли не хранятся в виде открытого текста, который может
прочитать кто угодно. Напротив, пароль, который вводится пользователем при
попытке подсоединения, шифруется (с помощью функции <code>PASSWORD()</code>). В
дальнейшем зашифрованный пароль используется клиентом/сервером в процессе
проверки его правильности (это делается вообще без пересылки пароля во
время подсоединения). Заметим, что с MySQL считает зашифрованный пароль
РЕАЛЬНЫМ паролем, поэтому не следует допускать к нему кого бы то ни было!
В частности, не разрешайте обычным пользователям доступ для чтения к
таблицам в базе <code>mysql</code>!

</P>
<P>
Примеры, приведенные ниже, показывают, каким входящим подсоединениям
соответствуют различные комбинации значений, указанных в полях <code>Host</code> и <code>User</code>
таблицы  <code>user</code>:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Значение в поле</strong> <code>Host</code> </TD><TD> <strong>Значение в поле</strong> <code>User</code> </TD><TD> <strong>Подсоединения, которым соответствует запись</strong>
</TD></TR>
<TR><TD><code>'thomas.loc.gov'</code> </TD><TD> <code>'fred'</code> </TD><TD> <code>fred</code>, подключающийся  с <code>thomas.loc.gov</code>
</TD></TR>
<TR><TD><code>'thomas.loc.gov'</code> </TD><TD> <code>''</code> </TD><TD> Любой пользователь, подключающийся с <code>thomas.loc.gov</code>
</TD></TR>
<TR><TD><code>'%'</code> </TD><TD> <code>'fred'</code> </TD><TD> <code>fred</code>, подключающийся с любого хоста
</TD></TR>
<TR><TD><code>'%'</code> </TD><TD> <code>''</code> </TD><TD> Любой пользователь, подключающийся с любого хоста
</TD></TR>
<TR><TD><code>'%.loc.gov'</code> </TD><TD> <code>'fred'</code> </TD><TD> <code>fred</code>, подключающийся с любого хоста, принадлежащего домену <code>loc.gov</code>
</TD></TR>
<TR><TD><code>'x.y.%'</code> </TD><TD> <code>'fred'</code> </TD><TD> <code>fred</code>, подключающийся с <code>x.y.net</code>, <code>x.y.com</code>,<code>x.y.edu</code>, и т.д. (это, по-видимому, бесполезный вариант)
</TD></TR>
<TR><TD><code>'144.155.166.177'</code> </TD><TD> <code>'fred'</code> </TD><TD> <code>fred</code>, подключающийся с хоста, имеющего IP-адрес <code>144.155.166.177</code>
</TD></TR>
<TR><TD><code>'144.155.166.%'</code> </TD><TD> <code>'fred'</code> </TD><TD> <code>fred</code>, подключающийся с любого хоста в подсети <code>144.155.166</code> класса C
</TD></TR>
<TR><TD><code>'144.155.166.0/255.255.255.0'</code> </TD><TD> <code>'fred'</code> </TD><TD> То же самое, что и в предыдущем примере
</TD></TR>
</TABLE>

<P>
Поскольку в IP-адресе, указываемом в поле <code>Host</code>, могут использоваться
шаблонные символы (например <code>'144.155.166.%'</code> - данное значение
соответствует всем без исключения хостам указанной подсети), возникает
опасность, что кто-нибудь может попытаться воспользоваться этой
возможностью, указав имя хоста, например, как <code>144.155.166.somewhere.com</code>.
Чтобы ``поставить заслон'' таким попыткам, в MySQL не разрешены имена
хостов, начинающиеся с цифр и точки. Другими словами, имени хоста типа
<code>1.2.foo.com</code>, никогда не найдется соответствия в столбцах <code>Host</code> таблиц
привилегий. IP-адресу с шаблонными символами может соответствовать только
IP-адрес.

</P>
<P>
Входящее подсоединение может совпадать с несколькими записями в таблице
user. Например, как было показано выше, подсоединению с <code>thomas.loc.gov by</code> 
<code>fred</code> могут подходить разные записи. Каким образом сервер определяет, какую
из записей использовать, при совпадении с более чем одной из них? Для
этого после считывания таблицы <code>user</code> во время запуска сервер производит ее
сортировку, а затем, когда пользователь пытается установить соединение,
записи таблицы просматриваются в порядке их упорядочения,. Используется
первая подошедшая запись.

</P>
<P>
Сортировка таблицы user осуществляется следующим образом. Предположим,
таблица <code>user</code> имеет следующий вид:

</P>

<pre>
+-----------+----------+-
| Host      | User     | ...
+-----------+----------+-
| %         | root     | ...
| %         | jeffrey  | ...
| localhost | root     | ...
| localhost |          | ...
+-----------+----------+-
</pre>

<P>
При считывании этой таблицы сервер упорядочивает записи, начиная с
наиболее конкретных значений в столбце <code>Host</code> (<code>'%'</code> в столбце <code>Host</code> означает
``любой хост'' и является наименее конкретным). Записи с одинаковым
значением в столбце <code>Host</code> упорядочиваются между собой начиная с наиболее
конкретных значений в столбце <code>User</code> (пустое значение в столбце <code>User</code>
означает ``любой пользователь'' и является наименее конкретным).
Окончательно отсортированная таблица <code>user</code> имеет следующий вид:

</P>

<pre>
+-----------+----------+-
| Host      | User     | ...
+-----------+----------+-
| localhost | root     | ...
| localhost |          | ...
| %         | jeffrey  | ...
| %         | root     | ...
+-----------+----------+-
</pre>

<P>
<A NAME="IDX491"></A>
<A NAME="IDX492"></A>
<A NAME="IDX493"></A>

</P>
<P>
При попытке подсоединения сервер просматривает отсортированные записи и
использует первую подходящую запись. Для подсоединения с <code>localhost</code>
пользователя  <code>jeffrey</code> первыми подходящими записями являются записи со
значением <code>'localhost'</code> в столбце <code>Host</code>. Из них запись с пустым значением
имени пользователя соответствует и имени подсоединяющегося хоста и имени
пользователя. (запись <code>'%'/'jeffrey'</code> тоже подошла бы, но она -- не первая
подходящая в этой таблице).

</P>
<P>
Рассмотрим другой пример. Пусть таблица <code>user</code> имеет вид:

</P>

<pre>
+----------------+----------+-
| Host           | User     | ...
+----------------+----------+-
| %              | jeffrey  | ...
| thomas.loc.gov |          | ...
+----------------+----------+-
</pre>

<P>
Отсортированная таблица выглядит следующим образом:

</P>

<pre>
+----------------+----------+-
| Host           | User     | ...
+----------------+----------+-
| thomas.loc.gov |          | ...
| %              | jeffrey  | ...
+----------------+----------+-
</pre>

<P>
Для подсоединения пользователя <code>jeffrey</code> с <code>thomas.loc.gov</code> подходит первая
запись, в то время как для подсоединения <code>jeffrey</code> с <code>whitehouse.gov</code> -
вторая.

</P>
<P>
Существует распространенное заблуждение: иногда думают, что при поиске
записей для данного имени пользователя, соответствующих определенному
подсоединению, сервер первыми будет использовать записи, в которых этот
пользователь указан явно. Это абсолютно неверно, как и продемонстрировано
в предыдущем примере: для подсоединения пользователя <code>jeffrey</code> с
<code>thomas.loc.gov</code> первой подходящей записью является не запись, содержащая
значение <code>'jeffrey'</code> в поле <code>User</code>, а запись, не содержащая имени пользователя
вовсе!

</P>
<P>
Если у вас возникают проблемы с подсоединением к серверу, выведите
таблицу <code>user</code> и отсортируйте ее вручную, чтобы увидеть, где
происходит первое совпадение.

</P>
<P>
Если соединение было успешно, но ваши привилегии - не те, что вы ожидали
увижеть, вы можете использовать функцию <code>CURRENT_USER()</code> (новшество с
MySQL 4.0.6) чтобы узнать, какой комбинации пользователь/компьютер ваше
соединение соответствует. See section <A HREF="manual.ru_Reference.html#Miscellaneous_functions">6.3.6.2  Разные функции</A>.

</P>


<H3><A NAME="Request_access" HREF="manual.ru_toc.html#Request_access">4.2.10  Управление доступом, этап 2: верификация запросов</A></H3>

<P>
После установления соединения сервер приступает к выполнению второго
этапа. Для каждого поступающего запроса сервер проверяет, имеется ли у вас
достаточно привилегий для его выполнения, основываясь при этом на типе
операции, которую вы хотите выполнить. Теперь в действие вступают поля
привилегий в таблицах привилегий. Информация о привилегиях может
находиться в любой из таблиц привилегий - <code>user</code>, <code>db</code>, <code>host</code>, <code>tables_priv</code> или
<code>columns_priv</code>. Обработка таблиц привилегий осуществляется с помощью команд
<code>GRANT</code> и <code>REVOKE</code>. Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#GRANT">4.3.1  Синтаксис команд <code>GRANT</code> и <code>REVOKE</code></A>. Интерес
может представлять раздел See section <A HREF="manual.ru_MySQL_Database_Administration.html#Privileges">4.2.6  Как работает система привилегий</A>, в котором перечислены поля, имеющиеся в каждой из
таблиц привилегий.

</P>
<P>
Таблица <code>user</code> предоставляет привилегии глобального характера, и их
применение не зависит от того, в какой базе вы работаете в данный момент.
Например, если таблица <code>user</code> предоставляет пользователю привилегию <code>DELETE</code>,
он может удалять строки из любой базы данных на серверном хосте! Иными
словами, привилегии в таблице <code>user</code> - это привилегии суперпользователя.
Поэтому целесообразно предоставлять привилегии в таблице <code>user</code> только
суперпользователям, таким как администраторы сервера или администраторы
баз данных. Что касается других пользователей, для их привилегий в таблице
user следует установить значение <code>'N'</code> и предоставлять им привилегии только
на уровне баз данных, используя для этого таблицы <code>db</code> и <code>host</code>.

</P>
<P>
<A NAME="IDX494"></A>
<A NAME="IDX495"></A>
<A NAME="IDX496"></A>

</P>
<P>
Таблицы <code>db</code> и <code>host</code> предоставляют привилегии на уровне базы данных. Значения
в полях контекста могут задаваться следующим образом:

</P>

<ul>
<LI>

Шаблонные символы <samp>`%'</samp> и <samp>`_'</samp> могут использоваться в полях <code>Host</code>
и <code>Db</code> любой таблицы. Если вы хотите использовать символ <samp>`_'</samp> как
часть имени базы данных, укажите его как <samp>`\_'</samp> в операторе <code>GRANT</code>. 

<LI>

Значение <code>'%'</code> в колонке <code>Host</code> таблицы <code>db</code> означает ``любой хост''. Пустое
значение в поле <code>Host</code> таблицы <code>db</code> означает ``за дополнительной
информацией следует обратиться к таблице <code>host</code>''.

<LI>

Значение <code>'%'</code> или пустое значение в поле <code>Host</code> таблицы <code>host</code> означает
``любой хост''.

<LI>

Значение <code>'%'</code> или пустое значение в поле <code>Db</code> любой из таблиц означает
``любая база данных''.

<LI>

Пустое значение в поле <code>User</code> любой из таблиц соответствует анонимному
пользователю.
</ul>

<P>
<A NAME="IDX497"></A>
<A NAME="IDX498"></A>
<A NAME="IDX499"></A>
<A NAME="IDX500"></A>
Таблицы <code>db</code> и <code>host</code> считываются и сортируются при запуске сервера (тогда же,
когда он считывает таблицу <code>user</code>). Таблица <code>db</code> сортируется по полям
контекста <code>Host</code>, <code>Db</code> и <code>User</code>, а таблица <code>host</code> - по полям контекста <code>Host</code> и <code>Db</code>.
Как и в случае таблицы <code>user</code>, при сортировке первыми отбираются наиболее
конкретные значения, а последними - наименее конкретные, а когда сервер
производит поиск совпадающих записей, используется первая совпадающая
запись, которую он находит.

</P>
<P>
<A NAME="IDX501"></A>
<A NAME="IDX502"></A>
Таблицы <code>tables_priv</code> и <code>columns_priv</code> предоставляют привилегии соответственно
на уровне таблиц и столбцов. Значения в полях контекста задаются следующим
образом:

</P>

<ul>
<LI>

В обеих таблицах в поле <code>Host</code> можно использовать шаблонные символы <samp>`%'</samp>
и <samp>`_'</samp>.

<LI>

В обеих таблицах <code>'%'</code> или пустое значение в поле <code>Host</code> означает ``любой
хост''.

В обеих таблицах в полях <code>Db</code>, <code>Table_name</code> и <code>Column_name</code> запрещено
использовать шаблонные символы или пустое значение.
</ul>

<P>
<code>Таблицы_priv</code> и <code>columns_priv</code> сортируются по полям <code>Host</code>, <code>Db</code> и <code>User</code>. Эта
сортировка проводится так же, как и в таблице <code>db</code>, хотя в данном случае
задача несколько упрощается, т.к. шаблонные символы могут встретиться
только в поле <code>Host</code>.

</P>
<P>
Ниже описывается процесс верификации запроса. (Если вы хорошо знакомы с
исходным кодом проверки доступа, то заметите некоторые отличия:
приведенное здесь описание несколько упрощено, чтобы сделать его более
понятным, однако оно соответствует тому, что в действительности делает
код).

</P>
<P>
Для запросов на администрирование (<code>SHUTDOWN</code>, <code>RELOAD</code>, etc.) сервер
проверяет запись только в таблице <code>user</code>, т.к. это единственная таблица,
которая определяет привилегии администрирования. Доступ предоставляется
при условии, что выбранная запись разрешает затребованные операции, и
запрещается в противном случае. Например, вы хотите завершить работу <code>mysql</code>
с помощью <code>mysqladmin shutdown</code>, но ваша запись в таблице <code>user</code> не
предоставляет вам привилегию <code>SHUTDOWN</code>. В этом случае в доступе будет
отказано без дальнейшей проверки таблицы <code>db</code> и <code>host</code> (поскольку в них
отсутствует столбец <code>Shutdown_priv</code>, в такой проверке нет необходимости).

</P>
<P>
В случае запросов, относящихся к базам данных (<code>INSERT</code>, <code>UPDATE</code> и т.д.),
сервер сначала проверяет глобальные привилегии пользователя (привилегии
суперпользователя), просматривая запись в таблице <code>user</code>. Если эта запись
разрешает затребованную операцию, доступ предоставляется. Если глобальные
привилегии, указанные в таблице <code>user</code>, недостаточны, сервер проверяет
таблицы <code>db</code> и <code>host</code> и определяет привилегии пользователя на уровне баз
данных:

</P>

<ol>
<LI>

Сервер просматривает таблицу <code>db</code> в поисках записи с подходящими
значениями в полях <code>Host</code>, <code>Db</code> и <code>User</code>. Поля <code>Host</code> и <code>User</code> сравниваются с
именем подключающегося хоста и именем пользователя MySQL. Поле <code>Db</code>
сравнивается с именем базы данных, к которой пользователь хочет
получить доступ. Если запись с подходящими значениями в полях <code>Host</code> и
<code>User</code> отсутствует, в доступе будет отказано.

<LI>

Если же в таблице <code>db</code> имеется подходящая запись и значение в поле <code>Host</code>
- не пустое, эта запись определяет привилегии пользователя, касающиеся
базы данных.

<LI>

Если же в подходящей записи, выбранной в таблице <code>db</code>, значение в поле
Host пустое, это означает, что перечень хостов, которым разрешен
доступ к требуемой базе данных, приведен в таблице <code>host</code>. В этом случае
дальнейший поиск производится в таблице <code>host</code>, где ищется запись с
подходящими значениями в полях <code>Host</code> и <code>Db</code>. Если ни одной подходящей
записи в таблице <code>host</code> нет, в доступе будет отказано. Если такая запись
имеется, привилегии пользователя на уровне базы данных вычисляются
путем логического умножения (не логического сложения!) привилегий,
найденных в записях, которые выбраны в таблицах <code>db</code> и <code>host</code>. Другими
словами, пользователю назначаются те привилегии, для которых в обеих
записях установлено значение <code>'Y'</code>. (Этот способ можно использовать
следующим образом: предоставить всеобщие привилегии в записи,
хранящейся в таблице <code>db</code>, а затем выборочно ограничить их отдельно по
каждому хосту, используя для этого записи в таблице <code>host</code>.)
</ol>

<P>
Определив привилегии на уровне базы данных, предоставляемые записями в
таблицах <code>db</code> и <code>host</code>, сервер добавляет их к глобальным привилегиям, заданным
в таблице <code>user</code>. Если в результате привилегий оказывается достаточно для
выполнения затребованной операции, доступ предоставляется. В противном
случае сервер проверяет по таблицам <code>tables_priv</code> и <code>columns_priv</code> привилегии
пользователя на уровне таблиц и столбцов и добавляет их к уже имеющимся
привилегиям. В зависимости от полученного результата доступ либо
предоставляется, либо нет.

</P>
<P>
Если приведенное выше описание вычислений привилегий пользователя
перевести на язык алгебры логики, используя логические операторы, то в
результате получится примерно следующее:

</P>

<pre>
global privileges
OR (database privileges AND host privileges)
OR table privileges
OR column privileges
</pre>

<P>
Сам по себе алгоритм определения привилегий на первый взгляд может
показаться неочевидным. И в самом деле, если первоначально глобальных
привилегий, определяемых таблицей <code>user</code>, оказывается недостаточно для
выполнения затребованной операции, то зачем впоследствии эти вроде бы
бесполезные привилегии добавляются к привилегиям на уровне баз данных,
таблиц и столбцов? Смысл такого добавления заключается в том, что для
выполнения запроса может потребоваться не один, а несколько типов
привилегий. Например, для выполнения оператора <code>INSERT ... SELECT</code> вам
потребуется как привилегия <code>INSERT</code>, так и привилегия <code>SELECT</code>. Ваши
привилегии могут быть таковы, что запись в таблице user предоставляет вам
одну привилегию, а запись в таблице <code>db</code> - другую. Другими словами,
привилегии, необходимые для выполнения запроса, у вас есть, но сервер не
может выяснить при просмотре каждой таблицы в отдельности, и поэтому
привилегии, предоставляемые записями из обеих таблиц, должны быть
объединены.

</P>
<P>
<A NAME="IDX503"></A>
<A NAME="IDX504"></A>

</P>
<P>
Таблицу <code>host</code> можно использовать еще для одной цели - для поддержки списка
надежных серверов.

</P>
<P>
В таблицах на TcX <code>host</code> содержит список всех машин локальной сети. Им
предоставляются все привилегии.

</P>
<P>
Таблицу <code>host</code> можно также использовать для регистрации хостов, которые
являются <strong>ненадежными</strong>. Предположим, одна из ваших машин -
<code>public.your.domain</code> находится в общедоступной области, которую вы считаете
незащищенной. В таком случае можно разрешить доступ всем хостам вашей
сети, за исключением одной ``неблагонадежной'' машины, используя записи в
таблице <code>host</code>, подобные приведенным ниже:

</P>

<pre>
+--------------------+----+-
| Host               | Db | ...
+--------------------+----+-
| public.your.domain | %  | ... (для всех привилегий установлено значение 'N')
| %.your.domain      | %  | ... (для всех привилегий установлено значение 'Y')
+--------------------+----+-
</pre>

<P>
<A NAME="IDX505"></A>
<A NAME="IDX506"></A>
<A NAME="IDX507"></A>
<A NAME="IDX508"></A>
<A NAME="IDX509"></A>

</P>
<P>
Естественно, всегда нужно протестировать записи в таблицах привилегий
(например, с помощью <code>mysqlaccess</code>), чтобы убедиться в том, что привилегии
доступа установлены вами действительно так, как задумано.

</P>


<H3><A NAME="Access_denied" HREF="manual.ru_toc.html#Access_denied">4.2.11  Причины появления ошибок <code>Access denied</code> ("в доступе отказано")</A></H3>

<P>
Если при попытке подсоединения к серверу MySQL вы сталкиваетесь с ошибкой
<code>Access denied</code>, то воспользуйтесь приведенным ниже списком. В нем
перечислены меры, которые можно принять для решения этой проблемы:

</P>

<ul>
<LI>

Запускали ли вы после инсталляции MySQL скрипт <code>mysql_install_db</code> для
установки начального содержимого таблиц привилегий? Если нет, сделайте
это. Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Default_privileges">4.3.4  Задание изначальных привилегий MySQL</A>.
Проверьте первоначальные привилегии с помощью следующей команды:


<pre>
shell&#62; mysql -u root test
</pre>

Подсоединение должно произойти без сбоя. Следует также убедиться, что в
каталоге базы данных MySQL имеется файл <tt>`user.MYD'</tt>. Обычно он находится в
директории <tt>`PATH/var/mysql/user.MYD'</tt>, где <code>PATH</code> - путь к корневому каталогу
инсталляции MySQL.

<LI>

После новой инсталляции следует подсоединиться к серверу и создать
пользователей, а также установить для них права доступа:


<pre>
shell&#62; mysql -u root mysql
</pre>

Сервер разрешит подсоединение, т.к. пользователь MySQL с именем
пользователя <code>root</code> исходно не имеет пароля. Но в этом заключается также и
риск нарушения безопасности системы, поэтому при создании остальных
пользователей MySQL, вам, помимо прочего, следует задать пароль для
пользователя <code>root</code>. Если при попытке подсоединения от имени пользователя
root вы получите следующую ошибку:


<pre>
Access denied for user: '@unknown' to database mysql
</pre>

это означает, что в таблице <code>user</code> отсутствует запись со значением <code>'root'</code> в
столбце <code>User</code> и <code>mysqld</code> не может определить имя хоста для вашего клиента. В
этом случае необходимо перезапустить сервер с опцией <code>--skip-grant-tables</code> и
отредактировать файл <tt>`/etc/hosts'</tt> или <tt>`\windows\hosts'</tt>, добавив в него запись
для вашего хоста.

<LI>

Если вы столкнетесь с такой ошибкой, как:


<pre>
shell&#62; mysqladmin -u root -pxxxx ver
Access denied for user: 'root@localhost' (Using password: YES)
</pre>

это означает, что используется неверный пароль. Обратитесь к разделу
See section <A HREF="manual.ru_MySQL_Database_Administration.html#Passwords">4.3.7  Задание паролей</A>. Если вы забыли пароль для пользователя <code>root</code>, то
перезапустите <code>mysqld</code> с опцией <code>--skip-grant-tables</code> и измените пароль.
Обратитесь к разделу See section <A HREF="manual.ru_Problems.html#Resetting_permissions">A.4.2  Как переустановить забытый пароль пользователя <code>root</code></A>. Такая
ошибка может появляться даже в том случае, если вы не задавали пароля
вообще - это значит, что в каком-то файле <tt>`my.ini'</tt> имеется неверный пароль.
Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>. Отменить использование файлов
опций можно с помощью опции the <code>--no-defaults</code>, как показано ниже:


<pre>
shell&#62; mysqladmin --no-defaults -u root ver
</pre>

<LI>

<A NAME="IDX510"></A>
Запускали ли вы скрипт <code>mysql_fix_privilege_tables</code> при обновлении
имеющейся инсталляции MySQL, если установленная версия - более ранняя,
чем 3.22.11, а обновляется она до 3.22.11 или более поздней? Если нет,
сделайте это. Начиная с MySQL 3.22.11, когда оператор <code>GRANT</code> стал
функциональным, структура таблиц привилегий изменилась.

<LI>

Если во время сеанса ваши привилегии изменились, то, возможно, их
изменил суперпользователь. Перезагрузка таблиц привилегий отражается
не только на новых подсоединениях клиентов, но также на уже имеющихся,
как это показано в разделе See section <A HREF="manual.ru_MySQL_Database_Administration.html#Privilege_changes">4.3.3  Когда изменения в привилегиях вступают в силу</A>.

<LI>

Если не удается добиться, чтобы пароль работал, помните, что функция
<code>PASSWORD()</code> должна использоваться, если вы задаете пароль с помощью
операторов <code>INSERT</code>, <code>UPDATE</code> или <code>SET PASSWORD</code>. Если же вы задаете пароль
с помощью оператора <code>GRANT ... INDENTIFIED BY</code> или команды <code>mysqladmin
password</code>, функция <code>PASSWORD()</code> не нужна. Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Passwords">4.3.7  Задание паролей</A>.

<LI>

<code>localhost</code> - это синоним имени вашего локального хоста, и, если хост
явно не задан, также устанавливаемое по умолчанию имя хоста, к
которому клиенты пытаются подключиться. Однако подсоединения к
<code>localhost</code> не действуют, если в вашей рабочей системе используются
MIT-потоки и MySQL старше версии 3.23.27 (подсоединения к <code>localhost</code>
осуществляются с использованием сокетов Unix, а они не поддерживались тогда
технологией MIT-потоков). Чтобы в таких системах эта проблема не возникала,
следует явным образом задать имя серверного хоста с помощью опции
<code>--host</code>. Таким образом будет установлено подсоединение к серверу
<code>mysqld</code> по протоколу TCP/IP.  В этом случае в записях таблицы
<code>user</code>, хранящейся на серверном хосте, должно быть указано реальное имя
хоста. (Это справедливо даже для тех случаев, когда клиентская программа и
сервер запускаются на одном хосте).

<LI>

Если при попытке подсоединения к базе данных с помощью команды <code>mysql
-u user_name db_name</code> возникает ошибка <code>Access denied</code>, причина этого,
возможно, кроется в таблице <code>user</code>. Чтобы проверить это, выполните
команду <code>mysql -u root mysql</code> и введите следующий SQL-оператор:


<pre>
mysql&#62; SELECT * FROM user;
</pre>

В результате будет выведена запись со столбцами <code>Host</code> и <code>User</code>,
соответствующими имени вашего компьютера и вашему имени пользователя
MySQL.

<LI>

Сообщение об ошибке <code>Access denied</code> информирует вас о том, под каким
именем вы пытаетесь войти в систему, об имени хоста, с которого вы
пытаетесь установить соединение, и о том, использовали ли вы при этом
пароль или нет. Как правило, в таблице <code>user</code> будет одна запись, точно
соответствующая имени хоста и имени пользователя, указанным в
сообщении об ошибке. Например, если вы получите сообщение об ошибке, в
котором сказано <code>Using password: NO</code>, это означает, что вы пытались
войти в систему, не указав пароль.

<LI>

Если при попытке подсоединения не с того компьютера, на котором
работает сервер MySQL, а с другого, вы получите сообщение об ошибке,
приведенное ниже, то в таблице <code>user</code> отсутствует строка с таким именем
хоста:


<pre>
Host ... is not allowed to connect to this MySQL server
</pre>

Чтобы исправить эту ошибку, с помощью утилиты командной строки <code>mysql</code> (на
серверном хосте!) добавьте строку в таблицу <code>user</code>, <code>db</code> или <code>host</code> с
комбинацией имени пользователя/хоста, соответствующей той, которую вы
используете при попытке подсоединения. Затем выполните команду <code>mysqladmin
flush-privileges</code>. Если вы используете MySQL версии, отличной от Version
3.22, и вам неизвестно имя хоста или IP-адрес компьютера, с которого вы
подсоединяетесь, введите в таблицу user запись со значением <code>'%'</code> в поле
<code>Host</code> и перезапустите <code>mysqld</code> на серверной машине с опцией <code>--log</code>. Когда
соединение с клиентской машины будет установлено, вы найдете в журнале
регистрации MySQL информацию об имени хоста, с которого вы подсоединились.
(После этого следует заменить в записи таблицы <code>user</code> значение <code>'%'</code> настоящим
именем хоста, из журнала регистрации. Иначе ваша система останется
незащищенной.)

В Linux причиной такой ошибки может быть то, что бинарная
версия MySQL скомпилирована с версией glibc, отличной от используемой
вами. В этом случае нужно будет либо обновить ОС/glibc, используемые вами,
либо загрузить исходный код MySQL и скомпилировать сервер самостоятельно.
Как правило, исходный RPM компилируется и инсталлируется элементарно, так
что это не составит серьезной проблемы.

<LI>

Если будет выдано сообщение об ошибке, в котором имя хоста не указано
вообще или указан IP-адрес, хотя вы при попытке подсоединения
указывали имя хоста:


<pre>
shell&#62; mysqladmin -u root -pxxxx -h some-hostname ver
Access denied for user: 'root' (Using password: YES)
</pre>

то это означает, что ошибка возникает при попытке MySQL сопоставить
IP-адрес с именем хоста. В этом случае вы можете выполнить команду
<code>mysqladmin flush-hosts</code>, чтобы сбросить внутреннюю кэш-память DNS.
Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Optimisation.html#DNS">5.5.5  Как MySQL использует DNS</A>. Вот некоторые способы решения
этой проблемы:


<ul>
<LI>Попробуйте выяснить, что не так с вашим сервером DNS, и устраните

неисправность.

<LI>Задайте IP-адреса вместо имен хостов таблицах привилегий MySQL.

<LI>Запустите <code>mysqld</code> с опцией <code>--skip-name-resolve</code>.

<LI>Запустите <code>mysqld</code> с опцией <code>--skip-host-cache</code>.

<LI>Подключитесь к <code>localhost</code> если ваш сервер и клиент работают на одном

и том же компьютере.

<LI>Поместите имена клиентских машин в каталог <tt>`/etc/hosts'</tt>.

</ul>

<LI>

Если команда <code>mysql -u root test</code> работает успешно, а команда <code>mysql -h
your_hostname -u root tes</code>t приводит к ошибке <code>Access denied</code>, то,
возможно, в таблице <code>user</code> имя вашего хоста указано неверно. Одна из
распространенных проблем здесь заключается в том, что в поле <code>Host</code>
записи, хранящейся в таблице <code>user</code>, задается только имя хоста, в то
время как процедуры разрешения имен, используемые вашей системой,
возвращают полностью определенное доменное имя (или наоборот).
Например, если в таблице user имеется запись со значением <code>'tcx'</code> в поле
<code>host</code>, а DNS при этом сообщает MySQL, что имя хоста - <code>'tcx.subnet.se'</code>,
эта запись действовать не будет. Попробуйте добавить в таблицу <code>user</code>
запись, указав в колонке <code>Host</code> IP-адрес хоста. (В качестве альтернативы
можно добавить в таблицу <code>user</code> запись со значением в поле <code>Host</code>,
содержащим шаблонный символ, например <code>'tcx.%'</code>. Но использовать имена
хостов, оканчивающиеся на <code>'%'</code> - небезопасно  и делать это не
рекомендуется!)

<LI>

Если команда <code>mysql -u user_name test</code> работает успешно, а команда <code>mysql
-u user_name other_db_nam</code>e - нет, то в таблице <code>db</code> нет записи,
соответствующей <code>other_db_name</code>.

<LI>

Если команда <code>mysql -u user_name db_name</code> выполняется успешно на том
компьютере, где установлен сервер, а <code>mysql -u host_name -u user_name
db_name</code> не работает при выполнении ее на другой клиентской машине, то
в таблицах <code>user</code> или <code>db</code> эта клиентская машина не зарегистрирована.

<LI>

Если не удается выяснить причину ошибки <code>Access denied</code>, удалите из
таблицы <code>user</code> все записи, в которых значение в поле <code>Host</code> включает
шаблонные символы (записи, содержащие символы <samp>`'%''</samp> или <samp>`'_''</samp>). Очень
распространенной ошибкой является следующая: пользователь вставляет
новую запись со значением <code>'%'</code> в поле <code>Host</code> и со значением <code>'some user'</code> -
в поле <code>User</code>, полагая, что после этого для подсоединения с той же самой
машины он сможет использовать <code>localhost</code>. Такой расчет неверен, и
причина здесь в том, что устанавливаемые по умолчанию привилегии
включают запись со значением <code>'localhost'</code> в поле <code>Host</code> и пустым полем
<code>User</code>. И поскольку в этой записи значение <code>'localhost'</code> более конкретно,
чем <code>'%',</code> то именно она при подсоединении с <code>localhost</code> предшествует
новой записи и, соответственно, будет выбрана и сработает! Правильным
в этом случае будет вставить вторую запись со значением <code>'localhost'</code> в
поле <code>Host</code> и значением <code>'some_user'</code> - в поле <code>User</code> или удалить запись со
значением <code>'localhost'</code> в поле <code>Host</code> и пустым полем <code>User</code>.

<LI>

Если вы получите следующую ошибку, то эта проблема, возможно, связана
с таблицей <code>db</code> или таблицей <code>host</code>:


<pre>
Access to database denied
</pre>

Если в записи, выбранной из таблицы <code>db</code>, столбец <code>Host</code> - пустой,
удостоверьтесь, что в таблице <code>host</code> имеется по крайней мере одна
соответствующая запись, указывающая, к каким хостам относится запись из
таблицы <code>db</code>. Если ошибка возникает при выполнении SQL-команды <code>SELECT ...
INTO OUTFILE</code> или <code>LOAD DATA INFILE</code>, то в вашей записи из таблицы <code>user</code>,
вероятно, отсутствует разрешение на предоставление привилегии <code>FILE</code>.

<A NAME="IDX511"></A>
<A NAME="IDX512"></A>
<A NAME="IDX513"></A>

<LI>

Помните, что клиентские программы будут использовать параметры
подсоединения, указанные файлах конфигурации или переменных окружения.
Обратитесь к разделу See section <A HREF="manual.ru_Environment_variables.html#Environment_variables">F  Переменные окружения</A>. Если есть подозрение, что
клиент отсылает неверные устанавливаемые по умолчанию параметры
подсоединения, в случае, когда вы не задаете их в командной строке,
проверьте ваше окружение и файл <tt>`my.cnf'</tt> в своей домашней директории.
Можете также проверить конфигурационные файлы MySQL относящиеся ко все
системе, хотя параметры клиентского подсоединения вряд ли указаны
именно здесь. Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>. Если ошибка <code>Access denied</code> возникает при
выполнении вашей клиентской программы без каких-либо опций, убедитесь,
что ни в одном из ваших файлов опций не указан старый пароль!
Обратитесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>.

<LI>

Если вы вносите изменения в таблицы привилегий непосредственно (с
помощью операторов <code>INSERT</code> или <code>UPDATE</code>), а ваши изменения, похоже,
игнорируются, то следует выдать оператор <code>FLUSH PRIVILEGES</code> или
выполнить команду <code>mysqladmin flush-privileges</code> - для того, чтобы
заставить сервер перечитать таблицы привилегий. В противном случае
ваши изменения вступят в силу лишь при последующем перезапуске
сервера. Помните, что после того, как вы зададите пароль от имени
пользователя, вам нужно будет указывать его только после сброса
привилегий, т.к. серверу еще не будет известно о том, что вы изменили
пароль!

<LI>

При возникновении проблемы с доступом при использовании Perl-, PHP-,
Python- или ODBC-программ, попробуйте установить соединение с сервером
при помощи команды <code>mysql -u user_name db_name</code> или команды <code>mysql -u
user_name -pyour_pass db_name</code>. Если ваш клиент <code>mysql</code> обеспечивает
подсоединение, то проблема связана не с привилегиями доступа, а с
вашей программой. (Заметим, что между <code>-p</code> и паролем пробела нет; для
задания пароля можно также использовать синтаксическую структуру
<code>--password=your_pass</code>. Если вы используете только саму опцию <code>-p</code>, MySQL
запросит у вас пароль)

<LI>

При тестировании запускайте демон <code>mysqld</code> с опцией <code>--skip-grant-tables</code>.
Тогда вы сможете изменять таблицы привилегий MySQL и с помощью скрипта
<code>mysqlaccess</code> проверять, произвели ли сделанные вами изменения желаемый
эффект. Если результаты вас устраивают, выполните команду <code>mysqladmin
flush-privileges</code>, чтобы приказать серверу <code>mysqld</code> приступить к
использованию новых таблиц привилегий. <strong>Внимание</strong>: перезагрузка таблиц
привилегий отменяет опцию <code>--skip-grant-tables</code>. Это позволяет заставить
сервер приступить к использованию новых таблиц привилегий без
завершения его работы и перезагрузки.

<LI>

Если ничего не помогает, запустите демон <code>mysqld</code> daemon с опцией
отладки (например <code>--debug=d,general,query</code>). В результате будет
выведена информация о неудачных подсоединениях, с указанием хоста и
пользователя, а также обо всех обработанных командах. Обратитесь к
разделу See section <A HREF="manual.ru_Porting.html#Making_trace_files">E.1.2  Создание трассировочных файлов</A>.

<LI>

Если у вас имеется какая-либо проблема с таблицами привилегий MySQL и
вы полагаете, что необходимо сообщить о ней в список рассылки, нужно
обязательно приложить к своему отчету распечатку таблиц привилегий
MySQL. Это можно сделать с помощью команды <code>mysqldump mysql</code>. Отчет о
проблеме, как и в других случаях, отправляется с помощью скрипта
<code>mysqlbug</code>. Обратитесь к разделу See section <A HREF="manual.ru_Introduction.html#Bug_reports">1.8.1.3  Как отправлять отчеты об ошибках или проблемах</A>. В некоторых случаях для выполнения скрипта <code>mysqldump</code> возможно,
потребуется перезапустить <code>mysqld</code> с опцией <code>--skip-grant-tables</code>.
</ul>



<H2><A NAME="User_Account_Management" HREF="manual.ru_toc.html#User_Account_Management">4.3  Управление учетными записями пользователей MySQL</A></H2>



<H3><A NAME="GRANT" HREF="manual.ru_toc.html#GRANT">4.3.1  Синтаксис команд <code>GRANT</code> и <code>REVOKE</code></A></H3>

<P>
<A NAME="IDX514"></A>
<A NAME="IDX515"></A>

</P>
<P>
<A NAME="IDX516"></A>
<A NAME="IDX517"></A>
<A NAME="IDX518"></A>
<A NAME="IDX519"></A>
<A NAME="IDX520"></A>

</P>

<pre>
GRANT priv_type [(column_list)] [, priv_type [(column_list)] ...]
    ON {tbl_name | * | *.* | db_name.*}
    TO user_name [IDENTIFIED BY [PASSWORD] 'password']
        [, user_name [IDENTIFIED BY 'password'] ...]
    [REQUIRE
	NONE |
        [{SSL| X509}]
        [CIPHER cipher [AND]]
        [ISSUER issuer [AND]]
        [SUBJECT subject]]
    [WITH [GRANT OPTION | MAX_QUERIES_PER_HOUR # |
                          MAX_UPDATES_PER_HOUR # |
                          MAX_CONNECTIONS_PER_HOUR #]]

REVOKE priv_type [(column_list)] [, priv_type [(column_list)] ...]
    ON {tbl_name | * | *.* | db_name.*}
    FROM user_name [, user_name ...]
</pre>

<P>
<code>GRANT</code> включен в MySQL начиная с версии 3.22.11 и выше. В более ранних
версиях MySQL оператор <code>GRANT</code> ничего не выполняет.

</P>
<P>
Команды <code>GRANT</code> и <code>REVOKE</code> позволяют системным администраторам создавать
пользователей MySQL, а также предоставлять права пользователям или лишать
их прав на четырех уровнях привилегий:

</P>
<DL COMPACT>

<DT><strong>Глобальный уровень</strong>
<DD>
Глобальные привилегии применяются ко всем базам данных на указанном
сервере. Эти привилегии хранятся в таблице <code>mysql.user</code>.

<DT><strong>Уровень базы данных</strong>
<DD>
Привилегии базы данных применяются ко всем таблицам указанной базы данных.
Эти привилегии хранятся в таблицах <code>mysql.db</code> и <code>mysql.host</code>.

<DT><strong>Уровень таблицы</strong>
<DD>
Привилегии таблицы применяются ко всем столбцам указанной таблицы. Эти
привилегии хранятся в таблице <code>mysql.tables_priv</code>.

<DT><strong>Уровень столбца</strong>
<DD>
Привилегии столбца применяются к отдельным столбцам указанной таблицы. Эти
привилегии хранятся в таблице <code>mysql.columns_priv</code>.
</DL>

<P>
Если привилегии предоставляются пользователю, которого не существует, то
этот пользователь создается. Чтобы просмотреть примеры работы команды
<code>GRANT</code>, см. раздел section <A HREF="manual.ru_MySQL_Database_Administration.html#Adding_users">4.3.5  Добавление новых пользователей в MySQL</A>.

</P>
<P>
В таблице приведен список возможных значений параметра <code>priv_type</code> для
операторов <code>GRANT</code> и <code>REVOKE</code>:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><code>ALL [PRIVILEGES]</code> </TD><TD> Задает все простые привилегии, кроме <code>WITH GRANT OPTION</code>
</TD></TR>
<TR><TD><code>ALTER</code> </TD><TD> Разрешает использование <code>ALTER TABLE</code>
</TD></TR>
<TR><TD><code>CREATE</code> </TD><TD> Разрешает использование <code>CREATE TABLE</code>
</TD></TR>
<TR><TD><code>CREATE TEMPORARY TABLES</code> </TD><TD> Разрешает использование <code>CREATE TEMPORARY TABLE</code>
</TD></TR>
<TR><TD><code>DELETE</code> </TD><TD> Разрешает использование <code>DELETE</code>
</TD></TR>
<TR><TD><code>DROP</code> </TD><TD> Разрешает использование <code>DROP TABLE</code>
</TD></TR>
<TR><TD><code>EXECUTE</code> </TD><TD> Разрешает пользователю запускать хранимые процедуры (для MySQL 5.0)
</TD></TR>
<TR><TD><code>FILE</code> </TD><TD> Разрешает использование <code>SELECT ... INTO OUTFILE</code> и <code>LOAD DATA INFILE</code>
</TD></TR>
<TR><TD><code>INDEX</code> </TD><TD> Разрешает использование <code>CREATE INDEX</code> and <code>DROP INDEX</code>
</TD></TR>
<TR><TD><code>INSERT</code> </TD><TD> Разрешает использование <code>INSERT</code>
</TD></TR>
<TR><TD><code>LOCK TABLES</code> </TD><TD> Разрешает использование <code>LOCK TABLES</code> на таблицах, для которых есть привилегия <code>SELECT</code>
</TD></TR>
<TR><TD><code>PROCESS</code> </TD><TD> Разрешает использование <code>SHOW FULL PROCESSLIST</code>
</TD></TR>
<TR><TD><code>REFERENCES</code> </TD><TD> Зарезервировано для использования в будущем
</TD></TR>
<TR><TD><code>RELOAD</code> </TD><TD> Разрешает использование <code>FLUSH</code>
</TD></TR>
<TR><TD><code>REPLICATION CLIENT</code> </TD><TD> Предоставляет пользователю право запрашивать местонахождение головного и подчиненных серверов
</TD></TR>
<TR><TD><code>REPLICATION SLAVE</code> </TD><TD> Необходимо для подчиненных серверов при репликации (для чтения информации из бинарных журналов головного сервера)
</TD></TR>
<TR><TD><code>SELECT</code> </TD><TD> Разрешает использование <code>SELECT</code>
</TD></TR>
<TR><TD><code>SHOW DATABASES</code> </TD><TD> <code>SHOW DATABASES</code> выводит все базы данных
</TD></TR>
<TR><TD><code>SHUTDOWN</code> </TD><TD> Разрешает использование <code>mysqladmin shutdown</code>
</TD></TR>
<TR><TD><code>SUPER</code> </TD><TD> Позволяет установить одно соединение (один раз), даже если достигнуто значение max_connections, и запускать команды <code>CHANGE MASTER</code>, <code>KILL thread</code>, <code>mysqladmin debug</code>, <code>PURGE MASTER LOGS</code> и <code>SET GLOBAL</code>
</TD></TR>
<TR><TD><code>UPDATE</code> </TD><TD> Разрешает использование <code>UPDATE</code>
</TD></TR>
<TR><TD><code>USAGE</code> </TD><TD> Синоним для ``без привилегий''
</TD></TR>
<TR><TD><code>GRANT OPTION</code> </TD><TD> Синоним для <code>WITH GRANT OPTION</code>
</TD></TR>
</TABLE>

<P>
Значение <code>USAGE</code> можно задавать, если необходимо создать пользователя без
привилегий.

</P>
<P>
Привилегии <code>CREATE TEMPORARY TABLES</code>, <code>EXECUTE</code>, <code>LOCK TABLES</code>, <code>REPLICATION ...</code>,
<code>SHOW DATABASES</code> и <code>SUPER</code> являются новыми для версии 4.0.2. Чтобы
воспользоваться этими новыми привилегиями после обновления до версии
4.0.2, необходимо запустить скрипт <code>mysql_fix_privilege_tables</code>.

</P>
<P>
В боле старых версиях MySQL привилегия <code>PROCESS</code> предоставляет такие же
права, как и новая привилегия <code>SUPER</code>.

</P>
<P>
Чтобы лишить пользователя привилегий, предоставленных командой <code>GRANT</code>,
воспользуйтесь значением <code>priv_type</code> в <code>GRANT OPTION</code>:

</P>

<pre>
mysql&#62; REVOKE GRANT OPTION ON ... FROM ...;
</pre>

<P>
Для таблицы можно указать только следующие значения <code>priv_type</code>:
<code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>CREATE</code>,
<code>DROP</code>, <code>GRANT OPTION</code>, I<code>NDEX</code> и <code>ALTER</code>.

</P>
<P>
Для столбца можно указать только следующие значения <code>priv_type</code> (при
использовании оператора <code>column_list</code>): <code>SELECT</code>, <code>INSERT</code> и <code>UPDATE</code>.

</P>
<P>
Глобальные привилегии можно задать, воспользовавшись синтаксисом <code>ON *.*</code>, а
привилегии базы данных - при помощи синтаксиса <code>ON db_name.*</code>. Если указать
<code>ON *</code> при открытой текущей базе данных, то привилегии будут заданы для этой
базы данных. (<strong>Предупреждение</strong>: если указать <code>ON *</code> при <strong>отсутствии</strong> открытой
текущей базы данных, это повлияет на глобальные привилегии!)

</P>
<P>
<strong>Заметьте:</strong> шаблонные символы <samp>`_'</samp> и <samp>`%'</samp>  не допускаются в определении
имени баз данных в операторе GRANT. Это означает, что если вы хотите
использовать, скажем, символ <samp>`_'</samp> в имени базы данных, то вы должны указать
его как <samp>`\_'</samp> в <code>GRANT</code>, чтобы пользователь не имел возможности
получить доступ к другим базам данных, соответствующих шаблону: <code>GRANT ...
ON `foo\_bar`.* TO ...</code>.

</P>
<P>
С тем, чтобы можно было определять права пользователям с конкретных
компьютеров, в MySQL обеспечивается возможность указывать имя пользователя
(<code>user_name</code>) в форме <code>user@host</code>. Если необходимо указать строку <code>user</code>, в
которой содержатся специальные символы (такие как <samp>`-'</samp>) или строку <code>host</code>, в
которой содержатся специальные или групповые символы (такие как <samp>`%'</samp>),
можно заключить имя удаленного компьютера или пользователя в кавычки
(например, <code>'test-user'@'test-hostname'</code>).

</P>
<P>
В имени удаленного компьютера также можно указывать групповые символы.
Например, <code>user@'%.loc.gov'</code> относится к <code>user</code> всех удаленных компьютеров
домена <code>loc.gov</code>, а <code>user@'144.155.166.%'</code> относится к <code>user</code> всех удаленных
компьютеров подсети <code>144.155.166</code> класс C.

</P>
<P>
Простая форма user является синонимом для <code>user@"%"</code>.

</P>
<P>
В MySQL не поддерживаются групповые символы в именах пользователей.
Анонимные пользователи определяются вставкой записей <code>User=''</code> в таблицу
<code>mysql.user</code> или созданием пользователя с пустым именем при помощи команды
<code>GRANT</code>.

</P>
<P>
<strong>Примечание</strong>: если анонимным пользователям разрешается подсоединяться к
серверу MySQL, необходимо также предоставить привилегии всем локальным
пользователям как <code>user@localhost</code>, поскольку в противном случае при попытке
пользователя зайти в MySQL с локального компьютера в таблице <code>mysql.user</code> 
будет использоваться вход для анонимного пользователя!

</P>
<P>
Чтобы проверить, происходит ли подобное на вашем компьютере, выполните
следующий запрос:

</P>

<pre>
mysql&#62; SELECT Host,User FROM mysql.user WHERE User='';
</pre>

<P>
На данный момент команда <code>GRANT</code> поддерживает имена удаленных компьютеров,
таблиц, баз данных и столбцов длиной не более 60 символов. Имя
пользователя должно содержать не более 16 символов.

</P>
<P>
Привилегии для таблицы или столбца формируются при помощи логического
оператора OR из привилегий каждого из четырех уровней. Например, если в
таблице <code>mysql.user</code> указано, что у пользователя есть глобальная привилегия
<code>SELECT</code>, эта привилегия не отменяется на уровне базы данных, таблицы или
столбца.

</P>
<P>
Привилегии для столбца могут быть вычислены следующим образом:

</P>

<pre>
глобальные привилегии
OR (привилегии базы данных AND привилегии удаленного компьютера)
OR привилегии таблицы
OR привилегии столбца
</pre>

<P>
В большинстве случаев права пользователя определяются только на одном
уровне привилегий, поэтому обычно эта процедура не настолько сложна, как
описано выше. Подробная информация о последовательности действий проверки
привилегий представлена в разделе section <A HREF="manual.ru_MySQL_Database_Administration.html#Privilege_system">4.2  Общие проблемы безопасности и система привилегий доступа MySQL</A>.

</P>
<P>
Если привилегии предоставляются сочетанию пользователь/удаленный
компьютер, которое отсутствует в таблице <code>mysql.user</code>, то в последнюю
добавляется запись, которая остается в таблице до тех пор, пока не будет
удалена при помощи команды <code>DELETE</code>. Иначе говоря, команда <code>GRANT</code> может
создавать записи <code>user</code> в таблице, но команда <code>REVOKE</code> не может их удалить.
Это необходимо делать при помощи команды <code>DELETE</code>.

</P>
<P>
<A NAME="IDX521"></A>
Если в MySQL версий 3.22.12 и выше создан новый пользователь или
предоставлены глобальные привилегии, пароль пользователя будет назначаться
оператором <code>IDENTIFIED BY</code>, если он указан. Если у пользователя уже есть
пароль, то этот пароль будет заменен новым.

</P>
<P>
Если вы не хотите отправлять пароль открытым текстом, можно
воспользоваться параметром <code>PASSWORD</code> с зашифрованным паролем, полученным
при помощи функции SQL <code>PASSWORD()</code> или функции C API
<code>make_scrambled_password(char *to, const char *password)</code>.

</P>
<P>
<strong>Предупреждение</strong>: если при создании нового пользователя не указать оператор
<code>IDENTIFIED BY</code>, будет создан пользователь без пароля. Это ненадежно с точки
зрения безопасности.

</P>
<P>
Пароли также можно задавать при помощи команды <code>SET PASSWORD</code>. See section <A HREF="manual.ru_Reference.html#SET">6.2.3.4  Тип множества <code>SET</code></A>.

</P>
<P>
Если у вас привилегии для базы данных, то при необходимости в таблице
<code>mysql.db</code> создается запись. Данная запись удаляется после удаления всех
привилегий для этой базы данных командой <code>REVOKE</code>.

</P>
<P>
Если у пользователя нет никаких привилегий для таблицы, то таблица не
отображается, когда пользователь запрашивает список таблиц (например, при
помощи оператора <code>SHOW TABLES</code>).

</P>
<P>
Оператор <code>WITH GRANT OPTION</code> предоставляет пользователю возможность наделять
других пользователей любыми привилегиями, которые он сам имеет на
указанном уровне привилегий. При предоставлении привилегии <code>GRANT</code>
необходимо проявлять осмотрительность, так как два пользователя с разными
привилегиями могут объединить свои привилегии!

</P>
<P>
Параметры <code>MAX_QUERIES_PER_HOUR #</code>, <code>MAX_UPDATES_PER_HOUR #</code> и
<code>MAX_CONNECTIONS_PER_HOUR #</code> являются новыми в MySQL версии 4.0.2. Эти
параметры ограничивают количество запросов, обновлений и входов, которые
пользователь может осуществить в течение одного часа. Если установлено
значение 0 (принято по умолчанию), то это означает, что для данного
пользователя нет ограничений. See section <A HREF="manual.ru_MySQL_Database_Administration.html#User_resources">4.3.6  Ограничение ресурсов пользователя</A>.

</P>
<P>
Внимание: чтобы указать любую из этих опция для существующего пользователя, но не
давать никаких дополнительных привилегий, используйте <code>GRANT USAGE ... WITH MAX_...</code>.

</P>
<P>
Нельзя предоставить другому пользователю привилегию, которой нет у вас
самого. Привилегия <code>GRANT</code> позволяет предоставлять только те привилегии,
которыми вы обладаете.

</P>
<P>
Учтите, что если пользователю назначена привилегия <code>GRANT</code> на определенном
уровне привилегий, то все привилегии, которыми этот пользователь уже
обладает (или которые будут ему назначены в будущем!) на этом уровне,
также могут назначаться этим пользователем. Предположим, пользователю
назначена привилегия <code>INSERT</code> в базе данных. Если потом в базе данных
назначить привилегию <code>SELECT</code> и указать <code>WITH GRANT OPTION</code>, пользователь
сможет назначать не только привилегию <code>SELECT</code>, но также и <code>INSERT</code>. Если
затем в базе данных предоставить пользователю привилегию <code>UPDATE</code>,
пользователь сможет после этого назначать <code>INSERT</code>, <code>SELECT</code> и <code>UPDATE</code>.

</P>
<P>
Не следует назначать привилегии <code>ALTER</code> обычным пользователям. Это дает
пользователю возможность разрушить систему привилегий путем переименования
таблиц!

</P>
<P>
Обратите внимание на то, что если используются привилегии для таблицы или
столбца даже для одного пользователя, сервер проверяет привилегии таблиц и
столбцов для всех пользователей, и это несколько замедляет работу MySQL.

</P>
<P>
При запуске <code>mysqld</code> все привилегии считываются в память. Привилегии базы
данных, таблицы и столбца вступают в силу немедленно, а привилегии уровня
пользователя - при следующем подсоединении пользователя. Изменения в
таблицах назначения привилегий, которые осуществляются при помощи команд
<code>GRANT</code> и <code>REVOKE</code>, обрабатываются сервером немедленно. Если изменять таблицы
назначения привилегий вручную (используя команды <code>INSERT</code>, <code>UPDATE</code> и т.д.),
необходимо запустить оператор <code>FLUSH PRIVILEGES</code> или <code>mysqladmin
flush-privileges</code>, чтобы указать серверу на необходимость перезагрузки
таблиц назначения привилегий. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Privilege_changes">4.3.3  Когда изменения в привилегиях вступают в силу</A>.

</P>
<P>
Наиболее значительные отличия команды <code>GRANT</code> версий ANSI SQL и MySQL
следующие:

</P>

<ul>
<LI>

В MySQL привилегии назначаются для сочетания имя пользователя +
удаленный компьютер, а не только для имени пользователя.

<LI>

В ANSI SQL отсутствуют глобальные привилегии и привилегии уровня базы
данных, и ANSI SQL поддерживает не все типы привилегий MySQL. В свою
очередь, в MySQL отсутствует поддержка привилегий ANSI SQL <code>TRIGGER</code>,
<code>UNDER</code>.

<LI>

Структура привилегий ANSI SQL является иерархической. Если удалить
пользователя, то все назначенные этому пользователелю привилегии будут
отменены. В MySQL назначенные привилегии не отменяются автоматически,
их при необходимости требуется удалять самостоятельно.

<LI>

В MySQL пользователь может применять к таблице оператор <code>INSERT</code> при
наличии у него привилегии <code>INSERT</code> только для нескольких столбцов в этой
таблице. Столбцы, для которых отсутствует привилегия <code>INSERT</code>, будут
установлены в свои значения, принятые по умолчанию. В ANSI SQL
требуется наличие привилегии <code>INSERT</code> для всех столбцов.

<LI>

При удалении таблицы в ANSI SQL все привилегии для этой таблицы будут
отменены. Если отменить привилегию в ANSI SQL, то все привилегии,
которые были назначены на основе этой привилегии, также будут
отменены. В MySQL привилегии могут удаляться только при помощи команды
<code>REVOKE</code> или путем изменения таблиц назначения привилегий MySQL.
</ul>

<P>
Чтобы ознакомиться с описанием использования <code>REQUIRE</code>, см. раздел See section <A HREF="manual.ru_MySQL_Database_Administration.html#Secure_connections">4.3.9  Использование безопасных соединений</A>.

</P>


<H3><A NAME="User_names" HREF="manual.ru_toc.html#User_names">4.3.2  Имена пользователей MySQL и пароли</A></H3>

<P>
<A NAME="IDX522"></A>
<A NAME="IDX523"></A>

</P>
<P>
Между MySQL и Unix или Windows существует несколько различий в
использовании имен пользователей и паролей:

</P>

<ul>
<LI>

Имена пользователей, которые применяются в MySQL для авторизации, не
имеют ничего общего с именами пользователей Unix (аккаунты Unix) или
именами пользователей Windows. Большинство клиентов MySQL по умолчанию
пытаются войти в систему, используя текущее имя пользователя Unix в
качестве имени пользователя MySQL, но это сделано только для удобства.
Программы клиентов позволяют указывать различные имена при помощи
параметров <code>-u</code> или <code>--user</code>. Это означает, что невозможно обеспечить
безопасность базы данных, если не все имена пользователей MySQL
снабжены паролями: ведь можно попытаться подсоединиться к серверу,
используя любое имя, а если воспользоваться именем, которому не
назначен пароль, то удастся войти в систему.

<LI>

Имена пользователей MySQL могут содержать до 16 символов. Имена
пользователей Unix обычно ограничены 8 символами.

<LI>

Пароли MySQL не имеют никакого отношения к паролям Unix. Не существует
связи между паролем, который используется для входа в Unix, и паролем,
необходимым для доступа к базе данных.

<LI>

MySQL шифрует пароли при помощи своего алгоритма, который отличается
от алгоритма Unix, используемого во время входа в систему. Описание
функций <code>PASSWORD()</code> и <code>ENCRYPT()</code> можно найти в разделе See section <A HREF="manual.ru_Reference.html#Miscellaneous_functions">6.3.6.2  Разные функции</A>. Обратите
внимание: даже если ваш пароль хранится в 'зашифрованном виде', то
знания этого 'зашифрованного' пароля будет достаточно, чтобы
подсоединиться к серверу MySQL!
</ul>

<P>
Пользователи MySQL и их привилегии обычно создаются при помощи команды
<code>GRANT</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#GRANT">4.3.1  Синтаксис команд <code>GRANT</code> и <code>REVOKE</code></A>.

</P>
<P>
Если подсоединение к серверу MySQL осуществляется с клиента командной
строки, необходимо указать пароль при помощи параметра
<code>--password=your-password</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Connecting">4.2.8  Соединение с сервером MySQL</A>.

</P>

<pre>
mysql --user=monty --password=guess database_name
</pre>

<P>
Если необходимо, чтобы клиент запрашивал пароль, то следует указать
<code>--password</code> без каких-либо аргументов

</P>

<pre>
mysql --user=monty --password database_name
</pre>

<P>
или сокращенный вариант этого параметра:

</P>

<pre>
mysql -u monty -p database_name
</pre>

<P>
Обратите внимание на то, что в последнем примере <code>database_name</code> не является
паролем.

</P>
<P>
Если необходимо указать пароль при помощи параметра <code>-p</code>, то следует
поступить следующим образом:

</P>

<pre>
mysql -u monty -pguess database_name
</pre>

<P>
В некоторых системах вызов библиотеки, который MySQL использует для
запроса пароля, автоматически обрезает пароль до 8 символов. В самом MySQL
не существует никаких ограничений на длину пароля.

</P>


<H3><A NAME="Privilege_changes" HREF="manual.ru_toc.html#Privilege_changes">4.3.3  Когда изменения в привилегиях вступают в силу</A></H3>

<P>
При запуске <code>mysqld</code> все таблицы назначения привилегий загружаются в память
и с этого момента привилегии вступают в силу.

</P>
<P>
Изменения, которые вносятся в таблицы назначения привилегий при помощи
команд <code>GRANT</code>, <code>REVOKE</code> или <code>SET PASSWORD</code>, учитываются сервером немедленно.

</P>
<P>
Если вносить изменения в таблицы назначения привилегий вручную (при помощи
команд <code>INSERT</code>, <code>UPDATE</code> и т.д.), необходимо запускать оператор <code>FLUSH
PRIVILEGES</code>, <code>mysqladmin flush-privileges</code> или <code>mysqladmin reload</code>, чтобы
указать серверу на необходимость перезагрузить эти таблицы. В противном
случае изменения не вступят в силу, пока сервер не будет перезагружен.
Если внести изменения вручную, но не перезагрузить таблицы назначения
привилегий, то останется только удивляться, почему внесенные изменения не
действуют!

</P>
<P>
Когда сервер замечает, что были внесены изменения в таблицы назначения
привилегий, он обрабатывает установленные соединения клиентов следующим
образом:

</P>

<ul>
<LI>

Изменения привилегий таблиц и столбцов вступают в силу при следующем
запросе клиента

<LI>

Изменения привилегий баз данных вступают в силу при следующем
использовании команды <code>USE db_name</code> 

<LI>

Изменения глобальных привилегий и изменения пароля вступают в силу при
следующем подсоединении пользователя.
</ul>



<H3><A NAME="Default_privileges" HREF="manual.ru_toc.html#Default_privileges">4.3.4  Задание изначальных привилегий MySQL</A></H3>

<P>
<A NAME="IDX524"></A>
<A NAME="IDX525"></A>
<A NAME="IDX526"></A>
<A NAME="IDX527"></A>
<A NAME="IDX528"></A>
<A NAME="IDX529"></A>
<A NAME="IDX530"></A>

</P>
<P>
После установки MySQL изначальные привилегии доступа задаются при помощи
<tt>`scripts/mysql_install_db'</tt>. See section <A HREF="manual.ru_Installing.html#Quick_install">2.3.1  Обзор  быстрой  установки</A>. Скрипт <code>mysql_install_db</code> запускает
сервер <code>mysqld</code>, а затем инициализирует таблицы предоставления привилегий со
следующим набором привилегий:

</P>

<ul>
<LI>

В качестве суперпользователя создается MySQL <code>root</code> который может делать
все, что угодно. Соединения должны устанавливаться с локального
компьютера.

<strong>Примечание</strong>: Изначально пароль <code>root</code> пуст, поэтому кто
угодно может подсоединиться в качестве <code>root</code> <em>без пароля</em> и получить все
привилегии.

<A NAME="IDX531"></A>
<LI>

Создается анонимный пользователь, который может выполнять любые
операции над базами данных с именами <code>test</code> или начинающимися с <code>test_</code>.
Соединения должны устанавливаться с локального компьютера. Это
означает, что любой локальный пользователь может подключиться без
пароля и будет воспринят сервером как анонимный пользователь.

<LI>

Остальные привилегии запрещены. Например, обычный пользователь не
может использовать команды <code>mysqladmin shutdown</code> или <code>mysqladmin
processlist</code>.
</ul>

<P>
<strong>Примечание</strong>: В Windows принятые по умолчанию привилегии отличаются от
указанных. See section <A HREF="manual.ru_Installing.html#Windows_running">2.6.2.3  Работа MySQL в среде Windows</A>.

</P>
<P>
Поскольку сразу после установки программа совершенно не защищена, первым
делом необходимо задать пароль для пользователя MySQL <code>root</code>. Это можно
сделать следующим образом (обратите внимание, что пароль указывается при
помощи функции <code>PASSWORD()</code>):

</P>

<pre>
shell&#62; mysql -u root mysql
mysql&#62; SET PASSWORD FOR root@localhost=PASSWORD('new_password');
</pre>

<P>
Опытные пользователи могут работать непосредственно с таблицами назначения
привилегий:

</P>

<pre>
shell&#62; mysql -u root mysql
mysql&#62; UPDATE user SET Password=PASSWORD('new_password')
    -&#62;     WHERE user='root';
mysql&#62; FLUSH PRIVILEGES;
</pre>

<P>
Еще один способ задать пароль - воспользоваться командой <code>mysqladmin</code>:

</P>

<pre>
shell&#62; mysqladmin -u root password new_password
</pre>

<P>
Изменять пароли других пользователей могут только пользователи с правом
записи/обновления базы данных <code>mysql</code>. Все обычные пользователи (не
анонимные) могут модифицировать только свой собственный пароль при помощи
указанных выше команд или команды <code>SET PASSWORD=PASSWORD('new_password')</code>.

</P>
<P>
Обратите внимание на то, что если пароль в таблице <code>user</code> обновляется
напрямую при помощи первого метода, требуется указать серверу на
необходимость перезагрузки таблиц привилегий (при помощи команды <code>FLUSH
PRIVILEGES</code>), иначе изменения не будут учтены.

</P>
<P>
После того, как был задан пароль <code>root</code>, этот пароль необходимо будет
вводить, подсоединяясь к серверу как <code>root</code>.

</P>
<P>
Можно оставить пароль <code>root</code> пустым, тогда не придется его указывать во
время проведения дополнительных установок и тестирования. Тем не менее,
обязательно укажите его, прежде чем использовать сервер для любой реальной
работы.

</P>
<P>
Ознакомьтесь со скриптом <tt>`scripts/mysql_install_db'</tt>, чтобы увидеть, как
задавать привилегии по умолчанию. Данный скрипт можно использовать как
основу для добавления других пользователей.

</P>
<P>
Если необходимо, чтобы изначальные привилегии отличались от указанных
выше, можно изменить базу <code>mysql_install_db</code> еще до ее запуска.

</P>
<P>
<A NAME="IDX532"></A>
<A NAME="IDX533"></A>
Чтобы полностью заново создать таблицы предоставления привилегий, удалите
все файлы с расширениями <tt>`.frm'</tt>, <tt>`.MYI'</tt> и <tt>`.MYD'</tt> в каталоге, где находится база
данных <code>mysql</code> (это каталог с именем <code>mysql</code> в каталоге базы данных, который
выводится на экран при запуске команды <code>mysqld --help</code>). Затем запустите
скрипт <code>mysql_install_db</code> (возможно, после добавления в него необходимых
привилегий).

</P>
<P>
<strong>Примечание</strong>: в более старых, чем 3.22.10, версиях MySQL файлы с расширением
<tt>`.frm'</tt> удалять не следует. Если же случайно они были удалены, их следует
восстановить, скопировав из дистрибутива MySQL до запуска
<code>mysql_install_db</code>.

</P>


<H3><A NAME="Adding_users" HREF="manual.ru_toc.html#Adding_users">4.3.5  Добавление новых пользователей в MySQL</A></H3>

<P>
<A NAME="IDX534"></A>
<A NAME="IDX535"></A>

</P>
<P>
<A NAME="IDX536"></A>
<A NAME="IDX537"></A>
<A NAME="IDX538"></A>

</P>
<P>
Пользователей можно добавлять двумя различными способами - при помощи
команды <code>GRANT</code> или напрямую в таблицы назначения привилегий MySQL.
Предпочтительнее использовать команду <code>GRANT</code> - этот способ проще и дает
меньше ошибок. See section <A HREF="manual.ru_MySQL_Database_Administration.html#GRANT">4.3.1  Синтаксис команд <code>GRANT</code> и <code>REVOKE</code></A>.

</P>
<P>
Существует также большое количество программ (таких как <code>phpmyadmin</code>),
которые служат для создания и администрирования пользователей. 

</P>
<P>
В приведенных ниже примерах демонстрируется, как использовать клиент <code>mysql</code>
для задания новых пользователей. В примерах предполагается, что привилегии
установлены в соответствии с принятыми по умолчанию значениями, описанными
в предыдущем разделе. Это означает, что для внесения изменений на том же
компьютере, где запущен <code>mysqld</code>, необходимо подсоединиться к серверу как
пользователь MySQL <code>root</code>, и у пользователя <code>root</code> должна быть привилегия
<code>INSERT</code> для базы данных <code>mysql</code>, а также административная привилегия <code>RELOAD</code>.
Кроме того, если был изменен пароль пользователя <code>root</code>, его необходимо
указать здесь для команды <code>mysql</code>.

</P>
<P>
Новых пользователей можно добавлять, используя команду <code>GRANT</code>:

</P>

<pre>
shell&#62; mysql --user=root mysql
mysql&#62; GRANT ALL PRIVILEGES ON *.* TO monty@localhost
    -&#62;     IDENTIFIED BY 'some_pass' WITH GRANT OPTION;
mysql&#62; GRANT ALL PRIVILEGES ON *.* TO monty@"%"
        -&#62; IDENTIFIED BY 'some_pass' WITH GRANT OPTION;
mysql&#62; GRANT RELOAD,PROCESS ON *.* TO admin@localhost;
mysql&#62; GRANT USAGE ON *.* TO dummy@localhost;
</pre>

<P>
Эти команды <code>GRANT</code> создают трех новых пользователей:

</P>
<DL COMPACT>

<DT><code>monty</code>
<DD>
Полноценный суперпользователь - он может подсоединяться к серверу откуда
угодно, но должен использовать для этого пароль <code>some_pass</code>. Обратите
внимание на то, что мы должны применить операторы <code>GRANT</code> как для
<code>monty@localhost</code>, так и для <code>monty@"%"</code>. Если не добавить запись с <code>localhost</code>,
запись анонимного пользователя для <code>localhost</code>, которая создается при помощи
<code>mysql_install_db</code>, будет иметь преимущество при подсоединении с локального
компьютера, так как в ней указано более определенное значение для поля
<code>Host</code>, и она расположена раньше в таблице <code>user</code>.

<DT><code>admin</code>
<DD>
Пользователь, который может подсоединяться с <code>localhost</code> без пароля; ему
назначены административные привилегии <code>RELOAD</code> и <code>PROCESS</code>. Эти привилегии
позволяют пользователю запускать команды <code>mysqladmin reload</code>, <code>mysqladmin
refresh</code> и <code>mysqladmin flush-*</code>, а также <code>mysqladmin processlist</code>. Ему не
назначено никаких привилегий, относящихся к базам данных (их можно
назначить позже, дополнительно применив оператор <code>GRANT</code>).

<DT><code>dummy</code>
<DD>
Пользователь, который может подсоединяться к серверу без пароля, но только
с локального компьютера. Все глобальные привилегии установлены в значение
<code>'N'</code>-тип привилегии <code>USAGE</code>, который позволяет создавать пользователей без
привилегий. Предполагается, что относящиеся к базам данных привилегии
будут назначены позже.
</DL>

<P>
<A NAME="IDX539"></A>
<A NAME="IDX540"></A>

</P>
<P>
Можно напрямую добавить точно такую же информацию о пользователе при
помощи оператора <code>INSERT</code>, а затем дать серверу команду перезагрузить
таблицы назначения привилегий:

</P>

<pre>
shell&#62; mysql --user=root mysql
mysql&#62; INSERT INTO user VALUES('localhost','monty',PASSWORD('some_pass'),
    -&#62;		'Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y');
mysql&#62; INSERT INTO user VALUES('%','monty',PASSWORD('some_pass'),
    -&#62;		'Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y');
mysql&#62; INSERT INTO user SET Host='localhost',User='admin',
    -&#62;		 Reload_priv='Y', Process_priv='Y';
mysql&#62; INSERT INTO user (Host,User,Password)
    -&#62;		 VALUES('localhost','dummy','');
mysql&#62; FLUSH PRIVILEGES;
</pre>

<P>
В зависимости от версии MySQL в примере, приведенном выше, может
указываться различное количество значений <code>'Y'</code> (в версиях до Version
3.22.11 было меньше столбцов привилегий). Для пользователя <code>admin</code>
используется более удобочитаемый расширенный синтаксис команды <code>INSERT</code>,
который доступен начиная с версии 3.22.11.

</P>
<P>
Обратите внимание: чтобы создать суперпользователя, необходимо создать
запись таблицы <code>user</code> с полями привилегий, установленными в значение <code>'Y'</code>.
Нет необходимости задавать значения в записях таблиц <code>db</code> или <code>host</code>.

</P>
<P>
Столбцы привилегий в таблице user в последнем операторе <code>INSERT</code> (для
пользователя <code>dummy</code>) не были заданы явно, поэтому данным столбцам был
присвоено принятое по умолчанию значение <code>'N'</code>. Точно так же действует
команда <code>GRANT USAGE</code>.

</P>
<P>
В приведенном ниже примере добавляется пользователь <code>custom</code>, который может
подсоединяться с компьютеров <code>localhost</code>, <code>server.domain</code> и <code>whitehouse.gov</code>. Он
хочет получать доступ к базе данных <code>bankaccount</code> только с компьютера
<code>localhost</code>, к базе данных <code>expenses</code> - только с <code>whitehouse.gov</code>, и к базе
данных <code>customer</code> - со всех трех компьютеров, а также использовать пароль
<code>stupid</code> при подсоединении со всех трех компьютеров.

</P>
<P>
Чтобы задать эти привилегии пользователя при помощи оператора <code>GRANT</code>,
выполните следующие команды:

</P>

<pre>
shell&#62; mysql --user=root mysql
mysql&#62; GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP
    -&#62; 	   ON bankaccount.*
    -&#62; 	   TO custom@localhost
    -&#62;     IDENTIFIED BY 'stupid';
mysql&#62; GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP
    -&#62;     ON expenses.*
    -&#62;     TO custom@whitehouse.gov
    -&#62;     IDENTIFIED BY 'stupid';
mysql&#62; GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP
    -&#62;     ON customer.*
    -&#62;     TO custom@'%'
    -&#62;     IDENTIFIED BY 'stupid';
</pre>

<P>
Привилегии для пользователя custom мы назначаем потому, что этот
пользователь хочет получать доступ к MySQL как с локального компьютера
через сокеты Unix, так и с удаленного компьютера <code>whitehouse.gov</code> через
протокол TCP/IP.

</P>
<P>
Чтобы задать привилегии пользователя путем непосредственного внесения
изменений в таблицы назначения привилегий, выполните следующие команды
(обратите внимание на команду <code>FLUSH PRIVILEGES</code> в конце примера):

</P>

<pre>
shell&#62; mysql --user=root mysql
mysql&#62; INSERT INTO user (Host,User,Password)
    -&#62; VALUES('localhost','custom',PASSWORD('stupid'));
mysql&#62; INSERT INTO user (Host,User,Password)
    -&#62; VALUES('server.domain','custom',PASSWORD('stupid'));
mysql&#62; INSERT INTO user (Host,User,Password)
    -&#62; VALUES('whitehouse.gov','custom',PASSWORD('stupid'));
mysql&#62; INSERT INTO db
    -&#62; (Host,Db,User,Select_priv,Insert_priv,Update_priv,Delete_priv,
    -&#62; Create_priv,Drop_priv)
    -&#62; VALUES
    -&#62; ('localhost','bankaccount','custom','Y','Y','Y','Y','Y','Y');
mysql&#62; INSERT INTO db
    -&#62; (Host,Db,User,Select_priv,Insert_priv,Update_priv,Delete_priv,
    -&#62; Create_priv,Drop_priv)
    -&#62; VALUES
    -&#62; ('whitehouse.gov','expenses','custom','Y','Y','Y','Y','Y','Y');
mysql&#62; INSERT INTO db
    -&#62; (Host,Db,User,Select_priv,Insert_priv,Update_priv,Delete_priv,
    -&#62; Create_priv,Drop_priv)
    -&#62; VALUES('%','customer','custom','Y','Y','Y','Y','Y','Y');
mysql&#62; FLUSH PRIVILEGES;
</pre>

<P>
Первые три оператора <code>INSERT</code> добавляют в таблицу user записи, которые
позволят пользователю <code>custom</code> подключаться с различных компьютеров с
указанным паролем, но не дают ему никаких привилегий (все привилегии
установлены в принятое по умолчанию значение <code>'N'</code>). Следующие три оператора
<code>INSERT</code> добавляют записи в таблицу <code>db</code>, в которой назначаются привилегии для
пользователя <code>custom</code> по отношению к базам данных <code>bankaccount</code>, <code>expenses</code> и
customer, но только если доступ осуществляется с определенных компьютеров.
Как обычно, после внесения изменений непосредственно в таблицы назначения
привилегий серверу необходимо дать команду на перезагрузку этих таблиц
(при помощи <code>FLUSH PRIVILEGES</code>), чтобы внесенные изменения вступили в силу.

</P>
<P>
Если необходимо предоставить определенному пользователю доступ с любого
компьютера к определенному домену, можно воспользоваться оператором <code>GRANT</code>
следующим образом:

</P>

<pre>
mysql&#62; GRANT ...
    -&#62;	   ON *.*
    -&#62;     TO myusername@"%.mydomainname.com"
    -&#62;     IDENTIFIED BY 'mypassword';
</pre>

<P>
Чтобы сделать то же самое путем непосредственного внесения изменений в
таблицы назначения привилегий, выполните следующие действия:

</P>

<pre>
mysql&#62; INSERT INTO user VALUES ('%.mydomainname.com', 'myusername',
    -&#62;		   PASSWORD('mypassword'),...);
mysql&#62; FLUSH PRIVILEGES;
</pre>



<H3><A NAME="User_resources" HREF="manual.ru_toc.html#User_resources">4.3.6  Ограничение ресурсов пользователя</A></H3>

<P>
Начиная с MySQL версии 4.0.2 можно ограничивать определенные ресурсы,
выделяемые пользователям.

</P>
<P>
До этой версии единственным возможным методом ограничения использования
ресурсов сервера MySQL была установка переменной запуска
<code>max_user_connections</code> в значение, отличное от нуля. Но этот метод действует
только на глобальном уровне и не позволяет управлять отдельными
пользователями. Он может представлять определенный интерес только для
провайдеров услуг Internet.

</P>
<P>
На уровне отдельного пользователя теперь введено управление следующими
тремя ресурсами:

</P>

<ul>
<LI>Количество всех запросов в час: все команды, которые может запускать

пользователь.
<LI>Количество всех обновлений в час: любая команда, которая изменяет

таблицу или базу данных.
<LI>Количество соединений, сделанных за час: новые соединения, открытые за

час.
</ul>

<P>
Пользователь в упомянутом выше контексте представляет собой отдельную
запись в таблице user, которая уникальным образом идентифицируется своими
столбцами <code>user</code> и <code>host</code>.

</P>
<P>
По умолчанию все пользователи не ограничены в использовании указанных выше
ресурсов только в случае, только если эти ограничения не наложены на них.
Данные ограничения могут быть наложены <strong>только</strong> при помощи глобальной
команды <code>GRANT (*.*)</code> с использованием следующего синтаксиса:

</P>

<pre>
GRANT ... WITH MAX_QUERIES_PER_HOUR N1
	       MAX_UPDATES_PER_HOUR N2
	       MAX_CONNECTIONS_PER_HOUR N3;
</pre>

<P>
Можно указать любое сочетание приведенных выше ресурсов. N1, N2 и N3
являются целыми числами, представляющими собой значения количеств
запросов/обновлений/соединений в час.

</P>
<P>
Если пользователь в течение часа достигает предела любого из вышеуказанных
значений, его соединение будет прервано с выдачей соответствующего
сообщения об ошибке.

</P>
<P>
Текущие значения для определенного пользователя могут быть сброшены
(установлены в нуль), если воспользоваться оператором <code>GRANT</code> с любым из
приведенных выше пунктов, включая оператор <code>GRANT</code> с текущими значениями.

</P>
<P>
Кроме того, текущие значения для всех пользователей сбрасываются, если
производится перезагрузка привилегий (на сервере или при использовании
команды <code>mysqladmin reload</code>) или если выполняется команда <code>FLUSH
USER_RESOURCES</code>.

</P>
<P>
Эта функция включается сразу после того, как на пользователя будут
наложены ограничения при помощи команды <code>GRANT</code>.

</P>
<P>
Необходимым условием для включения данной функции является наличие в
таблице <code>user</code> базы данных <code>mysql</code> дополнительного столбца, как это определено
в скриптах создания таблиц <code>mysql_install_db</code> и <code>mysql_install_db.sh</code> в
подкаталоге <tt>`scripts'</tt>.

</P>


<H3><A NAME="Passwords" HREF="manual.ru_toc.html#Passwords">4.3.7  Задание паролей</A></H3>

<P>
<A NAME="IDX541"></A>
<A NAME="IDX542"></A>

</P>
<P>
<A NAME="IDX543"></A>
<A NAME="IDX544"></A>

</P>
<P>
В большинстве случаев для задания пользователей и их паролей следует
пользоваться командой <code>GRANT</code>, поэтому приведенная ниже информация
предназначена для опытных пользователей. See section <A HREF="manual.ru_MySQL_Database_Administration.html#GRANT">4.3.1  Синтаксис команд <code>GRANT</code> и <code>REVOKE</code></A>.

</P>
<P>
В примерах, приведенных в предыдущих разделах, демонстрируется важный
принцип, который заключается в следующем: при сохранении непустых паролей
с использованием операторов <code>INSERT</code> или <code>UPDATE</code> для их шифрования должна
применяться функция <code>PASSWORD()</code>. Это делается потому, что в таблице <code>user</code>
пароли хранятся в зашифрованном виде, а не как простой текст. Предположим,
что мы упустили это из виду и задали пароли следующим образом:

</P>

<pre>
shell&#62; mysql -u root mysql
mysql&#62; INSERT INTO user (Host,User,Password)
    -&#62; VALUES('%','jeffrey','biscuit');
mysql&#62; FLUSH PRIVILEGES;
</pre>

<P>
В результате выполнения этих команд в таблице user будет сохранено
значение пароля <code>biscuit</code> в виде простого текста. Когда пользователь <code>jeffrey</code>
попытается подсоединиться к серверу, используя этот пароль, клиент <code>mysql</code>
зашифрует его при помощи функции <code>PASSWORD()</code>, сгенерирует вектор
аутентификации, основанный на зашифрованном пароле и случайно выбранном
числе, полученном от сервера, и направит результат на сервер. Сервер
использует значение <code>password</code> из таблицы <code>user</code> (в данном случае, это
незашифрованное значение <code>biscuit</code>), чтобы осуществить точно такие же
вычисления, и сравнит результаты. Результаты не совпадут, и сервер не
позволит установить соединение:

</P>

<pre>
shell&#62; mysql -u jeffrey -pbiscuit test
Access denied
</pre>

<P>
Перед занесением в таблицу <code>user</code> пароли необходимо зашифровывать, поэтому
оператор <code>INSERT</code> должен использоваться следующим образом:

</P>

<pre>
mysql&#62; INSERT INTO user (Host,User,Password)
    -&#62; VALUES('%','jeffrey',PASSWORD('biscuit'));
</pre>

<P>
При использовании оператора <code>SET PASSWORD</code> также необходимо применять
функцию <code>PASSWORD()</code>:

</P>

<pre>
mysql&#62; SET PASSWORD FOR jeffrey@"%" = PASSWORD('biscuit');
</pre>

<P>
Если пароль задается при помощи оператора <code>GRANT ... IDENTIFIED BY</code> или
команды <code>mysqladmin password</code>, нет необходимости использовать функцию
<code>PASSWORD()</code>. Обе эти команды самостоятельно производят шифровку пароля,
поэтому пароль следует указывать как <code>biscuit</code>, например, таким образом:

</P>

<pre>
mysql&#62; GRANT USAGE ON *.* TO jeffrey@"%" IDENTIFIED BY 'biscuit';
</pre>

<P>
или

</P>

<pre>
shell&#62; mysqladmin -u jeffrey password biscuit
</pre>

<P>
Примечание: Функция <code>PASSWORD()</code> шифрует пароли отличным от Unix образом. Не
следует полагать, что если ваши пароли для Unix и для MySQL совпадают, то
функция <code>PASSWORD()</code> выдаст точно такой же результат шифрования, как и файл
паролей Unix. See section <A HREF="manual.ru_MySQL_Database_Administration.html#User_names">4.3.2  Имена пользователей MySQL и пароли</A>.

</P>


<H3><A NAME="Password_security" HREF="manual.ru_toc.html#Password_security">4.3.8  Обеспечение безопасности своего пароля</A></H3>

<P>
Не рекомендуется указывать пароль таким образом, чтобы его могли подобрать
другие пользователи. Ниже приведены методы, которыми можно пользоваться
при задании своего пароля при запуске указанных клиентских программ, а
также степенью риска для каждого из методов:

</P>

<ul>
<LI>

Никогда не заносите пароль обычного доступа в таблицу <code>mysql.user</code>. Зная
даже зашифрованный пароль пользователя, можно войти в систему под
именем этого пользователя. Пароли шифруются только для того, чтобы
нельзя было увидеть, какой именно пароль используется (если вы
используете один и тот же пароль для разных приложений).

<LI>

Использование параметров <code>-pyour_pass</code> или <code>--password=your_pass</code> в
командной строке удобно, но не очень безопасно, так как ваш пароль
становится видимым для системных статусных утилит (таких как <code>ps</code>), и
другие пользователи могут просмотреть командные строки (во время
запуска клиенты MySQL обычно перезаписывают аргументы командной строки
нулями, но существует небольшой промежуток времени, на протяжении
которого значение остается видимым).

<LI>

Используйте параметр <code>-p</code> или <code>--password</code> (без указания значения
<code>your_pass</code>). В этом случае программа клиента запрашивает пароль с
терминала:
<A NAME="IDX545"></A>
<A NAME="IDX546"></A>
<A NAME="IDX547"></A>
<A NAME="IDX548"></A>


<pre>
shell&#62; mysql -u user_name -p
Enter password: ********
</pre>

Ваш пароль будет представлен символами <samp>`*'</samp>.

Вводить пароль таким образом
намного безопаснее, чем из командной строки, поскольку он невидим для
остальных пользователей. Тем не менее, этот метод подходит только для тех
программ, которые вы запускаете самостоятельно. Если клиент требуется
запустить из скрипта, то возможности ввести пароль с терминала не будет. В
некоторых системах первая строка скрипта считывается и неправильно
распознается как ваш пароль!

<LI>

<A NAME="IDX549"></A>
Храните свой файл в файле конфигурации. Например, можно записать свои
пароли в разделе <code>[client]</code> файла <tt>`.my.cnf'</tt> в своем каталоге:


<pre>
[client]
password=your_pass
</pre>

Если пароль хранится в <tt>`.my.cnf'</tt>, файл не должен быть доступен для чтения
или записи для всех или для отдельных групп пользователей. Убедитесь, что
права доступа к файлу установлены в 400 или 600. 

<LI>

Можно хранить свой пароль в переменной окружения <code>MYSQL_PWD</code>, но этот
метод считается очень небезопасным и не должен использоваться. В
некоторые версии ps включена возможность отображать переменные
окружения работающего процесса. Поэтому если задать свой пароль при
помощи <code>MYSQL_PWD</code>, он будет виден для всех,. Даже в системах без такой
версии <code>ps</code>, неразумно предполагать, что не существует другого метода
получить информацию по переменным окружения. See section <A HREF="manual.ru_Environment_variables.html#Environment_variables">F  Переменные окружения</A>.
</ul>

<P>
Исходя из всего сказанного выше, самыми безопасными методами указания
пароля являются запрос программы клиента на ввод пароля с терминала или
указание пароля в защищенном надлежащим образом файле <tt>`.my.cnf'</tt>.

</P>


<H3><A NAME="Secure_connections" HREF="manual.ru_toc.html#Secure_connections">4.3.9  Использование безопасных соединений</A></H3>

<P>
<A NAME="IDX550"></A>
<A NAME="IDX551"></A>

</P>



<H4><A NAME="Secure_basics" HREF="manual.ru_toc.html#Secure_basics">4.3.9.1  Основные сведения</A></H4>

<P>
MySQL поддерживает шифрованные SSL-соединения. Для лучшего понимания того,
как в MySQL используется SSL, мы приводим здесь основные сведения по SSL и
X509. Пользователи, которые уже знакомы с данным протоколом и стандартом,
эту часть могут пропустить.

</P>
<P>
По умолчанию в MySQL используются незашифрованные соединения между
клиентом и сервером. Это означает, что просматривать все данные,
передаваемые между клиентом и сервером, может кто угодно. На практике
можно даже изменять данные во время передачи их от клиента к серверу и
наоборот. Помимо того, иногда возникает необходимость передать
действительно секретные данные через общедоступную сеть - в таких случаях
использование незашифрованных соединений просто неприемлемо.

</P>
<P>
В протоколе SSL используются различные алгоритмы шифрования,
обеспечивающие безопасность для данных, передаваемых через общедоступные
сети. Этот протокол содержит средства, позволяющие обнаруживать любые
изменения, потери и повторы данных. В протоколе SSL также применяются
алгоритмы для проведения идентификации при помощи стандарта X509.

</P>
<P>
<A NAME="IDX552"></A>
Шифровка - это метод, позволяющий сделать прочтение любых данных
невозможным. Фактически при современном положении дел для алгоритмов
шифрования требуется использование дополнительных элементов безопасности.
Они должны обеспечивать противодействие многим видам известных на
настоящий момент атак, таких как изменение порядка зашифрованных сообщений
или повторение данных.

</P>
<P>
<A NAME="IDX553"></A>
Стандарт X509 позволяет производить идентификацию в Internet. Чаще всего
он используется в приложениях электронной коммерции. Упрощенно схема его
применения выглядит следующим образом: существует некая организация под
названием "Certificate Authority" (можно перевести как ``Сертификационное
Бюро''. - Прим. пер.), которая назначает электронные сертификаты всем,
кому они нужны. Сертификаты основываются на асимметричных алгоритмах
шифрования, содержащих два ключа - публичный и секретный. Владелец
сертификата может подтвердить свою личность, предъявив свой сертификат
другой стороне. Сертификат состоит из публичного ключа владельца. Любые
данные, зашифрованные при помощи этого публичного ключа могут быть
расшифрованы только при помощи соответствующего секретного ключа, который
находится у владельца сертификата.

</P>
<P>
В MySQL по умолчанию не используется шифрование при соединениях, так как
это значительно замедляет обмен данными между клиентом и сервером. Любые
дополнительные функции приводят к дополнительной нагрузке для компьютера,
а шифрование данных требует интенсивной работы процессора, что может
вызвать задержку выполнения основных задач MySQL. По умолчанию MySQL
настроен на максимально быструю работу.

</P>
<P>
Если вы хотите получить дополнительную информацию о SSL/X509/шифровании,
необходимо воспользоваться своим любимым поисковым сервером Internet и
произвести поиск по словам, которые вас интересуют.

</P>


<H4><A NAME="Secure_requirements" HREF="manual.ru_toc.html#Secure_requirements">4.3.9.2  Требования</A></H4>

<P>
Для того чтобы SSL-соединения могли работать с MySQL, необходимо выполнить
следующие действия:

</P>

<ol>
<LI>

Установите библиотеку OpenSSL. Тестирование MySQL производилось с
библиотекой OpenSSL 0.9.6. <a HREF="http://www.openssl.org/">http://www.openssl.org/</a>.
<LI>

Выполните настройку компиляции MySQL (<code>configure</code>) при помощи параметров
<code>--with-vio --with-openssl</code>.
<LI>

Если используется старая версия MySQL, то необходимо обновить таблицу
<code>mysql.user</code> путем добавления в нее определенных новых столбцов. Это
можно сделать, запустив скрипт <code>mysql_fix_privilege_tables.sh</code>.
<LI>

Проверить, скомпилирована ли в запущенном сервере <code>mysqld</code> библиотека
OpenSSL можно, убедившись, что <code>SHOW VARIABLES LIKE 'have_openssl'</code> показывает
<code>YES</code>.
</ol>



<H4><A NAME="Secure_Create_Certs" HREF="manual.ru_toc.html#Secure_Create_Certs">4.3.9.3  Создание SSL-сертификатов</A></H4>

<P>
Вот пример, как создаются SSL-сертификаты для MySQL: 

</P>

<pre>
DIR=`pwd`/openssl
PRIV=$DIR/private

mkdir $DIR $PRIV $DIR/newcerts
cp /usr/share/ssl/openssl.cnf $DIR
replace ./demoCA $DIR -- $DIR/openssl.cnf

# создаем необходимые файлы: $database, $serial и каталог $new_certs_dir 
# (опционально)

touch $DIR/index.txt
echo "01" &#62; $DIR/serial

#
# Создаем Certificate Authority(CA)
#

openssl req -new -x509 -keyout $PRIV/cakey.pem -out $DIR/cacert.pem \
    -config $DIR/openssl.cnf

# Пример вывода:
# Using configuration from /home/monty/openssl/openssl.cnf
# Generating a 1024 bit RSA private key
# ................++++++
# .........++++++
# writing new private key to '/home/monty/openssl/private/cakey.pem'
# Enter PEM pass phrase:
# Verifying password - Enter PEM pass phrase:
# -----
# You are about to be asked to enter information that will be incorporated
# into your certificate request.
# What you are about to enter is what is called a Distinguished Name or a DN.
# There are quite a few fields but you can leave some blank
# For some fields there will be a default value,
# If you enter '.', the field will be left blank.
# -----
# Country Name (2 letter code) [AU]:FI
# State or Province Name (full name) [Some-State]:.
# Locality Name (eg, city) []:
# Organization Name (eg, company) [Internet Widgits Pty Ltd]:MySQL AB
# Organizational Unit Name (eg, section) []:
# Common Name (eg, YOUR name) []:MySQL admin
# Email Address []:

#
# Создаем server-request и ключ
#
openssl req -new -keyout $DIR/server-key.pem -out \
    $DIR/server-req.pem -days 3600 -config $DIR/openssl.cnf

# Пример вывода:
# Using configuration from /home/monty/openssl/openssl.cnf
# Generating a 1024 bit RSA private key
# ..++++++
# ..........++++++
# writing new private key to '/home/monty/openssl/server-key.pem'
# Enter PEM pass phrase:
# Verifying password - Enter PEM pass phrase:
# -----
# You are about to be asked to enter information that will be incorporated
# into your certificate request.
# What you are about to enter is what is called a Distinguished Name or a DN.
# There are quite a few fields but you can leave some blank
# For some fields there will be a default value,
# If you enter '.', the field will be left blank.
# -----
# Country Name (2 letter code) [AU]:FI
# State or Province Name (full name) [Some-State]:.
# Locality Name (eg, city) []:
# Organization Name (eg, company) [Internet Widgits Pty Ltd]:MySQL AB
# Organizational Unit Name (eg, section) []:
# Common Name (eg, YOUR name) []:MySQL server
# Email Address []:
# 
# Please enter the following 'extra' attributes
# to be sent with your certificate request
# A challenge password []:
# An optional company name []:

#
# Удаляем парольную фразу из ключа (опционально)
#

openssl rsa -in $DIR/server-key.pem -out $DIR/server-key.pem

#
# Подписываем сертификат сервера
#
openssl ca  -policy policy_anything -out $DIR/server-cert.pem \
    -config $DIR/openssl.cnf -infiles $DIR/server-req.pem

# Пример вывода:
# Using configuration from /home/monty/openssl/openssl.cnf
# Enter PEM pass phrase:
# Check that the request matches the signature
# Signature ok
# The Subjects Distinguished Name is as follows
# countryName           :PRINTABLE:'FI'
# organizationName      :PRINTABLE:'MySQL AB'
# commonName            :PRINTABLE:'MySQL admin'
# Certificate is to be certified until Sep 13 14:22:46 2003 GMT (365 days)
# Sign the certificate? [y/n]:y
# 
# 
# 1 out of 1 certificate requests certified, commit? [y/n]y
# Write out database with 1 new entries
# Data Base Updated

#
# Создаем client request и ключ
#
openssl req -new -keyout $DIR/client-key.pem -out \
    $DIR/client-req.pem -days 3600 -config $DIR/openssl.cnf

# Пример вывода:
# Using configuration from /home/monty/openssl/openssl.cnf
# Generating a 1024 bit RSA private key
# .....................................++++++
# .............................................++++++
# writing new private key to '/home/monty/openssl/client-key.pem'
# Enter PEM pass phrase:
# Verifying password - Enter PEM pass phrase:
# -----
# You are about to be asked to enter information that will be incorporated
# into your certificate request.
# What you are about to enter is what is called a Distinguished Name or a DN.
# There are quite a few fields but you can leave some blank
# For some fields there will be a default value,
# If you enter '.', the field will be left blank.
# -----
# Country Name (2 letter code) [AU]:FI
# State or Province Name (full name) [Some-State]:.
# Locality Name (eg, city) []:
# Organization Name (eg, company) [Internet Widgits Pty Ltd]:MySQL AB
# Organizational Unit Name (eg, section) []:
# Common Name (eg, YOUR name) []:MySQL user
# Email Address []:
# 
# Please enter the following 'extra' attributes
# to be sent with your certificate request
# A challenge password []:
# An optional company name []:

#
# Удаляем парольную фразу из ключа (опционально)
#
openssl rsa -in $DIR/client-key.pem -out $DIR/client-key.pem

#
# Подписываем клиентский сертификат
#

openssl ca  -policy policy_anything -out $DIR/client-cert.pem \
    -config $DIR/openssl.cnf -infiles $DIR/client-req.pem

# Пример вывода:
# Using configuration from /home/monty/openssl/openssl.cnf
# Enter PEM pass phrase:
# Check that the request matches the signature
# Signature ok
# The Subjects Distinguished Name is as follows
# countryName           :PRINTABLE:'FI'
# organizationName      :PRINTABLE:'MySQL AB'
# commonName            :PRINTABLE:'MySQL user'
# Certificate is to be certified until Sep 13 16:45:17 2003 GMT (365 days)
# Sign the certificate? [y/n]:y
# 
# 
# 1 out of 1 certificate requests certified, commit? [y/n]y
# Write out database with 1 new entries
# Data Base Updated

#
# Создаем такой my.cnf, который позволит нам протестировать сертификаты
#

cnf=""
cnf="$cnf [client]"
cnf="$cnf ssl-ca=$DIR/cacert.pem"
cnf="$cnf ssl-cert=$DIR/client-cert.pem"
cnf="$cnf ssl-key=$DIR/client-key.pem"
cnf="$cnf [mysqld]"
cnf="$cnf ssl-ca=$DIR/cacert.pem"
cnf="$cnf ssl-cert=$DIR/server-cert.pem"
cnf="$cnf ssl-key=$DIR/server-key.pem"
echo $cnf | replace " " '
' &#62; $DIR/my.cnf

#
# Тестируем MySQL

mysqld --defaults-file=$DIR/my.cnf &#38;

mysql --defaults-file=$DIR/my.cnf
</pre>

<P>
Вы также можете тестировать сертификаты путем модификации <code>my.cnf</code> таким образом, 
чтобы использовать демонстрационные сертификаты в каталоге <code>mysql-source-dist/SSL</code>. 

</P>


<H4><A NAME="Secure_GRANT" HREF="manual.ru_toc.html#Secure_GRANT">4.3.9.4  Параметры команды <code>GRANT</code></A></H4>

<P>
<A NAME="IDX554"></A>
<A NAME="IDX555"></A>
<A NAME="IDX556"></A>

</P>
<P>
В дополнение к обычной схеме имя пользователя/пароль MySQL может
производить проверку атрибутов сертификата X509. Для этого необходимы
также все обычные параметры (имя пользователя, пароль, маска IP-адреса,
имя базы данных/таблицы).

</P>
<P>
Существует несколько возможностей ограничить соединения:

</P>

<ul>
<LI>

Если не указано никаких параметров SSL/X509, а имя пользователя и
пароль указаны правильно, то разрешены все виды шифрованных и
нешифрованных соединений.

<LI>

Параметр <code>REQUIRE SSL</code> позволяет серверу устанавливать только
зашифрованные при помощи протокола SSL соединения. Обратите внимание,
что этот параметр может быть неприемлемым, если существуют записи ACL,
разрешающие не-SSL соединения.


<pre>
mysql&#62; GRANT ALL PRIVILEGES ON test.* TO root@localhost
    -&#62; IDENTIFIED BY "goodsecret" REQUIRE SSL;
</pre>

<LI>

<code>REQUIRE X509</code> означает, что у клиента должен быть действительный
сертификат, но мы не требуем наличия определенного сертификата,
сертификата определенной фирмы или темы. Единственное ограничение -
подпись должна поддаваться проверке при помощи одного из сертификатов
бюро сертификации.


<pre>
mysql&#62; GRANT ALL PRIVILEGES ON test.* TO root@localhost
    -&#62; IDENTIFIED BY "goodsecret" REQUIRE X509;
</pre>

<LI>

<code>REQUIRE ISSUER "issuer"</code> делает требования по соединению более
определенными: теперь клиент должен предоставить действительный
сертификат X509, выданный бюро сертификации (CA) <code>"issuer"</code>. Использование
сертификатов X509 всегда означает применение шифрования, поэтому
параметр <code>SSL</code> больше не нужен.


<pre>
mysql&#62; GRANT ALL PRIVILEGES ON test.* TO root@localhost
    -&#62; IDENTIFIED BY "goodsecret"
    -&#62; REQUIRE ISSUER "C=FI, ST=Some-State, L=Helsinki,
    "&#62; O=MySQL Finland AB, CN=Tonu Samuel/Email=tonu@mysql.com";
</pre>

<LI>

<code>REQUIRE SUBJECT "subject"</code> требует наличия у клиента действительного
сертификата X509 с содержащейся в нем темой "subject". Если у клиента
есть действительный сертификат, но другой "subject", то соединение не
будет установлено.


<pre>
mysql&#62; GRANT ALL PRIVILEGES ON test.* TO root@localhost
    -&#62; IDENTIFIED BY "goodsecret"
    -&#62; REQUIRE SUBJECT "C=EE, ST=Some-State, L=Tallinn,
    "&#62; O=MySQL demo client certificate,
    "&#62; CN=Tonu Samuel/Email=tonu@mysql.com";
</pre>

<LI>

<code>REQUIRE CIPHER "cipher"</code> требуется для обеспечения достаточно сложных
шифра и длины ключа. Протокол SSL сам по себе может быть ненадежным
из-за использования старых алгоритмов с короткими ключами шифрования.
Воспользовавшись этим параметром, мы можем указать определенный метод
шифрования, разрешающий соединение.


<pre>
mysql&#62; GRANT ALL PRIVILEGES ON test.* TO root@localhost
    -&#62; IDENTIFIED BY "goodsecret"
    -&#62; REQUIRE CIPHER "EDH-RSA-DES-CBC3-SHA";
</pre>

Разрешается также сочетать <code>SUBJECT</code>, <code>ISSUER</code>, <code>CIPHER</code> в <code>REQUIRE</code>, например, так: 


<pre>
mysql&#62; GRANT ALL PRIVILEGES ON test.* TO root@localhost
    -&#62; IDENTIFIED BY "goodsecret"
    -&#62; REQUIRE SUBJECT "C=EE, ST=Some-State, L=Tallinn,
    "&#62; O=MySQL demo client certificate,
    "&#62; CN=Tonu Samuel/Email=tonu@mysql.com"
    -&#62; AND ISSUER "C=FI, ST=Some-State, L=Helsinki,
    "&#62; O=MySQL Finland AB, CN=Tonu Samuel/Email=tonu@mysql.com"
    -&#62; AND CIPHER "EDH-RSA-DES-CBC3-SHA";
</pre>

Начиная с MySQL 4.0.4, слово <code>AND</code> необязательно в опциях <code>REQUIRE</code>. 

Порядок опций не имеет значения, но ни одна опция не может быть указана дважды.

</ul>



<H2><A NAME="Disaster_Prevention" HREF="manual.ru_toc.html#Disaster_Prevention">4.4  Предотвращение катастроф и восстановление</A></H2>



<H3><A NAME="Backup" HREF="manual.ru_toc.html#Backup">4.4.1  Резервное копирование баз данных</A></H3>

<P>
<A NAME="IDX557"></A>
<A NAME="IDX558"></A>

</P>
<P>
Поскольку таблицы MySQL хранятся в виде файлов, то резервное копирование
выполняется легко. Чтобы резервная копия была согласованной, выполните на
выбранных таблицах <code>LOCK TABLES</code>, а затем <code>FLUSH TABLES</code> для этих таблиц (см.
разделы section <A HREF="manual.ru_Reference.html#LOCK_TABLES">6.7.2  Синтаксис команд <code>LOCK TABLES/UNLOCK TABLES</code></A> и see section <A HREF="manual.ru_MySQL_Database_Administration.html#FLUSH">4.5.3  Синтаксис команды <code>FLUSH</code></A>). При этом
требуется блокировка только на чтение; поэтому другие потоки смогут
продолжать запросы на таблицах в то время, пока будут создаваться копии
файлов из каталога базы данных. Команда <code>FLUSH TABLE</code> обеспечивает гарантию
того, что все активные индексные страницы будут записаны на диск прежде,
чем начнется резервное копирование.

</P>
<P>
Начиная с 3.23.56 и 4.0.12 <code>BACKUP TABLE</code> не позволит вам перезаписать существующие
файлы, так как это создает потенциальные проблемы в безопасности. 

</P>
<P>
Если есть необходимость провести резервное копирование на уровне SQL, то
можно воспользоваться <code>SELECT INTO OUTFILE</code> или <code>BACKUP TABLE</code> (см. разделы
section <A HREF="manual.ru_Reference.html#SELECT">6.4.1  Синтаксис оператора <code>SELECT</code></A> и see section <A HREF="manual.ru_MySQL_Database_Administration.html#BACKUP_TABLE">4.4.2  Синтаксис <code>BACKUP TABLE</code></A>).

</P>
<P>
Существует еще один способ создать резервную копию базы данных -
использовать программу <code>mysqldump</code> или сценарий <code>mysqlhotcopy</code> (см. разделы
section <A HREF="manual.ru_MySQL_Database_Administration.html#mysqldump">4.8.5  <code>mysqldump</code>, Получение дампов данных и структуры таблицы</A> и see section <A HREF="manual.ru_MySQL_Database_Administration.html#mysqlhotcopy">4.8.6  <code>mysqlhotcopy</code>, Копирование баз данных и таблиц MySQL</A>).  Для этого нужно выполнить следующие действия:

</P>

<ol>
<LI>

Сделать полное резервное копирование баз данных:


<pre>
shell&#62; mysqldump --tab=/path/to/some/dir --opt --all

или

shell&#62; mysqlhotcopy database /path/to/some/dir
</pre>

Можно также просто скопировать табличные файлы (файлы <tt>`*.frm'</tt>, <tt>`*.MYD'</tt> и
<tt>`*.MYI'</tt>) в тот момент, когда сервер не проводит никаких обновлений. Этот
метод используется в сценарии <code>mysqlhotcopy</code>.

<LI>

<A NAME="IDX559"></A>
<A NAME="IDX560"></A>
Если <code>mysqld</code> выполняется, остановить его, и затем запустить с опцией
<code>--log-update[=file_name]</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Update_log">4.9.3  Журнал обновлений (update)</A>). В файлах журнала
обновлений находится информация, необходимая для того, чтобы повторить
в базе данных последовательность изменений, внесенных с момента
выполнения <code>mysqldump</code>.
</ol>

<P>
Если дело дошло до восстановления, сначала надо попробовать восстановить
таблицы с помощью <code>REPAIR TABLE</code> или <code>myisamchk -r</code> - это должно сработать в
99,9% случаев. Если <code>myisamchk</code> не даст результата, попробуйте применить
следующую процедуру (эти действия применимы только в случае, если MySQL
запускался с <code>--log-update</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Update_log">4.9.3  Журнал обновлений (update)</A>)):

</P>

<ol>
<LI>

Восстановите исходный вариант по копии, сделанной в <code>mysqldump</code>.

<LI>

Выполните следующую команду, чтобы повторить обновления из бинарного
журнала:


<pre>
shell&#62; mysqlbinlog hostname-bin.[0-9]* | mysql
</pre>

Если используется журнал обновлений, то можно применить:


<pre>
shell&#62; ls -1 -t -r hostname.[0-9]* | xargs cat | mysql
</pre>

</ol>

<P>
<code>ls</code> используется для того, чтобы расположить все файлы журнала обновлений в
правильном порядке.

</P>
<P>
Можно проводить избирательное резервное копирование посредством <code>SELECT *
INTO OUTFILE 'file_name' FROM tbl_name</code>, а восстановление - при помощи <code>LOAD
DATA INFILE 'file_name' REPLACE ...</code> Чтобы избежать повторения записей, в
таблице должен быть <code>первичный</code> или <code>уникальный ключ</code>. Ключевое слово <code>REPLACE</code>
задает замену старых записей новыми в случае, когда новая запись в
значении уникального ключа повторяет старую.

</P>
<P>
Если в системе, где выполняется резервное копирование, возникают проблемы
с производительностью, то решить их можно, установив репликацию и выполняя
резервное копирование на подчиненном сервере вместо головного (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Replication_Intro">4.10.1  Введение</A>).

</P>
<P>
Пользователи файловой системы Veritas могут поступить следующим образом:

</P>

<ol>
<LI>

Из  клиента (или Perl) выполнить: <code>FLUSH TABLES WITH READ LOCK</code>.

<LI>

Из другого shell выполнить: <code>mount vxfs snapshot</code>.

<LI>

Из первого клиента выполнить: <code>UNLOCK TABLES</code>.

<LI>

Скопировать файлы из образа.

<LI>

Демонтировать образ.
</ol>



<H3><A NAME="BACKUP_TABLE" HREF="manual.ru_toc.html#BACKUP_TABLE">4.4.2  Синтаксис <code>BACKUP TABLE</code></A></H3>

<P>
<A NAME="IDX561"></A>

</P>
<P>
<A NAME="IDX562"></A>

</P>

<pre>
BACKUP TABLE tbl_name[,tbl_name...] TO '/path/to/backup/directory'
</pre>

<P>
Копирует в каталог резервного копирования тот минимум табличных файлов, который
достаточен для восстановления таблицы, после сброса на диск всех изменений. На
данный момент работает только для таблиц <code>MyISAM</code>. Для таблиц
<code>MyISAM</code> копирует файлы <tt>`.frm'</tt> (определений) и <tt>`.MYD'</tt> (данных).
Индексные файлы могут быть реконструированы по этим двум.

</P>
<P>
Перед использованием этой команды, пожалуйста, ознакомьтесь с разделом
See section <A HREF="manual.ru_MySQL_Database_Administration.html#Backup">4.4.1  Резервное копирование баз данных</A>.

</P>
<P>
В процессе резервного копирования будет установлена блокировка  чтения
отдельно для каждой таблицы на время ее копирования. Если необходимо
сделать резервное копирование в виде мгновенного образа нескольких таблиц,
необходимо сначала запросить <code>LOCK TABLES</code> установки блокировки  чтения для
каждой таблицы в группе.

</P>
<P>
Команда возвращает таблицу со следующими столбцами:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Столбец</strong> </TD><TD> <strong>Значение</strong>
</TD></TR>
<TR><TD>Table </TD><TD> Имя таблицы
</TD></TR>
<TR><TD>Op </TD><TD> Всегда ``backup''
</TD></TR>
<TR><TD>Msg_type </TD><TD> Одно  из  значений <code>status</code>, <code>error</code>, <code>info</code> или <code>warning</code>.
</TD></TR>
<TR><TD>Msg_text </TD><TD> Само сообщение.
</TD></TR>
</TABLE>

<P>
Заметим, что <code>BACKUP TABLE</code> доступна только в версии MySQL 3.23.25 и выше.

</P>


<H3><A NAME="RESTORE_TABLE" HREF="manual.ru_toc.html#RESTORE_TABLE">4.4.3  Синтаксис <code>RESTORE TABLE</code></A></H3>

<P>
<A NAME="IDX563"></A>

</P>

<pre>
RESTORE TABLE tbl_name[,tbl_name...] FROM '/path/to/backup/directory'
</pre>

<P>
Восстанавливает таблицу(ы) из резервной копии, созданной с помощью <code>BACKUP
TABLE</code>. Существующие таблицы не перезаписываются: при попытке
восстановления поверх существующей таблицы будет выдана ошибка.
Восстановление занимает больше времени, нежели <code>BACKUP</code> - из-за
необходимости повторного построения индекса. Чем больше в таблице будет
ключей, тем больше времени заберет реконструкция. Эта команда, так же как
и <code>BACKUP TABLE</code>, в настоящее время работает только для таблиц <code>MyISAM</code>.

</P>
<P>
Команда возвращает таблицу со следующими столбцами:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Столбец</strong> </TD><TD> <strong>Значение</strong>
</TD></TR>
<TR><TD>Table </TD><TD> Имя таблицы
</TD></TR>
<TR><TD>Op </TD><TD> Всегда ``restore''
</TD></TR>
<TR><TD>Msg_type </TD><TD> Одно  из  значений <code>status</code>, <code>error</code>, <code>info</code> или <code>warning</code>.
</TD></TR>
<TR><TD>Msg_text </TD><TD> Само сообщение.
</TD></TR>
</TABLE>



<H3><A NAME="CHECK_TABLE" HREF="manual.ru_toc.html#CHECK_TABLE">4.4.4  Синтаксис <code>CHECK TABLE</code></A></H3>

<P>
<A NAME="IDX564"></A>

</P>

<pre>
CHECK TABLE tbl_name[,tbl_name...] [option [option...]]

option = QUICK | FAST | MEDIUM | EXTENDED | CHANGED
</pre>

<P>
<code>CHECK TABLE</code> работает только на таблицах <code>MyISAM</code> и <code>InnoDB</code>. На таблицах типа
<code>MyISAM</code> команда эквивалентна запуску на таблице <code>myisamchk -m table_name</code>.

</P>
<P>
Если опция не указана, используется <code>MEDIUM</code>.

</P>
<P>
Проверяет таблицу(ы) на наличие ошибок. Для таблиц <code>MyISAM</code> обновляется
статистика ключей. Команда возвращает таблицу со следующими столбцами:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Столбец</strong> </TD><TD> <strong>Значение</strong>
</TD></TR>
<TR><TD>Table </TD><TD> Имя таблицы.
</TD></TR>
<TR><TD>Op </TD><TD> Всегда ``check''.
</TD></TR>
<TR><TD>Msg_type </TD><TD> Одно из значений <code>status</code>, <code>error</code>, <code>info</code>, или <code>warning</code>.
</TD></TR>
<TR><TD>Msg_text </TD><TD> Само сообщение.
</TD></TR>
</TABLE>

<P>
Заметим, что по каждой проверяемой таблице может быть выдано много строк
информации. Последняя строка будет  представлять <code>Msg_type status</code> и, как
правило, должна содержать <code>OK</code>. Если выдается что-либо отличное от
<code>OK</code> и <code>Not checked</code>, то обычно следует провести ремонт таблицы
(see section <A HREF="manual.ru_MySQL_Database_Administration.html#Table_maintenance">4.4.6  Использование <code>myisamchk</code> для профилактики таблиц и послеаварийного</A>). <code>Table already up to date</code> свидетельствует о
том, что указанный для таблицы тип (<code>TYPE</code>) вернул информацию о том, что
таблица не нуждается в проверке.

</P>
<P>
Различные типы проверки означают следующее:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Тип</strong> </TD><TD> <strong>Действия</strong>
</TD></TR>
<TR><TD><code>QUICK</code> </TD><TD> Не сканировать строки для проверки на неправильные связи.
</TD></TR>
<TR><TD><code>FAST</code> </TD><TD> Проверять только таблицы, которые не были корректно закрыты.
</TD></TR>
<TR><TD><code>CHANGED</code> </TD><TD> Проверять только таблицы, которые изменились со времени последней
проверки или не были закрыты корректно.
</TD></TR>
<TR><TD><code>MEDIUM</code> </TD><TD> Сканировать строки для проверки того, что уничтоженные связи в                               порядке. При этом также подсчитывается ключевая контрольная сумма для                               строки и сравнивается с подсчитанной контрольной суммой для ключей.
</TD></TR>
<TR><TD><code>EXTENDED</code> </TD><TD> Выполнить полный просмотр ключа для всех ключей для каждой                                 строки. Успех такой проверки гарантирует 100%-ное отсутствие противоречий                           в таблице, но на проверку уйдет немало времени!
</TD></TR>
</TABLE>

<P>
Для таблиц <code>MyISAM</code> с динамическими размерами при запуске проверки всегда
выполняется проверка <code>MEDIUM</code>. Для строк со статическими размерами мы
пропускаем сканирование строк для <code>QUICK</code> и <code>FAST</code>, поскольку повреждение
строк происходит крайне редко.

</P>
<P>
Проверочные опции можно сочетать:

</P>

<pre>
CHECK TABLE test_table FAST QUICK;
</pre>

<P>
Эта команда просто вызовет быструю проверку таблицы для выявления того,
была ли она закрыта корректно.

</P>
<P>
<strong>Примечание</strong>: в некоторых случаях <code>CHECK TABLE</code> изменяет таблицу! Это
происходит, если таблица помечена как 'поврежденная/corrupted' или 'не
закрытая корректно/not closed properly', а <code>CHECK TABLE</code> не находит никаких
проблем в таблице. В этом случае <code>CHECK TABLE</code> отметит в таблице, что с ней
все нормально.

</P>
<P>
Если таблица повреждена, то, скорее всего, проблема в индексах, а не в
данных. Проверки всех типов обеспечивают всестороннюю проверку индексов и
тем самым должны обнаруживать большинство ошибок.

</P>
<P>
Если проверяется таблица, с которой предположительно все нормально, то
можно опустить проверочные опции или указать опцию <code>QUICK</code>. Последнюю
возможность следует использовать в случае ограничений по времени и тогда,
когда можно пойти на риск (очень незначительный), что <code>QUICK</code> пропустит
ошибку в файле данных. (В большинстве случаев MySQL должен найти - при
нормальной работе - любые ошибки в файле с данными. Если ошибки найдены,
то таблица будет отмечена как 'поврежденная/corrupted', и в таком случае
ее нельзя будет использовать, пока она не будет исправлена.)

</P>
<P>
<code>FAST</code> и <code>CHANGED</code> главным образом предназначены для использования в сценариях
(например, для запуска из <code>cron</code>), если необходимо время от времени
проверять таблицы. В большинстве случаев следует отдавать предпочтение
<code>FAST</code> перед <code>CHANGED</code> (иначе надо поступать только в случае, когда возникает
подозрение, что найдена ошибка в самом коде <code>MyISAM</code>).

</P>
<P>
Прибегать к <code>EXTENDED</code> следует только тогда, когда после выполнения
нормальной проверки для таблицы по-прежнему выдаются странные ошибки при
попытке MySQL обновить строку или найти строку по ключу (что очень
маловероятно в случае успеха нормальной проверки!).

</P>
<P>
Некоторые проблемы, о которых сообщается при проверке таблицы, нельзя
исправить автоматически:

</P>

<ul>
<LI>

<code>Found row where the auto_increment column has the value 0</code>.

Это означает, что в таблице есть строка, где индексированный столбец
<code>AUTO_INCREMENT</code> содержит значение 0 (строку, в которой столбец
<code>AUTO_INCREMENT</code> имеет значение 0, можно создать, явно установив столбец
в 0 командой <code>UPDATE</code>).

Это само по себе не является ошибкой, но может
вызвать неприятности, если понадобится сделать дамп таблицы или
восстановить ее или выполнить над ней <code>ALTER</code> TABLE. В этом случае
столбец с атрибутом <code>AUTO_INCREMENT</code> изменит значение в соответствии с
правилами для столбцов <code>AUTO_INCREMENT</code>, что может вызвать проблемы,
подобные ошибке дублирования ключа.

Чтобы избавиться от
предупреждения, просто выполните команду <code>UPDATE</code> для установки в
столбце значения, отличного от 0.
</ul>



<H3><A NAME="REPAIR_TABLE" HREF="manual.ru_toc.html#REPAIR_TABLE">4.4.5  Синтаксис <code>REPAIR TABLE</code></A></H3>

<P>
<A NAME="IDX565"></A>

</P>

<pre>
REPAIR TABLE tbl_name[,tbl_name...] [QUICK] [EXTENDED] [USE_FRM]
</pre>

<P>
<code>REPAIR TABLE</code> работает только на таблицах типа <code>MyISAM</code> и эквивалентна
выполнению на таблице <code>myisamchk -r table_name</code>.

</P>
<P>
При обыкновенной работе запускать эту команду не приходится, но если
случится катастрофа, то с помощью <code>REPAIR TABLE</code> практически наверняка
удастся вернуть все данные из таблицы <code>MyISAM</code>. Если таблицы сильно
повреждены, то следует постараться выяснить, что послужило этому причиной!
Обращайтесь к разделам section <A HREF="manual.ru_Problems.html#Crashing">A.4.1  Что делать, если работа MySQL сопровождается постоянными сбоями</A> и See section <A HREF="manual.ru_Table_types.html#MyISAM_table_problems">7.1.3  Проблемы с таблицами <code>MyISAM</code>.</A>.

</P>
<P>
<code>REPAIR TABLE</code> ремонтирует таблицу, которая, возможно, повреждена. Команда
возвращает таблицу со следующими столбцами:
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Столбец</strong> </TD><TD> <strong>Значение</strong>
</TD></TR>
<TR><TD>Table </TD><TD> Имя таблицы
</TD></TR>
<TR><TD>Op </TD><TD> Всегда ``repair''
</TD></TR>
<TR><TD>Msg_type </TD><TD> Одно из значений <code>status</code>, <code>error</code>, <code>info</code> или <code>warning</code>.
</TD></TR>
<TR><TD>Msg_text </TD><TD> Само сообщение.
</TD></TR>
</TABLE>

</P>
<P>
Заметим, что по каждой ремонтируемой таблице может быть выдано много строк
информации. Последняя строка будет представлять <code>Msg_type status</code> и, как
правило, должна содержать <code>OK</code>. Если выдается что-либо отличное от <code>OK</code>, то
следует попробовать исправить таблицу с помощью <code>myisamchk -o</code>, поскольку в
<code>REPAIR TABLE</code> пока реализованы не все опции <code>myisamchk</code>. В скором будущем мы
сделаем команду более гибкой.

</P>
<P>
Если указан <code>QUICK</code>, то MySQL будет пытаться сделать <code>REPAIR</code> только
индексного дерева.

</P>
<P>
Если используется <code>EXTENDED</code>, то MySQL будет создавать индекс строка за
строкой вместо создания по одному индексу единоразово с помощью
сортировки; такая техника может работать лучше сортировки для ключей
фиксированной длины, если речь идет о хорошо сжимаемых ключах типа <code>CHAR</code> 
большой длины. Это такой же ремонт, как делается с помощью <code>myisamchk --safe-recover</code>.

</P>
<P>
Что касается MySQL 4.0.2, то тут для <code>REPAIR</code> существует режим <code>USE_FRM</code>.
Используйте его, если отсутствует файл <tt>`.MYI'</tt> или поврежден его заголовок. В
этом режиме MySQL воссоздаст таблицу, используя информацию из файла <tt>`.frm'</tt>.
Этот вид исправления в <code>myisamchk</code> недоступен.

</P>


<H3><A NAME="Table_maintenance" HREF="manual.ru_toc.html#Table_maintenance">4.4.6  Использование <code>myisamchk</code> для профилактики таблиц и послеаварийного</A></H3>
<P>
восстановления

</P>
<P>
Начиная с версии MySQL 3.23.13 таблицы <code>MyISAM</code> можно проверять с помощью
команды <code>CHECK TABLE</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#CHECK_TABLE">4.4.4  Синтаксис <code>CHECK TABLE</code></A>). Для исправления
таблиц используется команда <code>REPAIR TABLE</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#REPAIR_TABLE">4.4.5  Синтаксис <code>REPAIR TABLE</code></A>).

</P>
<P>
Для проверки/ремонта таблиц типа <code>MyISAM</code> (<tt>`.MYI'</tt> и <tt>`.MYD'</tt>) следует использовать
утилиту <code>myisamchk</code>, а для <code>ISAM</code> (<tt>`.ISM'</tt> и <tt>`.ISD'</tt>') - утилиту <code>isamchk</code> (see section <A HREF="manual.ru_Table_types.html#Table_types">7  Типы  таблиц MySQL</A>).

</P>
<P>
Ниже мы будем говорить о <code>myisamchk</code>, но все сказанное справедливо также и
для более старой <code>isamchk</code>.

</P>
<P>
Утилиту <code>myisamchk</code> можно использовать для получения информации о таблицах
рабочей базы данных, для их проверки и исправления или же оптимизации. В
следующих разделах описывается, как запускать <code>myisamchk</code> (включая описание
ее опций), как настроить график профилактики таблицы и как использовать
myisamchk для выполнения различных функций.

</P>
<P>
В большинстве случаев для оптимизации и исправления таблиц можно также
использовать команду <code>OPTIMIZE</code> TABLES, но этот вариант не такой быстрый и
не такой надежный (в случае действительно фатальных ошибок), как
<code>myisamchk</code>. С другой стороны, <code>OPTIMIZE TABLE</code> проще в использовании и
освобождает от забот со сбросом таблиц на диск (see section <A HREF="manual.ru_MySQL_Database_Administration.html#OPTIMIZE_TABLE">4.5.1  Синтаксис  команды <code>OPTIMIZE TABLE</code></A>).

</P>
<P>
Хотя исправление при помощи <code>myisamchk</code> и достаточно безопасно, никогда не
будет лишним сделать резервную копию прежде, чем выполнять ремонт (или
любые другие действия, которые могут привнести в таблицу значительные
изменения)

</P>



<H4><A NAME="myisamchk_syntax" HREF="manual.ru_toc.html#myisamchk_syntax">4.4.6.1  Синтаксис запуска <code>myisamchk</code></A></H4>

<P>
<code>myisamchk</code> запускается следующим образом:

</P>

<pre>
shell&#62; myisamchk [options] tbl_name
</pre>

<P>
Опции options определяют, что должна сделать <code>myisamchk</code>. В данном разделе
дается описание этих опций (список опций можно также получить, запустив
<code>myisamchk --help</code>). Если опции не указаны, <code>myisamchk</code> просто проверяет
таблицу. Чтобы получить дополнительную информацию или указать <code>myisamchk</code>
выполнить корректирующие действия, надо задать опции, как это описано в
этом и в следующих разделах.

</P>
<P>
<code>tbl_name</code> - это таблица базы данных, которую нужно проверить/исправить.
Если <code>myisamchk</code> запускается не из каталога базы данных, то следует задать
путь к файлу, поскольку <code>myisamchk</code> не имеет представления о том, где искать
базу данных. В действительности для <code>myisamchk</code> не важно, где находятся
рабочие файлы - в каталоге базы данных или нет; можно скопировать файлы,
относящиеся к базе данных, в другое место и выполнить операции
восстановления над ними там.

</P>
<P>
При желании в командной строке <code>myisamchk</code> можно перечислить имена
нескольких таблиц. В качестве имени можно также указать имя индексного
файла (с суффиксом <tt>`.MYI'</tt>), что позволит задавать все таблицы в каталоге при
помощи шаблона <tt>`*.MYI'</tt>. Например, находясь в каталоге базы данных, можно
проверить все таблицы этого каталога следующим образом:

</P>

<pre>
shell&#62; myisamchk *.MYI
</pre>

<P>
Если каталог базы данных не является текущим, то все таблицы каталога
можно проверить, указав к нему путь:

</P>

<pre>
shell&#62; myisamchk /path/to/database_dir/*.MYI
</pre>

<P>
Можно даже проверить все таблицы во всех базах данных, если задать шаблон
вместе с путем к каталогу данных MySQL:

</P>

<pre>
shell&#62; myisamchk /path/to/datadir/*/*.MYI
</pre>

<P>
Быстро проверять все таблицы рекомендуется следующим образом:

</P>

<pre>
myisamchk --silent --fast /path/to/datadir/*/*.MYI
isamchk --silent /path/to/datadir/*/*.ISM
</pre>

<P>
Если необходимо проверить все таблицы и исправить все поврежденные из них,
можно использовать следующую строку:

</P>

<pre>
myisamchk --silent --force --fast --update-state -O key_buffer=64M \
	  -O sort_buffer=64M -O read_buffer=1M -O write_buffer=1M \
	  /path/to/datadir/*/*.MYI
isamchk --silent --force -O key_buffer=64M -O sort_buffer=64M \
	-O read_buffer=1M -O write_buffer=1M /path/to/datadir/*/*.ISM
</pre>

<P>
Эти команды предполагают, что имеется более чем 64 Mб свободного
пространства.

</P>
<P>
Следует отметить, что если выдается ошибка, подобная следующей:

</P>

<pre>
myisamchk: warning: 1 clients is using or hasn't closed the table properly
</pre>

<P>
то это означает, что делается попытка проверить таблицу, обновленную
другой программой (такой как <code>mysqld</code>), которая еще не закрыла файл или чье
выполнение было прервано без возможности корректно закрыть файл.

</P>
<P>
Если <code>mysqld</code> запущен, то необходимо принудительно вызвать
синхронизацию/закрытие всех таблиц с помощью <code>FLUSH TABLES</code> и обеспечить,
чтобы никто не использовал таблиц, пока выполняется <code>myisamchk</code>. В версии
MySQL 3.23 самый простой способ избежать этой проблемы заключается в
применении для проверки таблиц команды <code>CHECK TABLE</code> вместо <code>myisamchk</code>.

</P>


<H4><A NAME="myisamchk_general_options" HREF="manual.ru_toc.html#myisamchk_general_options">4.4.6.2  Общие опции для <code>myisamchk</code></A></H4>

<P>
<A NAME="IDX566"></A>
<A NAME="IDX567"></A>
<A NAME="IDX568"></A>
<A NAME="IDX569"></A>

</P>
<P>
<code>myisamchk</code> поддерживает следующие опции.

</P>
<DL COMPACT>

<DT><code>-# или --debug=debug_options</code>
<DD>
Вывод отладочной информации. Часто строка <code>debug_options</code> имеет следующий
вид <code>d:t:o,filename</code>.
<DT><code>-? или --help</code>
<DD>
Отображение справочного сообщения с завершением работы.
<DT><code>-O var=option, --set-variable var=option</code>
<DD>
Устанавливает значение переменной.  Внимание:  <code>--set-variable</code>
морально устарела в MySQL 4.0, просто используйте <code>--var=option</code>.
Вывести список допустимых переменных и
их значений по умолчанию для <code>myisamchk</code> можно с помощью <code>myisamchk --help</code>:

<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Переменная</strong> </TD><TD> <strong>Значение</strong>
</TD></TR>
<TR><TD>key_buffer_size </TD><TD> 523264
</TD></TR>
<TR><TD>read_buffer_size </TD><TD> 262136
</TD></TR>
<TR><TD>write_buffer_size </TD><TD> 262136
</TD></TR>
<TR><TD>sort_buffer_size </TD><TD> 2097144
</TD></TR>
<TR><TD>sort_key_blocks </TD><TD> 16
</TD></TR>
<TR><TD>decode_bits </TD><TD> 9
</TD></TR>
</TABLE>

<code>sort_buffer_size</code> применяется, когда ключи исправляются посредством
сортировки ключей (обычный случай при указании <code>--recover</code>), а
<code>key_buffer_size</code> - если таблица проверяется с <code>--extended-check</code> или если
ключи исправляются посредством вставки ключей в таблицу построчно (как при
выполнении обычных вставок). Исправление через ключевой буфер применяется
в следующих случаях:


<ul>
<LI>

Если используется <code>--safe-recover</code>.
<LI>

Если размер требуемых для сортировки временных файлов будет более чем
вдвое превышать объем, требующийся при создании ключевого файла
непосредственно. Так часто обстоит дело, когда присутствуют большие ключи
типов <code>CHAR</code>, <code>VARCHAR</code> или <code>TEXT</code>, поскольку при сортировке необходимо
сохранять ключи целиком. Имея временное пространство на диске в избытке,
можно заставить <code>myisamchk</code> делать исправления посредством сортировки, задав
опцию <code>--sort-recover</code>.
</ul>

Ремонт посредством ключевого буфера требует значительно меньше
пространства, чем при использовании сортировки, однако выполняется
значительно медленнее. Когда желательно ускорить выполнение
ремонта/исправления, переменные нужно установить равными приблизительно
1/4 доступной памяти. Можно для обеих переменных задавать большие
значения, поскольку всякий раз будет использоваться только один из
рассматриваемых буферов.

<DT><code>-s или --silent</code>
<DD>
Молчаливый режим. Выдавать сообщения только при возникновении ошибок.
Можно использовать <code>-s</code> дважды (<code>-ss</code>), чтобы предельно ограничить выдачу
сообщений утилитой <code>myisamchk</code>.
<DT><code>-v или --verbose</code>
<DD>
Расширенный режим вывода. Выдается больше информации. Можно использовать с
<code>-d</code> и <code>-e</code>. Можно использовать <code>-v</code> многократно (<code>-vv</code>, <code>-vvv</code>) - чтобы еще более
расширить сводку!
<DT><code>-V или --version</code>
<DD>
Отображение версии <code>myisamchk</code> и завершение работы.
<DT><code>-w или, --wait</code>
<DD>
Если таблица заблокирована, то не выдавать ошибки, а, дождавшись снятия
блокировки с таблицы, продолжить выполнение. Заметим, что если <code>mysqld</code>
выполняется на таблице с <code>--skip-external-locking</code>, то таблица может быть
заблокирована только другой командой <code>myisamchk</code>.
</DL>



<H4><A NAME="myisamchk_check_options" HREF="manual.ru_toc.html#myisamchk_check_options">4.4.6.3  Проверочные опции для <code>myisamchk</code></A></H4>

<P>
<A NAME="IDX570"></A>
<A NAME="IDX571"></A>

</P>
<DL COMPACT>

<DT><code>-c или --check</code>
<DD>
Проверить таблицы на ошибки. Является операцией по умолчанию, если
<code>myisamchk</code> не передаются другие опции, меняющие это поведение.
<DT><code>-e или --extend-check</code>
<DD>
Проверить таблицу очень тщательно (выполняется достаточно медленно в
случае большого количества индексов). Эту опцию следует использовать в
экстремальных ситуациях. В большинстве случаев <code>myisamchk</code> или <code>myisamchk</code>
<code>--medium-check</code> вполне достаточно для выявления ошибок в таблице. Если
используется <code>--extended-check</code> и система располагает приличным объемом
памяти, то следует значительно увеличить значение <code>key_buffer_size</code>!
<DT><code>-F или --fast</code>
<DD>
Проверять только таблицы, которые не были корректно закрыты.
<DT><code>-C или --check-only-changed</code>
<DD>
Проверять только таблицы, изменившиеся с момента последней проверки.
<DT><code>-f или --force</code>
<DD>
Выполнять перезапуск <code>myisamchk</code> с <code>-r</code> (исправить) на таблице, если <code>myisamchk</code>
найдет в ней хоть одну ошибку.
<DT><code>-i или --information</code>
<DD>
Выдавать статистическую информацию о проверяемой таблице.
<DT><code>-m или --medium-check</code>
<DD>
Быстрее, чем расширенная проверка (<code>extended-check</code>), но при этом
обнаруживается только 99,99% из общего числа ошибок (чего, однако, в
большинстве случаев вполне достаточно).
<DT><code>-U или --update-state</code>
<DD>
Отмечать в файле <tt>`.MYI'</tt> факт проверки таблицы и наличие повреждений. Опцию
следует использовать для получения максимального эффекта от опции
<code>--check-only-changed</code>, однако ее применение недопустимо, если <code>mysqld</code>
работает с таблицей и был запущен с опцией <code>--skip-external-locking</code>.
<DT><code>-T или --read-only</code>
<DD>
Не отмечать таблицу как проверенную. Это может пригодиться, когда
myisamchk используется для проверки таблиц, используемых каким-то другим
приложением, и это приложение не выполняет блокировку (как <code>mysqld
--skip-external-locking</code>).
</DL>



<H4><A NAME="myisamchk_repair_options" HREF="manual.ru_toc.html#myisamchk_repair_options">4.4.6.4  Опции исправления для <code>myisamchk</code></A></H4>

<P>
<A NAME="IDX572"></A>
<A NAME="IDX573"></A>

</P>
<P>
Следующие опции используются, если <code>myisamchk</code> запускается с <code>-r</code> или <code>-o</code>:

</P>
<DL COMPACT>

<DT><code></code>
<DD>
-D # или --data-file-length=#
Максимальная длина файла данных (когда файл данных пересоздается при его
``переполнении'').
<DT><code></code>
<DD>
-e или --extend-check
Пробовать исправлять каждую возможную строку из файла данных. Обычно при
этом обнаруживается масса замусоренных строк. Использовать эту опцию
следует только в самом крайнем случае, когда больше ничего не остается.
<DT><code></code>
<DD>
-f или --force
Писать поверх старых временных файлов (<tt>`table_name.TMD'</tt>) вместо аварийного
прекращения.
<DT><code></code>
<DD>
-k # или keys-used=#
Если используется <code>ISAM</code>, то данный параметр предписывает обработчику таблиц
<code>ISAM</code> на необходимость обновить только первые <code>#</code> индексов. Если используется
<code>MyISAM</code>, то определяет, какие ключи использовать, при этом каждый двоичный
бит соответствует одному ключу (первый ключ - это бит 0). Может
использоваться для ускорения вставок! Отключенные индексы можно снова
активизировать с помощью <code>myisamchk -r. keys</code>.
<DT><code></code>
<DD>
-l или --no-symlinks
Не рассматривать символические ссылки. Обычно <code>myisamchk</code> исправляет
таблицы, на которые указывают символические ссылки. Данная опция
отсутствует в MySQL 4.0, в связи с тем, что MySQL 4.0 не удаляет
символические ссылки во время восстановления.
<DT><code></code>
<DD>
-r или --recover
При указании этой опции можно исправить  практически все, кроме уникальных ключей, в которых есть повторения (ошибка, вероятность которой мизерна для таблиц <code>ISAM</code>/<code>MyISAM</code>). Если необходимо восстановить таблицу, то начинать надо с этой опции. Только если <code>myisamchk</code> сообщит, что таблица не может быть восстановлена с помощью <code>-r</code>, тогда следует пытаться применять <code>-o</code> 
(отметим, что в тех маловероятных случаях, когда <code>-r</code> не срабатывает, файл
данных остается неизменным), В случае большого объема памяти следует
увеличить размер <code>sort_buffer_size</code>!
<DT><code>-o или --safe-recover</code>
<DD>
Используется старый метод восстановления (читаются подряд все строки и
обновляются все деревья индексов на основе найденных строк); такой
алгоритм работает на порядок медленнее <code>-r</code>, но метод справляется с
несколькими редкими случаями, непосильными для <code>-r</code>. При этом методе
восстановления также используется значительно меньше дискового
пространства, нежели в случае <code>-r</code>. Обычно всегда следует начинать с
исправления посредством <code>-r</code>, и только если результат не будет достигнут,
использовать <code>-o</code>. Для систем с большим объемом памяти следует увеличить
размер <code>key_buffer_size</code>!
<DT><code>-n или --sort-recover</code>
<DD>
Заставляет <code>myisamchk</code> использовать сортировку при разрешении ключей, даже
если это потребует временных файлов очень большого размера.
<DT><code>--character-sets-dir=...</code>
<DD>
Каталог, где хранятся кодировки.
<DT><code>--set-character-set=name</code>
<DD>
Изменить используемую для индекса кодировку
<DT><code>-t или --tmpdir=path</code>
<DD>
Путь для хранения временных файлов. Если не задан, <code>myisamchk</code> использует
для пути переменную окружения <code>TMPDIR</code>.
Начиная с MySQL 4.1, в <code>TMPDIR</code> могут быть указаны несколько путей, разделенных
двоеточием <code>:</code> (точкой с запятой на Windows <code>;</code>). Эти пути будут 
использованы в ротации. Это используется для того, чтобы распределить
данные между разными физическими дисками. 
<DT><code>-q или --quick</code>
<DD>
Быстрый ремонт без изменения файла данных. Можно добавить вторую <code>-q</code>,
чтобы дать <code>myisamchk</code> санкцию на изменение исходного файла данных в случае
дублирования ключей
<DT><code>-u или --unpack</code>
<DD>
Распаковать файл, упакованный в <code>myisampack</code>.
</DL>



<H4><A NAME="myisamchk_other_options" HREF="manual.ru_toc.html#myisamchk_other_options">4.4.6.5  Другие опции для <code>myisamchk</code></A></H4>

<P>
Кроме ремонта и проверки таблиц, <code>myisamchk</code> может выполнять другие
операции:

</P>
<DL COMPACT>

<DT><code>-a или --analyze</code>
<DD>
Анализировать распределение ключей. Улучшает эффективность операции
связывания  за счет включения оптимизатора связей. Он обеспечивает лучший
порядок связывания таблиц и определяет, какие ключи при этом следует
использовать: <code>myisamchk --describe --verbose table_name</code> или посредством
<code>SHOW KEYS</code> в MySQL.
<DT><code>-d или --description</code>
<DD>
Отображает некоторую информацию о таблице.
<DT><code>-A или --set-auto-increment[=value]</code>
<DD>
Предписывает, чтобы отсчет значений <code>AUTO_INCREMENT</code> начинался с <code>value</code> или
большего значения. Если значение не указано, то в качестве следующего
значения <code>AUTO_INCREMENT</code> берется наибольшее использованное значение для
автоинкрементного ключа + 1.
<DT><code>-S или --sort-index</code>
<DD>
Сортировать блоки индексного дерева в порядке от больших к меньшим
(high-low). Этим оптимизируются операции поиска и повышается скорость
сканирования по ключу.
<DT><code>-R или --sort-records=#</code>
<DD>
Сортирует записи в соответствии с индексом. Это значительно повышает
локализацию данных и может ускорить операции <code>SELECT</code> и <code>ORDER BY</code>, которые
выполняются по индексу и выбирают данные по какому-либо интервалу.
(Возможно, что первая сортировка будет выполняться очень медленно!) Чтобы
узнать номера индексов таблицы, нужно использовать команду <code>SHOW INDEX</code>,
показывающую индексы таблицы в том же порядке, в каком их видит <code>myisamchk</code>.
Индексы нумеруются начиная с 1.
</DL>



<H4><A NAME="myisamchk_memory" HREF="manual.ru_toc.html#myisamchk_memory">4.4.6.6  Использование памяти утилитой <code>myisamchk</code></A></H4>

<P>
<A NAME="IDX574"></A>

</P>
<P>
При работе <code>myisamchk</code> очень важно распределение памяти. Объем используемой
<code>myisamchk</code> памяти не превышает количества, указанного с помощью опций <code>-O</code>.
Когда речь идет о применении <code>myisamchk</code> на очень больших файлах, следует
сначала принять решение о том, какое количество памяти будет при этом
использоваться. По умолчанию для целей исправления ошибок отводится только
около 3Mб. Применяя большие величины, можно достичь большей скорости
работы <code>myisamchk</code>. К примеру, если имеется более 32Mб оперативной памяти, 
то можно задать следующие опции (в дополнение к любым другим указанным опциям):

</P>

<pre>
shell&#62; myisamchk -O sort=16M -O key=16M -O read=1M -O write=1M ...
</pre>

<P>
В большинстве случаев достаточно использовать <code>-O sort=16M</code>.

</P>
<P>
Важно понимать, что <code>myisamchk</code> использует временные файлы, для указания на
которые служит <code>TMPDIR</code>. Если <code>TMPDIR</code> указывает на файловую систему с
размещением в памяти, то велика вероятность ошибок нехватки памяти (out of
memory). Если такое произойдет, то в <code>TMPDIR</code> следует поместить имя
некоторого другого каталога с большим пространством и перезапустить
<code>myisamchk</code>.

</P>
<P>
При выполнении ремонта <code>myisamchk</code> также понадобится большое количество
дискового пространства; :

</P>

<ul>
<LI>

Потребуется пространство порядка удвоенного размера файла - для
оригинала и копии файла данных. В этом пространстве нет необходимости,
когда исправление выполняется с <code>--quick</code>, поскольку в этом случае повторно
создается только индексный файл. Дополнительное место необходимо на том же
диске, где находится оригинальный файл записи!

<LI>

Необходимо место для нового индексного файла, заменяющего старый. В
начальной фазе выполнения старый индексный файл усекается, поэтому обычно
данный объем можно не учитывать. Место должно обеспечиваться на диске,
содержащем оригинальный индексный файл!

<LI>

При указании <code>--recover</code> или <code>--sort-recover</code> (но не в случае использования
<code>--safe-recover</code>) потребуется место для буфера сортировки:
(<code>largest_key + row_pointer_length)*number_of_rows * 2</code>.
Можно узнать длину ключей и <code>row_pointer_length</code> с помощью
<code>myisamchk -dv table</code>.
Это пространство выделяется на временном диске (который определяется при помощи <code>TMPDIR</code> либо
<code>--tmpdir=#</code>).
</ul>

<P>
Если возникнут проблемы в связи с нехваткой дискового пространства во
время исправления, можно попробовать использовать <code>--safe-recover</code> вместо
<code>--recover</code>.

</P>


<H4><A NAME="Crash_recovery" HREF="manual.ru_toc.html#Crash_recovery">4.4.6.7  Использование myisamchk для послеаварийного восстановления</A></H4>

<P>
<A NAME="IDX575"></A>
<A NAME="IDX576"></A>

</P>
<P>
При выполнении <code>mysqld</code> со <code>--skip-external-locking</code> (установка по умолчанию в
некоторых системах, подобных Linux) применение <code>myisamchk</code> для проверки
таблицы, когда она используется <code>mysqld</code>, не совсем безопасно. Если есть
уверенность, что никто не обратится к таблицам через <code>mysqld</code> во время
выполнения <code>myisamchk</code>, то достаточно до начала проверки таблиц выполнить
<code>mysqladmin flush-tables</code>, если нет - то на время проверки таблиц необходимо
приостановить <code>mysqld</code>. При запуске <code>myisamchk</code> в то время, когда <code>mysqld</code>
обновляет таблицы, может быть выдано предупреждение о повреждении таблицы
- даже в случае, если этого не произошло.

</P>
<P>
Если <code>--skip-external-locking</code> не используется, то проверять таблицы с помощью
<code>myisamchk</code> можно в любое время. Во время проверки все пытающиеся обновить
таблицу клиенты получат возможность сделать это, только дождавшись
готовности <code>myisamchk</code>.

</P>
<P>
Если <code>myisamchk</code> применяется для ремонта или оптимизации таблиц, то всегда
необходимо обеспечить отсутствие обращений сервера <code>mysqld</code> к таблице (это
также относится к случаю использования <code>--skip-external-locking</code>). Если <code>mysqld</code> не
может быть приостановлен, то до <code>myisamchk</code>, как минимум, надо выполнить
<code>mysqladmin flush-tables</code>. Таблицы могут быть повреждены, если сервер и
<code>myisamchk</code> обратятся к таблицам одновременно.

</P>
<P>
В данном разделе описывается, как выявлять повреждения данных в базах
данных MySQL и что делать с повреждениями дальше. Если таблица
повреждается часто, то надо постараться отыскать причину этих повреждений!
Обращайтесь к разделу See section <A HREF="manual.ru_Problems.html#Crashing">A.4.1  Что делать, если работа MySQL сопровождается постоянными сбоями</A>.

</P>
<P>
Причины повреждения таблиц рассматриваются также в разделе по таблицам
<code>MyISAM</code>. Обращайтесь к разделу See section <A HREF="manual.ru_Table_types.html#MyISAM_table_problems">7.1.3  Проблемы с таблицами <code>MyISAM</code>.</A>.

</P>
<P>
При выполнении послеаварийного восстановления важно понимать, что каждой
таблице <code>tbl_name</code> в базе данных соответствуют три файла в каталоге базы
данных:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Файл</strong> </TD><TD> <strong>Назначение</strong>
</TD></TR>
<TR><TD><tt>`tbl_name.frm'</tt> </TD><TD> Файл определения таблицы (формы)
</TD></TR>
<TR><TD><tt>`tbl_name.MYD'</tt> </TD><TD> Файл данных
</TD></TR>
<TR><TD><tt>`tbl_name.MYI'</tt> </TD><TD> Индексный файл
</TD></TR>
</TABLE>

<P>
Каждый из этих трех типов файлов ``имеет'' свои виды повреждений, но
наиболее часто проблемы возникают с файлами данных и индексными файлами.

</P>
<P>
Во время своей работы <code>myisamchk</code> построчно создает копию файла (данных)
<tt>`.MYD'</tt>. Стадия исправления завершается тем, что программа удаляет старый
файл <tt>`.MYD'</tt> и переименовывает новый путем присвоения ему имени исходного.
Если используется <code>--quick</code>, <code>myisamchk</code> не создает временного файла <tt>`.MYD'</tt>, а,
исходя из предположения, что файл <tt>`.MYD'</tt> правилен, только формирует новый
индексный файл, никак не меняя файл <tt>`.MYD'</tt>. Это безопасно, поскольку
<code>myisamchk</code> автоматически распознает, что файл <tt>`.MYD'</tt> запорчен, и в этом
случае прерывает исправление. Можно также задавать для <code>myisamchk</code> две опции
<code>--quick</code>. В этом случае <code>myisamchk</code> не прерывается аварийно по некоторым
ошибкам (таким как дублирование ключа), а пытается исправить их путем
модификации файла <tt>`.MYD'</tt>. Обычно использование двух опций <code>--quick</code> имеет
смысл только в случае, если свободного места на диске недостаточно для
выполнения нормального исправления. Тогда перед запуском <code>myisamchk</code> следует
по крайней мере выполнить резервное копирование.

</P>


<H4><A NAME="Check" HREF="manual.ru_toc.html#Check">4.4.6.8  Как проверять таблицы на ошибки</A></H4>

<P>
<A NAME="IDX577"></A>
<A NAME="IDX578"></A>
<A NAME="IDX579"></A>

</P>
<P>
Для проверки таблицы <code>MyISAM</code> используются следующие команды:

</P>
<DL COMPACT>

<DT><code>myisamchk tbl_name</code>
<DD>
Находит 99,99% всех ошибок. Не в состоянии отыскать повреждений,
затрагивающих только файл данных (которые весьма необычны). Если
необходимо только проверить таблицу, то обычно следует выполнить myisamchk
без опций либо с одной из опций -s или --silent.

<DT><code>myisamchk -m tbl_name</code>
<DD>
Находит 99,999% всех ошибок. Сначала на ошибки проверяются все индексные
элементы, а затем читаются все строки подряд. Программа вычисляет
контрольную сумму для всех ключей в строке и проверяет, совпадает ли она с
контрольной суммой в индексном дереве.

<DT><code>myisamchk -e tbl_name</code>
<DD>
В этом случае выполняется полная и тщательная проверка всех данных (<code>-e</code> 
означает ``расширенная проверка''). Происходит тестовое чтение каждого ключа
для каждой строки с целью контроля того, что ключи указывают на нужные
строки. Для большой таблицы с множеством ключей на это может потребоваться
много времени. <code>myisamchk</code> обычно останавливается после обнаружения первой
ошибки, но если желательно получить более подробную информацию, можно
добавить опцию <code>--verbose</code> (<code>-v</code>) - таким образом выполнение <code>myisamchk</code> будет
продолжаться вплоть до максимума в 20 ошибок. При нормальной работе
достаточно просто запустить <code>myisamchk</code> (без аргументов за исключением имени
таблицы).

<DT><code>myisamchk -e -i tbl_name</code>
<DD>
Аналогична предыдущей команде, но опция <code>-i</code> указывает <code>myisamchk</code>
дополнительно отображать некоторую статистическую информацию.
</DL>



<H4><A NAME="Repair" HREF="manual.ru_toc.html#Repair">4.4.6.9  Как ремонтировать таблицы</A></H4>

<P>
<A NAME="IDX580"></A>
<A NAME="IDX581"></A>

</P>
<P>
В данном разделе рассматривается только использование <code>myisamchk</code> на
таблицах <code>MyISAM</code> (расширения <tt>`.MYI'</tt> и <tt>`.MYD'</tt>). Если же в системе применяются
таблицы <code>ISAM</code> (расширения <tt>`.ISM'</tt> и <tt>`.ISD'</tt>), то следует пользоваться <code>isamchk</code>.

</P>
<P>
Начиная с версии MySQL 3.23.14 можно ремонтировать таблицы <code>MyISAM</code> при
помощи команды <code>REPAIR TABLE</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#REPAIR_TABLE">4.4.5  Синтаксис <code>REPAIR TABLE</code></A>).

</P>
<P>
К симптомам повреждения таблицы относятся неожиданные прерывания
выполнения запросов и появление следующих ошибок:

</P>

<ul>
<LI>

<tt>`tbl_name.frm'</tt> is locked against change (Файл  заблокирован  для 
изменений)
<LI>

Can't find file <tt>`tbl_name.MYI'</tt> (Errcode: ###) (Не  могу  найти  файл
<tt>`tbl_name.MYI'</tt> (Ошибка: ###))
<LI>

Unexpected end of file (Неожиданно  наступил  конец)
<LI>

Record file is crashed (Файл  записей  испорчен)
<LI>

Got error ### from table handler (Получена  ошибка ### от  дескриптора 
таблицы). Для получения более подробной информации об ошибке можно
выполнить <code>perror</code> ###. Чаще всего о проблемах с таблицей свидетельствуют
следующие ошибки:

<pre>
shell&#62; perror 126 127 132 134 135 136 141 144 145
126 = Index file is crashed / Wrong file format
127 = Record-file is crashed
132 = Old database file
134 = Record was already deleted (or record file crashed)
135 = No more room in record file
136 = No more room in index file
141 = Duplicate unique key or constraint on write or update
144 = Table is crashed and last repair failed
145 = Table was marked as crashed and should be repaired
</pre>

Заметим, что ошибка 135 - 'no more room in record file' ('не осталось места в
файле записей'), не может быть исправлена просто выполнением ремонта. В
этом случае необходимо использовать следующую команду:


<pre>
ALTER TABLE table MAX_ROWS=xxx AVG_ROW_LENGTH=yyy;
</pre>

</ul>

<P>
В других случаях следует выполнять ремонт таблиц. <code>myisamchk</code> обычно может
обнаружить и исправить большинство неполадок.

</P>
<P>
Процесс ремонтирования включает до четырех описанных здесь стадий. Перед
тем как приступить к ремонту, необходимо выполнить <tt>`cd'</tt> в каталог базы
данных и проверить права доступа к табличным файлам. Файлы должны быть
доступны для чтения Unix-пользователю, от имени которого выполняется
<code>mysqld</code>, (а также выполняющему ремонт, поскольку ему приходится обращаться
к проверяемым файлам). Если появится необходимость изменять файлы, то
проверяющий также должен иметь доступ для записи.

</P>
<P>
Если используется версия MySQL 3.23.16 и выше, то для проверки и ремонта
таблиц <code>MyISAM</code> можно (и нужно) использовать команды <code>CHECK</code> и <code>REPAIR</code> (section <A HREF="manual.ru_MySQL_Database_Administration.html#CHECK_TABLE">4.4.4  Синтаксис <code>CHECK TABLE</code></A> и see section <A HREF="manual.ru_MySQL_Database_Administration.html#REPAIR_TABLE">4.4.5  Синтаксис <code>REPAIR TABLE</code></A>).

</P>
<P>
Раздел руководства, посвященный сопровождению таблиц, содержит опции к
<code>isamchk</code>/<code>myisamchk</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Table_maintenance">4.4.6  Использование <code>myisamchk</code> для профилактики таблиц и послеаварийного</A>).

</P>
<P>
Случаи, когда упомянутые команды не дают результата или желательно
использовать расширенные возможности, представленные в <code>isamchk</code>/<code>myisamchk</code>,
рассматриваются в следующем разделе.

</P>
<P>
Если ремонт таблицы планируется выполнять из командной строки то сначала
требуется остановить сервер. Следует отметить, что при выполнении
<code>mysqladmin shutdown</code> с удаленного сервера <code>mysqld</code> все еще будет некоторое
время работать после завершения <code>mysqladmin</code>, пока не будут остановлены все
запросы и сброшены на диск все ключи.

</P>
<P>
<strong>Стадия 1: проверка таблиц</strong>

</P>
<P>
Выполните <code>myisamchk *.MYI</code> или, если вы располагаете временем, <code>myisamchk -e
*.MYI</code>. Используйте опцию <code>-s</code> (молчаливый режим) для подавления ненужной
информации.

</P>
<P>
Если <code>mysqld</code> остановлен, то следует использовать опцию <code>--update-state</code> для
указания <code>myisamchk</code> отмечать таблицы как 'проверенные'(checked).

</P>
<P>
Ремонтировать следует только те таблицы, для которых <code>myisamchk</code> выдала
ошибки. Для таких таблиц следует перейти к стадии 2.

</P>
<P>
Если во время проверки будут получены странные ошибки (подобные out of
memory), или <code>myisamchk</code> завершится аварийно, то перейдите к стадии 3.

</P>
<P>
<strong>Стадия 2: легкий безопасный ремонт</strong>

</P>
<P>
Примечание: если есть желание ускорить ремонт, рекомендуется добавить: <code>-O
sort_buffer=# -O key_buffer=#</code> (где # примерно 1/4 от имеющейся памяти) во
всех командах <code>isamchk</code>/<code>myisamchk</code>.

</P>

<P>
Сначала надо попробовать запустить <code>myisamchk -r -q tbl_name</code> (<code>-r -q</code> 
означает "режим быстрого восстановления"). При этом будет сделана попытка
исправить индексный файл без изменения файла данных. Если в файле данных
содержится все необходимое, а удаленные связи указывают на правильные
позиции в файле данных, то команда должна дать результат и таблица будет
исправлена. Перейдите к ремонту следующей таблицы. В противном случае
следует выполнить следующие действия:

</P>

<ol>
<LI>

Сделать резервную копию файла данных.

<LI>

Использовать <code>myisamchk -r tbl_name</code> (<code>-r</code> означает "режим
восстановления"). При этом из файла данных будут удалены некорректные
и уничтоженные записи, и будет заново создан индексный файл.

<LI>

Если на предыдущем шаге проблему решить не удастся, то используйте
<code>myisamchk --safe-recover tbl_name</code>. В режиме безопасного восстановления
используется старый метод восстановления, справляющийся с некоторыми
случаями, которые оказываются не под силу для режима обычного
исправления (но работает этот метод медленнее).
</ol>

<P>
Если во время проверки будут получены странные ошибки (подобные out of
memory) или <code>myisamchk</code> аварийно завершается, то перейдите к стадии 3.

</P>
<P>
<strong>Стадия 3: сложный ремонт</strong>

</P>
<P>
До этой стадии дело доходит, только если первый 16-килобайтный блок в
индексном файле разрушен или содержит неверную информацию, либо когда
индексный файл отсутствует. В этом случае необходимо создать новый
индексный файл. Необходимо выполнить следующие действия:

</P>

<ol>
<LI>

Переместить файл данных в какое-нибудь безопасное место.

<LI>

Использовать файл описания таблицы для создания новых (пустых) файлов
- данных и индексного:


<pre>
shell&#62; mysql db_name
mysql&#62; SET AUTOCOMMIT=1;
mysql&#62; TRUNCATE TABLE table_name;
mysql&#62; quit
</pre>

Если используемая версия SQL не располагает <code>TRUNCATE TABLE</code>, то взамен
используется <code>DELETE FROM table_name</code>.

<LI>

Скопируйте старый файл данных на место недавно созданного (делать
перемещение старого файла обратно на место нового нецелесообразно,
поскольку в старом файле может снова возникнуть потребность, если
что-то пойдет не так).
</ol>

<P>
Вернитесь к стадии 2. <code>myisamchk -r -q</code> теперь должна сработать (но
бесконечно повторять стадии не следует).

</P>
<P>
Что касается MySQL 4.0.2, то тут можно воспользоваться <code>REPAIR ... USE_FRM</code>,
выполняющей всю эту процедуру автоматически.

</P>
<P>
<strong>Стадия 4: очень сложный ремонт</strong>

</P>
<P>
До этой стадии вы дойдете только в случае, если ко всему прочему запорчен
и файл описания. Такого происходить не должно, поскольку файл описания
после создания таблицы не изменяется. Выполните следующие действия:

</P>

<ol>
<LI>

Восстановите файл описания из резервной копии и перейдите к стадии 3.
Можно также восстановить индексный файл и вернуться к стадии 2. Во
втором случае начинать надо с <code>myisamchk -r</code>.

<LI>

Если резервной копии нет, но точно известно, как таблица создавалась,
то создается копия таблицы в другой базе данных. Новый файл данных
удаляется, затем файл описания с индексным файлом перемещаются из
другой базы данных в поврежденную. Таким образом вы получаете новый
файл описания и индексный файл, не затрагивая при этом файла данных.
Делается возврат к стадии 2 с попыткой воссоздать индексный файл.
</ol>



<H4><A NAME="Optimisation" HREF="manual.ru_toc.html#Optimisation">4.4.6.10  Оптимизация  таблиц</A></H4>

<P>
<A NAME="IDX582"></A>
<A NAME="IDX583"></A>

</P>
<P>
Чтобы объединить фрагментированные записи и избавиться от потерь
пространства, происходящих из-за удаления и обновления записей, нужно
запустить <code>myisamchk</code> в режиме восстановления:

</P>

<pre>
shell&#62; myisamchk -r tbl_name
</pre>

<P>
Такую же оптимизацию таблицы можно произвести, используя команду SQL
<code>OPTIMIZE TABLE</code>. <code>OPTIMIZE TABLE</code> выполняет ремонт таблицы и анализ ключей, а
также сортирует дерево индексов для ускорения  поиска ключей. Вдобавок
сводится на нет нежелательное взаимодействие между утилитой и сервером,
поскольку при использовании <code>OPTIMIZE TABLE</code> работу выполняет сам сервер.
Обращайтесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#OPTIMIZE_TABLE">4.5.1  Синтаксис  команды <code>OPTIMIZE TABLE</code></A>.

</P>
<P>
<code>myisamchk</code> также располагает рядом других опций, которые можно использовать
для повышения производительности таблицы:

</P>

<ul>
<LI><code>-S</code>, <code>--sort-index</code>

<LI><code>-R index_num</code>, <code>--sort-records=index_num</code>

<LI><code>-a</code>, <code>--analyze</code>

</ul>

<P>
Полное  описание опций можно найти в разделе See section <A HREF="manual.ru_MySQL_Database_Administration.html#myisamchk_syntax">4.4.6.1  Синтаксис запуска <code>myisamchk</code></A>.

</P>


<H3><A NAME="Maintenance_regimen" HREF="manual.ru_toc.html#Maintenance_regimen">4.4.7  Настройка режима профилактики таблиц</A></H3>

<P>
<A NAME="IDX584"></A>
<A NAME="IDX585"></A>

</P>
<P>
Начиная с версии MySQL 3.23.13 можно проверять таблицы типа <code>MyISAM</code> с
помощью команды <code>CHECK TABLE</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#CHECK_TABLE">4.4.4  Синтаксис <code>CHECK TABLE</code></A>). Для ремонта
таблиц можно использовать команду <code>REPAIR TABLE</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#REPAIR_TABLE">4.4.5  Синтаксис <code>REPAIR TABLE</code></A>).

</P>
<P>
Целесообразно выполнять регулярные проверки таблиц, не дожидаясь появления
проблем. В целях профилактики для проверки таблиц  можно использовать
<code>myisamchk -s</code>. Опция <code>-s</code> (сокращение для <code>--silent</code>) задает выполнение
<code>myisamchk</code> в молчаливом режиме с выдачей сообщений только при возникновении
ошибок.

</P>
<P>
<A NAME="IDX586"></A>
Не стоит сбрасывать со счетов и выполнение проверки таблиц при запуске
сервера. Например, всякий раз, когда во время обновления происходит
перезагрузка, необходима проверка всех таблиц, которые могли при этом
пострадать (назовем их "потенциально поврежденными таблицами"). В
<code>safe_mysqld</code> можно добавить тест, запускающий <code>myisamchk</code> для проверки всех
таблиц, измененных за последние 24 часа, в случае, если после перезагрузки
остался старый файл <tt>`.pid'</tt> (ID процесса) (<code>mysqld</code> создает <tt>`.pid'</tt>-файл во время
запуска и удаляет его при нормальном завершении; наличие <tt>`.pid'</tt>-файла во
время запуска системы свидетельствует о том, что mysqld не завершился
нормально).

</P>
<P>
Можно сделать даже более надежный тест - выполнить проверку таблиц с более
поздней, чем у <tt>`.pid'</tt>-файла, датой последней модификации.

</P>
<P>
Таблицы также следует регулярно проверять в ходе нормального
функционирования системы. У себя в <code>MySQL AB</code> мы запускаем задачи по <code>cron</code>
для проверки всех наших важных таблиц раз в неделю, используя следующую
строку в файле <code>crontab</code>:

</P>

<pre>
35 0 * * 0 /path/to/myisamchk --fast --silent /path/to/datadir/*/*.MYI
</pre>

<P>
Такая команда отображает информацию о поврежденных таблицах, и мы при
надобности можем их исследовать и исправить.

</P>
<P>
Поскольку за последние пару лет у нас (на самом деле) не было неожиданно
поврежденных таблиц (таблиц, получивших повреждение по причинам, отличным
от неисправностей оборудования), то для нас проверки один раз в неделю
более чем достаточно.

</P>
<P>
Мы рекомендуем для начала выполнять <code>myisamchk -s</code> еженощно на всех
таблицах, обновленных на протяжении последних 24 часов, пока вы не станете
доверять MySQL настолько, насколько доверяем мы.

</P>
<P>
<A NAME="IDX587"></A>
Обычно в таком контроле над таблицами MySQL необходимости нет. При
изменении таблиц с динамическим размером строк (таблиц со столбцами типов
<code>VARCHAR</code>, <code>BLOB</code> или <code>TEXT</code>) или при наличии таблиц с большим числом удаленных
строк может потребоваться время от времени (где-то раз в месяц)
дефрагментировать таблицы.

</P>
<P>
Это можно сделать, используя <code>OPTIMIZE TABLE</code> на аналогичных таблицах, или,
если есть возможность приостановить <code>mysqld</code>, выполняя:

</P>

<pre>
isamchk -r --silent --sort-index -O sort_buffer_size=16M */*.ISM
myisamchk -r --silent --sort-index -O sort_buffer_size=16M */*.MYI
</pre>



<H3><A NAME="Table-info" HREF="manual.ru_toc.html#Table-info">4.4.8  Получение информации о таблице</A></H3>

<P>
<A NAME="IDX588"></A>

</P>
<P>
Команды, представленные в этом разделе, используются для получения
описания таблицы или статистики по таблице. Более подробное выборочное
разъяснение вывода этих команд будет приведено ниже:

</P>

<ul>
<LI>myisamchk -d tbl_name

Выполняет myisamchk в "описательном режиме" для
вывода описания таблицы. Если MySQL использует опцию <code>--skip-external-locking</code>, то
<code>myisamchk</code> может сообщить об ошибке для таблицы, обновляемой во время
исполнения утилиты. Однако поскольку <code>myisamchk</code> не меняет таблицы в
описательном режиме, то никакого риска разрушения данных нет.

<LI>myisamchk -d -v tbl_name

Для выдачи дополнительной информации по
действиям, выполняемым утилитой <code>myisamchk</code>, добавляется -v для указания
расширенного режима вывода сообщений.

<LI>myisamchk -eis tbl_name

Отображается только наиболее важная информация
из таблицы. Работает медленно вследствие того, что приходится считывать
всю таблицу.

<LI>myisamchk -eiv tbl_name

То же, что и <code>-eis</code>, но с сообщением о выполняемых
действиях.
</ul>

<P>
<A NAME="IDX589"></A>
<A NAME="IDX590"></A>

</P>
<P>
Пример вывода <code>myisamchk -d</code>:

</P>

<pre>
MyISAM file:     company.MYI
Record format:   Fixed length
Data records:    1403698  Deleted blocks:         0
Recordlength:    226

table description:
Key Start Len Index   Type
1   2     8   unique  double
2   15    10  multip. text packed stripped
3   219   8   multip. double
4   63    10  multip. text packed stripped
5   167   2   multip. unsigned short
6   177   4   multip. unsigned long
7   155   4   multip. text
8   138   4   multip. unsigned long
9   177   4   multip. unsigned long
    193   1           text
</pre>

<P>
Пример вывода <code>myisamchk -d -v</code>:

</P>

<pre>
MyISAM file:         company
Record format:       Fixed length
File-version:        1
Creation time:       1999-10-30 12:12:51
Recover time:        1999-10-31 19:13:01
Status:              checked
Data records:           1403698  Deleted blocks:              0
Datafile parts:         1403698  Deleted data:                0
Datafilepointer (bytes):      3  Keyfile pointer (bytes):     3
Max datafile length: 3791650815  Max keyfile length: 4294967294
Recordlength:               226

table description:
Key Start Len Index   Type                  Rec/key     Root Blocksize
1   2     8   unique  double                      1 15845376      1024
2   15    10  multip. text packed stripped        2 25062400      1024
3   219   8   multip. double                     73 40907776      1024
4   63    10  multip. text packed stripped        5 48097280      1024
5   167   2   multip. unsigned short           4840 55200768      1024
6   177   4   multip. unsigned long            1346 65145856      1024
7   155   4   multip. text                     4995 75090944      1024
8   138   4   multip. unsigned long              87 85036032      1024
9   177   4   multip. unsigned long             178 96481280      1024
    193   1           text
</pre>

<P>
Пример вывода <code>myisamchk -eis</code>:

</P>

<pre>
Checking MyISAM file: company
Key:  1:  Keyblocks used:  97%  Packed:    0%  Max levels:  4
Key:  2:  Keyblocks used:  98%  Packed:   50%  Max levels:  4
Key:  3:  Keyblocks used:  97%  Packed:    0%  Max levels:  4
Key:  4:  Keyblocks used:  99%  Packed:   60%  Max levels:  3
Key:  5:  Keyblocks used:  99%  Packed:    0%  Max levels:  3
Key:  6:  Keyblocks used:  99%  Packed:    0%  Max levels:  3
Key:  7:  Keyblocks used:  99%  Packed:    0%  Max levels:  3
Key:  8:  Keyblocks used:  99%  Packed:    0%  Max levels:  3
Key:  9:  Keyblocks used:  98%  Packed:    0%  Max levels:  4
Total:    Keyblocks used:  98%  Packed:   17%

Records:          1403698    M.recordlength:     226
Packed:             0%
Recordspace used:     100%   Empty space:          0%
Blocks/Record:   1.00
Record blocks:    1403698    Delete blocks:        0
Recorddata:     317235748    Deleted data:         0
Lost space:             0    Linkdata:             0

User time 1626.51, System time 232.36
Maximum resident set size 0, Integral resident set size 0
Non physical pagefaults 0, Physical pagefaults 627, Swaps 0
Blocks in 0 out 0, Messages in 0 out 0, Signals 0
Voluntary context switches 639, Involuntary context switches 28966
</pre>

<P>
Пример вывода <code>myisamchk -eiv</code>:

</P>

<pre>
Checking MyISAM file: company
Data records: 1403698   Deleted blocks:       0
- check file-size
- check delete-chain
block_size 1024:
index  1:
index  2:
index  3:
index  4:
index  5:
index  6:
index  7:
index  8:
index  9:
No recordlinks
- check index reference
- check data record references index: 1
Key:  1:  Keyblocks used:  97%  Packed:    0%  Max levels:  4
- check data record references index: 2
Key:  2:  Keyblocks used:  98%  Packed:   50%  Max levels:  4
- check data record references index: 3
Key:  3:  Keyblocks used:  97%  Packed:    0%  Max levels:  4
- check data record references index: 4
Key:  4:  Keyblocks used:  99%  Packed:   60%  Max levels:  3
- check data record references index: 5
Key:  5:  Keyblocks used:  99%  Packed:    0%  Max levels:  3
- check data record references index: 6
Key:  6:  Keyblocks used:  99%  Packed:    0%  Max levels:  3
- check data record references index: 7
Key:  7:  Keyblocks used:  99%  Packed:    0%  Max levels:  3
- check data record references index: 8
Key:  8:  Keyblocks used:  99%  Packed:    0%  Max levels:  3
- check data record references index: 9
Key:  9:  Keyblocks used:  98%  Packed:    0%  Max levels:  4
Total:    Keyblocks used:   9%  Packed:   17%

- check records and index references
[кое-что опущено для краткости]

Records:          1403698    M.recordlength:     226   Packed:             0%
Recordspace used:     100%   Empty space:          0%  Blocks/Record:   1.00
Record blocks:    1403698    Delete blocks:        0
Recorddata:     317235748    Deleted data:         0
Lost space:             0    Linkdata:             0

User time 1639.63, System time 251.61
Maximum resident set size 0, Integral resident set size 0
Non physical pagefaults 0, Physical pagefaults 10580, Swaps 0
Blocks in 4 out 0, Messages in 0 out 0, Signals 0
Voluntary context switches 10604, Involuntary context switches 122798
</pre>

<P>
Для использованной в предыдущих примерах таблицы размеры файла данных и
индексного файла были следующими:

</P>

<pre>
-rw-rw-r-- 1 monty tcx 317235748 Jan 12 17:30 company.MYD
-rw-rw-r-- 1 davida tcx 96482304 Jan 12 18:35 company.MYM
</pre>

<P>
Ниже приводятся пояснения по различным типам выдаваемой <code>myisamchk</code>
информации. ``keyfile'' означает индексный файл. ``Record'' (запись) и ``row''
(строка) являются синонимами:

</P>

<ul>
<LI>ISAM file - Имя (индексного) файла ISAM.

<LI>Isam-version - Версия  формата ISAM. На данный момент всегда 2.

<LI>Creation time - Время создания файла данных.

<LI>Recover time - Дата последнего восстановления индексного файла/файла

данных.

<LI>Data records - Количество записей в таблице.

<LI>Deleted blocks - Количество удаленных блоков, пространство для  которых

все еще зарезервировано. Таблицу можно оптимизировать для сведения к
минимуму этого пространства (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Optimisation">4.4.6.10  Оптимизация  таблиц</A>).

<LI>Datafile parts - Для динамического формата записей показывает количество

блоков данных. Для оптимизированной таблицы без фрагментированных записей
совпадает с <code>Data records</code>.

<LI>Deleted data - Количество байтов удаленных данных, которые не были

затребованы. Можно оптимизировать таблицу, чтобы сделать этот объем
минимальным (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Optimisation">4.4.6.10  Оптимизация  таблиц</A>).

<LI>Data file pointer - Размер указателя в файле данных (в байтах). Обычно

это 2, 3, 4 или 5 байтов. Для большинства таблиц достаточно 2 байтов, но
назначение размера пока невозможно контролировать из MySQL. Для
фиксированных таблиц указатель - это адрес записи, а для динамических -
адрес байта.

<LI>Keyfile pointer - Размер указателя индексного файла в байтах. Обычно

составляет 1, 2 или 3 байта. Для большинства таблиц хватает 2 байтов, но
размер автоматически вычисляется MySQL. Указатель всегда является адресом
блока.

<LI>Max datafile length - Максимальный размер файла данных таблицы

(<tt>`.MYD'</tt>-файл) в байтах.

<LI>Max keyfile length - Максимальный размер индексного файла таблицы

(<tt>`.MYI-файла'</tt>) в байтах.

<LI>Recordlength - Размер отдельной записи в байтах.

<LI>Record format - Формат, используемый для хранения строк таблицы. В

примерах, приведенных выше, использовался формат <code>Fixed length</code>. Другие
возможные значения: <code>Compressed</code> и <code>Packed</code>.

<LI>table description - Список всех ключей в таблице. Для каждого ключа

представляется некоторая низкоуровневая информация:


<ul>
<LI>Key

Номер данного ключа.

<LI>Start

Место в записи, где начинается данная часть индекса.

<LI>Len

Длина данной части индекса. Для упакованных чисел длина всегда
должна равняться полной длине для столбца. Для строк длина может быть
меньше полной длины индексированной колонки, поскольку допускается
индексирование префикса столбца со значениями строками.

<LI>Индекс <code>unique</code> или <code>multip</code>. (multiple - повторяющийся/многократный)

Показывает, может ли одно значение встречаться в индексе многократно.

<LI>Type

Тип данных данной части индекса. Это тип данных <code>ISAM</code> с возможными
вариантами - <code>packed</code>, <code>stripped</code> и <code>empty</code>.

<LI>Root

Адрес корневого индексного блока.

<LI>Blocksize

Размер каждого индексного блока. По умолчанию равен 1024, но
значение можно изменить во время компиляции.

<LI>Rec/key

Статистическое значение, используемое оптимизатором. Оно
показывает, сколько записей приходится на одно значение для данного ключа.
Для уникального ключа это соотношение всегда 1. Значение может быть
обновлено после загрузки таблицы (или значительного ее изменения)
посредством <code>myisamchk -a</code>. Если соотношение совсем не обновляется, то по
умолчанию принимается значение 30.
</ul>

<LI>В первом из приведенных примеров 9-й ключ является составным с двумя

частями.

<LI>Keyblocks used - Процент использованных блоков ключей. Поскольку для

примера была взята таблица, совсем недавно реорганизованная при помощи
<code>myisamchk</code>, то значения очень высоки (очень близки к теоретическому
максимуму).

<LI>Packed - MySQL пытается упаковывать ключи с общим суффиксом. Это может

быть использовано только для ключей типа <code>CHAR</code>/<code>VARCHAR</code>/<code>DECIMAL</code>. Для длинных
строк, таких как имена, при помощи упаковки можно значительно уменьшить
занимаемое ими место. В третьем из приведенных примеров 4-й ключ состоит
из 10 символов и для него достигнуто 60%-е уменьшение в объеме.

<LI>Max levels - Глубина B-дерева для данного ключа. В больших таблицах с

длинными ключами значение является большим.

<LI>Records Количество строк в таблице.

<LI>M.recordlength - Средняя длина записи. Для таблиц с фиксированной длиной

записи равняется точной длине записи.

<LI>Packed - MySQL отбрасывает пробелы в конце строк. Значение <code>Packed</code>

указывает на процент достигнутой этим экономии.

<LI>Recordspace used - Процент использования файла данных.

<LI>Empty space - На сколько процентов файл данных не использован.

<LI>Blocks/Record - Среднее число блоков на запись (т.е. из какого числа

связей состоит фрагментированная запись). Отношение всегда 1,0 для таблиц
фиксированного формата. Важно, чтобы это значение было как можно ближе к
1,0. Если значение становится слишком большим, можно реорганизовать
таблицу с помощью <code>myisamchk</code>. Обращайтесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Optimisation">4.4.6.10  Оптимизация  таблиц</A>.

<LI>Recordblocks - Количество использованных блоков (связей). Для

фиксированного формата совпадает с количеством записей.

<LI>Deleteblocks - Количество удаленных блоков (связей).

<LI>Recorddata - Количество использованных байтов в файле данных.

<LI>Deleted data - Количество удаленных (неиспользуемых) байтов в файле

данных.

<LI>Lost space - Если запись при обновлении уменьшается, то теряется

некоторое пространство. Данное значение является суммой всех таких потерь
в байтах.

<LI>Linkdata - При использовании динамического формата таблиц фрагменты

записи связываются с помощью указателей (каждый от 4 до 7 байтов).
<code>Linkdata</code> - общий объем памяти, занимаемый всеми такими указателями.
</ul>

<P>
Если таблица была сжата при помощи <code>myisampack</code>, то <code>myisamchk -d</code> выдает
дополнительную информацию о каждом столбце в таблице. Обращайтесь к
разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#myisampack">4.7.4  <code>myisampack</code>, MySQL-генератор сжатых таблиц (только для чтения)</A>, где
приведен пример такой информации и пояснение к ней.

</P>


<H2><A NAME="Database_Administration" HREF="manual.ru_toc.html#Database_Administration">4.5  Справочник по языку администрирования баз данных</A></H2>



<H3><A NAME="OPTIMIZE_TABLE" HREF="manual.ru_toc.html#OPTIMIZE_TABLE">4.5.1  Синтаксис  команды <code>OPTIMIZE TABLE</code></A></H3>

<P>
<A NAME="IDX591"></A>

</P>
<P>
<A NAME="IDX592"></A>
<A NAME="IDX593"></A>

</P>

<pre>
OPTIMIZE TABLE tbl_name[,tbl_name]...
</pre>

<P>
Команда <code>OPTIMIZE TABLE</code> должна использоваться после удаления большей части
таблицы или если в таблице было внесено много изменений в строки
переменной длины (таблицы, в которых есть столбцы <code>VARCHAR</code>, <code>BLOB</code> или <code>TEXT</code>).
Удаленные записи поддерживаются при помощи связного списка, и последующие
операции <code>INSERT</code> повторно используют позиции старых записей. Чтобы
перераспределить неиспользуемое пространство и дефрагментировать файл
данных, можно воспользоваться командой <code>OPTIMIZE TABLE</code>.

</P>
<P>
На данный момент команда <code>OPTIMIZE TABLE</code> работает только с таблицами <code>MyISAM</code>
и <code>BDB</code>. Для таблиц <code>BDB</code> команда <code>OPTIMIZE TABLE</code> выполняет <code>ANALYZE TABLE</code>. См.
раздел See section <A HREF="manual.ru_MySQL_Database_Administration.html#ANALYZE_TABLE">4.5.2  Синтаксис команды <code>ANALYZE TABLE</code></A>.

</P>
<P>
Можно применить <code>OPTIMIZE TABLE</code> к таблицам других типов, запустив 
<code>mysqld</code>  с  параметром  <code>--skip-new</code>  или  <code>--safe-mode</code>, но  в  этом  случае 
<code>OPTIMIZE TABLE</code>  лишь  только  выполняет  <code>ALTER TABLE</code>.

</P>
<P>
Команда <code>OPTIMIZE TABLE</code> работает следующим образом:

</P>

<ul>
<LI>

Если в таблице есть удаленные или разделенные строки, восстанавливает
таблицу.

<LI>

Если индексные страницы не отсортированы - сортирует их.

<LI>

Если статистические данные не обновлены (и восстановление нельзя
осуществить путем сортировки индексов), обновляет их.
</ul>

<P>
Команда <code>OPTIMIZE TABLE</code> для  <code>MyISAM</code> представляет собой эквивалент
выполнения  <code>myisamchk --quick --check-only-changed --sort-index --analyze</code> 
над таблицей.

</P>
<P>
Обратите внимание: во время работы <code>OPTIMIZE TABLE</code> таблица заблокирована!

</P>


<H3><A NAME="ANALYZE_TABLE" HREF="manual.ru_toc.html#ANALYZE_TABLE">4.5.2  Синтаксис команды <code>ANALYZE TABLE</code></A></H3>

<P>
<A NAME="IDX594"></A>

</P>

<pre>
ANALYZE TABLE tbl_name[,tbl_name...]
</pre>

<P>
Анализирует и сохраняет распределение ключей для таблицы. Во время
проведения анализа таблица заблокирована для чтения. Эта функция работает
для таблиц <code>MyISAM</code> и <code>BDB</code>.

</P>
<P>
Данная команда является эквивалентом выполнения <code>myisamchk -a</code> для таблицы.

</P>
<P>
Сохраненное распределение ключей в MySQL используется для принятия решения
о том, в каком порядке следует связывать таблицы, когда для связывания
используются не константы, а другая база.

</P>
<P>
Эта команда выдает таблицу со следующими столбцами:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Столбец</strong> </TD><TD> <strong>Значение</strong>
</TD></TR>
<TR><TD>Table </TD><TD> Имя таблицы
</TD></TR>
<TR><TD>Op </TD><TD> Всегда ``analyze''
</TD></TR>
<TR><TD>Msg_type </TD><TD> Одно из значений <code>status</code>, <code>error</code>, <code>info</code> или <code>warning</code>.
</TD></TR>
<TR><TD>Msg_text </TD><TD> Сообщение.
</TD></TR>
</TABLE>

<P>
Просмотреть сохраненное распределение ключей можно при помощи команды <code>SHOW
INDEX</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#SHOW_DATABASE_INFO">4.5.6.1  Получение информации по базам данных, таблицам, столбцам и индексам</A>.

</P>
<P>
Если таблица не изменялась с момента предыдущего запуска команды <code>ANALYZE
TABLE</code>, повторный анализ таблицы проводиться не будет.

</P>


<H3><A NAME="FLUSH" HREF="manual.ru_toc.html#FLUSH">4.5.3  Синтаксис команды <code>FLUSH</code></A></H3>

<P>
<A NAME="IDX595"></A>

</P>
<P>
<A NAME="IDX596"></A>
<A NAME="IDX597"></A>
<A NAME="IDX598"></A>

</P>


<pre>
FLUSH flush_option [,flush_option] ...
</pre>

<P>
Команда <code>FLUSH</code> применяется для очистки части кэша, используемого MySQL. Для
запуска <code>FLUSH</code> необходимо обладать привилегиями <code>RELOAD</code>.

</P>
<P>
Параметр <code>flush_option</code> может быть одним из следующих:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Параметр</strong> </TD><TD> <strong>Описание</strong>

</TD></TR>
<TR><TD><code>HOSTS</code> </TD><TD> Производится очистка таблиц кэша удаленных компьютеров. Сброс таблиц удаленного компьютера следует производить, если один из удаленных компьютеров изменил IP-адрес или если было получено сообщение об ошибке <code>Host ... is blocked</code>. Если во время соединения с сервером MySQL происходит больше ошибок подряд, чем указано в <code>max_connect_errors</code> для определенного удаленного компьютера, то MySQL предполагает, что что-то не в порядке, и блокирует последующие попытки установления соединения со стороны этого удаленного компьютера. Сброс таблиц удаленного компьютера позволяет снова попытаться установить соединение. See section <A HREF="manual.ru_Problems.html#Blocked_host">A.2.4  Ошибка <code>Host '...' is blocked</code></A>. Чтобы это сообщение об ошибке не появлялось, запустите <code>mysqld</code> с параметром <code>-O max_connect_errors=999999999</code>.

</TD></TR>
<TR><TD><code>DES_KEY_FILE</code> </TD><TD> Производится перезагрузка ключей <code>DES</code> из файла, указанного параметром <code>--des-key-file</code>, при запуске сервера.

</TD></TR>
<TR><TD><code>LOGS</code> </TD><TD> Закрываются и повторно открывается все файлы журналов. Если файл журнала обновлений или файл бинарного журнала был указан без расширения, номер расширения файла журнала будет увеличен на единицу относительно предыдущего файла. Если в имени файла было указано расширение, MySQL закроет и повторно откроет файл журнала обновлений. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Update_log">4.9.3  Журнал обновлений (update)</A>. Эти действия аналогичны отправке сигнала <code>SIGHUP</code> на сервер <code>mysqld</code>.

</TD></TR>
<TR><TD><code>PRIVILEGES</code> </TD><TD> Производится перезагрузка привилегий из таблиц привилегий в базе данных <code>mysql</code>.

</TD></TR>
<TR><TD><code>QUERY CACHE</code> </TD><TD> Производится дефрагментация кэша запросов, чтобы эффективнее использовать его память. Эта команда не удаляет запросы из кэша, как команда <code>RESET QUERY CACHE</code>.

</TD></TR>
<TR><TD><code>TABLES</code> </TD><TD> Закрываются все открытые таблицы и принудительно закрываются все используемые таблицы. Также сбрасывается кэш запросов.

</TD></TR>
<TR><TD><code>[TABLE | TABLES] tbl_name [,tbl_name...]</code> </TD><TD> Производится сброс только указанных таблиц.

</TD></TR>
<TR><TD><code>TABLES WITH READ LOCK</code> </TD><TD> Закрываются все открытые таблицы и блокируется доступ для чтения всех таблиц для всех баз данных, пока не будет запущена команда <code>UNLOCK TABLES</code>. Это очень удобный способ создавать резервные копии, если у вас файловая система наподобие Veritas, которая может обеспечить моментальные снимки данных в режиме реального времени.

</TD></TR>
<TR><TD><code>STATUS</code> </TD><TD> Большинство переменных состояния сбрасываются в нуль. Эту команду необходимо использовать при отладке запроса.

</TD></TR>
<TR><TD><code>USER_RESOURCES</code> </TD><TD> Все ресурсы пользователя сбрасываются в нулевое значение. Это позволяет заблокированному пользователю подсоединиться еще раз. See section <A HREF="manual.ru_MySQL_Database_Administration.html#User_resources">4.3.6  Ограничение ресурсов пользователя</A>.
</TD></TR>
</TABLE>

<P>
Ко всем приведенным выше командам можно получить доступ при помощи утилиты
<code>mysqladmin</code>, используя команды <code>flush-hosts</code>, <code>flush-logs</code>, <code>reload</code> или
<code>flush-tables</code>.

</P>
<P>
Рекомендуется также ознакомиться с командой <code>RESET</code>, которая применяется с
репликацией. See section <A HREF="manual.ru_MySQL_Database_Administration.html#RESET">4.5.4  Синтаксис команды <code>RESET</code></A>.

</P>


<H3><A NAME="RESET" HREF="manual.ru_toc.html#RESET">4.5.4  Синтаксис команды <code>RESET</code></A></H3>


<pre>
RESET reset_option [,reset_option] ...
</pre>

<P>
Команда <code>RESET</code> используется для очистки. Кроме того, она также действует
как более сильная версия команды <code>FLUSH</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#FLUSH">4.5.3  Синтаксис команды <code>FLUSH</code></A>.

</P>
<P>
Чтобы запустить команду <code>RESET</code>, необходимо обладать привилегиями <code>RELOAD</code>.

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Параметр</strong> </TD><TD> <strong>Описание</strong>

</TD></TR>
<TR><TD><code>MASTER</code> </TD><TD> Удаляет все бинарные журналы, перечисленные в индексном файле, обнуляет значения индексного файла <code>binlog</code>. В версиях до 3.23.26 - <code>FLUSH MASTER</code> (Master)

</TD></TR>
<TR><TD><code>SLAVE</code> </TD><TD> Сбрасывает положение репликации подчиненного компьютера в журналах головного компьютера. В версиях до 3.23.26 эта команда называлась <code>FLUSH SLAVE</code> (Slave)

</TD></TR>
<TR><TD><code>QUERY CACHE</code> </TD><TD> Удаляет все результаты запросов из кэша запросов.
</TD></TR>
</TABLE>



<H3><A NAME="KILL" HREF="manual.ru_toc.html#KILL">4.5.5  Синтаксис команды <code>KILL</code></A></H3>

<P>
<A NAME="IDX599"></A>

</P>
<P>
<A NAME="IDX600"></A>

</P>

<pre>
KILL thread_id
</pre>

<P>
Каждое соединение с <code>mysqld</code> запускается в отдельном потоке. При помощи
команды <code>SHOW PROCESSLIST</code> можно просмотреть список запущенных потоков, а
при помощи команды <code>KILL thread_id</code> - удалить поток.

</P>
<P>
Если у вас есть привилегия <code>PROCESS</code>, можно просмотреть все потоки. Обладая
привилегией <code>SUPER</code>, можно удалять любые потоки. В противном случае можно
просматривать и удалять только свои собственные потоки.

</P>
<P>
Для просмотра и удаления потоков можно также применять команды <code>mysqladmin
processlist</code> и <code>mysqladmin kill</code>.

</P>
<P>
При использовании команды <code>KILL</code> для потока устанавливается специальный флаг
<code>kill flag</code>.

</P>
<P>
В большинстве случаев удаление потока занимает некоторое время, поскольку
этот флаг проверяется с определенным интервалом.

</P>

<ul>
<LI>

В циклах <code>SELECT</code>, <code>ORDER BY</code> и <code>GROUP BY</code> флаг проверяется только после
считывания блока строк. Если установлен флаг удаления, то выполнение
оператора будет отменено.

<LI>

При выполнении команды <code>ALTER TABLE</code> флаг удаления проверяется перед
считыванием каждого блока строк из исходной таблицы. Если флаг
установлен, то выполнение команды отменяется и временная таблица
удаляется. При выполнении команд <code>UPDATE</code> и <code>DELETE</code> флаг
удаления проверяется после каждого считывания блока, а также после
каждого обновления или удаления строки. Если флаг удаления установлен,
то выполнение оператора отменяется. Обратите внимание: если не
используются транзакции, то отменить изменения будет невозможно!

<LI>

<code>GET_LOCK()</code> будет отменен при помощи <code>NULL</code>.

<LI>

Поток <code>INSERT DELAYED</code> быстро сбросит все строки, которые он содержит в
памяти и будет удален.

<LI>

Если поток находится в заблокированной таблице (состояние: <code>Locked</code>), то
блокировка таблицы будет быстро отменена.

<LI>

Если поток ожидает освобождения дискового пространства в запросе
write, запись будет отменена с выдачей сообщения о переполнении диска.
</ul>



<H3><A NAME="SHOW" HREF="manual.ru_toc.html#SHOW">4.5.6  Синтаксис команды <code>SHOW</code></A></H3>

<P>
<A NAME="IDX601"></A>
<A NAME="IDX602"></A>
<A NAME="IDX603"></A>
<A NAME="IDX604"></A>
<A NAME="IDX605"></A>
<A NAME="IDX606"></A>
<A NAME="IDX607"></A>
<A NAME="IDX608"></A>
<A NAME="IDX609"></A>
<A NAME="IDX610"></A>
<A NAME="IDX611"></A>
<A NAME="IDX612"></A>
<A NAME="IDX613"></A>
<A NAME="IDX614"></A>
<A NAME="IDX615"></A>
<A NAME="IDX616"></A>
<A NAME="IDX617"></A>
<A NAME="IDX618"></A>

</P>

<pre>
SHOW DATABASES [LIKE wild]
или SHOW [OPEN] TABLES [FROM db_name] [LIKE wild]
или SHOW [FULL] COLUMNS FROM tbl_name [FROM db_name] [LIKE wild]
или SHOW INDEX FROM tbl_name [FROM db_name]
или SHOW TABLE STATUS [FROM db_name] [LIKE wild]
или SHOW STATUS [LIKE wild]
или SHOW VARIABLES [LIKE wild]
или SHOW LOGS
или SHOW [FULL] PROCESSLIST
или SHOW GRANTS FOR user
или SHOW CREATE TABLE table_name
или SHOW MASTER STATUS
или SHOW MASTER LOGS
или SHOW SLAVE STATUS
или SHOW WARNINGS [LIMIT #]
или SHOW ERRORS [LIMIT #]
или SHOW TABLE TYPES

</pre>

<P>
Команда <code>SHOW</code> предоставляет информацию по базам данных, таблицам, столбцам
или о состоянии сервера. Если используется <code>LIKE wild</code>, то строка <code>wild</code> может
содержать в себе шаблонные символы SQL <samp>`%'</samp> и <samp>`_'</samp>.

</P>



<H4><A NAME="SHOW_DATABASE_INFO" HREF="manual.ru_toc.html#SHOW_DATABASE_INFO">4.5.6.1  Получение информации по базам данных, таблицам, столбцам и индексам</A></H4>

<P>
<A NAME="IDX619"></A>

</P>
<P>
Можно использовать два альтернативных синтаксиса - <code>tbl_name FROM db_name</code> и
<code>db_name.tbl_name</code>. Приведенные ниже два оператора эквивалентны:

</P>

<pre>
mysql&#62; SHOW INDEX FROM mytable FROM mydb;
mysql&#62; SHOW INDEX FROM mydb.mytable;
</pre>

<P>
Команда <code>SHOW DATABASES</code> выдает список баз данных на компьютере, где
установлен сервер MySQL. Этот список можно также получить,
воспользовавшись инструментом командной строки <code>mysqlshow</code>. В версии 4.0.2
можно увидеть только те базы данных, для которых у вас есть какие-либо
привилегии, если вы не имеете глобальной привилегии <code>SHOW DATABASES</code>.

</P>
<P>
Команда <code>SHOW TABLES</code> выводит список таблиц в указанной базе данных. Этот
список также можно получить, используя команду <code>mysqlshow db_name</code>.

</P>
<P>
<strong>Примечание</strong>: если у пользователя нет никаких привилегий для таблицы,
таблица не будет показана в результатах команды <code>SHOW TABLES</code> или <code>mysqlshow
db_name</code>.

</P>
<P>
Команда <code>SHOW OPEN TABLES</code> выводит список таблиц, которые в настоящий момент
открыты в кэше таблицы. See section <A HREF="manual.ru_MySQL_Optimisation.html#Table_cache">5.4.7  Открытие и закрытие таблиц в MySQL</A>. В
поле <code>Comment</code> указывается, сколько раз таблица кэшировалась (<code>cached</code>) и
сколько раз использовалась (<code>in_use</code>).

</P>
<P>
Команда <code>SHOW COLUMNS</code> выводит список столбцов в заданной таблице. Если
указать параметр <code>FULL</code>, то будут показаны также ваши привилегии для каждого
столбца. Если типы столбцов отличаются от заданных в параметрах оператора
<code>CREATE TABLE</code>, учтите, что MySQL иногда изменяет типы столбцов. See section <A HREF="manual.ru_Reference.html#Silent_column_changes">6.5.3.1  Молчаливые изменения определений столбцов</A>.

</P>
<P>
Оператор <code>DESCRIBE</code> предоставляет почти такую же информацию, что и <code>SHOW
COLUMNS</code>. See section <A HREF="manual.ru_Reference.html#DESCRIBE">6.6.2  Синтаксис команды <code>DESCRIBE</code> (Получение информации о столбцах)</A>.

</P>
<P>
Команда <code>SHOW FIELDS</code>  является  синонимом  команды  <code>SHOW COLUMNS</code>, а 
команда  <code>SHOW KEYS</code> - синонимом <code>SHOW INDEX</code>. Список  столбцов  или 
индексов  таблицы  можно  также  вывести  при  помощи  команды  <code>mysqlshow
db_name tbl_name</code> или <code>mysqlshow -k db_name tbl_name</code>.

</P>
<P>
Команда <code>SHOW INDEX</code> выводит информацию по индексу в формате, подобном
формату вывода запроса <code>SQLStatistics в ODBC</code>. Выводятся следующие столбцы:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Столбец</strong> </TD><TD> <strong>Значение</strong>
</TD></TR>
<TR><TD><code>Table</code> </TD><TD> Имя таблицы.
</TD></TR>
<TR><TD><code>Non_unique</code> </TD><TD> 0 если индекс не может содержать дублирующихся значений.
</TD></TR>
<TR><TD><code>Key_name</code> </TD><TD> Имя индекса.
</TD></TR>
<TR><TD><code>Seq_in_index</code> </TD><TD> Порядковый номер столбца в индексе, начиная с 1.
</TD></TR>
<TR><TD><code>Column_name</code> </TD><TD> Имя  столбца.
</TD></TR>
<TR><TD><code>Collation</code> </TD><TD> Как столбцы отсортированы в индексе. В MySQL в данном столбце могут присутствовать значения <code>'A'</code> (в порядке возрастания) или <code>NULL</code> (не отсортирован).
</TD></TR>
<TR><TD><code>Cardinality</code> </TD><TD> Количество уникальных значений в индексе. Обновляется путем запуска <code>isamchk -a</code>.
</TD></TR>
<TR><TD><code>Sub_part</code> Количество индексированных символов, если столбец индексируется частично. Если проиндексирован весь ключ, то будет содержаться значение <code>NULL</code>.
</TD></TR>
<TR><TD><code>Null</code> </TD><TD> Содержит значение <code>'YES'</code>, если столбец может содержать <code>NULL</code>.
</TD></TR>
<TR><TD><code>Index_type</code> Используемый метод индексирования.
</TD></TR>
<TR><TD><code>Comment</code> </TD><TD> Различные примечания. На данный момент в версиях MySQL &#60; 4.0.2 выдается, является индекс <code>FULLTEXT</code> или нет.
</TD></TR>
</TABLE>

<P>
Обратите внимание на то, что значение <code>Cardinality</code> подсчитывается по
результатам статистики, сохраняющейся в виде целых чисел, которые
недостаточно точны для небольших таблиц.

</P>
<P>
Столбцы <code>Null</code> и <code>Index_type</code> были добавлены начиная с версии MySQL 4.0.2.

</P>


<H4><A NAME="SHOW_TABLE_STATUS" HREF="manual.ru_toc.html#SHOW_TABLE_STATUS">4.5.6.2  <code>SHOW TABLE STATUS</code></A></H4>

<P>
<A NAME="IDX620"></A>
<A NAME="IDX621"></A>
<A NAME="IDX622"></A>

</P>

<pre>
SHOW TABLE STATUS [FROM db_name] [LIKE wild]
</pre>

<P>
Команда <code>SHOW TABLE STATUS</code> (новшество версии 3.23) работает как <code>SHOW
STATUS</code>, но предоставляет большое количество информации по каждой таблице.
Приведенный ниже список также можно получить, используя команду <code>mysqlshow
--status db_name</code>. Выводятся следующие столбцы:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Столбец</strong> </TD><TD> <strong>Значение</strong>
</TD></TR>
<TR><TD><code>Name</code> </TD><TD> Имя таблицы.
</TD></TR>
<TR><TD><code>Type</code> </TD><TD> Тип таблицы. See section <A HREF="manual.ru_Table_types.html#Table_types">7  Типы  таблиц MySQL</A>.
</TD></TR>
<TR><TD><code>Row_format</code> </TD><TD> Формат хранения строк (Fixed, Dynamic, или Compressed).
</TD></TR>
<TR><TD><code>Rows</code> </TD><TD> Количество строк.
</TD></TR>
<TR><TD><code>Avg_row_length</code> </TD><TD> Средняя длина строки.
</TD></TR>
<TR><TD><code>Data_length</code> </TD><TD> Размер файла данных.
</TD></TR>
<TR><TD><code>Max_data_length</code> </TD><TD> Максимальная длина файла данных.
</TD></TR>
<TR><TD><code>Index_length</code> </TD><TD> Длина индексного файла.
</TD></TR>
<TR><TD><code>Data_free</code> </TD><TD> Количество распределенных, но не используемых байтов.
</TD></TR>
<TR><TD><code>Auto_increment</code> </TD><TD> Следующее значение автоинкремента.
</TD></TR>
<TR><TD><code>Create_time</code> </TD><TD> Время создания таблицы.
</TD></TR>
<TR><TD><code>Update_time</code> </TD><TD> Время последнего обновления файла данных.
</TD></TR>
<TR><TD><code>Check_time</code> </TD><TD> Время последней проверки таблицы.
</TD></TR>
<TR><TD><code>Create_options</code> </TD><TD> Дополнительные параметры, использовавшиеся для команды <code>CREATE TABLE</code>.
</TD></TR>
<TR><TD><code>Comment</code> </TD><TD> Примечания, внесенные при создании таблицы (или информация о причинах, почему MySQL не может получить доступ к данным в таблицах).
</TD></TR>
</TABLE>

<P>
В таблицах <code>InnoDB</code> информация о свободном дисковом пространстве в таблице
заносится в ячейки примечаний к таблице.

</P>


<H4><A NAME="SHOW_STATUS" HREF="manual.ru_toc.html#SHOW_STATUS">4.5.6.3  <code>SHOW STATUS</code></A></H4>

<P>
<A NAME="IDX623"></A>

</P>
<P>
Команда <code>SHOW STATUS</code> предоставляет информацию по состоянию сервера (как
<code>mysqladmin extended-status</code>). Пример выходных данных приведен ниже (формат
и числа могут иметь некоторые отличия):

</P>

<pre>
+--------------------------+------------+
| Variable_name            | Value      |
+--------------------------+------------+
| Aborted_clients          | 0          |
| Aborted_connects         | 0          |
| Bytes_received           | 155372598  |
| Bytes_sent               | 1176560426 |
| Connections              | 30023      |
| Created_tmp_disk_tables  | 0          |
| Created_tmp_tables       | 8340       |
| Created_tmp_files        | 60         |
| Delayed_insert_threads   | 0          |
| Delayed_writes           | 0          |
| Delayed_errors           | 0          |
| Flush_commands           | 1          |
| Handler_delete           | 462604     |
| Handler_read_first       | 105881     |
| Handler_read_key         | 27820558   |
| Handler_read_next        | 390681754  |
| Handler_read_prev        | 6022500    |
| Handler_read_rnd         | 30546748   |
| Handler_read_rnd_next    | 246216530  |
| Handler_update           | 16945404   |
| Handler_write            | 60356676   |
| Key_blocks_used          | 14955      |
| Key_read_requests        | 96854827   |
| Key_reads                | 162040     |
| Key_write_requests       | 7589728    |
| Key_writes               | 3813196    |
| Max_used_connections     | 0          |
| Not_flushed_key_blocks   | 0          |
| Not_flushed_delayed_rows | 0          |
| Open_tables              | 1          |
| Open_files               | 2          |
| Open_streams             | 0          |
| Opened_tables            | 44600      |
| Questions                | 2026873    |
| Select_full_join         | 0          |
| Select_full_range_join   | 0          |
| Select_range             | 99646      |
| Select_range_check       | 0          |
| Select_scan              | 30802      |
| Slave_running            | OFF        |
| Slave_open_temp_tables   | 0          |
| Slow_launch_threads      | 0          |
| Slow_queries             | 0          |
| Sort_merge_passes        | 30         |
| Sort_range               | 500        |
| Sort_rows                | 30296250   |
| Sort_scan                | 4650       |
| Table_locks_immediate    | 1920382    |
| Table_locks_waited       | 0          |
| Threads_cached           | 0          |
| Threads_created          | 30022      |
| Threads_connected        | 1          |
| Threads_running          | 1          |
| Uptime                   | 80380      |
+--------------------------+------------+
</pre>

<P>
Приведенные выше переменные состояния имеют следующие значения:

</P>
<P>
<A NAME="IDX624"></A>

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Переменная</strong> </TD><TD> <strong>Значение</strong>
</TD></TR>
<TR><TD><code>Aborted_clients</code> </TD><TD> Количество соединений, отмененных по причине отключения клиента без надлежащего закрытия соединения. See section <A HREF="manual.ru_Problems.html#Communication_errors">A.2.9  Коммуникационные ошибки / Оборванные соединения</A>.
</TD></TR>
<TR><TD><code>Aborted_connects</code> </TD><TD> Количество неудачных попыток подсоединения к серверу MySQL. See section <A HREF="manual.ru_Problems.html#Communication_errors">A.2.9  Коммуникационные ошибки / Оборванные соединения</A>.
</TD></TR>
<TR><TD><code>Bytes_received</code> </TD><TD> Количество байтов, полученных от всех клиентов.
</TD></TR>
<TR><TD><code>Bytes_sent</code> </TD><TD> Количество байтов, отправленных всем клиентам.
</TD></TR>
<TR><TD><code>Com_xxx</code> </TD><TD> Количество запусков каждой команды xxx.
</TD></TR>
<TR><TD><code>Connections</code> </TD><TD> Количество попыток подсоединения к серверу MySQL.
</TD></TR>
<TR><TD><code>Created_tmp_tables</code> </TD><TD> Количество неявных временных таблиц на диске, созданных во время выполнения операторов.
</TD></TR>
<TR><TD><code>Created_tmp_tables</code> </TD><TD> Количество неявных временных таблиц в памяти, созданных во время выполнения операторов.
</TD></TR>
<TR><TD><code>Created_tmp_files</code> </TD><TD> Количество созданных временных файлов <code>mysqld</code>.
</TD></TR>
<TR><TD><code>Delayed_insert_threads</code> </TD><TD> Количество используемых потоков вставки данных в режиме <code>insert delayed</code>.
</TD></TR>
<TR><TD><code>Delayed_writes</code> </TD><TD> Количество строк, вставленных при помощи команды <code>INSERT DELAYED</code>.
</TD></TR>
<TR><TD><code>Delayed_errors</code> </TD><TD> Количество записанных при помощи команды <code>INSERT DELAYED</code> строк, в которых произошли какие-либо ошибки (возможно, <code>duplicate key</code>).
</TD></TR>
<TR><TD><code>Flush_commands</code> </TD><TD> Количество запущенных команд <code>FLUSH</code>.
</TD></TR>
<TR><TD><code>Handler_commit</code> </TD><TD> Количество внутренних команд <code>COMMIT</code>.
</TD></TR>
<TR><TD><code>Handler_delete</code> </TD><TD> Количество удалений строки из таблицы.
</TD></TR>
<TR><TD><code>Handler_read_first</code> </TD><TD> Количество считываний из индекса первой записи. Если это значение высокое, то, по всей вероятности, сервер осуществляет много полных индексных сканирований, например, <code>SELECT col1 FROM foo</code>, предполагая, что <code>col1</code> проиндексирован.
</TD></TR>
<TR><TD><code>Handler_read_key</code> </TD><TD> Количество запросов на чтение строки, основанных на ключе. Высокое значение переменной говорит о том, что ваши запросы и таблицы проиндексированы надлежащим образом.
</TD></TR>
<TR><TD><code>Handler_read_next</code> </TD><TD> Количество запросов на чтение следующей строки в порядке расположения ключей. Это значение будет увеличиваться, если производится запрос индексного столбца с ограничением по размеру. Значение также увеличивается во время проведения индексного сканирования.
</TD></TR>
<TR><TD><code>Handler_read_prev</code> </TD><TD> Количество запросов на чтение предыдущей строки в порядке расположения ключей. В большинстве случаев используется для оптимизации <code>ORDER BY ... DESC</code>.
</TD></TR>
<TR><TD><code>Handler_read_rnd</code> </TD><TD> Количество запросов на чтение строки, основанных на фиксированной позиции. Значение будет высоким, если выполняется много запросов, требующих сортировки результатов.
</TD></TR>
<TR><TD><code>Handler_read_rnd_next</code> </TD><TD> Количество запросов на чтение следующей строки из файла данных. Данное значение будет высоким, если производится много сканирований таблиц. Обычно это означает, что ваши таблицы не проиндексированы надлежащим образом или ваши запросы не используют преимущества индексов.
</TD></TR>
<TR><TD><code>Handler_rollback</code> </TD><TD> Количество внутренних команд <code>ROLLBACK</code>.
</TD></TR>
<TR><TD><code>Handler_update</code> </TD><TD> Количество запросов на обновление строки в таблице.
</TD></TR>
<TR><TD><code>Handler_write</code> </TD><TD> Количество запросов на вставку строки в таблицу.
</TD></TR>
<TR><TD><code>Key_blocks_used</code> </TD><TD> Количество используемых блоков в кэше ключей.
</TD></TR>
<TR><TD><code>Key_read_requests</code> </TD><TD> Количество запросов на чтение блока ключей из кэша.
</TD></TR>
<TR><TD><code>Key_reads</code> </TD><TD> Количество физических считываний блока ключей с диска.
</TD></TR>
<TR><TD><code>Key_write_requests</code> </TD><TD> Количество запросов на запись блока ключей в кэш.
</TD></TR>
<TR><TD><code>Key_writes</code> </TD><TD> Количество физических записей блоков ключей на диск.
</TD></TR>
<TR><TD><code>Max_used_connections</code> </TD><TD> Максимальное количество одновременно используемых соединений.
</TD></TR>
<TR><TD><code>Not_flushed_key_blocks</code> </TD><TD> Блоки ключей в кэше ключей, которые были изменены, но еще не записаны на диск.
</TD></TR>
<TR><TD><code>Not_flushed_delayed_rows</code> </TD><TD> Количество строк, стоящих в очереди на запись в запросах <code>INSERT DELAY</code>.
</TD></TR>
<TR><TD><code>Open_tables</code> </TD><TD> Количество открытых таблиц.
</TD></TR>
<TR><TD><code>Open_files</code> </TD><TD> Количество открытых файлов.
</TD></TR>
<TR><TD><code>Open_streams</code> </TD><TD> Количество открытых потоков (в основном используется для журналирования).
</TD></TR>
<TR><TD><code>Opened_tables</code> </TD><TD> Количество открывавшихся таблиц.
</TD></TR>
<TR><TD><code>Rpl_status</code> </TD><TD> Статус отказобезопасной репликации (еще не используется).
</TD></TR>
<TR><TD><code>Select_full_join</code> </TD><TD> Количество соединений без ключей (если это значение равно 0, необходимо внимательно проверить индексы своих таблиц).
</TD></TR>
<TR><TD><code>Select_full_range_join</code> </TD><TD> Количество соединений, где был использован поиск по диапазону в справочной таблице.
</TD></TR>
<TR><TD><code>Select_range</code> </TD><TD> Количество соединений, в которых использовались диапазоны в первой таблице. (Обычно это значение не критично, даже если оно велико)
</TD></TR>
<TR><TD><code>Select_scan</code> </TD><TD> Количество соединений, в которых проводилось первое сканирование первой таблицы.
</TD></TR>
<TR><TD><code>Select_range_check</code> </TD><TD> Количество соединений без ключей, в которых проверка использования ключей производится после каждой строки (если это значение равно 0, необходимо внимательно проверить индексы своих таблиц).
</TD></TR>
<TR><TD><code>Questions</code> </TD><TD> Количество запросов, направленных на сервер.
</TD></TR>
<TR><TD><code>Slave_open_temp_tables</code> </TD><TD> Количество временных таблиц, открытых в настоящий момент потоком подчиненного компьютера.
</TD></TR>
<TR><TD><code>Slave_running</code> </TD><TD> Содержит значение <code>ON</code>, если это подчиненный компьютер, подключенный к головному компьютеру.
</TD></TR>
<TR><TD><code>Slow_launch_threads</code> </TD><TD> Количество потоков, создание которых заняло больше, чем указано в <code>slow_launch_time</code>.
</TD></TR>
<TR><TD><code>Slow_queries</code> </TD><TD> Количество запросов, обработка которых заняла больше времени, чем <code>long_query_time</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Slow_query_log">4.9.5  Журнал медленных запросов</A>.
</TD></TR>
<TR><TD><code>Sort_merge_passes</code> </TD><TD> Количество объединений, осуществленных алгоритмом сортировки. Если это значение велико, следует увеличить <code>sort_buffer_size</code>.
</TD></TR>
<TR><TD><code>Sort_range</code> </TD><TD> Количество сортировок, которые осуществлялись в диапазонах.
</TD></TR>
<TR><TD><code>Sort_rows</code> </TD><TD> Количество отсортированных строк.
</TD></TR>
<TR><TD><code>Sort_scan</code> </TD><TD> Количество сортировок, осуществленных путем сканирования таблицы.
</TD></TR>
<TR><TD><code>ssl_xxx</code> </TD><TD> Переменные, используемые SSL; еще не реализовано.
</TD></TR>
<TR><TD><code>Table_locks_immediate</code> </TD><TD> Количество запросов на немедленную блокировку таблицы. Доступно начиная с версии 3.23.33.
</TD></TR>
<TR><TD><code>Table_locks_waited</code> </TD><TD> Количество запросов, когда немедленная блокировка не могла быть осуществлена и требовалось время на ожидание. Если это значение велико, и у вас есть проблемы с производительностью, сначала необходимо оптимизировать свои запросы, а затем либо разделить таблицы, либо использовать репликацию. Доступно начиная с версии 3.23.33.
</TD></TR>
<TR><TD><code>Threads_cached</code> </TD><TD> Количество потоков в кэше потоков.
</TD></TR>
<TR><TD><code>Threads_connected</code> </TD><TD> Количество открытых в настоящий момент соединений.
</TD></TR>
<TR><TD><code>Threads_created</code> </TD><TD> Количество потоков, созданных для управления соединениями.
</TD></TR>
<TR><TD><code>Threads_running</code> </TD><TD> Количество не простаивающих потоков.
</TD></TR>
<TR><TD><code>Uptime</code> </TD><TD> Время в секундах, в течение которого сервер находится в работе.
</TD></TR>
</TABLE>

<P>
Некоторые примечания к приведенной выше информации:

</P>

<ul>
<LI>

Если значение <code>Opened_tables</code> велико, возможно, что значение переменной
<code>table_cache</code> слишком мало.

<LI>

Если значение <code>Key_reads</code> велико, возможно, что значение переменной
<code>key_buffer_size</code> слишком мало. Частоту <strong>неуспешных обращений</strong> к кэшу можно
вычислить так: <code>Key_reads</code>/<code>Key_read_requests</code>.

<LI>

Если значение <code>Handler_read_rnd</code> велико, возможно, поступает слишком
много запросов, требующих от MySQL полного сканирования таблиц или у
вас есть соединения, которые не используют ключи надлежащим образом.

<LI>

Если значение <code>Threads_created</code> велико, возможно, необходимо увеличить
значение переменной <code>thread_cache_size</code>. Частоту успешных обращений к
кэшу можно вычислить при помощи <code>Threads_created</code>/<code>Connections</code>.

<LI>

Если значение <code>Created_tmp_disk_tables</code> велико, возможно, необходимо
увеличить значение переменной <code>tmp_table_size</code>, чтобы временные таблицы
располагались в памяти, а не на жестком диске.
</ul>



<H4><A NAME="SHOW_VARIABLES" HREF="manual.ru_toc.html#SHOW_VARIABLES">4.5.6.4  <code>SHOW VARIABLES</code></A></H4>


<pre>
SHOW [GLOBAL | SESSION] VARIABLES [LIKE wild]
</pre>

<P>
Команда <code>SHOW VARIABLES</code> отображает значения некоторых системных переменных
MySQL. Такую же информацию можно получить и при помощи команды <code>mysqladmin
variables</code>. Если установленные по умолчанию значения вам не подходят,
большинство из этих переменных можно задать, используя параметры командной
строки при запуске <code>mysqld</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Command-line_options">4.1.1  Параметры командной строки <code>mysqld</code></A>.

</P>
<P>
Опции <code>GLOBAL</code> и <code>SESSION</code> новы с версии MySQL 4.0.3. С помощью <code>GLOBAL</code> вы получите
значения, использующиеся для новых подключений к MySQL. С помощью <code>SESSION</code> вы 
получите значения, которые действуют прямо сейчас в текущем соединении. Если вы 
не указываете эти опции, подразумевается <code>SESSION</code>. 

</P>
<P>
Вы можете изменить большинство параметров с помощью команды <code>SET</code>. See section <A HREF="manual.ru_MySQL_Optimisation.html#SET_OPTION">5.5.6  Синтаксис команды <code>SET</code></A>. 

</P>

<P>
Ниже приведен пример выходных данных; формат и числа могут иметь некоторые
отличия:

</P>

<pre>
+---------------------------------+------------------------------+
| Variable_name                   | Value                        |
+---------------------------------+------------------------------|
| back_log                        | 50                           |
| basedir                         | /usr/local/mysql             |
| bdb_cache_size                  | 8388572                      |
| bdb_log_buffer_size             | 32768                        |
| bdb_home                        | /usr/local/mysql             |
| bdb_max_lock                    | 10000                        |
| bdb_logdir                      |                              |
| bdb_shared_data                 | OFF                          |
| bdb_tmpdir                      | /tmp/                        |
| bdb_version                     | Sleepycat Software: ...	 |
| binlog_cache_size               | 32768                        |
| bulk_insert_buffer_size         | 8388608                      |
| character_set                   | latin1                       |
| character_sets                  | latin1 big5 czech euc_kr	 |
| concurrent_insert               | ON                           |
| connect_timeout                 | 5                            |
| convert_character_set           |                              |
| datadir                         | /usr/local/mysql/data/       |
| delay_key_write                 | ON                           |
| delayed_insert_limit            | 100                          |
| delayed_insert_timeout          | 300                          |
| delayed_queue_size              | 1000                         |
| flush                           | OFF                          |
| flush_time                      | 0                            |
| ft_boolean_syntax               | + -&#62;&#60;()~*:""&#38;|               |
| ft_min_word_len                 | 4                            |
| ft_max_word_len                 | 254                          |
| ft_max_word_len_for_sort        | 20                           |
| ft_stopword_file                | (built-in)                   |
| have_bdb                        | YES                          |
| have_innodb                     | YES                          |
| have_isam                       | YES                          |
| have_raid                       | NO                           |
| have_symlink                    | DISABLED                     |
| have_openssl                    | YES                          |
| have_query_cache                | YES                          |
| init_file                       |                              |
| innodb_additional_mem_pool_size | 1048576                      |
| innodb_buffer_pool_size         | 8388608                      |
| innodb_data_file_path           | ibdata1:10M:autoextend       |
| innodb_data_home_dir            |                              |
| innodb_file_io_threads          | 4                            |
| innodb_force_recovery           | 0                            |
| innodb_thread_concurrency       | 8                            |
| innodb_flush_log_at_trx_commit  | 0                            |
| innodb_fast_shutdown            | ON                           |
| innodb_flush_method             |                              |
| innodb_lock_wait_timeout        | 50                           |
| innodb_log_arch_dir             |                              |
| innodb_log_archive              | OFF                          |
| innodb_log_buffer_size          | 1048576                      |
| innodb_log_file_size            | 5242880                      |
| innodb_log_files_in_group       | 2                            |
| innodb_log_group_home_dir       | ./                           |
| innodb_mirrored_log_groups      | 1                            |
| interactive_timeout             | 28800                        |
| join_buffer_size                | 131072                       |
| key_buffer_size                 | 16773120                     |
| language                        | /usr/local/mysql/share/...   |
| large_files_support             | ON                           |
| local_infile                    | ON                           |
| locked_in_memory                | OFF                          |
| log                             | OFF                          |
| log_update                      | OFF                          |
| log_bin                         | OFF                          |
| log_slave_updates               | OFF                          |
| log_slow_queries                | OFF                          |
| log_warnings                    | OFF                          |
| long_query_time                 | 10                           |
| low_priority_updates            | OFF                          |
| lower_case_table_names          | OFF                          |
| max_allowed_packet              | 1047552                      |
| max_binlog_cache_size           | 4294967295                   |
| max_binlog_size                 | 1073741824                   |
| max_connections                 | 100                          |
| max_connect_errors              | 10                           |
| max_delayed_threads             | 20                           |
| max_heap_table_size             | 16777216                     |
| max_join_size                   | 4294967295                   |
| max_sort_length                 | 1024                         |
| max_user_connections            | 0                            |
| max_tmp_tables                  | 32                           |
| max_write_lock_count            | 4294967295                   |
| myisam_max_extra_sort_file_size | 268435456                    |
| myisam_max_sort_file_size       | 2147483647                   |
| myisam_recover_options          | force                        |
| myisam_sort_buffer_size         | 8388608                      |
| net_buffer_length               | 16384                        |
| net_read_timeout                | 30                           |
| net_retry_count                 | 10                           |
| net_write_timeout               | 60                           |
| open_files_limit                | 0                            |
| pid_file                        | /usr/local/mysql/name.pid    |
| port                            | 3306                         |
| protocol_version                | 10                           |
| read_buffer_size                | 131072                       |
| read_rnd_buffer_size            | 262144                       |
| rpl_recovery_rank               | 0                            |
| query_cache_limit               | 1048576                      |
| query_cache_size                | 0                            |
| query_cache_type                | ON                           |
| safe_show_database              | OFF                          |
| server_id                       | 0                            |
| slave_net_timeout               | 3600                         |
| skip_external_locking           | ON                           |
| skip_networking                 | OFF                          |
| skip_show_database              | OFF                          |
| slow_launch_time                | 2                            |
| socket                          | /tmp/mysql.sock              |
| sort_buffer_size                | 2097116                      |
| sql_mode                        | 0                            |
| table_cache                     | 64                           |
| table_type                      | MYISAM                       |
| thread_cache_size               | 3                            |
| thread_stack                    | 131072                       |
| tx_isolation                    | READ-COMMITTED               |
| timezone                        | EEST                         |
| tmp_table_size                  | 33554432                     |
| tmpdir                          | /tmp/:/mnt/hd2/tmp/          |
| version                         | 4.0.4-beta                   |
| wait_timeout                    | 28800                        |
+---------------------------------+------------------------------+
</pre>

<P>
<A NAME="IDX625"></A>

</P>
<P>
Ниже описаны все параметры. Значения размеров буферов, длины и размеры
стеков приведены в байтах. Значения можно указать с суффиксом <code>'K'</code> или <code>'M'</code>,
чтобы обозначить килобайты или мегабайты. Например, <code>16M</code> означает <code>16</code>
мегабайт. Регистр буквы суффикса не имеет значения, <code>16M</code> и <code>16m</code> обозначают
одно и то же:

</P>

<ul>
<LI><code>ansi_mode</code>.

Имеет значение <code>ON</code>, если <code>mysqld</code> был запущен с параметром <code>--ansi</code>. See section <A HREF="manual.ru_Introduction.html#ANSI_mode">1.9.2  Запуск MySQL в режиме ANSI</A>.

<LI><code>back_log</code>

Количество поддерживаемых MySQL запросов на соединение,
находящихся в очереди. Этот параметр начинает играть роль, когда
главный поток MySQL получает очень много запросов на соединение за
короткий промежуток времени. У главного потока уходит некоторое время
(хотя очень небольшое) на проверку соединения и запуск нового потока.
Значение <code>back_log</code> показывает, сколько запросов может находиться в
очереди на этом коротком промежутке времени, прежде чем MySQL
прекратит отвечать на новые запросы. Данное значение необходимо
увеличить только в том случае, если ожидается большое количество
соединений на протяжении короткого промежутка времени. Иначе говоря,
это значение является размером очереди ожидания входящих соединений
TCP/IP. У вашей операционной системы есть свое собственное ограничение
на размер этой очереди. За более подробной информацией обращайтесь на
страницу руководства ОС Unix по системному вызову <code>listen(2)</code>. Чтобы
узнать максимальное значение для этой переменной, обратитесь к
документации по своей операционной системе. Попытка установить
значение <code>back_log</code> выше, чем допускается в вашей операционной системе,
не принесет положительного результата.

<LI><code>basedir</code>

Значение параметра <code>--basedir</code>.

<LI><code>bdb_cache_size</code>

Буфер, выделенный для индекса кэша и строк таблиц <code>BDB</code>.
Если таблицы <code>BDB</code> не используются, необходимо запустить <code>mysqld</code> с
параметром <code>--skip-bdb</code>, чтобы не расходовать память на этот кэш.

<LI><code>bdb_log_buffer_size</code>

Буфер, выделенный для индекса кэша и строк таблиц
<code>BDB</code>. Если таблицы <code>BDB</code> не используются, его значение необходимо
установить в 0 или запустить <code>mysqld</code> с параметром <code>--skip-bdb</code>, чтобы не
расходовать память на этот кэш.

<LI><code>bdb_home</code>

Значение параметра <code>--bdb-home</code>.

<LI><code>bdb_max_lock</code>

Максимальное количество блокировок (по умолчанию 10000),
которые можно установить на таблицу <code>BDB</code>. Этот параметр необходимо
увеличить, если возникают ошибки типа <code>bdb: Lock table is out of
available locks</code> или <code>Got error 12 from ...</code> при выполнении длинных
транзакций или когда <code>mysqld</code> должен просмотреть много строк для
вычисления запроса.

<LI><code>bdb_logdir</code>

Значение параметра <code>--bdb-logdir</code>.

<LI><code>bdb_shared_data</code>

Содержит значение <code>ON</code>, если используется параметр
<code>--bdb-shared-data</code>.

<LI><code>bdb_tmpdir</code>

Значение параметра <code>--bdb-tmpdir</code>.

<LI><code>binlog_cache_size</code>.

Размер кэша для хранения операторов бинарного
журнала SQL во время транзакции. Если часто используются большие
транзакции со значительным количеством операторов, то в целях
повышения производительности значение этого параметра можно увеличить.
See section <A HREF="manual.ru_Reference.html#COMMIT">6.7.1  Синтаксис команд <code>BEGIN/COMMIT/ROLLBACK</code></A>.

<LI><code>bulk_insert_buffer_size</code> (был <code>myisam_bulk_insert_tree_size</code>)

MyISAM использует специальный древо-подобный кэш чтобы ускорить многострочные
вставки (которые <code>INSERT ... SELECT</code>, <code>INSERT ... VALUES (...),
(...), ...</code>, и <code>LOAD DATA INFILE</code>). Эта переменная ограничивает размер
такого кэша в каждом потоке (указывается в байтах). Установка в 0 запретит
такую оптимизацию. 

<code>Внимание:</code> этот кэш работает только тогда, когда делается вставка в
непустую таблицу. Значение по умолчанию: 8 Мб. 

<LI><code>character_set</code>

Принятый по умолчанию набор символов.

<LI><code>character_sets</code>

Поддерживаемые наборы символов.

<LI><code>concurrent_inserts</code>

Если установлено значение <code>ON</code> (принятое по
умолчанию), MySQL обеспечивает возможность использовать команду <code>INSERT</code>
на таблицах <code>MyISAM</code> одновременно с выполнением над этими же таблицами
запросов <code>SELECT</code>. Этот параметр можно отключить, запустив <code>mysqld</code> с
параметром <code>--safe</code> или <code>--skip-new</code>.

<LI><code>connect_timeout</code>

Количество времени в секундах, на протяжении которого
сервер <code>mysqld</code> ожидает поступления пакета соединения, после чего
генерирует <code>Bad handshake</code>.

<LI><code>datadir</code>

Значение параметра <code>--datadir</code>.

<LI><code>delay_key_write</code>

Опция для таблиц MyISAM. Может принимать одно из следующих значений: 

<TABLE BORDER WIDTH="100%">
<TR><TD>OFF </TD><TD> Все CREATE TABLE ... DELAYED_KEY_WRITES игнорируются.
</TD></TR>
<TR><TD>ON </TD><TD> (по умолчанию)  MySQL будет учитывать опцию <code>DELAY_KEY_WRITE</code>
в <code>CREATE TABLE</code>.
</TD></TR>
<TR><TD>ALL </TD><TD> Все вновь открытые таблицы обслуживаются так, будто бы они были созданы с опцией <code>DELAY_KEY_WRITE</code>.
</TD></TR>
</TABLE>

Если <code>DELAY_KEY_WRITE</code> включен, это означает что ключевой буфер для таблиц с этой опцией не будет сбрасываться на диск при каждом обновлении индексов, но только тогда, когда таблица закрывается. Это весьма ускорит записи ключей, но вы должны обязательно реализовать автоматическую проверку всех таких таблиц с помощью <code>myisamchk --fast --force</code> если вы хотите использовать эту опцию. 

<LI><code>delay_key_write</code>

Если включен (по умолчанию - включен), MySQL будет
учитывать параметр <code>DELAY_KEY_WRITE</code> для команды <code>CREATE</code> TABLE. Это
означает, что ключевой буфер таблиц с данным параметром будет
сбрасываться на диск не при каждом обновлении индексов, а только при
закрытии таблицы. Такой режим работы значительно ускоряет запись
ключей, однако в случае использования данного параметра необходимо
будет также добавить автоматическую проверку всех таблиц при помощи
<code>myisamchk --fast --force</code>. Обратите внимание: если запустить <code>mysqld</code> с
параметром <code>--delay-key-write-for-all-tables</code>, то все таблицы будут
обрабатываться таким образом, как будто они были созданы с применением
параметра <code>delay_key_write</code>. Этот флаг можно снять, запустив <code>mysqld</code> с
параметром <code>--skip-new</code> или <code>--safe-mode</code>.

<LI><code>delayed_insert_limit</code>

После вставки строк <code>delayed_insert_limit</code>
обработчик <code>INSERT DELAYED</code> проверит, остались ли незавершенные
операторы <code>SELECT</code>. Если да, то перед тем, как приступить к выполнению
следующих действий, они будут выполнены.

<LI><code>delayed_insert_timeout</code>

Временной промежуток, в течение которого
процесс <code>INSERT DELAYED</code> должен ожидать операторов <code>INSERT</code> до прекращения
выполнения задачи.

<LI><code>delayed_queue_size</code>

Размер очереди (в строках), который должен быть
назначен для обработки команды <code>INSERT DELAYED</code>. При переполнении
очереди все клиенты, выполняющие команду <code>INSERT DELAYED</code>, будут
ожидать, пока в очереди снова появится свободное место.

<LI><code>flush</code>

Значение этой переменной будет <code>ON</code>, если вы запустили MySQL с
параметром <code>--flush</code>.

<LI><code>flush_time</code>

Если значение этой переменной отличается от нуля, то каждые
<code>flush_time</code> секунд все таблицы будут закрываться (чтобы освободить
ресурсы и записать информацию на диск). Мы рекомендуем использовать
этот параметр только для Windows 9x/Me или на системах с ограниченным
количеством ресурсов.

<LI><code>ft_boolean_syntax</code>

Список операторов, поддерживаемых <code>MATCH ... AGAINST(... IN BOOLEAN MODE)</code>.
See section <A HREF="manual.ru_Reference.html#Fulltext_Search">6.8  Полнотекстовый поиск в MySQL</A>.

<LI><code>ft_min_word_len</code>

Минимальная длина слова, включаемого в индекс
<code>FULLTEXT</code>. <strong>Примечание: индексы <code>FULLTEXT</code> после изменения этой
переменной должны быть скомпонованы заново (это новый параметр в MySQL
4.0)</strong>.

<LI><code>ft_max_word_len</code>

Максимальная длина слова, включаемого в индекс
<code>FULLTEXT</code>. <strong>Примечание: индексы <code>FULLTEXT</code> после изменения этой переменной
должны быть скомпонованы заново (это новый параметр в MySQL 4.0)</strong>.

<LI><code>ft_max_word_len_for_sort</code>

Максимальная длина слова в индексе <code>FULLTEXT</code>; эта
длина будет использоваться для метода быстрого восстановления индекса
в командах <code>REPAIR</code>, <code>CREATE INDEX</code> или <code>ALTER</code> TABLE. Более длинные слова
вставляются дольше. При увеличении значения <code>ft_max_word_len_for_sort</code> MySQL
будет создавать временные файлы большего размера (таким образом будет
замедляться работа из-за возрастания нагрузки на порт ввода/вывода
диска), а также будет помещать меньше ключей в один блок сортировки
(что, опять же, способствует снижению производительности). Если
значение переменной <code>ft_max_word_len_for_sort</code> слишком мало, MySQL будет
вставлять большое количество слов достаточно медленно, но короткие
слова будут вставляться очень быстро.

<LI><code>ft_stopword_file</code>

Из этого файла читается список стоп-слов для полнотекстового поиска. 
Все слова из этого файла будут использованы, комментарии в этом файле <strong>недопустимы</strong>.
По умолчанию используется встроенный список стоп-слов (определен в файле 
<tt>`myisam/ft_static.c'</tt>).
Установка этого параметра в пустое значение (<code>""</code>) выключает фильтрацию по стоп-словам. 

<strong>Внимание: <code>FULLTEXT</code> индексы должны быть перестроены после того, как эта переменная изменена.</strong>
(Эта опция нова в MySQL 4.0.10)

<LI><code>have_innodb</code>

Значение <code>YES</code>, если <code>mysqld</code> поддерживает  таблицы
<code>InnoDB</code>. Значение <code>DISABLED</code>, если  используется  параметр 
<code>--skip-innodb</code>.

<LI><code>have_bdb</code>

Значение <code>YES</code>, если <code>mysqld</code> поддерживает таблицы <code>Berkeley DB</code>.
Значение <code>DISABLED</code>, если используется параметр <code>--skip-bdb</code>.

<LI><code>have_raid</code>

Значение <code>YES</code>, если <code>mysqld</code> поддерживает параметр <code>RAID</code>.

<LI><code>have_openssl</code>

Значение <code>YES</code>, если <code>mysqld</code> поддерживает SSL (шифрование) в
протоколе клиент/сервер.

<LI><code>init_file</code>

Имя файла, указанного при помощи параметра <code>--init-file</code> при
запуске сервера. Это файл операторов SQL, которые сервер должен
выполнить при запуске.

<LI><code>interactive_timeout</code>

Количество времени в секундах, на протяжении
которого сервер ожидает активности со стороны интерактивного
соединения, прежде чем закрыть его. Интерактивный клиент - это клиент,
который использует параметр <code>CLIENT_INTERACTIVE</code> для
<code>mysql_real_connect</code>(). См. также информацию по <code>wait_timeout</code>.

<LI><code>join_buffer_size</code>

Размер буфера, используемого для полных объединений
(объединения, в которых не применяются индексы). Буфер выделяется один
раз для каждого полного объединения двух таблиц. Если нужно ускорить
полное объединение и невозможно добавить индексы, следует увеличить
это значение (обычно добавление индексов является лучшим способом
добиться быстрых объединений).

<A NAME="IDX626"></A>
<LI><code>key_buffer_size</code>

Блоки индексов буферизированы и доступ к ним разрешен
всем потокам. <code>key_buffer_size</code> - размер буфера, используемого для
блоков индексов. Чтобы улучшить обработку индексов (для всех операций
чтения и записи нескольких элементов), необходимо увеличить это
значение настолько, насколько возможно. Размер 64 Мб для компьютера с
256 Мб (именно такой компьютер в основном используется для работы с
MySQL) - довольно распространенная конфигурация. Тем не менее, если
задать слишком большое значение (например, больше 50% от общего
количества памяти), система может начать сохранять временные файлы на
диске, что значительно снизит производительность. Помните, что,
поскольку MySQL не производит кэширования считываемых данных, нужно
оставлять определенное пространство для кэша файловой системы
операционной системы. Производительность буфера ключей можно
проверить, выполнив команду <code>SHOW STATUS</code> и проверив значения переменных
<code>Key_read_requests</code>, <code>Key_reads</code>, <code>Key_write_requests</code> и <code>Key_writes</code>.
Отношение значений <code>Key_reads</code>/<code>Key_read_request</code> обычно должно быть &#60;
0,01. Отношение <code>Key_write</code>/<code>Key_write_requests</code> примерно равно 1, если в
основном используются обновления/удаления, но может быть и меньше,
если чаще используются обновления сразу многих элементов или если
<code>DELAY_KEY_WRITE</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#SHOW">4.5.6  Синтаксис команды <code>SHOW</code></A>. Чтобы еще больше увеличить
скорость при одновременной записи большого количества строк,
используйте команду <code>LOCK TABLES</code>. See section <A HREF="manual.ru_Reference.html#LOCK_TABLES">6.7.2  Синтаксис команд <code>LOCK TABLES/UNLOCK TABLES</code></A>.

<LI><code>language</code>

Язык, используемый для вывода сообщений об ошибках.

<LI><code>large_file_support</code>

Если <code>mysqld</code> был откомпилирован с параметрами для
поддержки больших файлов.

<LI><code>locked_in_memory</code>

Если <code>mysqld</code> был заблокирован в памяти при помощи
<code>--memlock</code>

<LI><code>log</code>

Если включено занесение в журнал всех запросов.

<LI><code>log_update</code>

Если включен журнал обновлений.

<LI><code>log_bin</code>

Если включен бинарный журнал.

<LI><code>log_slave_updates</code>

Если обновления от подчиненного компьютера должны
заноситься в журнал.

<LI><code>long_query_time</code>

Если обработка запроса отнимает больше указанного
промежутка времени (в секундах), значение счетчика <code>Slow_queries</code> будет
увеличено. Если используется параметр <code>--log-slow-queries</code>, запрос будет
записан в журнал медленных запросов.
Это значение указывается в единицах реального времени, а не времени занятости процессора (CPU time).
Таким образом, некий запрос, который выполняется быстрее указываемого времени
на слегка загруженном сервере может выполняться больше указанного времени на
более загруженном компьютере. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Slow_query_log">4.9.5  Журнал медленных запросов</A>.

<LI><code>lower_case_table_names</code>

Если установлено значение 1, имена таблиц будут
сохранятся на диск с использованием строчных букв, а имена таблиц не
будут чувствительны к регистру. С версии MySQL 4.0.2 это также 
касается и имен баз данных. See section <A HREF="manual.ru_Reference.html#Name_case_sensitivity">6.1.3  Чувствительность имен к регистру</A>.

<LI><code>max_allowed_packet</code>

Максимальный размер одного пакета. Изначально
размер буфера сообщений устанавливается в <code>net_buffer_length</code> байтов, но
при необходимости может возрасти до <code>max_allowed_packet</code> байтов. Это
значение по умолчанию не настолько велико, чтобы отсеивать большие
(возможно ошибочные) пакеты. Если используются большие столбцы <code>BLOB</code>,
его необходимо увеличить. Значение должно быть не меньше самого
большого <code>BLOB</code>, который будет использоваться. Ограничение протокола для
<code>max_allowed_packet</code> составляет 16 Мб в MySQL 3.23 и 1Гб в MySQL 4.0.

<LI><code>max_binlog_cache_size</code>

Если для транзакции с большим количеством
операторов потребуется большее количество памяти, чем указано этим
параметром, будет выдано сообщение об ошибке "Multi-statement
transaction required more than 'max_binlog_cache_size' bytes of
storage" (для транзакции с большим количеством операторов требуется
больше, чем 'max_binlog_cache_size' байтов для хранения).

<LI><code>max_binlog_size</code>

Доступно после версии 3.23.33. Если запись в бинарный
журнал (репликация) превысит данное значение, производится ротация
журнала. Нельзя установить значение, меньшее, чем 1024 байта или
большее, чем 1 Гб. По умолчанию установлено значение 1 Гб.

<LI><code>max_connections</code>

Разрешенное количество одновременно подсоединенных
клиентов. Увеличение этого значения увеличивает количество
дескрипторов файлов, необходимых для <code>mysqld</code>. Ниже приведены примечания
по ограничениям для дескрипторов. See section <A HREF="manual.ru_Problems.html#Too_many_connections">A.2.5  Ошибка <code>Too many connections</code></A>.

<LI><code>max_connect_errors</code>

Если количество прерванных соединений с удаленным
компьютером превышает это число, дальнейшие попытки удаленного
компьютера установить соединение будут заблокированы. Блокировку с
удаленного компьютера можно снять при помощи команды <code>FLUSH HOSTS</code>.

<LI><code>max_delayed_threads</code>

Не запускайте больше потоков, чем указано здесь,
для обработки операторов <code>INSERT DELAYED</code>. Если попытаться вставить
данные в новую таблицу, когда все потоки <code>INSERT DELAYED</code> заняты, строка
будет вставлена таким образом, как будто атрибут <code>DELAYED</code> не был
указан.

<LI><code>max_heap_table_size</code>

Не позволяет создавать динамические таблицы,
размер которых превышает указанное значение.

<LI><code>max_join_size</code>

Объединения, которые потенциально могут считывать более
<code>max_join_size</code> записей, будут возвращать ошибку. Это значение нужно
задавать, если ваши пользователи осуществляют объединения, которым
недостает оператора <code>WHERE</code>,  -  такие объединения занимают много
времени, а затем возвращают миллионы строк.

<LI><code>max_sort_length</code>

Параметр определяет, сколько байтов следует
использовать при сортировке значений <code>BLOB</code> или <code>TEXT</code> (обрабатываются
только первые <code>max_sort_length</code> байтов каждого значения, остальные
игнорируются).

<LI><code>max_user_connections</code>

Максимальное количество активных соединений для
одного пользователя (0 = без ограничений).

<LI><code>max_tmp_tables</code>

(Этот параметр пока ни на что не влияет.) Максимальное
количество временных таблиц, которые клиент может открывать
одновременно.

<LI><code>max_write_lock_count</code>

После данного количества блокирования записей
разрешается выполнить между ними несколько блокировок чтения.

<LI><code>myisam_recover_options</code>

Значение  параметра  <code>--myisam-recover</code>.

<LI><code>myisam_sort_buffer_size</code>

Буфер, который выделяется для сортировки
индексов при выполнении команды <code>REPAIR</code> или для создания индексов при
помощи команд <code>CREATE INDEX</code> или <code>ALTER TABLE</code>.

<LI><code>myisam_max_extra_sort_file_size</code>.

Если размер временного файла,
используемого для быстрого создания индексов, превышает на указанный
здесь объем используемый кэш ключей, то лучше отдать предпочтение
методу кэша ключей. Такой метод применяется для того, чтобы для
больших ключей символов в больших таблицах использовался более
медленный метод кэширования ключей при создании таблиц.
<strong>Обратите внимание</strong>: значение этого параметра в байтах, начиная с 4.0.3
(до 4.0.3 параметр указывался в мегабайтах).

<LI><code>myisam_max_sort_file_size</code>

Максимальный размер временного файла,
который в MySQL может использоваться при восстановлении индекса (во
время работы команд <code>REPAIR</code>, <code>ALTER TABLE</code> или <code>LOAD DATA INFILE</code>). Для
файлов, размер которых превышает указанное значение, индекс будет
создаваться при помощи кэша ключей (такой алгоритм работает несколько
медленнее).
<strong>Обратите внимание</strong>: значение этого параметра в байтах, начиная с 4.0.3
(до 4.0.3 параметр указывался в мегабайтах).

<LI><code>net_buffer_length</code>

В данное значение устанавливается в промежутках
между запросами буфер соединения. Обычно это значение не изменяется,
но если у вас очень мало памяти, можно установить его по размеру
ожидаемого запроса (т.е. равным предполагаемой длине операторов SQL,
отправляемых клиентами; если оператор превысит указанную длину, буфер
будет автоматически увеличен как максимум до <code>max_allowed_packet</code>
байтов).

<LI><code>net_read_timeout</code>

Количество времени в секундах, на протяжении которого
ожидаются дополнительные данные от соединения, пока не будет отменено
чтение. Обратите внимание, что мы не ожидаем поступления данных от
соединения, время ожидания определяется по <code>write_timeout</code>. Также см.
<code>slave_net_timeout</code>.

<LI><code>net_retry_count</code>

Если чтение из порта связи было прервано, будет
предпринято указанное количество попыток повторного чтения. Это
значение должно быть достаточно высоким на <code>FreeBSD</code>, так как внутренние
прерывания направляются на все потоки.

<LI><code>net_write_timeout</code>

Время ожидания записи блока через соединение, пока
запись не будет прервана (в секундах).

<LI><code>open_files_limit</code>

Если это значение отлично от 0, то <code>mysqld</code> будет
применять его для резервных дескрипторов файлов, используемых с
<code>setrlimit()</code>. Если это значение равно 0, то <code>mysqld</code> будет резервировать
<code>max_connections*5</code> или <code>max_connections + table_cache*2</code> (в зависимости
от того, какое число больше) файлов. Если <code>mysqld</code> выдает ошибку 'Too
many open files' (слишком много открытых файлов), данное значение
необходимо увеличить.

<LI><code>pid_file</code>

Значение параметра <code>--pid-file</code>.

<LI><code>port</code>

Значение параметра <code>--port</code>.

<LI><code>protocol_version</code>

Версия протокола, используемого сервером MySQL.

<LI><code>read_buffer_size</code> (было <code>record_buffer</code>)

Каждый поток, осуществляющий последовательное
сканирование, выделяет буфер указанного размера для каждой сканируемой
таблицы. Если проводится много последовательных сканирований, это
значение можно увеличить.

<LI><code>record_rnd_buffer_size</code>

При считывании строк после проведения сортировки в
отсортированном порядке строки считываются через буфер, чтобы избежать
операций поиска по диску. Это может улучшить выполнение <code>ORDER BY</code> весьма
и весьма, если параметр установлен в большое значение. Т.к. эта переменная
имеет отношение к потоку, то не устанавливайте слишком большое значение
глобально, но просто меняйте его при выполнении некоторых больших запросов. 

<LI><code>query_cache_limit</code>

Результаты, превышающие это значение, не кэшируются
(по умолчанию - 1Мб).

<LI><code>query_cache_size</code>

Память, выделенная для хранения результатов старых
запросов. Если значение установлено в 0, кэш запросов отключен
(принято по умолчанию).

<LI><code>query_cache_type</code>

Могут быть заданы следующие значения (только
числовые):

<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Значение</strong> </TD><TD> <strong>Объяснение</strong> </TD><TD> <strong>Примечание</strong>
</TD></TR>
<TR><TD>0 </TD><TD> OFF </TD><TD> Не  кэширует  и  не  извлекает результаты.
</TD></TR>
<TR><TD>1 </TD><TD> ON </TD><TD> Кэширует все результаты, кроме запросов <code>SELECT SQL_NO_CACHE ...</code>.
</TD></TR>
<TR><TD>2 </TD><TD> DEMAND </TD><TD> Кэширует только запросы <code>SELECT SQL_CACHE ...</code>.
</TD></TR>
</TABLE>

<LI><code>safe_show_database</code>

Не отображаются базы данных, для которых у
пользователя нет каких-либо привилегий по базам данных или таблицам.
Таким образом можно увеличить степень безопасности, если вы не хотите
предоставлять посторонним лицам возможность получать информацию о том,
какие базы данных есть у других пользователей. Также  см. <code>skip_show_database</code>.

<LI><code>server_id</code>

Значение параметра <code>--server-id</code>.

<LI><code>skip_locking</code>

Установлено в значение <code>OFF</code>, если <code>mysqld</code> использует
внешнюю блокировку.

<LI><code>skip_networking</code>

Установлено в значение <code>ON</code>, если разрешаются только
локальные соединения (через сокет).

<LI><code>skip_show_database</code>

Эта переменная не позволяет выполнять команду <code>SHOW
DATABASES</code>, если у пользователя нет привилегии <code>PROCESS</code>. Таким образом
можно увеличить степень безопасности, если вы не хотите предоставлять
посторонним лицам возможность получать информацию о том, какие базы
данных есть у других пользователей. Также  см. <code>safe_show_database</code>.

<LI><code>slave_net_timeout</code>

Количество времени в секундах, в течение которого
ожидаются дополнительные данные от подсоединенного головного или
подчиненного компьютера прежде, чем будет отменено чтение.

<LI><code>slow_launch_time</code>

Если создание потока занимает больше, чем указанное
значение (в секундах), значение счетчика <code>Slow_launch_threads</code> будет
увеличено.

<LI><code>socket</code>

Сокет Unix, используемый сервером.

<LI><code>sort_buffer_size</code>

Каждый поток, которому необходимо произвести сортировку,
выделяет буфер данного размера. Увеличение данного значения позволит
ускорить выполнение операторов <code>ORDER BY</code> или <code>GROUP BY</code>. See section <A HREF="manual.ru_Problems.html#Temporary_files">A.4.4  Где MySQL хранит временные файлы</A>.

<LI><code>table_cache</code>

Количество открытых таблиц для всех потоков. С увеличением
этого значения увеличивается количество дескрипторов файлов,
необходимых для <code>mysqld</code>. Чтобы узнать, необходимо ли изменять значение
кэша таблиц, следует проверить значение переменной <code>Opened_tables</code>. См.
раздел See section <A HREF="manual.ru_Problems.html#Temporary_files">A.4.4  Где MySQL хранит временные файлы</A>. Если у этой переменной
большое значение, а команда <code>FLUSH TABLES</code> (которая закрывает все
таблицы, а потом открывает их повторно) используется не часто, то
необходимо увеличить ее значение. Чтобы получить дополнительную
информацию по кэшу таблиц, см. раздел See section <A HREF="manual.ru_MySQL_Optimisation.html#Table_cache">5.4.7  Открытие и закрытие таблиц в MySQL</A>.

<LI><code>table_type</code>

Принятый по умолчанию тип таблиц.

<LI><code>thread_cache_size</code>

Определяет, сколько потоков должно сохраняться в
кэше для повторного использования. После отключения клиента потоки
клиента помещаются в кэш, если там не больше потоков, чем
<code>thread_cache_size</code>. Все новые потоки сначала берутся из кэша, и только
когда кэш становится пустым, создаются новые потоки. Значение этой
переменной можно увеличить, чтобы повысить производительность, если
создается много новых соединений (если потоки у вас хорошо
организованы, обычно заметного улучшения производительности не
наблюдается). Насколько эффективен текущий кэш потоков, можно
определить по разнице между <code>Connections</code> и <code>Threads_created</code>.

<LI><code>thread_concurrency</code>

В системе Solaris <code>mysqld</code> вызывает функцию
<code>thr_setconcurrency()</code> с этим значением. <code>thr_setconcurrency()</code> позволяет
приложению дать системе потоков подсказку по необходимому количеству
потоков, которые должны быть запущены в одно и то же время.

<LI><code>thread_stack</code>

Размер стека для каждого потока. От данного значения
зависит большое количество ограничений, обнаруживаемых при помощи
теста <code>crash</code>-me. По умолчанию этот размер достаточен для нормальной
работы. See section <A HREF="manual.ru_MySQL_Optimisation.html#MySQL_Benchmarks">5.1.4  Набор тестов MySQL (The MySQL Benchmark Suite)</A>.

<LI><code>timezone</code>

Часовой пояс, в котором находится сервер.

<LI><code>tmp_table_size</code>

Если находящаяся в памяти временная таблица превысит
этот размер, MySQL автоматически преобразует ее в дисковую таблицу
<code>MyISAM</code>. Значение <code>tmp_table_size</code> следует увеличить, если выполняется
много расширенных запросов <code>GROUP BY</code> и в вашей системе установлено
значительное количество оперативной памяти.

<LI><code>tmpdir</code>

Каталог, используемый для временных файлов и временных таблиц.
Начиная с MySQL 4.1, в <code>tmpdir</code> могут быть указаны несколько путей, разделенных
двоеточием <code>:</code> (точкой с запятой на Windows <code>;</code>). Эти пути будут 
использованы в ротации. 

<LI><code>version</code>

Номер версии сервера.

<LI><code>wait_timeout</code>

Время в секундах, на протяжении которого сервер наблюдает неактивность в
неинтерактивном соединения прежде, чем закрыть его.  Когда запускается поток,
<code>SESSION.WAIT_TIMEOUT</code> инициализируется исходя из
<code>GLOBAL.WAIT_TIMEOUT</code> или <code>GLOBAL.INTERACTIVE_TIMEOUT</code>, в зависимости
от типа клиента (как определяется в <code>CLIENT_INTERACTIVE</code> опции
соединения).

См. также <code>interactive_timeout</code>.
</ul>

<P>
Раздел руководства, в котором описывается настройка MySQL содержит
некоторую информацию по настройке приведенных выше переменных. 
See section <A HREF="manual.ru_MySQL_Optimisation.html#Server_parameters">5.5.2  Настройка параметров сервера</A>.

</P>


<H4><A NAME="SHOW_LOGS" HREF="manual.ru_toc.html#SHOW_LOGS">4.5.6.5  <code>SHOW LOGS</code></A></H4>

<P>
<code>SHOW LOGS</code> отображает информацию по состоянию существующих файлов журналов.
На данный момент выводится информация только по файлам журналов Berkeley
DB.

</P>

<ul>
<LI><code>File</code> отображает полный путь к файлу журнала

<LI><code>Type</code> отображает тип файла журнала (<code>BDB</code> для файлов журналов Berkeley

DB)
<LI><code>Status</code> отображает состояние файла журнала (<code>FREE</code> - если файл может быть

удален, или <code>IN USE</code>, если файл необходим подсистеме транзакций).
</ul>



<H4><A NAME="SHOW_PROCESSLIST" HREF="manual.ru_toc.html#SHOW_PROCESSLIST">4.5.6.6  <code>SHOW PROCESSLIST</code></A></H4>

<P>
<A NAME="IDX627"></A>
<A NAME="IDX628"></A>
<A NAME="IDX629"></A>

</P>
<P>
<A NAME="IDX630"></A>
<A NAME="IDX631"></A>

</P>
<P>
Команда <code>SHOW [FULL] PROCESSLIST</code> показывает, какие потоки запущены в
настоящий момент. Эту информацию также можно получить при помощи команды
<code>mysqladmin processlist</code>. Если у вас привилегия <code>SUPER</code>, можно
просматривать все потоки, в противном случае - только свои потоки. See section <A HREF="manual.ru_MySQL_Database_Administration.html#KILL">4.5.5  Синтаксис команды <code>KILL</code></A>.
Если не используется параметр <code>FULL</code>, будут показаны только первые 100
символов каждого запроса.

</P>
<P>
Начиная с 4.0.12, MySQL сообщает имя хоста для TCP/IP соединений как 
<code>имя_хоста:клиентский_порт</code> с тем, чтобы было проще понять, какой клиент
чем занят. 

</P>
<P>
Эта команда очень полезна, если выдается сообщение об ошибке 'too many
connections' (слишком много соединений) и необходимо выяснить, что
происходит. MySQL резервирует одно дополнительное соединение для клиента с
привилегией <code>SUPER</code>, чтобы у вас всегда была возможность войти в систему и
произвести проверку (предполагается, что вы не станете раздавать эту
привилегию всем своим пользователям).

</P>
<P>
Некоторые состояния обычно можно увидеть в <code>mysqladmin processlist</code>.

</P>

<ul>
<LI><code>Checking table</code>

Поток осуществляет [автоматическую] проверку таблицы.
<LI><code>Closing tables</code>

Означает, что поток записывает измененные данные таблиц
на диск и закрывает использующиеся таблицы. Выполнение этой операции
должно произойти быстро. Если на нее уходит значительное время,
убедитесь, что диск не переполнен или что диск не используется слишком
интенсивно.
<LI><code>Connect Out</code>

Подчиненный компьютер, подсоединенный к головному
компьютеру.
<LI><code>Copying to tmp table on disk</code>

Набор временных результатов превысил
<code>tmp_table_size</code>, и теперь поток изменяет таблицу временных данных,
расположенную в памяти, на дисковую таблицу, чтобы сохранить память.
<LI><code>Creating tmp table</code>

Поток создает временную таблицу, чтобы хранить
часть результатов для запроса.
<LI><code>deleting from main table</code>

При запуске первой части удаления нескольких
таблиц удаление производится только начиная с первой таблицы.
<LI><code>deleting from reference tables</code>

При запуске второй части удаления
нескольких таблиц удаляются совпадающие строки из других таблиц.
<LI><code>Flushing tables</code>

Поток запускает команду <code>FLUSH TABLES</code> и ожидает, пока
все потоки закроют свои таблицы.
<LI><code>Killed</code>

Кто-то направил команду на закрытие потока, и поток будет
закрыт при следующей проверке флага закрытия. Флаг проверяется при
каждом основном цикле в MySQL, но в некоторых случаях закрытие потока
может занять некоторое время. Если поток заблокирован другим потоком,
закрытие будет произведено сразу после того, как другой поток снимет
блокировку.
<LI><code>Sending data</code>

Поток обрабатывает строки для оператора <code>SELECT</code>, а также
направляет данные клиенту.
<LI><code>Sorting for group</code>

Поток осуществляет сортировку в соответствии с <code>GROUP BY</code>.
<LI><code>Sorting for order</code>

Поток осуществляет сортировку в соответствии с <code>ORDER BY</code>.
<LI><code>Opening tables</code>

Это просто означает, что поток пытается открыть
таблицу. Такая процедура осуществляется довольно быстро, если что-либо
не мешает открытию. Например, команды <code>ALTER TABLE</code> или <code>LOCK TABLE</code> могут
помешать открытию таблицы, пока выполнение команды не будет завершено.
<LI><code>Removing duplicates</code>

Запрос использовал команду <code>SELECT DISTINCT</code> таким
образом, что MySQL не смог произвести оптимизацию на начальном этапе.
Поэтому MySQL перед отправкой результатов клиенту должен выполнить
дополнительное удаление всех дублирующихся строк.
<LI><code>Reopen table</code>

Поток заблокировал таблицу, но обнаружил, что после
блокировки структура таблицы изменилась. Он снял блокировку, закрыл
таблицу и теперь пытается повторно ее открыть.
<LI><code>Repair by sorting</code>

Код восстановления использует сортировку для
создания индексов.
<LI><code>Repair with keycache</code>

Код восстановления использует создание ключей
один за другим, через кэш ключей. Это намного медленнее, чем <code>Repair by
sorting</code>.
<LI><code>Searching rows for update</code>

Поток осуществляет первую фазу - производит
поиск всех совпадающих строк, чтобы затем обновить их. Это действие
необходимо выполнить, если команда <code>UPDATE</code> изменяет индекс, который
используется для поиска указанных строк.
<LI><code>Sleeping</code>

Поток ожидает, когда клиент направит ему новую команду.
<LI><code>System lock</code>

Поток ожидает получения внешней системной блокировки
таблицы. Если не используется несколько серверов <code>mysqld</code>, которые
получают доступ к одним и тем же таблицам, системную блокировку можно
отключить при помощи параметра <code>--skip-external-locking</code>.
<LI><code>Upgrading lock</code>

Обработчик <code>INSERT DELAYED</code> пытается заблокировать
таблицу, чтобы вставить строки.
<LI><code>Updating</code>

Поток производит поиск строк, которые необходимо обновить, и
обновляет их.
<LI><code>User Lock</code>

Поток  ожидает  <code>GET_LOCK()</code>.
<LI><code>Waiting for tables</code>

Поток получил уведомление, что структура таблицы
изменилась, и ему необходимо повторно открыть таблицу, чтобы получить
новую структуру. Чтобы повторно открыть таблицу, он должен подождать,
пока ее не закроют все остальные потоки. Это уведомление выдается,
если другой поток воспользовался командой <code>FLUSH TABLES</code> или к таблице
была применена одна из следующих команд: <code>FLUSH TABLES table_name</code>,
<code>ALTER TABLE</code>, <code>RENAME TABLE</code>, <code>REPAIR TABLE</code>, <code>ANALYZE TABLE</code> или <code>OPTIMIZE TABLE</code>.
Обработчик <code>INSERT DELAYED</code> завершил работу
со всеми вставками и ожидает новые.
</ul>

<P>
Большинство состояний - это очень быстрые операции. Если потоки остаются в
любом из этих состояний на протяжении большого количества секунд, то,
возможно, возникла какая-то проблема, которую следует устранить.

</P>
<P>
Существует еще несколько состояний, не упомянутых выше, но большинство из
них полезны только для поиска ошибок в <code>mysqld</code>.

</P>


<H4><A NAME="SHOW_GRANTS" HREF="manual.ru_toc.html#SHOW_GRANTS">4.5.6.7  <code>SHOW GRANTS</code></A></H4>

<P>
<A NAME="IDX632"></A>
<A NAME="IDX633"></A>

</P>
<P>
<A NAME="IDX634"></A>
<A NAME="IDX635"></A>

</P>
<P>
SHOW GRANTS FOR user выводит список команд назначения привилегий, которые
нужны при дублировании привилегий для пользователя.

</P>

<pre>
mysql&#62; SHOW GRANTS FOR root@localhost;
+---------------------------------------------------------------------+
| Grants for root@localhost                                          |
+---------------------------------------------------------------------+
| GRANT ALL PRIVILEGES ON *.* TO 'root''localhost' WITH GRANT OPTION |
+---------------------------------------------------------------------+
</pre>

<P>
Для получения информации по привилегии в текущей сессии можно использовать
функцию <code>CURRENT_USER()</code> (новшество в версии 4.0.6) для того, чтобы
выяснить, по какому пользователю в действительности аутентифицировалась сессия.
See section <A HREF="manual.ru_Reference.html#Miscellaneous_functions">6.3.6.2  Разные функции</A>.

</P>



<H4><A NAME="SHOW_CREATE_TABLE" HREF="manual.ru_toc.html#SHOW_CREATE_TABLE">4.5.6.8  <code>SHOW CREATE TABLE</code></A></H4>

<P>
<A NAME="IDX636"></A>

</P>
<P>
Показывает оператор <code>CREATE TABLE</code>, который будет создавать данную таблицу:

</P>

<pre>
mysql&#62; SHOW CREATE TABLE t\G
*************************** 1. row ***************************
Table: t
Create Table: CREATE TABLE t (
id int(11) default NULL auto_increment,
s char(60) default NULL,
PRIMARY KEY (id)
) TYPE=MyISAM
</pre>

<P>
Команда  <code>SHOW CREATE TABLE</code>  будет выдавать таблицу и названия столбцов
в  соответствии с параметром <code>SQL_QUOTE_SHOW_CREATE</code>. See section <A HREF="manual.ru_MySQL_Optimisation.html#SET_OPTION">5.5.6  Синтаксис команды <code>SET</code></A>.

</P>


<H4><A NAME="SHOW_WARNINGS" HREF="manual.ru_toc.html#SHOW_WARNINGS">4.5.6.9  <code>SHOW WARNINGS | ERRORS</code></A></H4>

<P>
<A NAME="IDX637"></A>

</P>

<pre>
SHOW WARNINGS [LIMIT #]
SHOW ERRORS [LIMIT #]
</pre>

<P>
Эта команда реализована в версии MySQL 4.1.0.

</P>
<P>
Команда показывает информацию по ошибкам, предупреждениям и сообщениям,
касающихся последней команды.  Эти сообщения сбрасываются для каждой новой
команды, использующей таблицы.

</P>
<P>
Сервер MySQL возвращает общее количество сообщений и ошибок, которые вы
получили для последней команды. Это количество можно получить вызовом
<code>mysql_warning_count()</code>.

</P>
<P>
Максимум <code>max_error_count</code> сообщений сохраняется (переменная глобальная и
специфичная для потока). 

</P>
<P>
Вы можете получить количество ошибок из  <code>@error_count</code> и количество
предупреждений из <code>@warning_count</code>.

</P>
<P>
<code>SHOW WARNINGS</code> сообщает все ошибки, предупреждения и заметки, которые вы получили 
для последней команды, в то время как <code>SHOW ERRORS</code> даешь лишь только информацию по 
ошибкам. 

</P>

<pre>
mysql&#62; DROP TABLE IF EXISTS нет_такой_таблицы;
mysql&#62; SHOW WARNINGS;

+-------+------+-----------------------------------+
| Level | Code | Message                           |
+-------+------+-----------------------------------+
| Note  | 1051 | Unknown table 'нет_такой_таблицы' |
+-------+------+-----------------------------------+
</pre>



<H4><A NAME="SHOW_TABLE_TYPES" HREF="manual.ru_toc.html#SHOW_TABLE_TYPES">4.5.6.10  <code>SHOW TABLE TYPES</code></A></H4>

<P>
<A NAME="IDX638"></A>

</P>

<pre>
SHOW TABLE TYPES
</pre>

<P>
Эта команда реализована в 4.1.0.

</P>
<P>
<code>SHOW TABLE TYPES</code> дает статусную информацию про типы таблиц.  Эта
информация полезна, например, для проверки, поддерживается ли определенный тип
таблицы или для того чтобы узнать, какой тип таблиц используется по умолчанию. 

</P>

<pre>
mysql&#62; SHOW TABLE TYPES;

+--------+---------+----------------------------------------------------------------+
| Type   | Support | Comment                                                        |
+--------+---------+----------------------------------------------------------------+
| MyISAM | DEFAULT | Основной тип для 3.23 с отличной производительностью           | 
| HEAP   | YES     | Хеш-тип, хранится только в памяти, полезен для временных таблиц|
| MERGE  | YES     | Набор идентичных MyISAM-таблиц                                 |
| ISAM   | YES     | Старый тип; замещен MyISAM                                     |
| InnoDB | YES     | Поддерживает транзакции, строчную блокировку и внешние ключи   |
| BDB    | NO      | Поддерживает транзакции и страничную блокировку                |
+--------+---------+----------------------------------------------------------------+
6 rows in set (0.00 sec)
</pre>

<P>
Опция <code>DEFAULT</code> в столбце <code>Support</code> указывает, что данный конкретный
тип таблицы поддерживается и является принятым по умолчанию. Если сервер был
запущен с <code>--default-table-type=InnoDB</code>, тогда для InnoDB столбец
<code>Support</code> примет значение <code>DEFAULT</code>. 

</P>



<H4><A NAME="SHOW_PRIVILEGES" HREF="manual.ru_toc.html#SHOW_PRIVILEGES">4.5.6.11  <code>SHOW PRIVILEGES</code></A></H4>

<P>
<A NAME="IDX639"></A>

</P>

<pre>
SHOW PRIVILEGES
</pre>

<P>
Эта команда реализована в MySQL 4.1.0.

</P>
<P>
<code>SHOW PRIVILEGES</code> показывает список системных привилегий, 
которые поддерживаются сервером MySQL. 

</P>

<pre>
mysql&#62; show privileges;
+------------+--------------------------+-------------------------------------------------------+
| Privilege  | Context                  | Comment                                               |
+------------+--------------------------+-------------------------------------------------------+
| Select     | Tables                   | To retrieve rows from table                           |
| Insert     | Tables                   | To insert data into tables                            |
| Update     | Tables                   | To update existing rows                               |
| Delete     | Tables                   | To delete existing rows                               |
| Index      | Tables                   | To create or drop indexes                             |
| Alter      | Tables                   | To alter the table                                    |
| Create     | Databases,Tables,Indexes | To create new databases and tables                    |
| Drop       | Databases,Tables         | To drop databases and tables                          |
| Grant      | Databases,Tables         | To give to other users those privileges you possess   |
| References | Databases,Tables         | To have references on tables                          |
| Reload     | Server Admin             | To reload or refresh tables, logs and privileges      |
| Shutdown   | Server Admin             | To shutdown the server                                |
| Process    | Server Admin             | To view the plain text of currently executing queries |
| File       | File access on server    | To read and write files on the server                 |
+------------+--------------------------+-------------------------------------------------------+
14 rows in set (0.00 sec)
</pre>

<P>
Этот же пример в переводе на русский язык: 

</P>

<pre>
mysql&#62; show privileges;
+------------+--------------------------+-------------------------------------------------------+
| Привилегия | Контекст                 | Описание                                              |
+------------+--------------------------+-------------------------------------------------------+
| Select     | Таблица                  | Для выборки строк из таблицы                          |
| Insert     | Таблица                  | Для вставки данных в таблицы                          |
| Update     | Таблица                  | Для обновления существующих записей                   |
| Delete     | Таблица                  | Для удаления существующих записей                     |
| Index      | Таблица                  | Для создания или удаления индексов                    |
| Alter      | Таблица                  | Для изменения таблиц                                  |
| Create     | База,Таблица,Индекс      | Для создания новых баз данных и таблиц                |
| Drop       | База,Таблица             | Для удаления баз данных и таблиц                      |
| Grant      | База,Таблица             | Для раздачи другим пользователям имеющихся у вас прав |
| References | База,Таблица             | Для обладания ссылок на таблицы                       |
| Reload     | Администрирование        | Для обновления таблиц, журналов и привилегий          |
| Shutdown   | Администрирование        | Для остановки сервера                                 |
| Process    | Администрирование        | Для просмотра текста выполняющихся запросов           |
| File       | Доступ к файлам          | Для чтения и записи файлов на сервере                 |
+------------+--------------------------+-------------------------------------------------------+
14 rows in set (0.00 sec)
</pre>



<H2><A NAME="Localisation" HREF="manual.ru_toc.html#Localisation">4.6  Локализация MySQL и использование национальных алфавитов</A></H2>



<H3><A NAME="Character_sets" HREF="manual.ru_toc.html#Character_sets">4.6.1  Набор символов, применяющийся для записи данных и сортировки</A></H3>

<P>
<A NAME="IDX640"></A>
<A NAME="IDX641"></A>
<A NAME="IDX642"></A>
<A NAME="IDX643"></A>
<A NAME="IDX644"></A>
<A NAME="IDX645"></A>

</P>
<P>
По умолчанию в MySQL используется набор символов ISO-8859-1 (Latin1) с
сортировкой согласно шведским/финским правилам. Этот набор символов также
подходит для использования в США и Западной Европе.

</P>
<P>
Все стандартные исполняемые файлы MySQL компилируются с настройкой
<code>--with-extra-charsets=complex</code>. Таким образом в файл помещается код,
позволяющий всем стандартным программам работать с набором символов
<code>latin1</code>, а также многобайтовыми наборами символов. Другие наборы символов
могут загружаться из соответствующих файлов определений по необходимости.

</P>
<P>
Набор определяет, какие символы могут использоваться в именах, а также
способ сортировки значений в операторах <code>ORDER BY</code> и <code>GROUP BY</code> команды
<code>SELECT</code>.

</P>
<P>
При запуске сервера можно изменить набор символов при помощи параметра
<code>--default-character-set</code>. Выбрать доступные наборы символов можно при
помощи параметров <code>--with-charset=charset</code> и <code>--with-extra-charsets=
список-кодировок | complex | all</code>, и файлов наборов символов, перечисленных
в <code>SHAREDIR/charsets/Index</code>. See section <A HREF="manual.ru_Installing.html#configure_options">2.3.3  Типичные опции <code>configure</code></A>.

</P>
<P>
При смене набора символов во время работы MySQL (что может одновременно
изменить и порядок сортировки) необходимо запустить команду <code>myisamchk -r
-q --set-character-set=charset</code> для всех таблиц. В противном случае индексы
могут быть созданы в неправильном порядке.

</P>
<P>
При подключении клиента к серверу MySQL сервер отправляет ему используемый
по умолчанию набор символов. На время соединения клиент переключается на
использование этого набора.

</P>
<P>
Для экранирования строк в SQL-запросе необходимо пользоваться функцией
<code>mysql_real_escape_string()</code>. <code>mysql_real_escape_string()</code> идентична старой
функции <code>mysql_escape_string()</code> - во всем, кроме одного: в качестве первого
параметра она принимает дескриптор соединения MYSQL.

</P>
<P>
Если клиент был скомпилирован с набором путей, в которых не было пути
установки сервера, а настраивавший MySQL пользователь на включил в
исполняемый файл системы все наборы символов, клиенту необходимо сообщить
о местонахождении дополнительных наборов символов, которые нужны ему для
общения с сервером.

</P>
<P>
Сделать это можно путем внесения в файл настроек MySQL следующей строки:

</P>

<pre>
[client]
character-sets-dir=/usr/local/mysql/share/mysql/charsets
</pre>

<P>
путь в ней указывает на каталог, в котором хранятся динамические наборы
символов MySQL.

</P>
<P>
Заставить клиента использовать определенный набор символов можно следующим
образом:

</P>

<pre>
[client]
default-character-set=character-set-name
</pre>

<P>
но обычно этого не требуется.

</P>



<H4><A NAME="German_character_set" HREF="manual.ru_toc.html#German_character_set">4.6.1.1  Набор символов немецкого алфавита</A></H4>

<P>
Для задания порядка сортировки в соответствии с немецким алфавитом нужно
запустить <code>mysqld</code> с параметром <code>--default-character-set=latin1_de</code>.

</P>
<P>
При сортировке и сравнении строк осуществляется следующая подстановка:

</P>

<pre>
Д  -&#62;  ae
Ж  -&#62;  oe
Э  -&#62;  ue
ъ  -&#62;  ss
</pre>

<P>
Все символы с диакритическими знаками заменяются их аналогами из верхнего
регистра и без ударения. Все буквы переводятся в верхний регистр.

</P>
<P>
При сравнении строк с помощью команды <code>LIKE</code>, подстановки двух символов
вместо одного не происходит. Все буквы переводятся в верхний регистр.
Диакритические знаки снимаются со всех букв, кроме: <code>э</code>, <code>Э</code>, <code>ж</code>, <code>Ж</code>, <code>д</code> и <code>Д</code>.

</P>


<H3><A NAME="Languages" HREF="manual.ru_toc.html#Languages">4.6.2  Сообщения об ошибках на языках, отличных от английского</A></H3>

<P>
<A NAME="IDX646"></A>
<A NAME="IDX647"></A>
<A NAME="IDX648"></A>
<A NAME="IDX649"></A>

</P>
<P>
<code>mysqld</code> может выдавать сообщения об ошибках на следующих языках: чешском,
датском, голландском, английском (по умолчанию), эстонском, французском,
немецком, греческом, венгерском, итальянском, японском, корейском,
норвежском, новонорвежском, польском, португальском, румынском, русском,
словацком, испанском и шведском.

</P>
<P>
При запуске <code>mysqld</code> выбрать определенный язык можно при помощи настройки
<code>--language=язык</code> или <code>-L язык</code>. Например:

</P>

<pre>
shell&#62; mysqld --language=swedish
или:
shell&#62; mysqld --language=/usr/local/share/swedish
</pre>

<P>
Обратите внимание: названия языков вводятся в нижнем регистре.

</P>
<P>
Файлы языков по умолчанию располагаются в папке
<tt>`<var>mysql_base_dir</var>/share/<var>LANGUAGE</var>/'</tt>.

</P>
<P>
Для того чтобы изменить тексты сообщений об ошибках, нужно отредактировать
файл <tt>`errmsg.txt'</tt> и запустить следующую команду для генерации нового файла
<tt>`errmsg.sys'</tt>:

</P>

<pre>
shell&#62; comp_err errmsg.txt errmsg.sys
</pre>

<P>
Установив новую версию MySQL, не забудьте внести те же изменения в новый
файл <tt>`errmsg.txt'</tt>.

</P>


<H3><A NAME="Adding_character_set" HREF="manual.ru_toc.html#Adding_character_set">4.6.3  Добавление набора символов</A></H3>

<P>
<A NAME="IDX650"></A>
<A NAME="IDX651"></A>
<A NAME="IDX652"></A>
<A NAME="IDX653"></A>

</P>
<P>
Снабдить MySQL новым набором символов можно следующим образом.

</P>
<P>
Определите, является ли новый набор символов простым или сложным. Если для
работы с этим набором никаких специальных процедур обработки строк и
поддержки многобайтовых символов не требуется, он является простым. Если
вышеперечисленные возможности необходимы, этот набор символов относится к
сложным.

</P>
<P>
Например, наборы <code>latin1</code> и <code>danish</code> - простые, а <code>big5</code> и <code>czech</code> - сложные.

</P>
<P>
Для всех приведенных ниже примеров предполагается, что используемый набор
символов называется <code>MYSET</code>.

</P>
<P>
Для создания простого набора достаточно сделать следующее:

</P>

<ol>
<LI>

Вставьте имя <code>MYSET</code> в конец файла <tt>`sql/share/charsets/Index'</tt> и присвойте
этому набору символов уникальный номер.

<LI>

Создайте файл <tt>`sql/share/charsets/MYSET.conf'</tt>. (в качестве основы можно
использовать файл <tt>`sql/share/charsets/latin1.conf'</tt>). Правила составления
этого файла очень просты:


<ul>
<LI>

Комментарием считается целая строка, начинающаяся с символа <samp>`#'</samp>.

<LI>

Слова разделяются любым количеством непечатаемых символов.

<LI>

При определении набора символов каждое слово должно представлять собой
число в шестнадцатеричной системе счисления.

<LI>

Массив ctype занимает первых 257 слов. За ним следуют массивы
<code>to_lower</code>, <code>to_upper[]</code> и <code>sort_order[]</code>, каждый из которых занимает 256 слов.
</ul>

See section <A HREF="manual.ru_MySQL_Database_Administration.html#Character_arrays">4.6.4  Массивы определения символов</A>.

<LI>

Добавьте имя набора символов в списки <code>CHARSETS_AVAILABLE</code> и
<code>COMPILED_CHARSETS</code> файла <tt>`configure.in'</tt>.

<LI>

Перенастройте, перекомпилируйте и протестируйте систему.

</ol>

<P>
Для создания сложного набора необходимо выполнить следующие действия:

</P>

<ol>
<LI>

Создайте файл strings/ctype-MYSET.c в исходном дистрибутиве MySQL.

<LI>

Вставьте имя MYSET в конец файла sql/share/charsets/Index и присвойте
этому набору символов уникальный номер.

<LI>

Просмотрите один из существующих файлов ctype-*.c
(например strings/ctype-big5.c) и узнайте, что нужно определить. Не
забывайте, что имена массивов в вашем файле должны быть похожи на
следующие: ctype_MYSET, to_lower_MYSET и т.п. Эти имена соответствуют
именам массивов из простого набора символов (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Character_arrays">4.6.4  Массивы определения символов</A>).

<LI>

В начале файла целесообразно поместить комментарий наподобие
следующего:


<pre>
/*
этот комментарий разбирается configure для создания ctype.c,
поэтому не меняйте его, если не уверены в правильности своих действий.
*
.configure. number_MYSET=MYNUMBER
.configure. strxfrm_multiply_MYSET=N
.configure. mbmaxlen_MYSET=N
*/
</pre>

Программа configure использует этот комментарий для линкования набора
символов с библиотекой MySQL. Значение строк strxfrm_multiply и mbmaxlen
будет разъяснено ниже. Использовать их нужно только в том случае, если вам
нужны функции для сортировки строк или работы с многобайтовыми наборами
символов соответственно.

<LI>

После этого нужно создать некоторые из следующих функций:


<ul>
<LI><code>my_strncoll_MYSET()</code>

<LI><code>my_strcoll_MYSET()</code>

<LI><code>my_strxfrm_MYSET()</code>

<LI><code>my_like_range_MYSET()</code>

</ul>

See section <A HREF="manual.ru_MySQL_Database_Administration.html#String_collating">4.6.5  Поддержка упорядочивания строк</A>.

<LI>

Добавьте имя набора символов в списки <code>CHARSETS_AVAILABLE</code> и
<code>COMPILED_CHARSETS</code> файла <tt>`configure.in'</tt>.

<LI>

Перенастройте, перекомпилируйте и протестируйте систему.
</ol>

<P>
Более подробные инструкции приведены в файле <tt>`sql/share/charsets/README'</tt>.

</P>
<P>
Если вы хотите, чтобы ваш набор символов был включен в комплект поставки
MySQL, вышлите патч с ним по адресу <a HREF="mailto:internals@lists.mysql.com">internals@lists.mysql.com</a>.

</P>


<H3><A NAME="Character_arrays" HREF="manual.ru_toc.html#Character_arrays">4.6.4  Массивы определения символов</A></H3>

<P>
<A NAME="IDX654"></A>
<A NAME="IDX655"></A>

</P>
<P>
Простые массивы <code>to_lower[]</code> и <code>to_upper[]</code> содержат символы верхнего и
нижнего регистров, соответствующие каждому из символов набора. Например:

</P>

<pre>
to_lower['A'] should contain 'a'
to_upper['a'] should contain 'A'
</pre>

<P>
<code>sort_order[]</code> - карта, устанавливающая правила упорядочивания символов для
сравнения и сортировки. Во многих наборах символов эта таблица совпадает с
<code>to_upper[]</code> (благодаря чему при сортировке регистр символов не
учитывается). MySQL сортирует символы в соответствии со значением
<code>sort_order[символ]</code>. Более сложные правила упорядочивания строк
разъясняются ниже. See section <A HREF="manual.ru_MySQL_Database_Administration.html#String_collating">4.6.5  Поддержка упорядочивания строк</A>.

</P>
<P>
<code>ctype[]</code> представляет собой массив битов, по одному элементу на каждый из
символов. (Массивы <code>to_lower[]</code>, <code>to_upper[]</code>, и <code>sort_order[]</code> индексируются по
значению символа, а <code>ctype[]</code> - по значению символа + 1. Это позволяет
обрабатывать символы <code>EOF</code>).

</P>
<P>
В файле <tt>`m_ctype.h'</tt> приведены следующие определения битовых масок:

</P>

<pre>
#define _U 01 /* верхний регистр */
#define _L 02 /* нижний регистр */
#define _N 04 /* число (цифра) */
#define _S 010 /* символ пробела */
#define _P 020 /* знак пунктуации */
#define _C 040 /* управляющий символ */
#define _B 0100 /* пустой символ */
#define _X 0200 /* шестнадцатеричная цифра */
</pre>

<P>
Значение <code>ctype[]</code> для каждого из символов должно представлять собой
объединение значений битовых масок, описывающих символ. Например, <code>'A'</code> 
представят собой символ верхнего регистра (<code>_U</code>) а также шестнадцатеричную
цифру (<code>_X</code>), поэтому элемент <code>['A'+1]</code> должен содержать значение:

</P>

<pre>
_U + _X = 01 + 0200 = 0201
</pre>



<H3><A NAME="String_collating" HREF="manual.ru_toc.html#String_collating">4.6.5  Поддержка упорядочивания строк</A></H3>

<P>
<A NAME="IDX656"></A>
<A NAME="IDX657"></A>

</P>
<P>
Если правила сортировки вашего естественного языка слишком сложны и не
могут быть заданы с помощью простой таблицы <code>sort_order</code>[], необходимо
использовать функции упорядочивания строк.

</P>
<P>
В настоящее время лучшим справочным пособием по этому вопросу являются уже
реализованные наборы символов. Примером такой реализации могут служить
наборы <code>big5</code>, <code>czech</code>, <code>gbk</code>, <code>sjis</code> и <code>tis160</code>.

</P>
<P>
В начале файла в особом комментарии необходимо указать значение
<code>strxfrm_multiply_MYSET=N</code>. Значение <code>N</code> представляет собой максимальный
прирост объема строк во время <code>my_strxfrm_MYSET</code> (т.е. положительное целое
число).

</P>


<H3><A NAME="Multi-byte_characters" HREF="manual.ru_toc.html#Multi-byte_characters">4.6.6  Поддержка многобайтовых символов</A></H3>

<P>
<A NAME="IDX658"></A>
<A NAME="IDX659"></A>

</P>
<P>
При желании обеспечить поддержку нового набора, содержащего многобайтовые
символы, нужно пользоваться специальными функциями для работы с
многобайтовыми символами.

</P>
<P>
В настоящее время лучшим справочным пособием по этому вопросу являются уже
реализованные наборы символов. Примером такой реализации могут служить
наборы <code>euc_kr</code>, <code>gb2312</code>, <code>gbk</code>, <code>sjis</code> и <code>ujis</code>. Они реализованы в файлах
<tt>`ctype-'charset'.c'</tt>, расположенных в папке <tt>`strings'</tt>.

</P>
<P>
В начале файла в особом комментарии необходимо указать значение
<code>strxfrm_multiply_MYSET=N</code>. Значение <code>N</code> должно содержать объем самого
``большого'' символа набора в байтах.

</P>


<H3><A NAME="Problems_with_character_sets" HREF="manual.ru_toc.html#Problems_with_character_sets">4.6.7  Проблемы с наборами символов</A></H3>

<P>
При попытке воспользоваться набором символов, не включенным в исполняемый
файл, можно столкнуться со следующими неприятностями:

</P>

<ul>
<LI>

В программе задан неверный путь к каталогу, в котором хранятся наборы
символов (по умолчанию это <tt>`/usr/local/mysql/share/mysql/charsets'</tt>).
Данную  проблему можно решить с помощью настройки
<code>--character-sets-dir</code>.
<LI>

Набор символов является многобайтовым и не может быть загружен
динамически. В таком случае нужно перекомпилировать программу и
включить в нее поддержку нужного набора.
<LI>

Набор символов может быть загружен динамически, но конфигурационного
файла для него нет. В таком случае нужно скопировать файл для этого
набора из нового дистрибутива MySQL.
<LI>

В файле <tt>`Index'</tt> нет имени набора символов.


<pre>
ERROR 1105: File '/usr/local/share/mysql/charsets/?.conf' not found (Errcode: 2)
</pre>

В таком случае нужно либо установить новый файл <tt>`Index'</tt> или вручную внести в
него недостающие имена наборов.

</ul>

<P>
Узнать имя набора символов таблиц <code>MyISAM</code> можно с помощью команды <code>myisamchk
-dvv table_name</code>.

</P>


<H2><A NAME="Server-Side_Scripts" HREF="manual.ru_toc.html#Server-Side_Scripts">4.7  Серверные сценарии и утилиты MySQL</A></H2>



<H3><A NAME="Server-Side_Overview" HREF="manual.ru_toc.html#Server-Side_Overview">4.7.1  Обзор серверных сценариев и утилит</A></H3>

<P>
<A NAME="IDX660"></A>
<A NAME="IDX661"></A>

</P>
<P>
Все программы MySQL имеют множество различных опций. При этом каждая
программа MySQL поддерживает опцию <code>--help</code>, которую можно использовать
для получения полного описания различных опций программы. Например,
попробуйте выполнить <code>mysql --help</code>.

</P>
<P>
Заданные по умолчанию опции для всех стандартных программ можно
переопределять при помощи файла опций. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>.

</P>
<P>
В следующем списке приводятся краткие описания серверных программ MySQL:

</P>
<DL COMPACT>

<DT><code>myisamchk</code>
<DD>
<A NAME="IDX662"></A>
 
Утилита, используемая для описания, проверки, оптимизации и восстановления
таблиц MySQL. Поскольку утилита <code>myisamchk</code> имеет много функций, она
описывается в отдельном разделе. See section <A HREF="manual.ru_MySQL_Database_Administration.html#MySQL_Database_Administration">4  Администрирование баз данных</A>.

<A NAME="IDX663"></A>
<DT><code>make_binary_distribution</code>
<DD>
Создает бинарную поставку откомпилированного кода MySQL. Эту версию при
помощи <code>FTP</code> можно передать на сайт <code>support.mysql.com</code> в директорию
<tt>`/pub/mysql/Incoming'</tt>, чтобы ею могли воспользоваться и другие пользователи
MySQL.

<A NAME="IDX664"></A>
<DT><code>mysqlbug</code>
<DD>
Сценарий, составляющий отчет о возникшей в MySQL неполадке. Этот сценарий
должен всегда использоваться для составления отчета для почтового списка
рассылки MySQL.

<A NAME="IDX665"></A>
<DT><code>mysqld</code>
<DD>
Сам сервер MySQL, демон. Он должен работать постоянно.

<A NAME="IDX666"></A>
<DT><code>mysql_install_db</code>
<DD>
Создает таблицы привилегий MySQL с заданными по умолчанию привилегиями.
Это обычно делается только один раз, при первой инсталляции MySQL в
системе.

</DL>



<H3><A NAME="safe_mysqld" HREF="manual.ru_toc.html#safe_mysqld">4.7.2  <code>safe_mysqld</code>, оболочка <code>mysqld</code></A></H3>

<P>
<A NAME="IDX667"></A>
<A NAME="IDX668"></A>
<A NAME="IDX669"></A>
<A NAME="IDX670"></A>

</P>
<P>
В MySQL 4.0 <code>safe_mysqld</code> был переименован в <code>mysqld_safe</code>.

</P>
<P>
<code>safe_mysqld</code> - это сценарий, с помощью которого рекомендуется запускать
демон mysqld на Unix. <code>safe_mysqld</code> служит для реализации неких
дополнительных функций безопасности для <code>mysqld</code>, таких как возможность
перезапуска сервера при обнаружении ошибки и записи в журнал информации о
процессе работы <code>mysqld</code>.

</P>
<P>
Если не указаны опции <code>--mysqld=#</code> или <code>--mysqld-version=#</code>,  <code>safe_mysqld</code> 
будет использовать исполняемый файл <code>mysqld</code>-max, если последний существует.
Если <code>mysqld-max</code> не существует, <code>safe_mysqld</code> запустит <code>mysqld</code>. Это позволяет
легко выяснить, что даст использование <code>mysqld-max</code> вместо <code>mysqld</code>: просто
скопируйте <code>mysqld-max</code> поверх <code>mysqld</code>, и он будет работать.

</P>
<P>
Как правило, редактировать сценарий <code>safe_mysqld</code> не следует, однако можно
указать опции для <code>safe_mysqld</code>, поместив их в раздел <code>[safe_mysqld]</code> файла
<tt>`my.cnf'</tt>. <code>safe_mysqld</code> будет считывать все опции из разделов файлов опций
<code>[mysqld]</code>, <code>[server]</code> и <code>[safe_mysqld]</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>.

</P>
<P>
Обратите внимание: все опции, которые вводятся в командной строке для
<code>safe_mysqld</code>, передаются <code>mysqld</code>. Если требуется применить в <code>safe_mysqld</code>
какие-либо опции, которые <code>mysqld</code> не поддерживает, эти опции нужно
определить в файле опций.

</P>
<P>
Большинство опций <code>safe_mysqld</code> - те же, что и у <code>mysqld</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Command-line_options">4.1.1  Параметры командной строки <code>mysqld</code></A>.

</P>
<P>
<code>Safe_mysqld</code> поддерживает следующие опции:

</P>
<DL COMPACT>

<DT><code>--basedir=path</code>
<DD>
<DT><code>--core-file-size=#</code>
<DD>
Размер <code>core</code>-файла который может быть создан <code>mysqld</code>. Значение передается <code>ulimit -c</code> 
<DT><code>--datadir=path</code>
<DD>
<DT><code>--defaults-extra-file=path</code>
<DD>
<DT><code>--defaults-file=path</code>
<DD>
<DT><code>--err-log=path  (устарело в 4.0; Используйте --log-error вместо)</code>
<DD>
<DT><code>--log-error=path</code>
<DD>
Писать журнал ошибок в указанный файл. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Error_log">4.9.1  Журнал ошибок</A>.
<DT><code>--ledir=path</code>
<DD>
Путь к <code>mysqld</code>
<DT><code>--log=path</code>
<DD>
<DT><code>--mysqld=mysqld-version</code>
<DD>
Имя версии <code>mysqld</code>, которую вы хотите запустить в директории <tt>`ledir'</tt>
<DT><code>--mysqld-version=version</code>
<DD>
То же, что и <code>--mysqld=</code>, но в этой опции задается только суффикс для
<code>mysqld</code>. Например, если используется <code>--mysqld-version=max</code>, <code>safe_mysqld</code>
запустит версию <code>ledir/mysqld-max</code>. Если задать <code>--mysqld-version</code> без
аргумента, будет использоваться <code>ledir/mysqld</code>.
<DT><code>--no-defaults</code>
<DD>
<DT><code>--open-files-limit=#</code>
<DD>
Максимальное количество файлов, которые могут быть открыты <code>mysqld</code>.
Значение передается <code>ulimit -n</code>. Обратите внимание: чтобы эта опция работала
корректно, необходимо запустить <code>safe_mysqld</code> от пользователя root!
<DT><code>--pid-file=path</code>
<DD>
<DT><code>--port=#</code>
<DD>
<DT><code>--socket=path</code>
<DD>
<DT><code>--timezone=#</code>
<DD>
Устанавливает переменную часового пояса (<code>TZ</code>) в значение, передаваемое в
этом параметре.
<DT><code>--user=#</code>
<DD>
</DL>

<P>
Сценарий <code>safe_mysqld</code> написан таким образом, чтобы можно было запустить
сервер, инсталлированный как из исходного кода, так и из бинарной поставки
MySQL, даже если компоненты сервера, в зависимости от используемой
инсталляции, будут размещены несколько по-другому. Для <code>safe_mysqld</code>
требуется выполнение одного из следующих условий:

</P>

<ul>
<LI>

Сервер и базы данных можно обнаружить относительно каталога, в котором
вызывается <code>safe_mysqld</code>. <code>safe_mysqld</code> ищет в своей рабочей директории
<tt>`bin'</tt> и <tt>`data'</tt> (для бинарных дистрибутивов) или <tt>`libexec'</tt> и <tt>`var'</tt> (для
дистрибутивов с исходным кодом). Это условие должно выполняться, если
<code>safe_mysqld</code> запускается из директории, в которую инсталлирован MySQL
(например <tt>`/usr/local/mysql'</tt> для бинарного дистрибутива).

<LI>

Если сервер и базы данных не могут быть найдены относительно рабочей
директории, <code>safe_mysqld</code> пытается найти их по абсолютным путям.
Типичные местоположения - <tt>`/usr/local/libexec'</tt> и <tt>`/usr/local/var'</tt>.
Действительные местоположения определяются при создании дистрибутива,
из которого запускается <code>safe_mysqld</code>. Они должны быть корректными, если
MySQL был инсталлирован в стандартное местоположение.
</ul>

<P>
Поскольку <code>safe_mysqld</code> будет пытаться найти сервер и базы данных
относительно собственной рабочей директории, можно инсталлировать двоичный
дистрибутив MySQL куда угодно, при условии, что <code>safe_mysqld</code> будет
запускаться из директории, в которой установлен MySQL:

</P>

<pre>
shell&#62; cd mysql_installation_directory
shell&#62; bin/safe_mysqld &#38;
</pre>

<P>
Если <code>safe_mysqld</code> не может запустить сервер, даже в том случае, когда он
вызывается из инсталляционной директории MySQL, сценарий <code>safe_mysqld</code> можно
модифицировать так, чтобы он использовал верный путь к <code>mysqld</code> и опции
путей, которые являются правильными для вашей системы. Обратите внимание:
если в будущем вы будете делать апгрейд MySQL, новая версия <code>safe_mysqld</code>
будет записана поверх старой, поэтому нужно сделать копию
отредактированной версии, которую вы сможете затем установить повторно.

</P>


<H3><A NAME="mysqld_multi" HREF="manual.ru_toc.html#mysqld_multi">4.7.3  <code>Mysqld_multi</code>, программа для управления множеством серверов MySQL</A></H3>

<P>
<A NAME="IDX671"></A>
<A NAME="IDX672"></A>
<A NAME="IDX673"></A>
<A NAME="IDX674"></A>

</P>
<P>
Программа <code>mysqld_multi</code> предназначена для управления несколькими процессами
<code>mysqld</code>, работающих на различных сокетах Unix и портах TCP/IP.

</P>
<P>
Программа будет искать группу(группы) <code>[mysqld#]</code> в <tt>`my.cnf'</tt> (или
заданных при помощи <code>--config-file=...</code> файлах), где <code>#</code> - любое
положительное число, начиная с 1. Мы говорим про этот номер далее как про номер
группы опций, или GNR. Номера групп различают группы опций одну от другой и
используются как аргумент при запуске <code>mysqld_multi</code> чтобы указать, какие сервера
вы хотите запустить, остановить или получить статус об.  Эти группы должны быть
такими же, как и обычная группа <code>[mysqld</code>] (например содержать опции для
<code>mysqld</code>; см. в руководстве более подробную информацию), но с такими
портом, сокетом и т.д., которые требуются для каждого отдельного процесса
<code>mysqld</code>.

</P>
<P>
<code>mysqld_multi</code> запускается в таком синтаксисе:

<pre>
Использование: mysqld_multi [OPTIONS] {start|stop|report} [GNR,GNR,GNR...]
или            mysqld_multi [OPTIONS] {start|stop|report} [GNR-GNR,GNR,GNR-GNR,...]
</pre>

<P>
GNR здесь означает номер группы. Можно запускать, останавливать или
создавать отчеты о любом GNR, или о нескольких из них одновременно. Получить
пример о том, как бы вы могли настроить файл опций, можно так: 

</P>

<pre>
shell&#62; mysqld_multi --example
</pre>

<P>
В качестве разделителей в списке GNR применяются запятые,
комбинации создаются при помощи тире. Последнее означает, что будут
задействованы все номера GNR из диапазона GNR1-GNR2. Если не задан
аргумент GNR, то все группы будут либо запущены, либо остановлены, либо
будет выведен отчет об этих группах. Обратите внимание, что в списке GNR
не должно быть никаких пропусков (пробелов, символов табуляции или пустых
строк). Любые данные после пропуска будут игнорироваться.

</P>
<P>
mysqld_multi поддерживает следующие опции:

</P>
<DL COMPACT>

<DT><code>--config-file=...</code>
<DD>
<A NAME="IDX675"></A>
 
Альтернативный файл конфигурации (<code>config file</code>). Примечание: данный файл
не влияет на собственные опции этой программы (группа <code>[mysqld_multi]</code>), а
только на группы <code>[mysqld#]</code>. Без этой опции поиск всех данных будет
осуществляться только в обычном файле <tt>`my.cnf'</tt>.

<A NAME="IDX676"></A>
<DT><code>--example</code>
<DD>
Представляет пример файла конфигурации.

<A NAME="IDX677"></A>
<DT><code>--help</code>
<DD>
Выводит справочную информацию и завершает работу.

<A NAME="IDX678"></A>
<DT><code>--log=...</code>
<DD>
Файл журнала. Имя файла журнала и полный путь к нему. Примечание: если
файл существует, записи будут добавляться в конец файла.

<A NAME="IDX679"></A>
<DT><code>--mysqladmin=...</code>
<DD>
Исполняемый файл <code>mysqladmin</code>, используемый для завершения работы сервера.

<A NAME="IDX680"></A>
<DT><code>--mysqld=...</code>
<DD>
Исполняемый файл <code>mysqld</code>, который будет использоваться. Обратите внимание:
в этой опции можно также указывать <code>safe_mysqld</code>. Опции передаются <code>mysqld</code>.
Необходимо только удостовериться, что в переменной окружения PATH  имеется
<code>mysqld</code> или что установлен <code>safe_mysqld</code>.

<A NAME="IDX681"></A>
<DT><code>--no-log</code>
<DD>
Вывод в <code>stdout</code> вместо журнала. По умолчанию журналы включены.

<A NAME="IDX682"></A>
<DT><code>--password=...</code>
<DD>
Пароль пользователя для доступа к <code>mysqladmin</code>.

<A NAME="IDX683"></A>
<DT><code>--tcp-ip</code>
<DD>
Подсоединение к серверу(ам) MySQL по TCP/IP вместо Unix-сокетов. Данная
опция влияет на завершение работы сервера и создание отчетов. Если файл
сокета отсутствует, сервер будет работать, но к нему можно будет
обращаться только через порт TCP/IP. По умолчанию соединение
осуществляется через сокет Unix.

<A NAME="IDX684"></A>
<DT><code>--user=...</code>
<DD>
Имя пользователя MySQL для <code>mysqladmin</code>.

<A NAME="IDX685"></A>
<DT><code>--version</code>
<DD>
Вывод номера версии и завершение работы.
</DL>

<P>
Некоторые примечания относительно mysqld_multi:

</P>

<ul>
<LI>

Удостоверьтесь, что пользователь MySQL, останавливающий <code>mysqld</code>
(например, при помощи <code>mysqladmin</code>), имеет один пароль и имя
пользователя для всех директорий данных, к которым производится доступ
(имеется в виду - к базе данных <code>mysql</code>). Убедитесь также, что
пользователь имеет привилегию <code>Shutdown_priv</code>! Если имеется несколько
директорий с данными и несколько различных баз данных <code>mysql</code> с
различными паролями для пользователя <code>root</code> в MySQL, можно создать
некоего общего пользователя <code>multi_admin</code> для всех, с одинаковым паролем
(см. ниже). Сделать это можно так:


<pre>
shell&#62; mysql -u root -S /tmp/mysql.sock -proot_password -e
"GRANT SHUTDOWN ON *.* TO multi_admin@localhost IDENTIFIED BY
</pre>

See section <A HREF="manual.ru_MySQL_Database_Administration.html#Privileges">4.2.6  Как работает система привилегий</A>.
Эти действия нужно выполнять для каждого <code>mysqld</code> для каждой имеющейся
директории данных (для этого нужно выбрать другой сокет <code>-S=...</code>).

<LI>

<tt>`pid-файл'</tt> играет очень важную роль, если для запуска <code>mysqld</code> используется
сценарий <code>safe_mysqld</code> (например, <code>--mysqld=safe_mysqld</code>). Преимущество
использования <code>safe_mysqld</code> вместо <code>mysqld</code> заключается в том, что <code>safe_mysqld</code>
``бережет'' каждый процесс <code>mysqld</code> и перезапустит его, если <code>mysqld</code>-процесс
умрет по сигналу 9 или подобному (например, в случае ошибки сегментации -
хотя, конечно, уж этой ошибки MySQL в принципе совершать не должен;).
Пожалуйста, обратите внимание: может оказаться, что сценарий <code>safe_mysqld</code>
требуется запускать из определенного каталога. Это означает, что прежде
чем запустить <code>mysqld_multi</code>, прийдется перейти в нужный каталог. Если при
запуске возникнут проблемы, пожалуйста, просмотрите сценарий <code>safe_mysqld</code>.
Обратите внимание на следующие строки:


<pre>
--------------------------------------------------------------------------
MY_PWD=`pwd` Check if we are starting this relative (for the binary
release) if test -d /data/mysql -a -f ./share/mysql/english/errmsg.sys
-a -x ./bin/mysqld
--------------------------------------------------------------------------

See section <A HREF="manual.ru_MySQL_Database_Administration.html#safe_mysqld">4.7.2  <code>safe_mysqld</code>, оболочка <code>mysqld</code></A>.
</pre>

Этот тест может пройти успешно, однако возможны и проблемы.

<LI>

Не запускайте несколько демонов <code>mysqld</code> с одной и тожй же директорией
данных. Используйте различные директории с данными, если Вы четко не
уверены в своих действиях!

<LI>

Файл сокета и порт TCP/IP должны быть различными для каждого демона
<code>mysqld</code>.

<LI>

Первая и пятая группы <code>mysqld</code> были преднамеренно не включены в пример.
В файле конфигурации могут быть ``промежутки'' - это увеличивает
гибкость. Порядок, в котором запускаются или завершают работу демоны
<code>mysqld</code>, зависит от порядка, в котором они указаны в файле
конфигурации.

<LI>

Когда нужно обратиться к некоторой группе (GNR) в этой программе,
просто используйте номер в конце имени группы. Например, GNR для группы
<code>[mysqld17]</code> - 17. 

<LI>

Для <code>mysqld</code> можно использовать опцию <code>--user</code>, но для этого сценарий
<code>mysqld_multi</code> должен быть запущен от <code>root</code>. Наличие опции в файле
конфигурации не имеет значения; вы получите предупреждение только в
случаях, если не являетесь суперпользователем и демон <code>mysqlds</code> запущен
под <strong>вашим</strong> аккаунтом Unix. <strong>Важно</strong>: удостоверьтесь, что для <code>pid-файла</code> и
директории с данными имеется доступ для чтения+записи(+выполнения -
для директории с данными) для <strong>того</strong> пользователя Unix, который
запускает определенный процесс <code>mysqld</code>. <strong>Не</strong> используйте для этого
аккаунт <code>root</code> в Unix, если Вы не уверены в своих действиях!

<LI>

<strong>Очень важно</strong>: удостоверьтесь, что вы понимаете значения опций, которые
передаются демонам <code>mysqld</code>, и что осознаете то, почему могут быть нужны
отдельные процессы <code>mysqld</code>. Запуск нескольких демонов <code>mysqld</code> с одной
директорией данных не увеличит производительность в многопоточной
системе!
</ul>

<P>
See section <A HREF="manual.ru_MySQL_Database_Administration.html#Multiple_servers">4.1.4  Запуск нескольких серверов MySQL на одном компьютере</A>.

</P>
<P>
Пример файла конфигурации для <code>mysqld_multi</code>.

</P>

<pre>
# Этот файл может находиться в вашей домашней директории (~/.my.cnf) или
/etc/my.cnf
# Version 2.1 by Jani Tolonen

[mysqld_multi]
mysqld = /usr/local/bin/safe_mysqld
mysqladmin = /usr/local/bin/mysqladmin
user = multi_admin
password = multipass

[mysqld2]
socket = /tmp/mysql.sock2
port = 3307
pid-file = /usr/local/mysql/var2/hostname.pid2
datadir = /usr/local/mysql/var2
language = /usr/local/share/mysql/english
user = john

[mysqld3]
socket = /tmp/mysql.sock3
port = 3308
pid-file = /usr/local/mysql/var3/hostname.pid3
datadir = /usr/local/mysql/var3
language = /usr/local/share/mysql/swedish
user = monty

[mysqld4]
socket = /tmp/mysql.sock4
port = 3309
pid-file = /usr/local/mysql/var4/hostname.pid4
datadir = /usr/local/mysql/var4
language = /usr/local/share/mysql/estonia
user = tonu

[mysqld6]
socket = /tmp/mysql.sock6
port = 3311
pid-file = /usr/local/mysql/var6/hostname.pid6
datadir = /usr/local/mysql/var6
language = /usr/local/share/mysql/japanese
user = jani
</pre>

<P>
See section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>.

</P>


<H3><A NAME="myisampack" HREF="manual.ru_toc.html#myisampack">4.7.4  <code>myisampack</code>, MySQL-генератор сжатых таблиц (только для чтения)</A></H3>

<P>
<A NAME="IDX686"></A>
<A NAME="IDX687"></A>
<A NAME="IDX688"></A>
<A NAME="IDX689"></A>
<A NAME="IDX690"></A>

</P>
<P>
Утилита <code>myisampack</code> используется для сжатия таблиц <code>MyISAM</code>, а утилита
<code>pack_isam</code> - для сжатия таблиц <code>ISAM</code>. Поскольку таблицы <code>ISAM</code> являются
устаревшими, здесь будет рассматриваться только <code>myisampack</code>, но все,
сказанное относительно <code>myisampack</code>, справедливо также и для <code>pack_isam</code>.

</P>
<P>
<code>myisampack</code>  сжимает каждый столбец в таблице по отдельности. Информация,
необходимая для декомпрессии столбцов, считывается в память при открытии
таблицы. В результате обеспечивается более высокая производительность при
доступе к отдельным записям, поскольку нужно распаковывать только одну
запись, а не значительно больший по размеру дисковый блок, как при
использовании программы Stacker в MS DOS. В среднем <code>myisampack</code> сжимает
файл данных на 40%-70%.

</P>
<P>
(MySQL использует отображение в памяти (<code>mmap()</code>) для сжатых таблиц

</P>
<P>
а если <code>mmap()</code> не работает, возвращается назад к нормальному режиму
чтения/записи.

</P>
<P>
Обратите внимание на следующее:

</P>

<ul>
<LI>

После сжатия таблица доступна в режиме только для чтения. Это удобно,
скажем, для записи на CD. Реализация возможности записи в сжатые таблицы
находится в нашем списке задач к выполнению, но имеет низкий приоритет.

<LI>

<code>myisampack</code> может также сжимать столбцы c типами <code>BLOB</code> или <code>TEXT</code>. В
предыдущей версии <code>pack_isam</code> (для таблиц <code>ISAM</code>) данной функции не было.
</ul>

<P>
Утилиту <code>myisampack</code> можно запустить следующим образом:

</P>

<pre>
shell&#62; myisampack [options] filename ...
</pre>

<P>
Каждое имя файла (<code>filename</code>) должно быть именем индексного файла (<tt>`.MYI'</tt>).
Если вы не находитесь в директории базы данных, необходимо указать полный
путь к файлу. Допускается опускать расширение <tt>`.MYI'</tt>.

</P>
<P>
myisampack  поддерживает следующие опции:

</P>
<DL COMPACT>

<DT><code>-b, --backup</code>
<DD>
Создает резервную копию таблицы, присваивая ей имя <tt>`tbl_name.OLD'</tt>.

<DT><code>-#, --debug=debug_options</code>
<DD>
Выводить журнал отладки. Строка <code>debug_options</code> часто принимает значение
<code>d:t:o,filename</code>

<DT><code>-f, --force</code>
<DD>
Сжатие таблицы происходит, даже если она увеличивается или если существует
временный файл. Во время сжатия таблицы <code>myisampack</code>  создает временный файл
<tt>`tbl_name.TMD'</tt>. Если вы вручную прекратите выполнение <code>myisampack</code>, может
оказаться так, что файл <tt>`tbl_name.TMD'</tt> не будет удален. Обычно если
<code>myisampack</code> обнаруживает существующий <tt>`tbl_name.TMD'</tt>, она прекращает работу и
выдает ошибку. При указании опции <code>--force</code> <code>myisampack</code> сжимает таблицу в
любом случае.

<DT><code>-?, --help</code>
<DD>
Выдает справочную информацию и завершает работу.

<DT><code>-j big_tbl_name, --join=big_tbl_name</code>
<DD>
Соединяет все таблицы, указанные в командной строке, в одну таблицу
<code>big_tbl_name</code>. Все таблицы, подлежащие объединению, должны быть идентичными
(одинаковые имена и типы столбцов, одинаковые индексы и т.д.).

<DT><code>-p #, --packlength=#</code>
<DD>
Определяет разрядность поля, хранящего длину строки, в байтах. Может
принимать значения 1, 2 или 3. (<code>myisampack</code>  хранит все строки с
указателями длины размером в 1, 2, или 3 байта. В большинстве случаев
<code>myisampack</code> способна определить правильное значение длины перед началом
сжатия файла, но во время сжатия она может обнаружить, что может быть
использована более короткая длина. В этом случае <code>myisampack</code> выведет
сообщение о том, что в следующий раз при сжатии данного файла можно
использовать более короткую длину записи.)

<DT><code>-s, --silent</code>
<DD>
Молчаливый режим. Сообщения выводятся только при возникновении ошибок.

<DT><code>-t, --test</code>
<DD>
Сжатие таблицы не выполняется, происходит только проверка процедуры
сжатия.

<DT><code>-T dir_name, --tmp_dir=dir_name</code>
<DD>
Указанная директория используется как местоположение для создания
временной таблицы.

<DT><code>-v, --verbose</code>
<DD>
Расширенный режим вывода сообщений. Выводится информация о состоянии
процесса и результаты сжатия.

<DT><code>-V, --version</code>
<DD>
Отображает информацию о версии и завершает работу.

<DT><code>-w, --wait</code>
<DD>
Если таблица уже используется, подождать повторить попытку. Если сервер
<code>mysqld</code> был вызван с опцией <code>--skip-external-locking</code>, то не самая лучшая идея -
вызывать <code>myisampack</code>, если таблица может модифицироваться во время процесса
сжатия.
</DL>

<P>
<A NAME="IDX691"></A>
Последовательность приведенных ниже команд иллюстрирует типичный сеанс
сжатия таблицы:

</P>

<pre>
shell&#62; ls -l station.*
-rw-rw-r--   1 monty    my         994128 Apr 17 19:00 station.MYD
-rw-rw-r--   1 monty    my          53248 Apr 17 19:00 station.MYI
-rw-rw-r--   1 monty    my           5767 Apr 17 19:00 station.frm

shell&#62; myisamchk -dvv station

MyISAM file:     station
Isam-version:  2
Creation time: 1996-03-13 10:08:58
Recover time:  1997-02-02  3:06:43
Data records:              1192  Deleted blocks:              0
Datafile: Parts:           1192  Deleted data:                0
Datafile pointer (bytes):     2  Keyfile pointer (bytes):     2
Max datafile length:   54657023  Max keyfile length:   33554431
Recordlength:               834
Record format: Fixed length

table description:
Key Start Len Index   Type                       Root  Blocksize    Rec/key
1   2     4   unique  unsigned long              1024       1024          1
2   32    30  multip. text                      10240       1024          1

Field Start Length Type
1     1     1
2     2     4
3     6     4
4     10    1
5     11    20
6     31    1
7     32    30
8     62    35
9     97    35
10    132   35
11    167   4
12    171   16
13    187   35
14    222   4
15    226   16
16    242   20
17    262   20
18    282   20
19    302   30
20    332   4
21    336   4
22    340   1
23    341   8
24    349   8
25    357   8
26    365   2
27    367   2
28    369   4
29    373   4
30    377   1
31    378   2
32    380   8
33    388   4
34    392   4
35    396   4
36    400   4
37    404   1
38    405   4
39    409   4
40    413   4
41    417   4
42    421   4
43    425   4
44    429   20
45    449   30
46    479   1
47    480   1
48    481   79
49    560   79
50    639   79
51    718   79
52    797   8
53    805   1
54    806   1
55    807   20
56    827   4
57    831   4

shell&#62; myisampack station.MYI
Compressing station.MYI: (1192 records)
- Calculating statistics

normal:     20  empty-space:      16  empty-zero:        12  empty-fill:  11
pre-space:   0  end-space:        12  table-lookups:      5  zero:         7
Original trees:  57  After join: 17
- Compressing file
87.14%

shell&#62; ls -l station.*
-rw-rw-r--   1 monty    my         127874 Apr 17 19:00 station.MYD
-rw-rw-r--   1 monty    my          55296 Apr 17 19:04 station.MYI
-rw-rw-r--   1 monty    my           5767 Apr 17 19:00 station.frm

shell&#62; myisamchk -dvv station

MyISAM file:     station
Isam-version:  2
Creation time: 1996-03-13 10:08:58
Recover time:  1997-04-17 19:04:26
Data records:              1192  Deleted blocks:              0
Datafile: Parts:           1192  Deleted data:                0
Datafilepointer (bytes):      3  Keyfile pointer (bytes):     1
Max datafile length:   16777215  Max keyfile length:     131071
Recordlength:               834
Record format: Compressed

table description:
Key Start Len Index   Type                       Root  Blocksize    Rec/key
1   2     4   unique  unsigned long             10240       1024          1
2   32    30  multip. text                      54272       1024          1

Field Start Length Type                         Huff tree  Bits
1     1     1      constant                             1     0
2     2     4      zerofill(1)                          2     9
3     6     4      no zeros, zerofill(1)                2     9
4     10    1                                           3     9
5     11    20     table-lookup                         4     0
6     31    1                                           3     9
7     32    30     no endspace, not_always              5     9
8     62    35     no endspace, not_always, no empty    6     9
9     97    35     no empty                             7     9
10    132   35     no endspace, not_always, no empty    6     9
11    167   4      zerofill(1)                          2     9
12    171   16     no endspace, not_always, no empty    5     9
13    187   35     no endspace, not_always, no empty    6     9
14    222   4      zerofill(1)                          2     9
15    226   16     no endspace, not_always, no empty    5     9
16    242   20     no endspace, not_always              8     9
17    262   20     no endspace, no empty                8     9
18    282   20     no endspace, no empty                5     9
19    302   30     no endspace, no empty                6     9
20    332   4      always zero                          2     9
21    336   4      always zero                          2     9
22    340   1                                           3     9
23    341   8      table-lookup                         9     0
24    349   8      table-lookup                        10     0
25    357   8      always zero                          2     9
26    365   2                                           2     9
27    367   2      no zeros, zerofill(1)                2     9
28    369   4      no zeros, zerofill(1)                2     9
29    373   4      table-lookup                        11     0
30    377   1                                           3     9
31    378   2      no zeros, zerofill(1)                2     9
32    380   8      no zeros                             2     9
33    388   4      always zero                          2     9
34    392   4      table-lookup                        12     0
35    396   4      no zeros, zerofill(1)               13     9
36    400   4      no zeros, zerofill(1)                2     9
37    404   1                                           2     9
38    405   4      no zeros                             2     9
39    409   4      always zero                          2     9
40    413   4      no zeros                             2     9
41    417   4      always zero                          2     9
42    421   4      no zeros                             2     9
43    425   4      always zero                          2     9
44    429   20     no empty                             3     9
45    449   30     no empty                             3     9
46    479   1                                          14     4
47    480   1                                          14     4
48    481   79     no endspace, no empty               15     9
49    560   79     no empty                             2     9
50    639   79     no empty                             2     9
51    718   79     no endspace                         16     9
52    797   8      no empty                             2     9
53    805   1                                          17     1
54    806   1                                           3     9
55    807   20     no empty                             3     9
56    827   4      no zeros, zerofill(2)                2     9
57    831   4      no zeros, zerofill(1)                2     9
</pre>

<P>
Ниже приведено описание вывода myisampack:

</P>
<DL COMPACT>

<DT><code>normal</code>
<DD>
Количество столбцов, для которых не используется никакого дополнительного
сжатия.

<DT><code>empty-space</code>
<DD>
Количество столбцов, содержащих пустые значения; эти занимают по 1 биту.

<DT><code>empty-zero</code>
<DD>
Количество целочисленных столбцов, в которых содержатся только двоичные
нули (ascii 0); каждый из них будет занимать 1 бит

<DT><code>empty-fill</code>
<DD>
Количество целочисленных столбцов, значения которых не полностью занимают
отведенную для них разрядность в байтах; тип этих столбцов изменяется на
тип с меньшей разрядностью(например, столбец <code>INTEGER</code> может быть изменен на
<code>MEDIUMINT</code>).

<DT><code>pre-space</code>
<DD>
Количество десятичных столбцов, которые хранятся с начальными пробелами. В
этом случае каждое значение будет содержать число ведущих пробелов.

<DT><code>end-space</code>
<DD>
Количество столбцов, имеющих много оконечных пробелов. В этом случае
каждое значение будет содержать число таких пробелов.

<DT><code>table-lookup</code>
<DD>
Столбец имеет только небольшое количество различающихся значений, которые
перед сжатием Хаффмана (Huffman) конвертируются в <code>ENUM</code>.

<DT><code>zero</code>
<DD>
Количество столбцов, все значения которых являются нулями.

<DT><code>Original  trees</code>
<DD>
Начальное количество деревьев Хаффмана.

<DT><code>After  join</code>
<DD>
Количество различных деревьев Хаффмана, оставленных после соединения
деревьев для сохранения немного пространства в заголовках.
</DL>

<P>
После сжатия таблицы <code>myisamchk -dvv</code> выводит дополнительную информацию по
каждому полю:

</P>
<DL COMPACT>

<DT><code>Type</code>
<DD>
Тип поля может содержать следующие дескрипторы:

<DL COMPACT>

<DT><code>constant</code>
<DD>
Все строки содержат одинаковое значение.

<DT><code>no  endspace</code>
<DD>
Не сохраняются замыкающие пробелы.

<DT><code>no endspace, not_always</code>
<DD>
Не сохраняются замыкающие пробелы и не производится сжатие за счет
замыкающих пробелов для всех значений.

<DT><code>no endspace, no empty</code>
<DD>
Не сохраняются замыкающие пробелы. Не сохраняются пустые значения.

<DT><code>table-lookup</code>
<DD>
Столбец был преобразован к <code>ENUM</code>.

<DT><code>zerofill(n)</code>
<DD>
В значении n главных байтов всегда являются 0 и не сохранены.

<DT><code>no zeros</code>
<DD>
Не сохраняются нули.

<DT><code>always  zero</code>
<DD>
Значения 0 хранятся в 1 бите.
</DL>

<DT><code>Huff  tree</code>
<DD>
Дерево Хаффмана, связанное с полем.

<DT><code>Bits</code>
<DD>
Количество битов, используемых в дереве Хаффмана.
</DL>

<P>
После запуска <code>pack_isam</code>/<code>myisampack</code> нужно запустить <code>isamchk</code>/<code>myisamchk</code> для
повторного создания индекса. В это время можно также отсортировать
индексные блоки и создать статистику, необходимую для более эффективной
работы оптимизатора MySQL:

</P>

<pre>
myisamchk -rq --analyze --sort-index table_name.MYI
isamchk -rq --analyze --sort-index table_name.ISM
</pre>

<P>
После установки сжатой таблицы в директорию базы данных MySQL нужно
проделать операцию <code>mysqladmin flush-tables</code>, чтобы сервер <code>mysqld</code> начал
использовать новую таблицу.

</P>
<P>
Для распаковки сжатой таблицы можно использовать опцию <code>--unpack</code> <code>isamchk</code>
или <code>myisamchk</code>.

</P>


<H3><A NAME="mysqld-max" HREF="manual.ru_toc.html#mysqld-max">4.7.5  <code>mysqld-max</code>, расширенный сервер <code>mysqld</code></A></H3>

<P>
<A NAME="IDX692"></A>

</P>
<P>
<code>mysqld-max</code> - это сервер MySQL (<code>mysqld</code>), скомпилированный со следующими
конфигурационными опциями:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Опция</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD>--with-server-suffix=-max </TD><TD> Добавляет суффикс к версии <code>mysqld</code>.
</TD></TR>
<TR><TD>--with-innodb </TD><TD> Поддержка таблиц InnoDB.
</TD></TR>
<TR><TD>--with-bdb </TD><TD> Поддержка таблиц Беркли DB (BDB)
</TD></TR>
<TR><TD>CFLAGS=-DUSE_SYMDIR </TD><TD> Символические ссылки для Windows.
</TD></TR>
</TABLE>

<P>
Бинарную версию MySQL-max можно найти по адресу 
<a HREF="http://www.mysql.com/downloads/mysql-max-3.23.html">http://www.mysql.com/downloads/mysql-max-3.23.html</a>.

</P>
<P>
Бинарные дистрибутивы Windows MySQL включают стандартный двоичный файл
<code>mysqld.exe</code> а также двоичный файл <code>mysqld-max.exe</code>.
<a HREF="http://www.mysql.com/downloads/mysql-3.23.html">http://www.mysql.com/downloads/mysql-3.23.html</a>. See section <A HREF="manual.ru_Installing.html#Windows_installation">2.1.2  Установка MySQL на Windows</A>.

</P>
<P>
Обратите внимание: поскольку таблицы InnoDB и Berkeley DB доступны не для
всех платформ, некоторые из двоичных дистрибутивов  могут не поддерживать
оба этих типа таблиц. Проверить, какие типы таблиц поддерживаются, можно
при помощи следующего запроса:

</P>

<pre>
mysql&#62; SHOW VARIABLES LIKE "have_%";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| have_bdb | YES |
| have_innodb | NO |
| have_isam | YES |
| have_raid | NO |
| have_openssl | NO |
+---------------+-------+
</pre>

<P>
Значения имеют следующий смысл:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Значение</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD><code>YES</code> </TD><TD> Опция активизирована.
</TD></TR>
<TR><TD><code>NO</code> </TD><TD> MySQL не поддерживает эту опцию.
</TD></TR>
<TR><TD><code>DISABLED</code> </TD><TD> Опция xxxx заблокирована, потому что <code>mysqld</code> был запущен с параметром <code>--skip-xxxx</code>  или потому, что <code>mysqld</code> был запущен не со всеми опциями, необходимыми для того, чтобы использование данной опции было возможным. В этом случае файл <tt>`hostname.err'</tt> будет содержать причину, по которой опция заблокирована.
</TD></TR>
</TABLE>

<P>
<strong>Примечание</strong>: чтобы получить возможность создавать таблицы InnoDB, вы <strong>должны</strong>
отредактировать опции, включив по меньшей мере опцию
<code>innodb_data_file_path</code>. See section <A HREF="manual.ru_Table_types.html#InnoDB_start">7.5.2  Параметры запуска InnoDB</A>.

</P>
<P>
Чтобы улучшить производительность таблиц BDB, для них нужно также добавить
некоторые конфигурационные опции. See section <A HREF="manual.ru_Table_types.html#BDB_start">7.6.3  Параметры запуска <code>BDB</code></A>.

</P>
<P>
<code>safe_mysqld</code> будет автоматически пытаться запустить двоичный <code>mysqld</code> с
суффиксом <code>-max</code>. Таким образом можно просто осуществлять тестирование
свежесобранного бинарного <code>mysqld</code> в существующей инсталляции. Для этого
нужно выполнить <code>configure</code> с требуемыми опциями, собрать, и затем
установить новый <code>mysqld</code> как <code>mysqld-max</code>  в тот же самый каталог, где
находится ``старый'' бинарный <code>mysqld</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#safe_mysqld">4.7.2  <code>safe_mysqld</code>, оболочка <code>mysqld</code></A>.

</P>
<P>
<code>mysqld-max</code> RPM использует вышеупомянутую возможность <code>safe_mysqld</code>. Он
только устанавливает исполняемый <code>mysqld-max</code>, и <code>safe_mysqld</code> будет
автоматически использовать его после перезапуска <code>safe_mysqld</code>.

</P>
<P>
В следующей таблице показаны типы таблиц, поддерживаемые двоичным
<code>MySQL-Max</code>:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>System</strong> </TD><TD> <code>BDB</code> </TD><TD> <code>InnoDB</code>
</TD></TR>
<TR><TD>AIX 4.3 </TD><TD> Нет </TD><TD> Да
</TD></TR>
<TR><TD>HP-UX 11.0 </TD><TD> Нет </TD><TD> Да
</TD></TR>
<TR><TD>Linux-Alpha </TD><TD> Нет </TD><TD> Да
</TD></TR>
<TR><TD>Linux-Intel </TD><TD> Да </TD><TD> Да
</TD></TR>
<TR><TD>Linux-IA64 </TD><TD> Нет </TD><TD> Да
</TD></TR>
<TR><TD>Solaris-Intel </TD><TD> Нет </TD><TD> Да
</TD></TR>
<TR><TD>Solaris-SPARC </TD><TD> Да </TD><TD> Да
</TD></TR>
<TR><TD>Caldera (SCO) OSR5 </TD><TD> Да </TD><TD> Да
</TD></TR>
<TR><TD>UnixWare </TD><TD> Да </TD><TD> Да
</TD></TR>
<TR><TD>Windows/NT </TD><TD> Да </TD><TD> Да
</TD></TR>
</TABLE>



<H2><A NAME="Client-Side_Scripts" HREF="manual.ru_toc.html#Client-Side_Scripts">4.8  Клиентские сценарии и утилиты MySQL</A></H2>



<H3><A NAME="Client-Side_Overview" HREF="manual.ru_toc.html#Client-Side_Overview">4.8.1  Обзор клиентских сценариев и утилит</A></H3>

<P>
<A NAME="IDX693"></A>
<A NAME="IDX694"></A>

</P>
<P>
Все клиенты MySQL, которые взаимодействуют с сервером с помощью библиотеки
<code>mysqlclient</code>, используют следующие переменные окружения:

</P>
<P>
<A NAME="IDX695"></A>
<A NAME="IDX696"></A>
<A NAME="IDX697"></A>
<A NAME="IDX698"></A>
<A NAME="IDX699"></A>
<A NAME="IDX700"></A>
<A NAME="IDX701"></A>
<A NAME="IDX702"></A>

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Имя</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD><code>MYSQL_UNIX_PORT</code> </TD><TD> Сокет, используемый по умолчанию для локальных подсоединений
</TD></TR>
<TR><TD><code>MYSQL_TCP_PORT</code> </TD><TD> Устанавливаемый по умолчанию порт TCP/IP
</TD></TR>
<TR><TD><code>MYSQL_PWD</code> </TD><TD> Устанавливаемый по умолчанию пароль
</TD></TR>
<TR><TD><code>MYSQL_DEBUG</code> </TD><TD> Опции пошаговой отладки программ
</TD></TR>
<TR><TD><code>TMPDIR</code> </TD><TD> Каталог для создания временных таблиц/файлов
</TD></TR>
</TABLE>

<P>
Использование <code>MYSQL_PWD</code> небезопасно. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Connecting">4.2.8  Соединение с сервером MySQL</A>.

</P>
<P>
<A NAME="IDX703"></A>
<A NAME="IDX704"></A>
<A NAME="IDX705"></A>
<A NAME="IDX706"></A>
<A NAME="IDX707"></A>
<A NAME="IDX708"></A>
<A NAME="IDX709"></A>

</P>
<P>
Клиент <code>mysql</code> использует файл, указанный в переменной окружения
<code>MYSQL_HISTFILE</code>, для хранения истории командной строки. Значение по
умолчанию для этого файла истории - <code>$HOME/.mysql_history</code>, где <code>$HOME</code> -
значение переменной окружения <code>HOME</code>. See section <A HREF="manual.ru_Environment_variables.html#Environment_variables">F  Переменные окружения</A>.

</P>
<P>
Все программы MySQL принимают множество различных опций. При этом каждая
программа MySQL поддерживает опцию <code>--help</code>, которую можно использовать для
получения полного описания различных опций программы. Например, попробуйте
запустить <code>mysql --help</code>.

</P>
<P>
Для всех стандартных клиентских программ можно переопределить значения
опций по умолчанию, используя файл опций. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Option_files">4.1.2  Файлы параметров <tt>`my.cnf'</tt></A>.

</P>
<P>
В приведенном ниже списке дано краткое описание клиентских программ MySQL:

</P>
<DL COMPACT>

<DT><code>msql2mysql</code>
<DD>
<A NAME="IDX710"></A>
 
Сценарий оболочки операционной системы, преобразующий программы базы
данных mSQL к виду, приемлемому для MySQL. Он не обрабатывает всех
случаев, но с него хорошо начинать такое преобразование.

<A NAME="IDX711"></A>
<DT><code>mysqlaccess</code>
<DD>
Сценарий, который проверяет привилегии доступа для комбинации значений
хоста, пользователя и базы данных.

<A NAME="IDX712"></A>
<DT><code>mysqladmin</code>
<DD>
Утилита для выполнения административных функций, таких как создание или
удаление баз данных, перезагрузка таблиц привилегий, запись на диск
содержимого таблиц, находящегося в буфере, повторное открытие файлов
журналов. Утилита  <code>mysqladmin</code> может также использоваться для получения
информации с сервера о номере версии, процессах и состоянии сервера. См.
раздел See section <A HREF="manual.ru_MySQL_Database_Administration.html#mysqladmin">4.8.3  <code>mysqladmin</code>, Администрирование MySQL-сервера.</A>.

<A NAME="IDX713"></A>
<DT><code>mysqldump</code>
<DD>
Выводит содержимое базы данных MySQL в виде файла с SQL-операторами или в
виде текстовых файлов с символом табуляции в качестве разделителя.
Усовершенствованная свободно распространяемая утилита, автором которой
является Игорь Романенко. See section <A HREF="manual.ru_MySQL_Database_Administration.html#mysqldump">4.8.5  <code>mysqldump</code>, Получение дампов данных и структуры таблицы</A>.

<A NAME="IDX714"></A>
<DT><code>mysqlimport</code>
<DD>
Импортирует текстовые файлы в соответствующие таблицы, используя команду
<code>LOAD DATA INFILE</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#mysqlimport">4.8.7  <code>mysqlimport</code>, импорт данных из текстовых файлов</A>.

<A NAME="IDX715"></A>
<DT><code>mysqlshow</code>
<DD>
Отображает информацию о существующих базах данных, таблицах, полях и
индексах.

<A NAME="IDX716"></A>
<DT><code>replace</code>
<DD>
Служебная программа, использующаяся в сценарии <code>msql2mysql</code>, но имеющая
также более широкое применение. Утилита <code>replace</code> изменяет строки,
находящиеся в файлах или в стандартных входных данных. Использует принцип
конечного автомата, чтобы в первую очередь найти соответствие длинных
строк. Может применяться для замены строк. Например, эта команда меняет
местами <code>a</code> и <code>b</code> в данных файлах:


<pre>
shell&#62; replace a b b a -- file1 file2 ...
</pre>

</DL>



<H3><A NAME="mysql" HREF="manual.ru_toc.html#mysql">4.8.2  <code>mysql</code>, Утилита командной строки</A></H3>

<P>
<A NAME="IDX717"></A>
<A NAME="IDX718"></A>
<A NAME="IDX719"></A>
<A NAME="IDX720"></A>

</P>
<P>
Утилита командной строки <code>mysql</code> является простой SQL-оболочкой (с
возможностями библиотеки <code>readline</code> проекта GNU). Она поддерживает
интерактивный и неинтерактивный режимы. В интерактивном режиме результаты
запроса представляются в ASCII-формате. При использовании в
неинтерактивном режиме (например, в качестве фильтра) результат
представляется в текстовом формате с символом табуляции в качестве
разделителя (выходной формат можно изменить при помощи параметров
командной строки). Сценарии можно запускать, как показано ниже:

</P>

<pre>
shell&#62; mysql database &#60; script.sql &#62; output.tab
</pre>

<P>
Если возникают проблемы из-за недостатка памяти на данном клиенте,
применяйте параметр <code>--quick</code>! Это заставит <code>mysql</code> использовать функцию
<code>mysql_use_result()</code> вместо функции <code>mysql_store_result()</code> для получения
результирующей выборки данных.

</P>
<P>
Использовать <code>mysql</code> очень легко. Запустите <code>mysql database</code> или <code>mysql
--user=user_name --password=your_password databas</code>e. Наберите SQL-команду
прямо в командной строке, завершив ее одним из символов: <samp>`;'</samp>, <samp>`\g'</samp> или
<samp>`\G'</samp>, и нажмите клавишу ``Ввод''.

</P>
<P>
Утилита командной строки <code>mysql</code> поддерживает следующие параметры:

</P>
<P>
<A NAME="IDX721"></A>
<A NAME="IDX722"></A>
<A NAME="IDX723"></A>
<A NAME="IDX724"></A>

</P>
<DL COMPACT>

<DT><code>-?, --help</code>
<DD>
<A NAME="IDX725"></A>
 
Вывод справочной информации об использовании программы и выход из нее.

<A NAME="IDX726"></A>
<DT><code>-A, --no-auto-rehash</code>
<DD>
Отключает автоматическое рехеширование. <code>rehash</code> следует использовать для
получения хеша таблиц и полей. Это обеспечивает более быстрый старт <code>mysql</code>.

<A NAME="IDX727"></A>
<DT><code>--prompt=...</code>
<DD>
Устанавливает приглашение на ввод команд в заданном формате.

<A NAME="IDX728"></A>
<DT><code>-b, --no-beep</code>
<DD>
Выключает звуковой сигнал об ошибке.

<A NAME="IDX729"></A>
<DT><code>-B, --batch</code>
<DD>
Выводит результаты в пакетном режиме с символом табуляции в качестве
разделителя, каждая строка с новой строки. Файл истории не используется.

<A NAME="IDX730"></A>
<DT><code>--character-sets-dir=...</code>
<DD>
Директория, где находятся наборы символов.

<A NAME="IDX731"></A>
<DT><code>-C, --compress</code>
<DD>
Использовать сжатие данных в протоколе сервер/клиент.

<A NAME="IDX732"></A>
<DT><code>-#, --debug[=...]</code>
<DD>
Журнал отладки. Значение по умолчанию - 'd:t:o,/tmp/mysql.trace'.

<A NAME="IDX733"></A>
<DT><code>-D, --database=...</code>
<DD>
Имя используемой базы данных. Большей частью применяется в
конфигурационном файле <tt>`my.cnf'</tt>.

<A NAME="IDX734"></A>
<DT><code>--default-character-set=...</code>
<DD>
Установить набор символов по умолчанию.

<A NAME="IDX735"></A>
<DT><code>-e, --execute=...</code>
<DD>
Выполнить команду и завершить программу (вывод результата как и для
<code>--batch</code>).

<A NAME="IDX736"></A>
<DT><code>-E, --vertical</code>
<DD>
Вывести результаты запроса (строки) по вертикали. Можно произвести вывод
подобным образом и без данного параметра, завершая команды символами <code>\G</code>.

<A NAME="IDX737"></A>
<DT><code>-f, --force</code>
<DD>
Продолжать обработку даже при обнаружении ошибки SQL.

<A NAME="IDX738"></A>
<DT><code>-g, --no-named-commands</code>
<DD>
Выключает именованные команды. Следует использовать только команды вида \*
либо применять именованные команды только в начале строки, заканчивающейся
символом <samp>`;'</samp>. Начиная с версии 10.9 клиент запускается с этой опцией,
<strong>включенной</strong> по умолчанию! С опцией <code>-g</code>, однако, длинные команды все еще
работают с первой строки.

<A NAME="IDX739"></A>
<DT><code>-G, --enable-named-commands</code>
<DD>
Разрешает именованные команды. Допускаются длинные команды, а также
укороченные команды вида \*.

<A NAME="IDX740"></A>
<DT><code>-i, --ignore-space</code>
<DD>
Игнорировать пробел после имен функций.

<A NAME="IDX741"></A>
<DT><code>-h, --host=...</code>
<DD>
Подсоединиться к базе данных на указанном хосте.

<A NAME="IDX742"></A>
<DT><code>-H, --html</code>
<DD>
Вывести выходные данные в виде HTML.

<A NAME="IDX743"></A>
<DT><code>-X, --xml</code>
<DD>
Вывести выходные данные в виде XML.

<A NAME="IDX744"></A>
<DT><code>-L, --skip-line-numbers</code>
<DD>
Не указывать номера строк для ошибок. Полезно для сравнения результирующих
файлов, включающих сообщения об ошибках.

<A NAME="IDX745"></A>
<DT><code>--no-pager</code>
<DD>
Блокирует пейджер (программа постраничного вывода) и выводит результат в
стандартный вывод stdout (в Unix). Смотрите также команду <code>\h</code>
(интерактивная помощь).

<A NAME="IDX746"></A>
<DT><code>--no-tee</code>
<DD>
Блокирует выходной файл. Смотрите также команду <code>\h</code> (интерактивная помощь).

<A NAME="IDX747"></A>
<DT><code>-n, --unbuffered</code>
<DD>
Очищать буфер после каждого запроса.

<A NAME="IDX748"></A>
<DT><code>-N, --skip-column-names</code>
<DD>
Не указывать имена столбцов в результатах.

<A NAME="IDX749"></A>
<DT><code>-O, --set-variable var=option</code>
<DD>
Установить значение переменной. Список используемых переменных выводится
через <code>--help</code>. Обратите внимание, что <code>--set-variable</code> не используется в 
MySQL 4.0. Просто используйте <code>--var=option</code>. 

<A NAME="IDX750"></A>
<DT><code>-o, --one-database</code>
<DD>
Обновить только базу данных, установленную по умолчанию. Позволяет
пропускать обновления другой базы данных в журнале обновления.

<A NAME="IDX751"></A>
<DT><code>--pager[=...]</code>
<DD>
Устанавливает тип данных вывода. По умолчанию это переменная окружения
<code>PAGER</code>. Ее возможные значения - less, more, cat [&#62; имя файла], и т.д. См.
также команду \h (интерактивная помощь). Этот параметр не работает в
пакетном (batch) режиме. Пейджер работает только под Unix.

<A NAME="IDX752"></A>
<DT><code>-p[password], --password[=...]</code>
<DD>
Пароль, используемый при подсоединении к серверу баз данных. Если в
командной строке пароль не указан, то он запрашивается у пользователя. При
использовании краткой формы <code>-p</code> не оставляйте пробел между параметром и
значением пароля.

<A NAME="IDX753"></A>
<DT><code>-P порт, --port=порт</code>
<DD>
Номер порта TCP/IP, используемый для подсоединения.

<A NAME="IDX754"></A>
<DT><code><code>--protocol=(TCP | SOCKET | PIPE | MEMORY)</code></code>
<DD>
Для указания протокола соединения, который надлежит использовать.
Новшество в  MySQL 4.1.0. 

<A NAME="IDX755"></A>
<DT><code>-q, --quick</code>
<DD>
Не кэшировать результат. Выводить его строка за строкой так, как он
приходит от сервера. Это может замедлить скорость работы сервера, если
вывод результата будет приостановлен. Файл истории не используется.

<A NAME="IDX756"></A>
<DT><code>-r, --raw</code>
<DD>
Показывать значения столбцов без какого-либо преобразования. Используется
с <code>--batch</code>.

<A NAME="IDX757"></A>
<DT><code>-s, --silent</code>
<DD>
Режим молчания. Выводить только сообщения об ошибках.

<A NAME="IDX758"></A>
<DT><code>-S --socket=...</code>
<DD>
Файл сокета, используемый для подсоединения.

<A NAME="IDX759"></A>
<DT><code>-t --table</code>
<DD>
Выводить результат в табличном формате. Установлено по умолчанию для
непакетного режима.

<A NAME="IDX760"></A>
<DT><code>-T, --debug-info</code>
<DD>
Выводить некоторые отладочные данные при выходе из программы.

<A NAME="IDX761"></A>
<DT><code>--tee=...</code>
<DD>
Присоединить что-либо к выходному файлу. Смотрите также команду \h
(интерактивная помощь). Этот параметр не работает в пакетном режиме.

<A NAME="IDX762"></A>
<DT><code>-u, --user=#</code>
<DD>
Имя пользователя MySQL, если этот пользователь не является активным в
данное время.

<A NAME="IDX763"></A>
<DT><code>-U, --safe-updates[=#], --i-am-a-dummy[=#]</code>
<DD>
Разрешает выполнять только операции <code>UPDATE</code> и <code>DELETE</code>, используя ключи.
Более полная информация об этом параметре приведена ниже. Можно сбросить
данный параметр, установив в конфигурационном файле <tt>`my.cnf'</tt> значение
аргумента <code>--safe-updates=0</code>.

<A NAME="IDX764"></A>
<DT><code>-v, --verbose</code>
<DD>
Более расширенный режим вывода результатов (<code>-v -v -v</code> дает формат вывода
таблицы).

<A NAME="IDX765"></A>
<DT><code>-V, --version</code>
<DD>
Вывод информации о версии и выход из программы.

<A NAME="IDX766"></A>
<DT><code>-w, --wait</code>
<DD>
Если соединение с сервером упало, подождать и попытаться восстановить его,
вместо того, чтобы прервать работу.
</DL>

<P>
Через параметры командной строки <code>-O</code> или <code>--set-variable</code> (в MySQL 4.0 используйте 
просто <code>--var=option</code>) можно также установить следующие переменные:

</P>
<P>
<A NAME="IDX767"></A>
<A NAME="IDX768"></A>
<A NAME="IDX769"></A>
<A NAME="IDX770"></A>
<A NAME="IDX771"></A>

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Имя переменной</strong> </TD><TD> <strong>По умолчанию</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD>connect_timeout </TD><TD> 0 </TD><TD> Число секунд до истечения времени ожидания соединения
</TD></TR>
<TR><TD>max_allowed_packet </TD><TD> 16777216 </TD><TD> Максимальная величина пакета, посылаемого/принимаемого с сервера
</TD></TR>
<TR><TD>net_buffer_length </TD><TD> 16384 </TD><TD> Размер буфера для TCP/IP и сокетного соединения
</TD></TR>
<TR><TD>select_limit </TD><TD> 1000 </TD><TD> Автоматическое ограничение количества команд SELECT при использовании --i-am-a-dummy
</TD></TR>
<TR><TD>max_join_size </TD><TD> 1000000 </TD><TD> Автоматическое ограничение количества связанных строк при использовании --i-am-a-dummy.
</TD></TR>
</TABLE>

<P>
Если ввести в командной строке <code>help</code>, программа <code>mysql</code> выведет список
поддерживаемых ею команд:

</P>
<P>
<A NAME="IDX772"></A>

</P>

<pre>
mysql&#62; help

Команды MySQL
help (\h)	Выводит данный текст.
? (\h)		Синоним для help.
clear (\c)	Команда очистки.
connect (\r)	Снова подключиться к серверу.
		Дополнительные аргументы - db и host.
edit (\e)	Редактировать текущую команду с помощью $EDITOR.
ego (\G)	Послать текущую команду MySQL серверу
		и вывести результат по вертикали.
exit (\q)	Выйти из программы. То же что и quit.
go (\g)		Послать текущую команду MySQL серверу.
nopager (\n)	Блокировать пейджер, выводить через stdout.
notee (\t)	Не добавлять записи в выходной файл outfile.
pager (\P)	Установить PAGER [to_pager].
		Выводить результаты запроса через PAGER.
print (\p)	Вывести текущую команду.
prompt (\R)	Изменить формат приглашения на ввод команд mysql.
quit (\q)	Выйти из программы.
rehash (\#)	Восстановить таблицу хэшей.
source (\.)	Запустить на выполнение файл с SQL-сценарием.
		Указать имя файла в качестве аргумента.
status (\s)	Получить информацию о статусе сервера.
tee (\T)	Установить параметр outfile [to_outfile].
		Присоединить что-либо к данному выходному файлу.
use (\u)	Использовать другую базу данных.
		Указать имя базы данных в качестве аргумента.
</pre>

<P>
Команда <code>pager</code> работает только под Unix.

</P>
<P>
<A NAME="IDX773"></A>
Команда <code>status</code> дает информацию о текущем соединении и используемом
сервере. Если вы работаете в режиме <code>--safe-updates</code>, команда <code>status</code> также
выведет значения переменных для <code>mysql</code>, которые влияют на ваши запросы.

</P>
<P>
Для начинающих рекомендуется пользоваться программой <code>mysql</code> с установленным
параметром (введен в MySQL 3.23.11) <code>--safe-updates</code> (или <code>--i-am-a-dummy</code> для
пользователей, выполнивших <code>DELETE FROM table_name</code>, но забывших указать
аргументы в <code>WHERE</code>). В этом случае <code>mysql</code> при установлении соединения
посылает следующую команду MySQL-серверу:

</P>

<pre>
SET SQL_SAFE_UPDATES=1,SQL_SELECT_LIMIT=#select_limit#,
    SQL_MAX_JOIN_SIZE=#max_join_size#"
</pre>

<P>
где <code>#select_limit#</code> и <code>#max_join_size#</code> - переменные, которые можно
установить из командной строки mysql. See section <A HREF="manual.ru_MySQL_Optimisation.html#SET_OPTION">5.5.6  Синтаксис команды <code>SET</code></A>.

</P>
<P>
Результат этого следующий:

</P>

<ul>
<LI>

Не разрешено выполнять команды <code>UPDATE</code> или <code>DELETE</code>, если не указаны
ограничения по ключам в секции <code>WHERE</code>. Однако можно заставить
выполняться команды <code>UPDATE</code>/<code>DELETE</code>, используя оператор <code>LIMIT</code>:


<pre>
UPDATE table_name SET not_key_column=# WHERE not_key_column=# LIMIT 1;
</pre>

<LI>

Все слишком большие результаты ограничены строками <code>#select_limit#</code>.

<LI>

<code>SELECT</code>ы, которые могут потребовать для исполнения количество
комбинаций строк более, чем <code>#max_join_size#</code>, будут прерваны.
</ul>

<P>
Несколько полезных советов по использованию клиента <code>mysql</code>:

</P>
<P>
Некоторые данные более удобочитаемы при выводе их по вертикали вместо
обычно используемого горизонтального окна вывода. Например, текст, который
больше по длине, чем по ширине, и содержит в себе много новых строк, часто
намного легче читать в вертикальном представлении.

</P>

<pre>
mysql&#62; SELECT * FROM mails WHERE LENGTH(txt) &#60; 300 lIMIT 300,1\G
*************************** 1. row ***************************
  msg_nro: 3068
     date: 2000-03-01 23:29:50
time_zone: +0200
mail_from: Monty
    reply: monty@no.spam.com
  mail_to: "Thimble Smith" &#60;tim@no.spam.com&#62;
      sbj: UTF-8
      txt: &#62;&#62;&#62;&#62;&#62; "Thimble" == Thimble Smith writes:
Thimble&#62; Hi.  I think this is a good idea.  Is anyone familiar with UTF-8
Thimble&#62; or Unicode? Otherwise, I'll put this on my TODO list and see what
Thimble&#62; happens.

Yes, please do that.
Regards,
Monty
     file: inbox-jani-1
     hash: 190402944
1 row in set (0.09 sec)
</pre>

<P>
Для журналирования можно использовать опции команды tee. Она может
быть запущена с помощью параметра <code>--tee=...</code> для  <code>mysql</code> или
интерактивно из командной строки вводом команды <code>tee</code>. Все
представляемые на экране данные будут также добавлены к заданному
файлу. Это может быть очень полезно для целей отладки программы.
Утилиту tee можно блокировать из командной строки командой <code>notee</code>.
Повторный запуск команды <code>tee</code> снова включит журналирование. Если при
этом параметр для команды <code>tee</code> не указан, то будет использоваться
предыдущий файл. Следует учесть, что команда <code>tee</code> будет записывать
результаты в файл после каждой выполненной команды, как раз перед
появлением командной строки для ввода очередной команды.

</P>
<P>
При помощи опции <code>--pager[=...]</code> стал возможным просмотр или поиск
результатов в интерактивном режиме с помощью Unix-программ <code>less</code>, <code>more</code>
или иных подобных. Если явно не указать аргумент в этом параметре,
клиент <code>mysql</code> будет искать переменную окружения <code>PAGER</code> и установит
значение <code>pager</code>. Программу <code>pager</code> также можно запустить из интерактивной
командной строки командой <code>pager</code> и остановить командой <code>nopager</code>. Команда
может принимать аргумент, который является необязательным; <code>pager</code> будет
установлена в значение этого аргумента.. Команда <code>pager</code> может быть
вызвана и без аргумента, но это требует использования опции <code>--pager</code> 
или соответствующей установки по умолчанию стандартного вывода <code>stdout</code>.
Команда pager работает только в Unix, поскольку использует функцию
<code>popen()</code>, отсутствующую в Windows. Вместо этого в Windows можно
использовать параметр <code>tee</code>, хотя в ряде ситуаций это менее удобно, чем
применение команды <code>pager</code>.

</P>
<P>
Несколько советов касательно команды <code>pager</code>: 

<ul>
<LI>

Ее можно использовать для записи в файл:


<pre>
mysql&#62; pager cat &#62; /tmp/log.txt
</pre>

и результаты будут направлены только в файл. Вызываемые командой <code>pager</code>
программы могут принимать любые допустимые опции:


<pre>
mysql&#62; pager less -n -i -S
</pre>

<LI>

Обратите особое внимание на опцию -S в вышеприведенном примере. Она может
быть очень полезна при просмотре результатов. Попробуйте применить ее с
горизонтальным выводом (завершайте команды символами '\g', or ';') и с
вертикальным (в конце команд - '\G'). Очень громоздкие результаты вывода
иногда трудно бывает прочесть с экрана, в этом случае команда less с
опцией -S позволит просмотреть результаты в интерактивном режиме слева
направо, при этом при появлении строк с длиной больше, чем ширина экрана,
их вывод будет продолжен вывод с новой строки. Вывод данных в таких
случаях получается более удобочитаемым. При интерактивном вызове команды
less с опцией '-S' можно переключать режим ее работы (включено/выключено)
из командной строки. Чтобы получить дополнительную информацию относительно
less, обращайтесь к описанию команды 'h'.

<LI>

В заключение отметим (если вы этого еще не поняли из предыдущих
примеров :), что существует возможность комбинировать очень сложные
способы обработки результатов. Так, в следующем примере результаты
будут посланы в два различных каталога, смонтированных на двух
различных жестких дисках в /dr1 and /dr2, и, несмотря на это,
результаты можно увидеть на экране посредством команды less:


<pre>
mysql&#62; pager cat | tee /dr1/tmp/res.txt | \
       tee /dr2/tmp/res2.txt | less -n -i -S
</pre>

</ul>

<P>
Приведенные выше функции можно тоже комбинировать: запустив <code>tee</code> и
установив <code>pager</code> в <code>less</code>, можно просматривать результаты с помощью
Unix-команды <code>less</code> и при этом одновременно производить запись в файл.
Разница между служебной Unix-утилитой <code>tee</code>, используемой в программе
<code>pager</code>, и встроенной в клиент <code>mysql</code> командой <code>tee</code> заключается в том, что
встроенная команда <code>tee</code> работает даже в том случае, если в Unix утилита
<code>tee</code> недоступна. Встроенная команда <code>tee</code> также ведет запись всего, что
выводится на экран, тогда как утилита Unix <code>tee</code>, используемая с <code>pager</code>,
не делает этого в достаточном объеме. Последнее, но тем не менее
важное обстоятельство состоит в том, что интерактивная команда <code>tee</code>
более удобна для переключения режимов работы включено/выключено, если
при записи в файл иногда возникает необходимость отключить эту
функцию.

</P>
<P>
Начиная с версии MySQL 4.0.2 можно изменить формат приглашения в командной
строке клиента <code>mysql</code>.

</P>
<P>
<A NAME="IDX774"></A>

</P>
<P>
Возможны следующие опции приглашения:
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Опция</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD>\v </TD><TD> версия mysqld
</TD></TR>
<TR><TD>\d </TD><TD> имя используемой базы данных
</TD></TR>
<TR><TD>\h </TD><TD> имя хоста, к которому производится подсоединение
</TD></TR>
<TR><TD>\p </TD><TD> номер порта, через который производится подсоединение
</TD></TR>
<TR><TD>\u </TD><TD> имя пользователя
</TD></TR>
<TR><TD>\U </TD><TD> полный адрес username@host
</TD></TR>
<TR><TD>\\ </TD><TD> обратный слэш <samp>`\'</samp>
</TD></TR>
<TR><TD>\n </TD><TD> символ новой строки
</TD></TR>
<TR><TD>\t </TD><TD> табуляция
</TD></TR>
<TR><TD>\ </TD><TD> пробел
</TD></TR>
<TR><TD>\_ </TD><TD> пробел с подчеркиванием
</TD></TR>
<TR><TD>\R </TD><TD> время по военному часовому поясу (0-23)
</TD></TR>
<TR><TD>\r </TD><TD> время по стандартному часовому поясу (1-12)
</TD></TR>
<TR><TD>\m </TD><TD> минуты
</TD></TR>
<TR><TD>\y </TD><TD> два разряда года
</TD></TR>
<TR><TD>\Y </TD><TD> четыре разряда года
</TD></TR>
<TR><TD>\D </TD><TD> полный формат даты
</TD></TR>
<TR><TD>\s </TD><TD> секунды
</TD></TR>
<TR><TD>\w </TD><TD> день недели в трехбуквенном формате (Mon, Tue, ...)
</TD></TR>
<TR><TD>\P </TD><TD> Время до полудня/после полудня (am/pm)
</TD></TR>
<TR><TD>\o </TD><TD> месяц в числовом формате
</TD></TR>
<TR><TD>\O </TD><TD> месяц в трехбуквенном формате (Jan, Feb, ...)
</TD></TR>
<TR><TD>\c </TD><TD> Счетчик, подсчитывающий количество вводимых команд
</TD></TR>
</TABLE>

</P>
<P>
Символ <samp>`\'</samp> за которым следует любая другая буква, просто дополняет эту
букву.

</P>
<P>
Установить параметры приглашения можно следующими способами:

</P>
<DL COMPACT>

<DT><strong>В переменных окружения</strong>
<DD>
Можно установить переменную окружения <code>MYSQL_PS1</code> для строки приглашения.
Например:


<pre>
shell&#62; export MYSQL_PS1="(\u@\h) [\d]&#62; "
</pre>

<DT><strong><tt>`my.cnf'</tt></strong>
<DD>
<DT><strong><tt>`.my.cnf'</tt></strong>
<DD>
Можно установить опцию prompt в любом конфигурационном файле MySQL в
группе <code>mysql</code>. Например:


<pre>
[mysql]
prompt=(\u@\h) [\d]&#62;\_
</pre>

<DT><strong>В командной строке</strong>
<DD>
Можно установить опцию <code>--prompt</code> из командной строки утилиты <code>mysql</code>.
Например:


<pre>
shell&#62; mysql --prompt="(\u@\h) [\d]&#62; "
(user@host) [database]&#62;
</pre>

<DT><strong>В интерактивном режиме</strong>
<DD>
Можно также использовать команду <code>prompt</code> (или <code>\R</code>) для изменения настроек
приглашения в интерактивном режиме. Например:


<pre>
mysql&#62; prompt (\u@\h) [\d]&#62;\_
PROMPT set to '(\u@\h) [\d]&#62;\_'

(user@host) [database]&#62;
(user@host) [database]&#62; prompt
Возвращение к исходным (по умолчанию) настройкам PROMPT в утилите mysql&#62;
mysql&#62;
</pre>

</DL>



<H3><A NAME="mysqladmin" HREF="manual.ru_toc.html#mysqladmin">4.8.3  <code>mysqladmin</code>, Администрирование MySQL-сервера.</A></H3>

<P>
<A NAME="IDX775"></A>
<A NAME="IDX776"></A>
<A NAME="IDX777"></A>

</P>
<P>
Утилита для выполнения административных операций. Ее  синтаксис:

</P>

<pre>
shell&#62; mysqladmin [ПАРАМЕТРЫ] command [command-option] command ...
</pre>

<P>
Список опций, поддерживаемых вашей конкретной версией <code>mysqladmin</code>, можно
получить, выполнив команду <code>mysqladmin --help</code>.

</P>
<P>
Текущая версия <code>mysqladmin</code> поддерживает следующие команды:

</P>
<DL COMPACT>

<DT><code>create databasename</code>
<DD>
Создать новую базу данных.

<DT><code>drop databasename</code>
<DD>
Удалить базу данных и все ее таблицы.

<DT><code>extended-status</code>
<DD>
Выдает расширенный отчет о состоянии сервера (более полный, чем при
команде <code>status</code> )

<DT><code>flush-hosts</code>
<DD>
Сбросить и перезагрузить хосты.

<DT><code>flush-logs</code>
<DD>
Сбросить на диск и переоткрыть все журналы.

<DT><code>flush-tables</code>
<DD>
Закрыть все открытые таблицы.

<DT><code>flush-privileges</code>
<DD>
Перечитать таблицы привилегий.

<DT><code>kill id,id,...</code>
<DD>
Завершить потоки <code>mysql</code> с указанными <code>thread-id</code>.

<DT><code>password</code>
<DD>
Установить новый пароль для сервера баз данных. Изменить старый пароль на
новый.

<DT><code>ping</code>
<DD>
Проверить, работает ли сервер <code>mysqld</code>.

<DT><code>processlist</code>
<DD>
Показать список активных потоков на сервере.

<DT><code>reload</code>
<DD>
Перезагрузить таблицы привилегий.

<DT><code>refresh</code>
<DD>
Выполнить все табличные операции, находящиеся в буфере, закрыть и открыть
заново все системные журналы.

<DT><code>shutdown</code>
<DD>
Завершить работу сервера баз данных.

<DT><code>slave-start</code>
<DD>
Запустить подчиненный дублирующий поток.

<DT><code>slave-stop</code>
<DD>
Остановить подчиненный дублирующий поток.

<DT><code>status</code>
<DD>
Выдает краткий отчет о состоянии сервера.

<DT><code>variables</code>
<DD>
Вывести доступные для использования переменные.

<DT><code>version</code>
<DD>
Вывести данные о версии сервера.
</DL>

<P>
Все команды могут сокращаться до их уникальных префиксов. Например:

</P>

<pre>
shell&#62; mysqladmin proc stat
+----+-------+-----------+----+-------------+------+-------+------+
| Id | User  | Host      | db | Command     | Time | State | Info |
+----+-------+-----------+----+-------------+------+-------+------+
| 6  | monty | localhost |    | Processlist | 0    |       |      |
+----+-------+-----------+----+-------------+------+-------+------+
Uptime: 10077  Threads: 1  Questions: 9  Slow queries: 0
Opens: 6 Flush tables: 1  Open tables: 2
Memory in use: 1092K  Max memory used: 1116K
</pre>

<P>
<A NAME="IDX778"></A>

</P>
<P>
Результат команды <code>mysqladmin</code> status выводится в виде следующих столбцов:

</P>
<P>
<A NAME="IDX779"></A>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Столбец</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD>Uptime </TD><TD> Количество секунд с момента запуска MySQL-сервера.
</TD></TR>
<TR><TD>Threads </TD><TD> Количество активных потоков (клиентов).
<A NAME="IDX780"></A>
 
</TD></TR>
<TR><TD>Questions </TD><TD> Количество вопросов от клиентов с момента запуска программы <code>mysqld</code>.
<A NAME="IDX781"></A>
 
</TD></TR>
<TR><TD>Slow queries </TD><TD> Количество запросов, потребовавших большее количество секунд, чем установлено в конфигурации ключом <code>long_query_time</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Slow_query_log">4.9.5  Журнал медленных запросов</A>.
<A NAME="IDX782"></A>
 
</TD></TR>
<TR><TD>Opens </TD><TD> Количество таблиц, открытых программой <code>mysqld</code>.
<A NAME="IDX783"></A>
 
</TD></TR>
<TR><TD>Flush table </TD><TD> Количество выполненных команд <code>flush</code> ..., <code>refresh</code>, <code>reload</code>.
<A NAME="IDX784"></A>
 <A NAME="IDX785"></A>
 
</TD></TR>
<TR><TD>Open  tables </TD><TD> Количество таблиц, открытых в данное время.
<A NAME="IDX786"></A>
 
</TD></TR>
<TR><TD>Memory in use </TD><TD> Память, используемая непосредственно программой <code>mysqld</code> (доступно только в случае компиляции MySQL с установленным значением <code>--with-debug=full</code>).
<A NAME="IDX787"></A>
 
</TD></TR>
<TR><TD>Max memory used </TD><TD> Максимальный объем памяти, использованный непосредственно программой mysqld (доступно только в случае компиляции MySQL с установленным значением <code>--with-debug=full</code>).
<A NAME="IDX788"></A>
 
</TD></TR>
</TABLE>

</P>
<P>
При выполнении <code>mysqladmin shutdown</code> через сокет
(другими словами, через компьютер с запущенным <code>mysqld</code>) <code>mysqladmin</code> будет
ожидать, пока на сервере MySQL не будет удален файл <code>pid-file</code> (в котором
содержится идентификатор процесса <tt>`pid'</tt> запущенного сервера) чтобы
убедиться, что сервер остановлен должным образом.

</P>


<H3><A NAME="Using_mysqlcheck" HREF="manual.ru_toc.html#Using_mysqlcheck">4.8.4  Использование <code>mysqlcheck</code> для сопровождения и аварийного восстановления таблиц.</A></H3>

<P>
Начиная с версии MySQL 3.23.38 можно применять новый инструмент для
проверки и восстановления <code>MyISAM</code>-таблиц. Отличие <code>mysqlcheck</code> от <code>myisamchk</code>
состоит в том, что утилита <code>mysqlcheck</code> должна использоваться при работающем
сервере <code>mysqld</code>, в то время как <code>myisamchk</code> - при остановленном. Преимущество
же заключается в том, что теперь не нужно останавливать сервер для
проверки или восстановления таблиц.

</P>
<P>
Утилита <code>mysqlcheck</code> использует соответствующие команды MySQL-сервера <code>CHECK</code>,
<code>REPAIR</code>, <code>ANALYZE</code> и <code>OPTIMIZE</code> удобным для пользователя образом.

</P>
<P>
Существует три альтернативных способа запуска <code>mysqlcheck</code>:

</P>

<pre>
shell&#62; mysqlcheck [OPTIONS] database [tables]
shell&#62; mysqlcheck [OPTIONS] --databases DB1 [DB2 DB3...]
shell&#62; mysqlcheck [OPTIONS] --all-databases
</pre>

<P>
Таким образом, утилита может использоваться подобно <code>mysqldump</code> по отношению
к выбранным базам данных и таблицам.

</P>
<P>
В сравнении с другими клиентами утилита <code>mysqlcheck</code> имеет следующую
отличительную особенность: установка поведения по умолчанию, (проверка
таблиц, <code>-с</code>), может быть изменена путем переименования исполняемого файла
утилиты. Итак, чтобы получить инструмент, восстанавливающий таблицы по
умолчанию, просто скопируйте <code>mysqlcheck</code> с новым именем, <code>mysqlrepair</code>, или,
наоборот, сделайте символьную ссылку на <code>mysqlrepair</code> и обозначьте ее как
<code>mysqlrepair</code>. Если теперь запустить <code>mysqlrepair</code>, то утилита по умолчанию
будет восстанавливать таблицы.

</P>
<P>
Для изменения поведения <code>mysqlcheck</code> по умолчанию можно использовать
следующие обозначения:

</P>

<pre>
mysqlrepair: Значение по умолчанию будет -r
mysqlanalyze: Значение по умолчанию будет -a
mysqloptimize: Значение по умолчанию будет -o
</pre>

<P>
Ниже приведены возможные опции для <code>mysqlcheck</code>. Какие из них поддерживает
ваша версия, можно проверить с помощью команды <code>mysqlcheck --help</code>.

</P>
<DL COMPACT>

<DT><code>-A, --all-databases</code>
<DD>
Проверить все базы данных. Аналогична опции <code>--databases</code>, если указать все
базы данных.

<DT><code>-1, --all-in-1</code>
<DD>
Вместо выполнения запросов для каждой таблицы в отдельности выполнить все
запросы в одном отдельно для каждой таблицы. Имена таблиц будут
представлены в виде списка имен, разделенных запятой.

<DT><code>-a, --analyze</code>
<DD>
Анализировать данные таблицы.

<DT><code>--auto-repair</code>
<DD>
Если проверенная таблица повреждена, автоматически восстановить ее.
Исправления будут произведены после проверки всех таблиц, если были
обнаружены повреждения.

<DT><code>-#, --debug=...</code>
<DD>
Выводит информацию журнала отладки. Часто используется следующий набор
параметров: 'd:t:o,filename'

<DT><code>--character-sets-dir=...</code>
<DD>
Директория, где находятся установки символов.

<DT><code>-c, --check</code>
<DD>
Проверить таблицу на наличие ошибок.

<DT><code>-C, --check-only-changed</code>
<DD>
Проверить только таблицы, измененные со времени последней проверки или
некорректно закрытые.

<DT><code>--compress</code>
<DD>
Использовать сжатие данных в протоколе сервер/клиент.

<DT><code>-?, --help</code>
<DD>
Вывести данную вспомогательную информацию и выйти из программы.

<DT><code>-B, --databases</code>
<DD>
Проверить несколько баз данных. Обратите внимание на разницу в
использовании: в этом случае таблицы не указываются. Все имена аргументов
рассматриваются как имена баз данных.

<DT><code>--default-character-set=...</code>
<DD>
Установить набор символов по умолчанию.

<DT><code>-F, --fast</code>
<DD>
Проверить только базы данных, которые не были закрыты должным образом.

<DT><code>-f, --force</code>
<DD>
Продолжать даже при получении ошибки SQL.

<DT><code>-e, --extended</code>
<DD>
При использовании данного параметра совместно с <code>CHECK TABLE</code> можно быть на
100 процентов быть уверенным в целостности таблицы, хотя это и займет
много времени. Если же использовать этот параметр с <code>REPAIR TABLE</code>,
запустится расширенное восстановление таблицы, которое может потребовать
не только длительного времени выполнения, но и привнесет также массу
ненужных строк!

<DT><code>-h, --host=...</code>
<DD>
Подключиться к хосту.

<DT><code>-m, --medium-check</code>
<DD>
Быстрее, чем <code>--extended-check</code>, но находит только 99,99 процентов всех
ошибок. Для большинства случаев этот вариант вполне подходит.

<DT><code>-o, --optimize</code>
<DD>
Оптимизировать таблицу.

<DT><code>-p, --password[=...]</code>
<DD>
Используемый пароль при подключении к серверу. Если пароль не указан, у
пользователя запрашивается пароль с терминала.

<DT><code>-P, --port=...</code>
<DD>
Номер порта, используемого для подключения по TCP/IP.

<DT><code><code>--protocol=(TCP | SOCKET | PIPE | MEMORY)</code></code>
<DD>
Для указания протокола соединения, который надлежит использовать. 
Новшество в  MySQL 4.1.0. 

<DT><code>-q, --quick</code>
<DD>
При использовании данной опции совместно с <code>CHECK TABLE</code> предотвращается
сканирование строк для корректировки неправильных связей. Это наиболее
быстрый метод проверки. Если же использовать этот параметр с <code>REPAIR 
TABLE</code>, программа попытается восстановить только систему индексов. Это
наиболее быстрый метод восстановления таблицы.

<DT><code>-r, --repair</code>
<DD>
Может исправить почти все, за исключением уникальных ключей, имеющих
дубликаты.

<DT><code>-s, --silent</code>
<DD>
Выводить только сообщения об ошибках.

<DT><code>-S, --socket=...</code>
<DD>
Файл сокета, используемый для подсоединения.

<DT><code>--tables</code>
<DD>
Перекрывает опцию <code>--databases</code> (<code>-B</code>).

<DT><code>-u, --user=#</code>
<DD>
Имя пользователя MySQL, если этот пользователь в данное время не является
активным.

<DT><code>-v, --verbose</code>
<DD>
Вывести информацию о различных этапах.

<DT><code>-V, --version</code>
<DD>
Вывести информацию о версии и выйти из программы.
</DL>



<H3><A NAME="mysqldump" HREF="manual.ru_toc.html#mysqldump">4.8.5  <code>mysqldump</code>, Получение дампов данных и структуры таблицы</A></H3>

<P>
<A NAME="IDX789"></A>
<A NAME="IDX790"></A>
<A NAME="IDX791"></A>
<A NAME="IDX792"></A>

</P>
<P>
Данная утилита позволяет получить дамп (``моментальный снимок'')
содержимого базы данных или совокупности баз для создания резервной копии
или пересылки данных на другой SQL-сервер баз данных (не обязательно
MySQL-сервер). Дамп будет содержать набор команд SQL для создания и/или
заполнения таблиц.

</P>
<P>
Если же резервная копия создается на сервере, то вместо описываемой
утилиты следует использовать <code>mysqlhotcopy</code>. См.раздел See section <A HREF="manual.ru_MySQL_Database_Administration.html#mysqlhotcopy">4.8.6  <code>mysqlhotcopy</code>, Копирование баз данных и таблиц MySQL</A>.

</P>

<pre>
shell&#62; mysqldump [OPTIONS] database [tables]
или  mysqldump [OPTIONS] --databases [OPTIONS] DB1 [DB2 DB3...]
или  mysqldump [OPTIONS] --all-databases [OPTIONS]
</pre>

<P>
Если не указывать имена таблиц или использовать параметры <code>--databases</code> или
<code>--all-databases</code>, то будет получен дамп базы данных в целом (соответственно
- всех баз данных).

</P>
<P>
Перечень опций, поддерживаемых вашей конкретной версией утилиты <code>mysqldump</code>,
можно получить, выполнив команду <code>mysqldump --help</code>.

</P>
<P>
Следует иметь в виду, что утилита <code>mysqldump</code>, используемая без опций
<code>--quick</code> или <code>--opt</code>, перед тем, как сделать дамп результата выборки
информации, загрузит весь результат в память. Это может создать проблемы
при получении дампа большой базы данных.

</P>
<P>
Учтите, что не следует применять параметры <code>--opt</code> или <code>-e</code>, если вы
собираетесь использовать для получения дампа новую копию программы
<code>mysqldump</code>, а затем воспроизводить его на очень старом MySQL-сервере.

</P>
<P>
Утилита <code>mysqldump</code> поддерживает следующие опции:

</P>
<DL COMPACT>

<DT><code>--add-locks</code>
<DD>
Добавить команды <code>LOCK TABLES</code> перед выполнением и <code>UNLOCK TABLE</code> после
выполнения каждого дампа таблицы (для ускорения доступа к MySQL).

<DT><code>--add-drop-table</code>
<DD>
Добавить команду <code>DROP TABLE</code> перед каждой командой <code>CREATE TABLE</code>.

<DT><code>-A, --all-databases</code>
<DD>
Произвести дамп всех баз данных. Аналогично опции <code>--databases</code> с указанием
всех баз данных.

<DT><code>-a, --all</code>
<DD>
Включить все опции создания объектов, специфичные для MySQL.

<DT><code>--allow-keywords</code>
<DD>
Разрешить создавать имена столбцов, которые совпадают с ключевыми словами.
Отсутствие конфликтов обеспечивается прибавлением имени таблицы в качестве
префикса к имени каждого столбца.

<DT><code>-c, --complete-insert</code>
<DD>
Использовать полные команды <code>INSERT</code> (с именами столбцов).

<DT><code>-C, --compress</code>
<DD>
Использовать сжатие всей информации между клиентом и сервером, если они
оба поддерживают сжатие.

<DT><code>-B, --databases</code>
<DD>
Выполнить дамп нескольких баз данных. Обратите внимание на разницу в
использовании: в этом случае таблицы не указываются. Все имена аргументов
рассматриваются как имена баз данных. Оператор <code>USE db_name;</code> включается в
вывод перед каждой новой базой данных.

<DT><code>--delayed</code>
<DD>
Использовать команду <code>INSERT DELAYED</code> при вставке строк.

<DT><code>-e, --extended-insert</code>
<DD>
Использовать команду <code>INSERT</code> с новым многострочным синтаксисом (повышает
компактность и быстродействие операторов ввода).

<DT><code>-#, --debug[=option_string]</code>
<DD>
Отслеживать прохождение программы (для отладки).

<DT><code>--help</code>
<DD>
Вывести справочную информацию и выйти из программы.

<DT><code>--fields-terminated-by=...</code>
<DD>
<DT><code>--fields-enclosed-by=...</code>
<DD>
<DT><code>--fields-optionally-enclosed-by=...</code>
<DD>
<DT><code>--fields-escaped-by=...</code>
<DD>
<DT><code>--lines-terminated-by=...</code>
<DD>
Эти опции используются совместно с параметром <code>-T</code> и имеют то же самое
значение, что и соответствующие операторы для <code>LOAD DATA INFILE</code>. См.
раздел See section <A HREF="manual.ru_Reference.html#LOAD_DATA">6.4.9  Синтаксис оператора  <code>LOAD DATA INFILE</code></A>.

<DT><code>-F, --flush-logs</code>
<DD>
Записать на диск данные системного журнала из буфера MySQL-сервера перед
началом выполнения дампа.

<DT><code>-f, --force,</code>
<DD>
Продолжать даже при получении ошибки SQL при выполнении дампа таблицы.

<DT><code>-h, --host=..</code>
<DD>
Выполнить дамп данных MySQL сервера на указанном хосте. Значение хоста по
умолчанию - <code>localhost</code>.

<DT><code>-l, --lock-tables.</code>
<DD>
Заблокировать все таблицы перед началом выполнения дампа. Таблицы
блокируются оператором <code>READ LOCAL</code>, чтобы разрешить параллельные записи
для <code>MyISAM</code>-таблиц. Следует отметить, что при выполнении дампа совокупности
баз данных опция <code>--lock-tables</code> блокирует таблицы каждой базы по
отдельности. Таким образом, использование этого параметра не гарантирует,
что таблицы будут логически непротиворечивы в пределах этих баз данных. В
различных базах данных при выполнении дампа таблицы могут находиться в
совершенно разных состояниях.

<DT><code>-K, --disable-keys</code>
<DD>
Добавляет выражение
<code>/*!40000 ALTER TABLE tb_name DISABLE KEYS */;</code>
и <code>/*!40000 ALTER TABLE tb_name ENABLE KEYS */;</code> 
в выводе результата. Это
ускорит загрузку данных на сервер MySQL 4.0, так как индексы создаются
после внесения всех данных.

<DT><code>-n, --no-create-db</code>
<DD>
В выводе результата выражение <code>CREATE DATABASE /*!32312 IF NOT EXISTS*/
db_name;</code> будет отсутствовать. Данная строка будет добавлена в любом случае
при использовании опций <code>--databases</code> или <code>--all-databases</code>.

<DT><code>-t, --no-create-info</code>
<DD>
Не записывать информацию о создании таблицы (команда <code>CREATE TABLE</code>).

<DT><code>-d, --no-data</code>
<DD>
Не записывать информацию из строк таблицы. Это очень полезно для получения
дампа структуры таблицы!

<DT><code>--opt</code>
<DD>
То же, что и <code>--quick --add-drop-table --add-locks --extended-insert
--lock-tables</code>. Должно дать наиболее быстрый дамп для чтения на
MySQL-сервере.

<DT><code>-pyour_pass, --password[=your_pass]</code>
<DD>
Используемый пароль при подключении к серверу. Если аргумент <code>=your_pass</code> не
введен, <code>mysqldump</code> предложит ввести пароль.

<DT><code>-P port_num, --port=port_num</code>
<DD>
Номер порта TCP/IP, используемого для подключения к хосту.

<DT><code><code>--protocol=(TCP | SOCKET | PIPE | MEMORY)</code></code>
<DD>
Для указания протокола соединения, который надлежит использовать. 
Новшество в  MySQL 4.1.0. 

<DT><code>-q, --quick</code>
<DD>
Выводить дамп непосредственно на стандартный вывод <code>stdout</code> без буферизации
запроса. Для этого используется функция <code>mysql_use_result()</code>.

<DT><code>-Q, --quote-names</code>
<DD>
Взять в кавычки имена таблиц и столбцов без символов <samp>``'</samp>.

<DT><code>-r, --result-file=...</code>
<DD>
Прямой вывод указанного файла. Этот опцию следует использовать в MS DOS,
так как она предотвращает преобразование символа новой строки '\n' в
последовательность '\n\r' (новая строка + возврат каретки).

<DT><code>--single-transaction</code>
<DD>
Данная опция выдает SQL-команду <code>BEGIN</code> перед выполнением дампа данных с
сервера. Наиболее часто используется с <code>InnoDB</code>-таблицамии и уровнем
изоляции транзакций <code>READ_COMMITTED</code>, так как именно в этом режиме можно
получить дамп с непротиворечивым состоянием базы данных после выполнения
команды <code>BEGIN</code> без блокирования каких-либо приложений. Используя эту опцию,
необходимо помнить, что при выполнении дампа только транзакционные таблицы
будут находиться в непротиворечивом состоянии, т.е. некоторые <code>MyISAM</code>- или
<code>HEAP</code>-таблицы при использовании данной опции могут все же изменить свое
состояние. 

Опция <code>--single-transaction</code> добавлена в версии 4.0.2. Она
является взаимоисключающей по отношению к опции <code>--lock-tables</code>, так как
команда <code>LOCK TABLES</code> уже принимает открытую транзакцию. 

<DT><code>-S /path/to/socket, --socket=/path/to/socket</code>
<DD>
Файл сокета для подсоединения к <code>localhost</code> (значение хоста по умолчанию).

<DT><code>--tables</code>
<DD>
Перекрывает параметр --databases (-B).

<DT><code>-T, --tab=path-to-some-directory</code>
<DD>
Для каждой заданной таблицы создает файл a <tt>`table_name.sql'</tt>, содержащий
SQL <code>CREATE</code> команды для создания таблицы, и файл <tt>`table_name.txt'</tt> с данными
таблицы. Файл <tt>`.txt'</tt> имеет формат в соответствии с параметрами <code>--fields-xxx</code> 
и <code>--lines--xxx</code>. <strong>Примечание</strong>: Этот параметр работает только при условии,
что утилита <code>mysqldump</code> запущена на том же компьютере, что и демон <code>mysqld</code>,
причем пользователь/группа, запустившие данный поток <code>mysqld</code> (обычно это
пользователь <code>mysql</code> и группа <code>mysql</code>), должны иметь право
создавать/записывать файл по указанному адресу.

<DT><code>-u user_name, --user=user_name</code>
<DD>
Имя пользователя MySQL-сервера, используемое при подключении к серверу.
Значением по умолчанию является имя пользователя Unix.

<DT><code>-O var=option, --set-variable var=option</code>
<DD>
Установить значения переменных. Доступные для использования переменные
перечислены ниже. В MySQL 4.0 просто используйте <code>--var=option</code>. 

<DT><code>-v, --verbose</code>
<DD>
Расширенный режим вывода. Вывод более детальной информации о работе
программы.

<DT><code>-V, --version</code>
<DD>
Вывести информацию о версии и выйти из программы.

<DT><code>-w, --where='where-condition'</code>
<DD>
Выполнить дамп только выбранных записей. Обратите внимание, что кавычки
обязательны.


<pre>
"--where=user='jimf'" "-wuserid&#62;1" "-wuserid&#60;1"
</pre>

<DT><code>-X, --xml</code>
<DD>
Представляет дамп базы данных в виде XML.

<DT><code>-x, --first-slave</code>
<DD>
Блокирует все таблицы во всех базах данных.

<DT><code>-O net_buffer_length=#, where # &#60; 16M</code>
<DD>
При создании многострочных операторов ввода (как и в случаях применения
параметров <code>--extended-insert</code> или <code>--opt</code>) утилита <code>mysqldump</code> будет создавать
строки длиной вплоть до указанной в <code>net_buffer_length</code>. При увеличении
значения этой переменной необходимо также убедиться в том, что в
MySQL-сервере для переменной <code>max_allowed_packet</code> указано значение больше,
чем величина <code>net_buffer_length</code>.
</DL>

<P>
Чаще всего утилита <code>mysqldump</code> используется для получения резервной копии
всех баз данных. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Backup">4.4.1  Резервное копирование баз данных</A>.

</P>

<pre>
mysqldump --opt database &#62; backup-file.sql
</pre>

<P>
Можно, наоборот, прочитать этот файл на MySQL-сервере посредством команды:

</P>

<pre>
mysql database &#60; backup-file.sql
</pre>

<P>
или

<pre>
mysql -e "source /patch-to-backup/backup-file.sql" database
</pre>

<P>
Данная утилита достаточно часто используется и для переноса информации из
базы данных на другой MySQL-сервер:

</P>

<pre>
mysqldump --opt database | mysql --host=remote-host -C database
</pre>

<P>
Вполне возможно получить дамп нескольких баз данных с помощью одной
команды:

</P>

<pre>
mysqldump --databases database1 [database2 ...] &#62; my_databases.sql
</pre>

<P>
Если необходим дамп всех баз данных, можно использовать:

</P>

<pre>
mysqldump --all-databases &#62; all_databases.sql
</pre>



<H3><A NAME="mysqlhotcopy" HREF="manual.ru_toc.html#mysqlhotcopy">4.8.6  <code>mysqlhotcopy</code>, Копирование баз данных и таблиц MySQL</A></H3>

<P>
<A NAME="IDX793"></A>
<A NAME="IDX794"></A>
<A NAME="IDX795"></A>
<A NAME="IDX796"></A>

</P>
<P>
Утилита <code>mysqlhotcopy</code> представляет собой Perl-сценарий, использующий
SQL-команды <code>LOCK TABLES</code>, <code>FLUSH TABLES</code> и Unix-утилиты <code>cp</code> или <code>scp</code> для
быстрого получения резервной копии базы данных. Пожалуй, это наиболее
быстрый способ копирования баз данных или таблиц, но он
может работать только на том же компьютере, где расположены каталоги
копируемой базы данных.

</P>

<pre>
mysqlhotcopy db_name [/path/to/new_directory]
mysqlhotcopy db_name_1 ... db_name_n /path/to/new_directory
mysqlhotcopy db_name./regex/
</pre>

<P>
Утилита <code>mysqlhotcopy</code> поддерживает следующие опции:

</P>
<DL COMPACT>

<DT><code>-?, --help</code>
<DD>
Показать окно справки и выйти из программы.

<DT><code>-u, --user=#</code>
<DD>
Имя пользователя для входа в базу данных.

<DT><code>-p, --password=#</code>
<DD>
Используемый пароль при подсоединении к серверу.

<DT><code>-P, --port=#</code>
<DD>
Номер порта, используемого для подсоединения к локальному серверу.

<DT><code>-S, --socket=#</code>
<DD>
Номер сокета, используемого для подсоединения к локальному серверу.

<DT><code>--allowold</code>
<DD>
Не делать прерывания, если объект уже существует (переименовать в it_old).

<DT><code>--keepold</code>
<DD>
Не удалять предыдущий результат (только что переименованный) после
выполнения команды.

<DT><code>--noindices</code>
<DD>
Не включать обширные индексные файлы в копию, чтобы сделать дубликат
меньше по размеру и более быстрым. Индексы можно реконструировать позже с
помощью команды <code>myisamchk -rq</code>.

<DT><code>--method=#</code>
<DD>
Метод копирования (<code>cp</code> или <code>scp</code>).

<DT><code>-q, --quiet</code>
<DD>
Выводить только сообщения об ошибках.

<DT><code>--debug</code>
<DD>
Разрешить отладку.

<DT><code>-n, --dryrun</code>
<DD>
Сообщать о действиях без их выполнения.

<DT><code>--regexp=#</code>
<DD>
Копировать все базы данных с именами, встречающимися в функции regexp.

<DT><code>--suffix=#</code>
<DD>
Суффикс для имен скопированных баз данных.

<DT><code>--checkpoint=#</code>
<DD>
Внести проверочную запись в предусмотренную таблицу базы данных.

<DT><code>--flushlog</code>
<DD>
Записать на диск данные журналов из буфера, как только все таблицы
заблокируются.

<DT><code>--tmpdir=#</code>
<DD>
Временная директория (вместо <tt>`/tmp'</tt>).
</DL>

<P>
Более полное описание данного сценария можно посмотреть в документации по
языку программирования Perl.

</P>
<P>
Сценарий <code>mysqlhotcopy</code> берет информацию для групп <code>[client]</code> и <code>[mysqlhotcopy]</code> 
из файлов опций.

</P>
<P>
Для выполнения программы <code>mysqlhotcopy</code> необходимы доступ для записи в
директорию, куда будет помещена копия, и привилегия выполнения команды
<code>SELECT</code> для копируемых таблиц и команды <code>RELOAD</code> для MySQL-сервера (чтобы
выполнить <code>FLUSH TABLES</code>).

</P>


<H3><A NAME="mysqlimport" HREF="manual.ru_toc.html#mysqlimport">4.8.7  <code>mysqlimport</code>, импорт данных из текстовых файлов</A></H3>

<P>
<A NAME="IDX797"></A>
<A NAME="IDX798"></A>
<A NAME="IDX799"></A>
<A NAME="IDX800"></A>
<A NAME="IDX801"></A>

</P>
<P>
Утилита <code>mysqlimport</code> обеспечивает интерфейс командной строки для
SQL-оператора <code>LOAD DATA INFILE</code>. Большинство параметров <code>mysqlimport</code>
полностью соответствует аналогичным параметрам для оператора <code>LOAD DATA
INFILE</code>. See section <A HREF="manual.ru_Reference.html#LOAD_DATA">6.4.9  Синтаксис оператора  <code>LOAD DATA INFILE</code></A>.

</P>
<P>
Утилита <code>mysqlimport</code> вызывается следующим образом:

</P>

<pre>
shell&#62; mysqlimport [параметры] database textfile1 [textfile2 ...]
</pre>

<P>
Для каждого текстового файла, указанного в командной строке, <code>mysqlimport</code>
удаляет расширение в каждом имени файла и использует его, чтобы
определить, в какую таблицу занести содержимое. Например, файлы с именами
<tt>`patient.txt'</tt>, <tt>`patient.text'</tt> и <tt>`patient'</tt> должны быть все занесены в таблицу с
именем <tt>`patient'</tt>.

</P>
<P>
Утилита <code>mysqlimport</code> поддерживает следующие опции:

</P>
<DL COMPACT>

<DT><code>-c, --columns=...</code>
<DD>
Эта опция принимает в качестве аргумента список разделенных запятыми имен
полей. Данный список полей используется для создания соответствующей
команды <code>LOAD DATA INFILE</code>, которая затем посылается в MySQL. 
See section <A HREF="manual.ru_Reference.html#LOAD_DATA">6.4.9  Синтаксис оператора  <code>LOAD DATA INFILE</code></A>.

<DT><code>-C, --compress</code>
<DD>
Использовать компрессию в связи между клиентом и сервером, если они оба
поддерживают сжатие.

<DT><code>-#, --debug[=option_string]</code>
<DD>
Отслеживать прохождение программы (для отладки).

<DT><code>-d, --delete</code>
<DD>
Удалить данные из таблицы перед импортированием текстового файла.

<DT><code>--fields-terminated-by=...</code>
<DD>
<DT><code>--fields-enclosed-by=...</code>
<DD>
<DT><code>--fields-optionally-enclosed-by=...</code>
<DD>
<DT><code>--fields-escaped-by=...</code>
<DD>
<DT><code>--lines-terminated-by=...</code>
<DD>
Эти опции аналогичны соответствующим операторам для <code>LOAD DATA INFILE</code>.
See section <A HREF="manual.ru_Reference.html#LOAD_DATA">6.4.9  Синтаксис оператора  <code>LOAD DATA INFILE</code></A>.

<DT><code>-f, --force</code>
<DD>
Игнорировать ошибки. Например, если таблица для текстового файла не
существует, продолжать обработку остающихся файлов. Без параметра <code>--force</code> 
утилита <code>mysqlimport</code> прекращает работу при отсутствии таблицы.

<DT><code>--help</code>
<DD>
Вывести справочную информацию и выйти из программы.

<DT><code>-h host_name, --host=host_name</code>
<DD>
Импортировать данные в MySQL-сервер на указанном хосте. Значение хоста по
умолчанию - <code>localhost</code>.

<DT><code>-i, --ignore</code>
<DD>
См. описание для параметра <code>--replace</code>.

<DT><code>-l, --lock-tables</code>
<DD>
Заблокировать все таблицы для записи перед обработкой любых текстовых
файлов. Это обеспечивает синхронизацию всех таблиц на сервере.

<DT><code>-L, --local</code>
<DD>
Читать входящие файлы из клиента. По умолчанию предполагается, что
текстовые файлы расположены на сервере при подсоединении к <code>localhost</code>
(значение хоста по умолчанию).

<DT><code>-pyour_pass, --password[=your_pass]</code>
<DD>
Используемый пароль при подключении к серверу. Если аргумент <code>=your_pass</code> не
введен, <code>mysqlimport</code> предложит ввести пароль.

<DT><code>-P port_num, --port=port_num</code>
<DD>
Номер порта TCP/IP, используемого для подсоединения к хосту.

<DT><code><code>--protocol=(TCP | SOCKET | PIPE | MEMORY)</code></code>
<DD>
Для указания протокола соединения, который надлежит использовать. 
Новшество в  MySQL 4.1.0. 

<DT><code>-r, --replace</code>
<DD>
Опции <code>--replace</code> и <code>--ignore</code> управляют обработкой поступающих на вход
записей, которые дублируют имеющиеся записи по значениям уникальных
ключей. Если задано значение <code>--replace</code>, новые строки заменяют существующие
с тем же самым значением уникального ключа. Если задано значение <code>--ignore</code>,
входные строки, которые дублируют существующую строку по значению
уникального ключа, пропускаются. Если же ни одна из опций не задана, то
при обнаружении ключа-дубликата возникает ошибка и остаток текстового
файла игнорируется.

<DT><code>-s, --silent</code>
<DD>
Режим молчания. Выводить только сообщения об ошибках.

<DT><code>-S /path/to/socket, --socket=/path/to/socket</code>
<DD>
Файл сокета для подсоединения к <code>localhost</code> (значение хоста по умолчанию).

<DT><code>-u user_name, --user=user_name</code>
<DD>
Имя пользователя MySQL-сервера, используемое при подсоединении к серверу.
Значением по умолчанию является имя для входа в Unix.

<DT><code>-v, --verbose</code>
<DD>
Расширенный режим вывода. Вывод более детальной информации о работе
программы.

<DT><code>-V, --version</code>
<DD>
Вывести информацию о версии и выйти из программы.
</DL>

<P>
Ниже приведен пример листинга программы, использующей утилиту <code>mysqlimport</code>:

</P>

<pre>
$ mysql --version
mysql  Ver 9.33 Distrib 3.22.25, for pc-linux-gnu (i686)
$ uname -a
Linux xxx.com 2.2.5-15 #1 Mon Apr 19 22:21:09 EDT 1999 i586 unknown
$ mysql -e 'CREATE TABLE imptest(id INT, n VARCHAR(30))' test
$ ed
a
100     Max Sydow
101     Count Dracula
.
w imptest.txt
32
q
$ od -c imptest.txt
0000000   1   0   0  \t   M   a   x       S   y   d   o   w  \n   1   0
0000020   1  \t   C   o   u   n   t       D   r   a   c   u   l   a  \n
0000040
$ mysqlimport --local test imptest.txt
test.imptest: Records: 2  Deleted: 0  Skipped: 0  Warnings: 0
$ mysql -e 'SELECT * FROM imptest' test
+------+---------------+
| id   | n             |
+------+---------------+
|  100 | Max Sydow     |
|  101 | Count Dracula |
+------+---------------+
</pre>



<H3><A NAME="mysqlshow" HREF="manual.ru_toc.html#mysqlshow">4.8.8  <code>mysqlshow</code>, просмотр баз данных, таблиц и столбцов</A></H3>

<P>
<A NAME="IDX802"></A>
<A NAME="IDX803"></A>
<A NAME="IDX804"></A>
<A NAME="IDX805"></A>
<A NAME="IDX806"></A>

</P>
<P>
Утилита <code>mysqlshow</code> позволяет кратко ознакомиться с существующими базами
данных, их таблицами и столбцами таблиц.

</P>
<P>
Аналогичную информацию можно получить с помощью программы <code>mysql</code>, используя
команду <code>SHOW</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#SHOW">4.5.6  Синтаксис команды <code>SHOW</code></A>.

</P>
<P>
Утилита <code>mysqlshow</code> вызывается следующим образом:

</P>

<pre>
shell&#62; mysqlshow [ПАРАМЕТРЫ] [database [table [column]]]
</pre>


<ul>
<LI>

Если имя базы данных не указано, то выдается список всех существующих
баз данных.

<LI>

Если не указана таблица - показываются все таблицы, найденные в этой
базе данных

<LI>

Если не задан столбец - показываются все найденные в таблице столбцы и
представленные в виде столбцов данные.
</ul>

<P>
Следует отметить, что в более новых версиях MySQL пользователь может
просмотреть только те базы/таблицы/столбцы, для которых у него имеются
соответствующие привилегии.

</P>
<P>
Если последний аргумент содержит в себе шаблонные символы (<code>*</code>, <code>?</code>,
<code>%</code> или <code>_</code>) процессора или SQL, то будут представлены только данные,
совпадающие с шаблоном.  Если имя базы данных содержит подчеркивание, то оно должно быть 
экранировано обратным слешом (некоторые оболочки в Unix востребуют два обратных
слеша) для того, чтобы получить корректные имена. <samp>`*'</samp> корвертируются в
<samp>`%'</samp> и <samp>`?'</samp> - в <samp>`_'</samp>.

</P>
<P>
Это может вызвать путаницу при попытке просмотреть
столбцы таблицы с символом <code>_</code>, так как в таком случае <code>mysqlshow</code>
покажет только имена таблиц, совпадающие с шаблоном. Ситуацию можно легко
исправить добавлением дополнительного символа <code>%</code> в конец командной строки
(как отдельного аргумента).

</P>


<H3><A NAME="mysql_config" HREF="manual.ru_toc.html#mysql_config">4.8.9  <code>mysql_config</code>, Получение опций компиляции для компиляции клиентских программ</A></H3>

<P>
<code>mysql_config</code> дает полезную информацию о том, как 
компилировать ваши клиентские программы. 

</P>
<P>
<code>mysql_config</code> поддерживает такие опции:

</P>
<DL COMPACT>

<DT><code>--cflags</code>
<DD>
Опции компилятора для поиска включаемых файлов
<DT><code>--libs</code>
<DD>
Библиотеки и опции, необходимые для линкования с клиентской библиотекой.
<DT><code>--socket</code>
<DD>
Имя сокета по умолчанию, определенное, когда конфигурировался MySQL.
<DT><code>--port</code>
<DD>
Номер порта по умолчанию, определенный, когда конфигурировался MySQL.
<DT><code>--version</code>
<DD>
Номер версии и версия для поставки MySQL.
<DT><code>--libmysqld-libs</code>
<DD>
Библиотеки и опции, необходимые для линкования с библиотекой встраиваемого сервера.
</DL>

<P>
Если вы выполняете <code>mysql_config</code> без каких-либо параметров, вы получите
все опции, которые он поддерживает плюс значение этих опций: 

</P>

<pre>
shell&#62; mysql_config
sage: /usr/local/mysql/bin/mysql_config [OPTIONS]
Options:
        --cflags         [-I'/usr/local/mysql/include/mysql']
        --libs           [-L'/usr/local/mysql/lib/mysql' -lmysqlclient -lz -lcrypt -lnsl -lm -L/usr/lib -lssl -lcrypto]
        --socket         [/tmp/mysql.sock]
        --port           [3306]
        --version        [4.0.8-gamma]
        --libmysqld-libs [ -L'/usr/local/mysql/lib/mysql' -lmysqld -lpthread -lz -lcrypt -lnsl -lm  -lpthread  -lrt]
</pre>

<P>
Вы можете это использовать, чтобы скопмилировать клиента MySQL таким образом: 

</P>

<pre>
CFG=/usr/local/mysql/bin/mysql_config
sh -c "gcc -o progname `$CFG --cflags` progname.c `$CFG --libs`"
</pre>



<H3><A NAME="perror" HREF="manual.ru_toc.html#perror">4.8.10  <code>perror</code>, разъяснение кодов ошибок</A></H3>

<P>
<A NAME="IDX807"></A>
<A NAME="IDX808"></A>

</P>
<P>
<A NAME="IDX809"></A>
<A NAME="IDX810"></A>

</P>
<P>
Для большинства системных ошибок, помимо внутреннего текстового сообщения
MySQL, можно также выводить номер кода системной ошибки в одном из
следующих стилей: <code>message ... (errno: #)</code> или <code>message ... (Errcode: #)</code>.

</P>
<P>
Выяснить, что данный код ошибки означает, можно либо путем изучения
документации на данную систему, либо воспользовавшись возможностями
утилиты <code>perror</code>.

</P>
<P>
perror выводит описание кода системной ошибки или код ошибки обработчика
таблиц <code>MyISAM</code>/<code>ISAM</code>.

</P>
<P>
<code>perror</code> вызывается следующим образом:

</P>

<pre>
shell&#62; perror [ПАРАМЕТРЫ] [ERRORCODE [ERRORCODE...]]
</pre>

<P>
Пример:

</P>

<pre>
shell&#62; perror 13 64
Error code 13: Доступ запрещен
Error code 64: Компьютер не находится в сети
</pre>

<P>
Следует учитывать, что сообщения об ошибках в большинстве своем являются
системно-зависимыми!

</P>


<H3><A NAME="Batch_Commands" HREF="manual.ru_toc.html#Batch_Commands">4.8.11  Как запускать SQL-команды из текстового файла</A></H3>

<P>
Обычно клиент <code>mysql</code> используется в интерактивном режиме, например,
следующим образом:

</P>

<pre>
shell&#62; mysql database
</pre>

<P>
Однако вполне можно поместить SQL команды в текстовый файл и указать <code>mysql</code>
считывать входные данные из этого файла. Для этого необходимо создать
текстовый файл <code>text_file</code>, содержащий команды, которые предстоит выполнить.
Затем запускаем <code>mysql</code> как показано ниже:

</P>

<pre>
shell&#62; mysql database &#60; text_file
</pre>

<P>
Можно также запустить текстовый файл с командой <code>USE db_name</code>. В этом случае
указывать имя базы данных в командной строке не обязательно:

</P>

<pre>
shell&#62; mysql &#60; text_file
</pre>

<P>
Если программ<code>а</code> mysql уже работает, можно запустить файл с SQL-сценарием,
используя команду <code>source</code>:

</P>

<pre>
mysql&#62; source filename;
</pre>

<P>
Более подробная информация по пакетному режиму работы находится в разделе
See section <A HREF="manual.ru_Tutorial.html#Batch_mode">3.6  Использование <code>mysql</code> в пакетном режиме</A>.

</P>


<H2><A NAME="Log_Files" HREF="manual.ru_toc.html#Log_Files">4.9  Файлы журналов MySQL</A></H2>

<P>
<A NAME="IDX811"></A>

</P>
<P>
В MySQL имеется несколько журналов, позволяющих узнать, что происходит
внутри <code>mysqld</code>:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Журнал</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD>Журнал ошибок </TD><TD> В нем хранятся ошибки запуска, работы или завершения работы <code>mysqld</code>.
</TD></TR>
<TR><TD>Журнал isam </TD><TD> В нем хранится информация обо всех изменениях таблиц <code>ISAM</code>. Используется только при отладке кода isam.
</TD></TR>
<TR><TD>Общий журнал запросов </TD><TD> В нем хранится информация об установленных соединениях и выполненных запросах.
</TD></TR>
<TR><TD>Журнал обновлений log </TD><TD> В нем хранятся все команды, меняющие данные; в скором времени выйдет из употребления
</TD></TR>
<TR><TD>Бинарный журнал обновлений </TD><TD> В нем хранятся все меняющие что-либо команды. Используется для репликации
</TD></TR>
<TR><TD>Журнал медленных запросов </TD><TD> В нем хранятся все запросы, на выполнение которых ушло больше времени, чем указано в переменной <code>long_query_time</code> (или запросы, не использовавшие индексов).
</TD></TR>
</TABLE>

<P>
Все файлы журналов хранятся в каталоге с данными <code>mysqld</code>. С помощью команды
<code>FLUSH LOGS</code> можно заставить <code>mysqld</code> открыть файлы журналов снова (или - в
некоторых случаях - переключиться на новый файл). See section <A HREF="manual.ru_MySQL_Database_Administration.html#FLUSH">4.5.3  Синтаксис команды <code>FLUSH</code></A>.

</P>



<H3><A NAME="Error_log" HREF="manual.ru_toc.html#Error_log">4.9.1  Журнал ошибок</A></H3>

<P>
Журнал ошибок содержит информацию о том, когда запускается и останавливается mysqld, 
а также все критические ошибки, обнаруженные в процессе работы. 

</P>
<P>
В нем содержится информация о запуске и завершении работы <code>mysqld</code>, а также
обо всех серьезных ошибках, возникших во время работы. Если произойдет
неожиданное аварийное завершение работы, и <code>safe_mysqld</code> придется
перезапустить <code>mysqld</code>, <code>safe_mysqld</code> внесет в этот файл соответствующую
запись. Кроме того, в этот журнал заносится предупреждение в том случае,
если <code>mysqld</code> обнаружит таблицу, нуждающуюся в автоматической проверке или
исправлении.

</P>
<P>
Все ошибки <code>mysqld</code> записывает в <code>stderr</code>, который сценарий <code>safe_mysqld</code>
перенаправляет в файл с именем <code>'hostname'.err</code> (в Windows <code>mysqld</code> сохраняет
его в каталоге <tt>`\mysql\data\mysql.err'</tt>).

</P>

<P>
В некоторых ОС в журнал включается распечатка части стека погибшего
<code>mysqld</code>. С помощью этой информации можно определить причину сбоя (see section <A HREF="manual.ru_Porting.html#Using_stack_trace">E.1.4  Использование трассировки стека</A>).

</P>
<P>
Начиная с MySQL 4.0.10 можно указать, где именно mysqld должен сохранять журнал
ошибок, с помощью опции <code>--log-error[=filename]</code>. Если имя файла не задается,
то тогда mysqld будет использовать <code>mysql-data-dir/'hostname'.err</code> на Unix
и <tt>`\mysql\data\mysql.err'</tt> на windows.

</P>
<P>
Если вы выполняете <code>FLUSH LOGS</code> старый файл будет сохранен с префиксом
<code>--old</code> и <code>mysqld</code> создаст новый пустой журнал.

</P>
<P>
На старых версиях MySQL журнал ошибок велся скриптом mysqld_safe, который перенаправлял вывод в
файл <code>'hostname'.err</code>.  В старых версиях можно было изменить имя этого файла опцией
<code>--err-log=filename</code>.

</P>
<P>
Если вы не указываете <code>--log-error</code> или используете  опцию <code>--console</code>,
то ошибки будут выводиться на stderr (на терминал). 

</P>
<P>
На Windows вывод всегда пишется в <code>.err</code>-файл если <code>--console</code> не была указана. 

</P>


<H3><A NAME="Query_log" HREF="manual.ru_toc.html#Query_log">4.9.2  Общий журнал запросов</A></H3>

<P>
<A NAME="IDX812"></A>
<A NAME="IDX813"></A>

</P>
<P>
Если вы хотите знать обо всем, что происходит с <code>mysqld</code>, нужно запустить
систему с ключом <code>--log[=file]</code>. После этого информация обо всех соединениях
и запросах будет записываться в файл журнала (по умолчанию ему дается имя
<code>'hostname'.log</code>). Этот журнал может оказаться полезным, если вы
подозреваете наличие ошибки в клиентском ПО и хотите выяснить, что, по
мнению <code>mysqld</code>, клиент передал базе.

</P>
<P>
Старые версии скрипта <code>mysql.server</code> (с MySQL 3.23.4 по 3.23.8)
передавали <code>safe_mysqld</code> опцию <code>--log</code> (включить общий журнал запросов).
Если вам нужна большая производительность при запуске MySQL в промышленной эксплуатации, 
вы можете удалить опцию <code>--log</code> из <code>mysql.server</code> или поменять ее на
<code>--log-bin</code>. See section <A HREF="manual.ru_MySQL_Database_Administration.html#Binary_log">4.9.4  Бинарный журнал обновлений</A>.

</P>
<P>
Записи в журнал заносятся по мере получения <code>mysqld</code> запросов. Порядок их
занесения может отличаться от порядка выполнения команд. В этом и
заключается основное отличие данного журнала от журналов обновлений и
бинарных журналов, в которые информация заносится по мере выполнения
запросов, но до отмены блокировок.

</P>


<H3><A NAME="Update_log" HREF="manual.ru_toc.html#Update_log">4.9.3  Журнал обновлений (update)</A></H3>

<P>
<A NAME="IDX814"></A>
<A NAME="IDX815"></A>

</P>
<P>
<strong>Обратите внимание</strong>: журнал обновлений (update) заменен бинарным журналом
(binary) (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Binary_log">4.9.4  Бинарный журнал обновлений</A>. С этим журналом можно
производить те же операции, что и с журналом обновлений.

</P>
<P>
При запуске с ключом <code>--log-update[=file_name]</code> <code>mysqld</code> создает журнал, в
который заносятся все команды SQL, обновляющие данные. Если имя файла не
задано, по умолчанию ему присваивается имя хоста. Если файлу присвоено
имя, не содержащее пути доступа к нему, этот файл сохраняется в каталоге с
данными. Если у имени <tt>`file_name'</tt> нет расширения, <code>mysqld</code> даст файлу примерно
такое имя: <tt>`file_name.###'</tt>, где <code>###</code> - номер, увеличивающийся при каждом
выполнении команд <code>mysqladmin refresh</code>, <code>mysqladmin flush-logs</code>, <code>FLUSH LOGS</code> 
или при перезапуске сервера.

</P>
<P>
<strong>Обратите внимание</strong>: чтобы вышеописанная схема могла работать, нельзя
самостоятельно создавать файлы с тем же именем, что и у журнала
обновлений, а также с некоторыми расширениями, которые могут быть
восприняты как номер, в каталоге, использующемся для хранения этого
журнала!

</P>
<P>
При запуске с ключами <code>--log</code> или <code>-l</code> <code>mysqld</code> создает общий журнал в файле с
именем <tt>`hostname.log'</tt>, причем перезапуски и обновления не приводят к
созданию нового файла журнала (хотя существующий при таких операциях
закрывается и затем открывается вновь). В таком случае скопировать его (в
Unix) можно так:

</P>

<pre>
mv hostname.log hostname-old.log
mysqladmin flush-logs
cp hostname-old.log to-backup-directory
rm hostname-old.log
</pre>

<P>
Журнал обновлений работает избирательно - в него попадают только те
команды, которые действительно обновляют данные. Команда <code>UPDATE</code> или
<code>DELETE</code>, выражение <code>WHERE</code> которой не находит совпадающих строк, в журнал не
заносится - как и команды <code>UPDATE</code>, присваивающие столбцам те же значения,
которые у них были до ``обновления''.

</P>
<P>
Запись в журнал осуществляется сразу по завершении работы запроса, но до
того, как будут сняты блокировки. Таким образом обеспечивается уверенность
в том, что журнал ведется именно в порядке выполнения запросов.

</P>
<P>
При желании обновить базу в соответствии с данными журналов обновлений
можно воспользоваться следующей командой (при условии, что имена файлов
журналов соответствуют форме <tt>`file_name.###'</tt>):

</P>

<pre>
shell&#62; ls -1 -t -r file_name.[0-9]* | xargs cat | mysql
</pre>

<P>
<code>ls</code> расставляет все файлы журналов в правильном порядке.

</P>
<P>
Эта возможность может пригодиться в случае, если возникнет необходимость
(в результате серьезного сбоя) привести базу в соответствие с резервной
копией и затем повторить все обновления, произошедшие с момента создания
копии и до сбоя.

</P>


<H3><A NAME="Binary_log" HREF="manual.ru_toc.html#Binary_log">4.9.4  Бинарный журнал обновлений</A></H3>

<P>
<A NAME="IDX816"></A>
<A NAME="IDX817"></A>

</P>
<P>
Бинарный журнал обновлений в скором времени должен полностью заменить
журнал обновлений, так что мы рекомендуем вам как можно скорее перейти на
его использование!

</P>
<P>
Бинарный журнал содержит всю информацию, имеющуюся в журнале обновлений, в
более эффективном формате. В нем имеется информация и о времени выполнения
каждого обновляющего базу запроса. В нем не содержится информации о запросах,
которые не изменяют данные. Если вам нужно журналировать все запросы (например для
выявления проблемного запроса), вам следует использовать общий журнал запросов. 
See section <A HREF="manual.ru_MySQL_Database_Administration.html#Query_log">4.9.2  Общий журнал запросов</A>.

</P>
<P>
Бинарный журнал используется и при репликации подчиненного сервера (slave)
с головного (master) (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Replication">4.10  Репликация в MySQL</A>).

</P>
<P>
При запуске с ключом <code>--log-bin[=file_name]</code> <code>mysqld</code> создает файл журнала, в
который вносятся данные обо всех обновляющих данные командах SQL. Если имя
файла не задано, по умолчанию ему дается имя хоста с окончанием <code>-bin</code>. Если
файлу присвоено имя, не содержащее пути доступа к нему, этот файл
сохраняется в каталоге данных.

</P>
<P>
При вводе расширения в имя файла (например: <code>--log-bin=filename.extension</code>)
это расширение удаляется без предупреждения.

</P>
<P>
К имени файла бинарного журнала программа <code>mysqld</code> прибавляет специальное
расширение - номер, увеличивающийся при каждом выполнении команд
<code>mysqladmin refresh</code>, <code>mysqladmin flush-logs</code>, <code>FLUSH LOGS</code> или перезапуске
сервера. При достижении файлом журнала максимального размера, заданного в
параметре <code>max_binlog_size</code>, автоматически создается новый. Все неактивные
файлы бинарных журналов можно удалить командой <code>RESET MASTER</code> (see section <A HREF="manual.ru_MySQL_Database_Administration.html#RESET">4.5.4  Синтаксис команды <code>RESET</code></A>.

</P>
<P>
На выбор данных, записываемых в журнал, влияют следующие настройки <code>mysqld</code>:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Опция</strong> </TD><TD> <strong>Описание</strong>

</TD></TR>
<TR><TD><code>binlog-do-db=database_name</code> </TD><TD>
Указывает головному серверу что он должен журналировать обновления в двоичный журнал
если текущая (т.е. выбранная) база данных - это 'database_name'. Остальные базы данных,
особо не отмеченные, игнорируются. Имейте в виду, что если вы используете эту опцию, то 
вам следует делать обновления только в этой базе данных. 
(пример: binlog-do-db=some_database) 

</TD></TR>
<TR><TD><code>binlog-ignore-db=database_name</code> </TD><TD>
Заставляет master отказаться от занесения в журнал обновлений определенной базы данных (пример: <code>binlog-ignore-db=some_database</code>)
</TD></TR>
</TABLE>

<P>
Чтобы была возможность определить, какие файлы журналов используются в
данный момент, <code>mysqld</code> создает и индексный файл, содержащий имена всех
находящихся в работе файлов. По умолчанию ему присваивается то же имя, что
и файлу журнала, но с расширением .index. Имя этого файла можно изменить с
помощью параметра <code>--log-bin-index=[filename]</code>.

</P>
<P>
При использовании репликации удалять старые файлы журналов не стоит до тех
пор, пока вы не будете уверены в том, что они никогда не понадобятся ни
одной зависимой базе. Добиться такого результата можно, запуская команду
<code>mysqladmin flush-logs</code> раз в день и затем удаляя все журналы, созданные
более 3 дней назад.

</P>
<P>
Работать с файлами бинарного журнала можно с помощью программы
<code>mysqlbinlog</code>. Обновить MySQL в соответствии с записями в журнале можно так:

</P>
<P>
<A NAME="IDX818"></A>

</P>

<pre>
shell&#62; mysqlbinlog log-file | mysql -h server_name
</pre>

<P>
С помощью программы <code>mysqlbinlog</code> можно даже считывать файлы журнала прямо с
удаленного сервера MySQL!

</P>
<P>
При запуске <code>mysqlbinlog</code> с ключом <code>--help</code> на экран выводится дополнительная
информация по работе с этой программой.

</P>
<P>
При работе с настройками <code>BEGIN [WORK]</code> или <code>SET AUTOCOMMIT=0</code> для резервного
копирования нужно использовать бинарный журнал, а не старый журнал
обновлений.

</P>
<P>
Занесение данных в бинарный журнал происходит сразу по завершении
исполнения запроса, но до снятия блокировок. Таким образом обеспечивается
уверенность в том, что журнал ведется именно в порядке выполнения
запросов.

</P>
<P>
Updates to non-transactional tables are stored in the binary log
immediately after execution.  

</P>
<P>
Обновления нетранзакционных таблиц сохраняются в двоичном журнале немедленно после выполнения. 
Все обновления (<code>UPDATE</code>, <code>DELETE</code> или <code>INSERT</code>), изменяющие данные в транзакционных
таблицах (например, BDB-таблицу) находятся в кэше до вызова <code>COMMIT</code>. В этот момент <code>mysqld</code> пишет
всю транзакцию целиком в двоичный журнал перед тем, как выполнить <code>COMMIT</code>. 
Каждый поток при запуске будет создавать буффер размером <code>binlog_cache_size</code> для буферизации запросов. 
Если запрос превышает этот размер, тогда поток откроет временный файл для сохранения транзакции. Временный 
файл будет удален при выходе потока.

</P>

<P>
При
запуске каждого потока создается буфер запросов, объем которого
соответствует значению параметра <code>binlog_cache_size</code>. Если запрос не
помещается в буфере, поток создаст временный файл для кэша. Временный файл
удаляется по завершении работы потока.

</P>
<P>
Параметр <code>max_binlog_cache_size</code> (по умолчанию 4Гб) позволяет ограничить
общий объем памяти, используемой для кэширования мультитранзакционного запроса.
Если транзакция больше этого - будет произведен откат. 

</P>
<P>
При использовании журнала обновлений или бинарного журнала параллельные
операции вставки будут преобразованы в нормальные операции вставки в командах <code>CREATE
... SELECT</code> и <code>INSERT ... SELECT</code>. Это сделано специально - для того, чтобы
обеспечить возможность создания точной копии таблиц путем объединения
резервной копии с журналом.

</P>


<H3><A NAME="Slow_query_log" HREF="manual.ru_toc.html#Slow_query_log">4.9.5  Журнал медленных запросов</A></H3>

<P>
<A NAME="IDX819"></A>
<A NAME="IDX820"></A>

</P>
<P>
При запуске с параметром <code>--log-slow-queries[=file_name]</code> <code>mysqld</code> создает
файл журнала, в котором сохраняются данные обо всех командах SQL, на
выполнение которых ушло больше времени, чем указано в значении параметра
<code>long_query_time</code>. Время, уходящее на первоначальную блокировку таблиц, не
включается во время исполнения запроса.

</P>
<P>
Занесение данных в журнал происходит сразу по завершении исполнения
запроса и снятия блокировок. Таким образом, порядок расположения записей
может отличаться от порядка выполнения запросов.

</P>
<P>
Если имя файла не задано, по умолчанию ему дается имя хоста с окончанием
<code>-slow.log</code>. Если файлу присвоено имя, не содержащее пути доступа к нему,
этот файл сохраняется в каталоге с данными.

</P>
<P>
Этот журнал позволяет определить запросы, на выполнение которых ушло
слишком много времени, а, значит, и обнаружить основных кандидатов на
оптимизацию. Конечно, при достижении журналом значительного объема эта
задача усложняется. В таком случае журнал можно пропустить через команду
<code>mysqldumpslow</code> и получить краткий отчет о запросах, попавших в список.

</P>
<P>
При использовании ключа <code>--log-long-format</code> на экран выводятся и запросы, не
работающие с индексами (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Command-line_options">4.1.1  Параметры командной строки <code>mysqld</code></A>).

</P>


<H3><A NAME="Log_file_maintenance" HREF="manual.ru_toc.html#Log_file_maintenance">4.9.6  Обслуживание файлов журналов</A></H3>

<P>
<A NAME="IDX821"></A>
<A NAME="IDX822"></A>
<A NAME="IDX823"></A>

</P>
<P>
В MySQL предусмотрено наличие нескольких файлов журналов, позволяющих следить
за всеми аспектами работы системы (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Log_Files">4.9  Файлы журналов MySQL</A>). Правда, иногда
приходится проверять, не занимают ли журналы лишнего места, и удалять ненужные.

</P>
<P>
При работе с журналами MySQL, вам, вероятнее всего, понадобится удалять их
или создавать их резервные копии, и указывать MySQL записывать данные
журналов в новые файлы (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Backup">4.4.1  Резервное копирование баз данных</A>).

</P>
<P>
В системе Linux (<code>Red Hat</code>) для этого можно использовать сценарий
<code>mysql-log-rotate</code>. При установке MySQL с дистрибутива RPM этот сценарий
устанавливается автоматически. Обратите внимание: использовать журнал для
репликации необходимо с максимальной аккуратностью!

</P>
<P>
В других ОС вы можете самостоятельно создать небольшой сценарий для
обработки журналов, запускаемый из <code>cron</code>.

</P>
<P>
Заставить MySQL создать новый файл журнала можно с помощью команды
<code>mysqladmin flush-logs</code> или SQL-команды <code>FLUSH LOGS</code>. При работе с MySQL
версии 3.21 пользоваться можно только командой <code>mysqladmin refresh</code>.

</P>
<P>
Эта команда выполняет следующие действия:

</P>

<ul>
<LI>

Если используется стандартный журнал (<code>--log</code>) или журнал медленных
запросов (<code>--log-slow-queries</code>), файл журнала (<code>mysql.log</code> и
<code>`hostname`-slow.log</code> по умолчанию) закрывается и открывается вновь.
<LI>

Если используется журнал обновлений (<code>--log-update</code>), файл журнала
закрывается, после чего создается новый файл с большим номером.
</ul>

<P>
При использовании одного журнала обновлений нужно очистить журналы и
перенести их старые файлы в резервную копию. При использовании обычной
процедуры ведения журналов для этого нужно выполнить примерно
следующую последовательность команд:

</P>

<pre>
shell&#62; cd mysql-data-directory
shell&#62; mv mysql.log mysql.old
shell&#62; mysqladmin flush-logs
</pre>

<P>
а затем сделать резервную копию файла <code>mysql.old</code> и удалить его.

</P>


<H2><A NAME="Replication" HREF="manual.ru_toc.html#Replication">4.10  Репликация в MySQL</A></H2>

<P>
<A NAME="IDX824"></A>
<A NAME="IDX825"></A>
<A NAME="IDX826"></A>
<A NAME="IDX827"></A>

</P>

<P>
В этом разделе описаны различные функциональные возможности репликации в
MySQL. Он может служить справочником по опциям, используемым при
репликации. Здесь будет описан механизм репликации и показано, как
реализовывать репликации. В конце раздела мы дадим ответы на некоторые
часто задаваемые вопросы, а также описания проблем и способы их решения.

</P>
<P>
Рекомендуем регулярно посещать наш web-сайт по адресу
<a HREF="http://www.mysql.com/">http://www.mysql.com/</a> для ознакомления с обновлениями, произошедшими в
этом разделе. Механизм репликации постоянно улучшается, и руководство
постоянно дополняется самой свежей информацией.

</P>


<H3><A NAME="Replication_Intro" HREF="manual.ru_toc.html#Replication_Intro">4.10.1  Введение</A></H3>

<P>
К числу преимуществ, которые обеспечивает репликация, относится повышение
скорости и надежности. Чтобы обеспечить надежность, можно установить две
системы и при возникновении проблем с головным сервером переключаться на
резервную копию. Для увеличения скорости можно перенаправлять те запросы,
которые не обновляют данные, на сервер с копиями. Разумеется, это даст
эффект лишь в том случае, если запросы, не обновляющие данные,
преобладают, но, как правило, чаще всего так и бывает.

</P>
<P>
MySQL, начиная с версии 3.23.15, поддерживает односторонний внутренний
механизм репликации. Один сервер действует как головной, а другие - как
подчиненные. Обратите внимание: один сервер может играть роль головного в
одной паре и подчиненного - в другой. Головной сервер содержит двоичный
журнал обновлений (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Binary_log">4.9.4  Бинарный журнал обновлений</A>) и индексный файл
двоичных журналов для протоколирования ротации двоичных журналов.
Подчиненный сервер при соединении уведомляет головной о том, в каком
состоянии он находится, начиная от последнего обновления, которое было
успешно опубликовано на подчиненный сервер. После этого подчиненный сервер
принимает обновления, а затем блокируется и ждет, пока головной сервер не
сообщит о новых обновлениях.

</P>
<P>
Обратите внимание: при реплицировании базы данных все обновления этой базы
данных должны производиться через головной сервер!

</P>
<P>
Еще одно преимущество использования механизма репликации заключается в
том, что можно иметь "живую" резервную копию системы, выполняя резервное
копирование не на головном, а на подчиненном сервере (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Backup">4.4.1  Резервное копирование баз данных</A>).

</P>


<H3><A NAME="Replication_Implementation" HREF="manual.ru_toc.html#Replication_Implementation">4.10.2  Как реализована репликация: обзор</A></H3>

<P>
<A NAME="IDX828"></A>
<A NAME="IDX829"></A>

</P>
<P>
Репликация в MySQL основывается на том, что все изменения базы данных
(обновления, удаления и т.д.) протоколируются в двоичном журнале на
сервере (see section <A HREF="manual.ru_MySQL_Database_Administration.html#Binary_log">4.9.4  Бинарный журнал обновлений</A>), а подчиненный сервер читает
сохраненные запросы из двоичного журнала головного сервера и выполняет эти
запросы на своей копии данных.

</P>
<P>
<strong>Очень важно</strong> понимать, что двоичный журнал - это просто запись, начатая с
фиксированного момента времени (с момента, когда вы включаете ведение
записей в двоичном журнале). При установке каждого из подчиненных серверов
нужно будет скопировать с головного сервера все данные, существовавшие на
нем к моменту начала ведения записей в двоичном журнале. Если подчиненный
сервер будет запущен с данными, не соответствующими тем, которые
содержались на головном сервере <strong>к моменту запуска двоичного журнала</strong>, на
подчиненном сервере может произойти сбой.

</P>
<P>
В следующей таблице вы найдете информацию о совместимости головных и подчиненных серверов 
разных версий. С учетом версии 4.0, мы рекомендуем использовать одну и ту же версию
на обеих серверах, подчиненном и головном. 

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD></TD><TD> </TD><TD> <strong>Головной</strong> </TD><TD> <strong>Головной</strong> </TD><TD> <strong>Головной</strong> </TD><TD> <strong>Головной</strong>
</TD></TR>
<TR><TD></TD><TD> </TD><TD> <strong>3.23.33 и новее</strong> </TD><TD> <strong>4.0.0</strong> </TD><TD> <strong>4.0.1</strong> </TD><TD> <strong>4.0.3 и новее</strong>
</TD></TR>
<TR><TD><strong>Подчиненный</strong> </TD><TD> <strong>3.23.33 и новее</strong> </TD><TD> да </TD><TD> нет </TD><TD> нет </TD><TD> нет
</TD></TR>
<TR><TD><strong>Подчиненный</strong> </TD><TD> <strong>4.0.0</strong> </TD><TD> нет </TD><TD> да </TD><TD> нет </TD><TD> нет
</TD></TR>
<TR><TD><strong>Подчиненный</strong> </TD><TD> <strong>4.0.1</strong> </TD><TD> да </TD><TD> нет </TD><TD> да </TD><TD> нет
</TD></TR>
<TR><TD><strong>Подчиненный</strong> </TD><TD> <strong>4.0.3 и новее</strong> </TD><TD> да </TD><TD> нет </TD><TD> нет </TD><TD> да
</TD></TR>
</TABLE>

<P>
<strong>Note</strong>: MySQL 4.0.2 не рекомендован для репликации.

</P>
<P>
Начиная с версии 4.0.0 для записи данных на подчиненный сервер можно
использовать команду <code>LOAD DATA FROM MASTER</code>. 
Учтите, что команда <code>LOAD DATA FROM MASTER</code> в настоящее время работает
только если все таблицы на головном сервере имеют тип <code>MyISAM</code>, и для них
будет установлена глобальная блокировка чтения, чтобы не допустить никаких
записей во время передачи таблиц от головного сервера к подчиненному.
Данное ограничение носит временный характер. Оно обусловлено тем, что мы
еще не реализовали горячее резервное копирование таблиц без блокировок.
Это ограничение мы снимем для следующих ветвей версии 4.0 - как только
будет реализовано горячее резервное копирование, которое позволит команде
<code>LOAD DATA FROM MASTER</code> работать без блокирования обновлений на головном
сервере.

</P>
<P>
Из-за вышеупомянутого ограничения рекомендуется использовать команду <code>LOAD
DATA FROM MASTER</code> только в тех случаях, если набор данных на головном
сервере относительно невелик или если для головного сервера допустима
длительная блокировка чтения. Скорость выполнения команды <code>LOAD DATA FROM
MASTER</code> для разных систем может быть различной, поэтому для грубой оценки
времени выполнения команды можно считать, что для передачи 1 Мб данных
требуется 1 секунда. Это приблизительно соответствует случаю, когда и
головной, и подчиненный серверы эквивалентны Pentium с тактовой частотой
700 МГц и связаны сетью с пропускной способностью 100 Мбит/с, а размер
индексного файла равен примерно половине размера файла данных. Разумеется,
такая прикидка дает лишь грубую приближенную оценку и в случае каждой
конкретной системы потребуются свои допущения.

</P>
<P>
После того как подчиненный сервер будут правильно сконфигурирован и
запущен, он должен легко соединиться с головным сервером и ожидать
обработки обновлений. Если головной сервер завершит работу или подчиненный
сервер потеряет связь с головным, подчиненный сервер будет пытаться
установить соединение каждый раз по истечении интервала времени,
указанного в опции <code>master-connect-retry</code> (в секундах) до тех пор, пока не
установится подсоединение и не продолжится прослушивание обновлений.

</P>
<P>
Каждый подчиненный сервер отслеживает события с момента разрыва. Головной
сервер не имеет никакой информации о том, сколько существует подчиненных
серверов, и какие из них обновлены последними данными в любой момент
времени.

</P>
<P>
В следующем разделе процесс установки головного/подчиненного серверов
рассматривается более подробно.

</P>


<H3><A NAME="Replication_HOWTO" HREF="manual.ru_toc.html#Replication_HOWTO">4.10.3  Как настроить репликацию</A></H3>

<P>
Здесь кратко описано как настроить полную репликацию вашего MySQL-сервера.
Предполагается, что реплицироваться будут все базы данных и репликация
ранее не настраивалась. Для того чтобы выполнить указанные здесь действия,
вам придется на короткое время остановить головной сервер.

</P>
<P>
Это самый простой способ установки подчиненного сервера, однако он не
единственный. Например, если уже имеется образ головного сервера, на
головном сервере уже установлен ID сервера и производятся записи в журнал,
подчиненный сервер можно установить, не останавливая головной сервер и
даже не устанавливая блокировки обновлений (за дополнительной информацией
обращайтесь к разделу See section <A HREF="manual.ru_MySQL_Database_Administration.html#Replication_FAQ">4.10.7  Часто задаваемые вопросы по репликации</A>.

</P>
<P>
Чтобы стать настоящим гуру по репликации в MySQL, советуем сначала
изучить, осмыслить и опробовать все команды, упомянутые в разделе See section <A HREF="manual.ru_MySQL_Database_Administration.html#Replication_SQL">4.10.6  SQL-команды, относящиеся к репликации</A>. Необходимо также ознакомиться с опциями
запуска репликации из файла <tt>`my.cnf'</tt> в разделе See section <A HREF="manual.ru_MySQL_Database_Administration.html#Replication_Options">4.10.5  Опции репликации в файле <tt>`my.cnf'</tt></A>.

</P>

<ol>
<LI>

Удостоверьтесь, что на головном и подчиненном(ых) серверах установлена
свежая версия MySQL. Используйте версию 3.23.29 или выше. В предыдущих
релизах применялся другой формат двоичного журнала и содержались
ошибки, которые были исправлены в более новых релизах. Большая
просьба: пожалуйста, не посылайте сообщения об ошибках, не проверив,
присутствует ли эта ошибка в последнем релизе.

<LI>

Установите на головном сервере отдельного пользователя для репликации
с привилегией <code>FILE</code> (в версиях MySQL ниже 4.0.2) или <code>REPLICATION SLAVE</code> 
в более новых версиях MySQL. У этого пользователя должно быть также
разрешение подсоединяться со всех подчиненных серверов. Если
пользователь будет выполнять только репликацию (рекомендуется), то ему
не нужно предоставлять какие-либо дополнительные привилегии. Например,
чтобы создать пользователя с именем <code>repl</code>, который может иметь доступ к
головному серверу с любого хоста, можно использовать такую команду:


<pre>
mysql&#62; GRANT FILE ON *.* TO repl@"%" IDENTIFIED BY '&#60;password&#62;'; # головной &#60; 4.0.2
</pre>


<pre>
mysql&#62; GRANT REPLICATION SLAVE ON *.* TO repl@"%" IDENTIFIED BY '&#60;password&#62;'; # головной &#62;= 4.0.2
</pre>

Если вы планируете использовать <code>LOAD TABLE FROM MASTER</code> или <code>LOAD
DATA FROM MASTER</code> (доступные с версии 4.0.0), вам также надо выделить
привилегии <code>RELOAD</code> и <code>SUPER</code> на головном сервере для вышеуказанного
пользователя. 

<LI>

Если вы используете MyISAM-таблицы, сохраните содержимое и заблокируйте модифицирующие запросы командой
<code>FLUSH TABLES WITH READ LOCK</code>.


<pre>
mysql&#62; FLUSH TABLES WITH READ LOCK;
</pre>

и после этого - снимите образ данных на вашем головном сервере. 

Легче всего сделать это (на Unix), создав при помощи <strong>tar</strong> архив всей
своей директории данных. Точное местоположение директории данных зависит от
вашей инсталляции.


<pre>
tar -cvf /tmp/mysql-snapshot.tar /path/to/data-dir
</pre>

Пользователи Windows для создания архива каталога данных могут
использовать <code>WinZIP</code> или другую подобную программу.

После того как снимок будет или прямо во время этого процесса, узнайте значения: 
имя текущего двоичного журнала и позицию на головном сервере: 


<pre>
mysql &#62; SHOW MASTER STATUS;
+---------------+----------+--------------+-------------------------------+
| File          | Position | Binlog_do_db | Binlog_ignore_db              |
+---------------+----------+--------------+-------------------------------+
| mysql-bin.003 | 73       | test,bar     | foo,manual,sasha_likes_to_run |
+---------------+----------+--------------+-------------------------------+
1 row in set (0.06 sec)
</pre>

Столбец <code>File</code> дает имя журнала, <code>Position</code> дает информацию о смещении в журнале
(позиции). В этом примере имя журнала - <code>mysql-bin.003</code> и смещение - <code>73</code>.
Запишите эти значения - они вам понадобятся чуть позже, когда будете
настраивать подчиненный сервер. 

Когда вы получили образ и сохранили указанную информацию, вы можете снова разрешить запись в таблицы
на головном сервере: 


<pre>
mysql&#62; UNLOCK TABLES;
</pre>

Если вы используете таблицы InnoDB, то в идеале было бы хорошо, чтобы вы
использовали ПО InnoDB Hot Backup. Она берет целостный снимок без установки
каких-либо блокировок на головном сервере, и сохраняет имя журнала и позицию
непосредственно в снимке, что позволит в дальнейшем использовать эту информацию
на подчиненном сервере.  Более подробная информация об этой программе доступна
на <a HREF="http://www.innodb.com/hotbackup.html">http://www.innodb.com/hotbackup.html</a>.

Без использования этой утилиты, наиболее быстрый способ получить снимок таблиц InnoDB - 
это остановить головной сервер и скопировать файлы данных, журналы, и файлы
определений формата таблицы (<tt>`.frm'</tt>). Для сохранения текущего имени файла
журнала и смещения, вам следует выполнить следующее перед остановкой сервера: 


<pre>
mysql&#62; FLUSH TABLES WITH READ LOCK;
mysql&#62; SHOW MASTER STATUS;
</pre>

И затем сохраните имя журнала и смещение из вывода команды 
<code>SHOW MASTER STATUS</code> так, как было показано выше. После этого 
остановите сервер без снятия блокировок с таблиц. Это нужно сделать именно так,
чтобы быть уверенным, что сервер остановится именно с тем снимком, который мы
сделали: 


<pre>
shell&#62; mysqladmin -uroot shutdown
</pre>

Если головной сервер был ранее запущен без опции <code>log-bin</code>, то значения
имени файла журнала и позиции будут пустыми  в выводе <code>SHOW MASTER
STATUS</code>. В этом случае, сохраните пустую строку ('') как имя файла журнала и
<code>4</code> как позицию. 

<LI>

В <tt>`my.cnf'</tt> на головном сервере добавьте к разделу <code>[mysqld]</code> записи
<code>log-bin</code> и <code>server-id=уникальный номер</code> и перезапустите сервер.
Очень важно, чтобы номер подчиненного сервера отличался от номера головного сервера.
Можно считать, что <code>server-id</code> играет роль IP-адреса - он уникально
идентифицирует сервер среди участников репликации.


<pre>
[mysqld]
log-bin
server-id=1
</pre>

<LI>

Добавьте в my.cnf на подчиненном сервере(ах) следующий фрагмент:


<pre>
server-id=&#60;некоторое уникальное число между 2 и 2^32-1&#62;
</pre>

заменяя значения в &#60;&#62; значениями, соответствующими вашей системе. Значения
<code>server-id</code> должны быть различными на каждом сервере, участвующем в
репликации. Если значение <code>server-id</code> не определено, оно будет установлено в
1, если также не определено значение <code>master-host</code>, оно будет установлено в
2. Обратите внимание, что если значение <code>server-id</code> опущено, то головной
сервер будет отказывать в соединении всем подчиненным серверам, а
подчиненный сервер - отказывать в соединении головному серверу. Таким
образом, опускать установку значения <code>server-id</code> можно лишь в случае
резервного копирования с использованием двоичного журнала.

<LI>

Когда подчиненный сервер будет работать, заставьте его забыть старую конфигурацию репликации, 
если он использовался в репликации раньше: 


<pre>
mysql&#62; RESET SLAVE;
</pre>

<LI>

Скопируйте данные снимка в директорию данных на подчиненном сервере
(ах). Удостоверьтесь в правильности привилегий для файлов и каталогов.
Пользователь, от имени которого запускается MySQL, должен иметь
возможность читать и записывать данные в них так же, как и на головном
сервере.

<LI>

Перезапустите подчиненный(ые) сервер(ы).

<LI>

Когда подчиненные сервера запустятся, выполните:


<pre>
mysql&#62; CHANGE MASTER TO MASTER_HOST='&#60;имя хоста головного сервера&#62;',
 MASTER_USER='&#60;имя пользователя репликации&#62;',
 MASTER_PASSWORD='&#60;пароль репликации&#62;',
 MASTER_LOG_FILE='&#60;записанное вами имя журнала&#62;',
 MASTER_LOG_POS=&#60;записанная вами позиция&#62;;
</pre>

заменяя значения в &#60;&#62; значениями, соответствующими вашей системе.

<LI>

Запустите поток подчиненного сервера: 


<pre>
mysql&#62; SLAVE START;
</pre>

</ol>

<P>
После выполнения указанных действий подчиненный(ые) сервер(ы) должен(ы)
подсоединиться к головному серверу и подгонять свои данные под любые
изменения, произошедшие на головном сервере после принятия образа.

</P>
<P>
Если не установлен идентификатор <code>server</code>-id для подчиненного сервера, в
журнальный файл регистрации ошибок будет внесена следующая ошибка:

</P>

<pre>
Warning: one should set server_id to a non-0 value if master_host is set.
The server will not act as a slave.

(Предупреждение: если задан master_host, следует установить server_id в
ненулевое значение.
Сервер не будет работать как подчиненный сервер.)
</pre>

<P>
Если не установлен идентификатор головного сервера, подчиненные серверы не
смогут подключиться к головному серверу.

</P>
<P>
Если подчиненный сервер по какой-либо причине не может выполнять
репликацию, соответствующие сообщения об ошибках можно найти в журнале
регистрации ошибок на подчиненном сервере.

</P>
<P>
После того как подчиненный сервер начнет выполнять репликацию, в той же
директории, где находится журнал регистрации ошибок, появится файл
<tt>`master.info'</tt>. Файл <tt>`master.info'</tt> используется подчиненным сервером для
отслеживания того, какие записи двоичных журналов головного сервера
обработаны. Не удаляйте и не редактируйте этот файл, если не уверены в
том, что это необходимо. Даже если такая уверенность есть, все равно лучше
использовать команду <code>CHANGE MASTER TO</code>.

</P>
<P>
На данном этапе у вас есть снимок, который вы можете использовать для настройки
и установки других подчиненных серверов. Чтобы сделать это, вам надо повторить
вышеописанную процедуру в части настройки подчиненного сервера. Вам не нужно
создавать еще один снимок головного сервера. 

</P>


<H3><A NAME="Replication_Features" HREF="manual.ru_toc.html#Replication_Features">4.10.4  Возможности репликации и известные проблемы</A></H3>

<P>
<A NAME="IDX830"></A>
<A NAME="IDX831"></A>
<A NAME="IDX832"></A>

</P>
<P>
Ниже приводится список поддерживаемых и не поддерживаемых при репликации
функций:

</P>

<ul>
<LI>

Реплицирование будет выполнено правильно при использовании значений
<code>AUTO_INCREMENT</code>, <code>LAST_INSERT_ID()</code> и <code>TIMESTAMP</code>.

<LI>

Если в обновлениях присутствует функция <code>RAND()</code>, реплицирование будет
выполнено некорректно. При реплицировании обновлений с функцией <code>RAND()</code> 
применяйте <code>RAND(some_non_rand_expr)</code>. В качестве аргумента
(<code>some_non_rand_expr</code> - некоторое не случайное выражение) для функции
<code>RAND()</code> можно, например, использовать функцию <code>UNIX_TIMESTAMP()</code>.

<LI>

На головном и подчиненном серверах следует использовать одинаковый
набор символов (<code>--default-character-set</code>). В противном случае могут
возникать ошибки дублирующихся ключей на подчиненном сервере,
поскольку ключ, который считается уникальным на головном сервере,
может не быть таковым при использовании другого набора символов.

<LI>

В MySQL 3.23 команда <code>LOAD DATA INFILE</code> будет выполнена корректно, если
файл во время выполнения обновления будет находиться на головном
сервере. Команда <code>LOAD LOCAL DATA INFILE</code> будет проигнорирована. В MySQL
4.0 это ограничение не присутствует - все разновидности команды <code>LOAD
DATA INFILE</code> реплицируются правильно.

<LI>

Запросы на обновление, в которых используются пользовательские
переменные, являются не безопасными для репликации (пока).

<LI>

Команды <code>FLUSH</code> не записываются в двоичный журнал и поэтому не
копируются на подчиненный сервер. Проблем при этом не возникает,
поскольку команды <code>FLUSH</code> ничего не изменяют. Однако это означает, что
при непосредственном, без использования оператора <code>GRANT</code>, обновлении
таблиц привилегий MySQL и при последующем реплицировании базы данных
привилегий <code>mysql</code> нужно выполнить команду <code>FLUSH PRIVILEGES</code> на
подчиненных серверах, чтобы новые привилегии вступили в силу.

<LI>

Временные таблицы, начиная с версии 3.23.29, реплицируются корректно,
за исключением случая, когда при прекращении работы подчиненного
сервера (не только потока подчиненного сервера) некоторые временные
таблицы остаются открытыми и используются в последующих обновлениях.
Для решения этой проблемы перед прекращением работы подчиненного
сервера выполните команду <code>SLAVE STOP</code>, проверьте, чтобы переменная
<code>Slave_open_temp_tables</code> содержала значение 0, затем выполните
<code>mysqladmin shutdown</code>. Если значение переменной <code>Slave_open_temp_tables</code>
не 0, перезапустите поток подчиненного сервера при помощи команды
<code>SLAVE START</code> и проверьте, не улучшилась ли ситуация теперь. Эта
проблема будет решаться более изящно, но придется подождать MySQL 4.0.
В более ранних версиях при использовании временных таблиц репликации
не выполняются должным образом - в таких случаях мы рекомендуем либо
обновить версию MySQL, либо перед выполнением запросов, использующих
временные таблицы, выполнить команду <code>SET SQL_LOG_BIN=0</code> на своих
клиентах.

<LI>

MySQL поддерживает лишь один головной и много подчиненных серверов. В
4.x будет добавлен алгоритм голосования, обеспечивающий автоматическое
изменение головного сервера, если что-либо будет выполняться
неправильно при текущем головном сервере. Будут также введены процессы
'агента', которые помогут выполнять распределение нагрузки путем
посылки запросов на выборки различным подчиненным серверам.

<LI>

Начиная с версии 3.23.26 стало безопасно соединять серверы
циклическими соединениями головной-подчиненный с включенной опцией
<code>log-slave-updates</code>. Однако обратите внимание: при таком способе
установки многие запросы не будут выполняться корректно, если только в
коде вашего клиента не предусмотрена обработка потенциальных проблем,
которые могут случаться при обновлениях, происходящих в различной
последовательности на различных серверах. Это означает, что если вы
сделаете установку следующим образом:

<pre>
A - &#62; B &#62; - C - &#62; A
</pre>

то такая установка будет работать только в том случае, если
выполняются непротиворечивые обновления между таблицами. Другими
словами, при вставке данных на серверах <code>A</code> и <code>C</code> нельзя вставлять на
сервере <code>A</code> строку, которая может иметь ключ, противоречащий строке,
вставляемой на сервере <code>C</code>. Также нельзя обновлять одинаковые строки на
двух серверах, если имеет значение порядок обновлений. Обратите
внимание: в версии 3.23.26 изменился формат журнала. Таким образом,
если версия подчиненного сервера меньше 3.23.26, сервер не сможет
считывать записи из журнала.

<LI>

Если запрос на подчиненном сервере вызывает ошибку, поток подчиненного
сервера завершится, и в файле <tt>`.err'</tt> появится соответствующее сообщение.
После этого нужно будет вручную установить соединение с подчиненным
сервером, исправить причину ошибки (например обращение к
несуществующей таблице) и затем выполнять SQL-команду <code>SLAVE START</code> 
(доступна в версии 3.23.16). При использовании версии 3.23.15
потребуется перезапустить сервер.

<LI>

Если соединение с головным сервером прервется, подчиненный сервер
попытается сразу же восстановить его, и затем в случае неудачи будет
повторять попытки через установленное в опции <code>master-connect-retry</code> 
количество секунд (по умолчанию 60). По этой причине безопасно
выключить головной сервер и после этого перезапустить его через
некоторое время. Подчиненный сервер будет также разрешать проблемы,
возникающие при аварийных отключениях электричества в узлах сети.

<LI>

Завершение работы подчиненного сервера (корректное) также является
безопасным, поскольку при этом отслеживаются события начиная от
момента остановки сервера. Но в случае некорректного отключения
сервера могут возникать проблемы, особенно, если дисковый кэш не был
синхронизирован перед ``смертью'' системы. Для того чтобы значительно
повысить эффективность своей системы обеспечения отказоустойчивости,
целесообразно приобрести хороший UPS (источник бесперебойного
питания).

<LI>

Если головной сервер слушает нестандартный порт, это нужно будет
указать также в параметре <code>master-port</code> в файле <tt>`my.cnf'</tt>.

<LI>

В версии 3.23.15 все таблицы и базы данных могут быть реплицированы.
Начиная с версии 3.23.16 появилась возможность ограничить репликацию
набором баз данных при помощи директив <code>replicate-do-db</code> в файле <tt>`my.cnf'</tt>;
можно также исключить набор баз данных из репликации при помощи
директив <code>replicate-ignore-db</code>. Обратите внимание,: в версиях MySQL до
3.23.23, имелась ошибка, из-за которой команда <code>LOAD DATA INFILE</code> 
выполнялась некорректно, если она применялась к базе данных,
исключенной из репликации.

<LI>

Начиная с версии 3.23.16 команда <code>SET SQL_LOG_BIN = 0</code> будет выключать
ведение записей о репликации в журналах (двоичных) на головном
сервере, а команда <code>SET SQL_LOG_BIN = 1</code> - включать такое ведение
записей. Для выполнения этих команд нужно иметь привилегию <code>SUPER</code> (в
MySQL 4.0.2 и выше) или <code>PROCESS</code> (в более ранних версиях MySQL).

<LI>

Начиная с версии 3.23.19 можно убрать мусор, оставшийся после
неоконченной репликации (если ее выполнение пошло не должным образом),
и начать все сначала, используя команды <code>FLUSH MASTER</code> и <code>FLUSH SLAVE</code>. В
версии 3.23.26 эти команды переименованы в RESET MASTER и RESET SLAVE
соответственно - чтобы сделать понятным их назначение. Тем не менее,
старые варианты <code>FLUSH</code> все еще работают - для обеспечения
совместимости.

<LI>

Начиная с версии 3.23.23 можно заменять головные серверы и
корректировать точку положения в журнале репликации при помощи команды
<code>CHANGE MASTER TO</code>.

<LI>

Начиная с версии 3.23.23 можно при помощи опции <code>binlog-ignore-db</code> 
уведомлять головной сервер о том, что обновления в некоторых базах
данных не должны отражаться в двоичном журнале.

<LI>

Начиная с версии 3.23.26, можно использовать опцию
<code>replicate-rewrite-db</code> для уведомления подчиненного сервера о том, что
он должен применить обновления базы данных на головном сервере к базе
данных с другим именем на подчиненном сервере.

<LI>

Начиная с версии 3.23.28 можно использовать команду <code>PURGE MASTER LOGS
TO 'имя-журнала'</code>, чтобы избавиться от старых журналов без завершения
работы подчиненного сервера. Это удалит все журналы до, но не включая <code>log-name</code>.

<LI>

Из-за того, что по своей природе таблицы <code>MyISAM</code> являются
нетранзакционными, может случиться так, что запрос обновит таблицу
только частично и возвратит код ошибки. Это может произойти, например,
при вставке нескольких строк, одна из которых нарушает ограничение
ключа, или в случае, когда длинный запрос обновления ``убивается''
после обновления некоторых строк. Если такое случится на головном
сервере, поток подчиненного сервера завершит работу и будет ждать,
пока администратор базы данных не примет решение о том, что делать в
этом случае (если только код ошибки не является легитимным и в
результате выполнения запроса не будет сгенерирована ошибка с тем же
кодом). Если такой способ проверки правильности кода ошибки
нежелателен, начиная с версии 3.23.47, некоторые (или все) ошибки
могут быть замаскированы при помощи опции <code>slave-skip-errors</code>.

<LI>

Отдельные таблицы могут исключаться из репликации при помощи опции
<code>replicate-do-table</code>/<code>replicate-ignore-tab</code> или опции
<code>replicate-wild-do-table</code>/<code>replicate-wild-ignore-table</code>. Однако в
настоящее время наличие определенных конструктивных неточностей в
некоторых довольно редких случаях может приводить к неожиданным
результатам. Протокол репликации явно не уведомляет подчиненный сервер
о том, какие таблицы должны быть изменены запросом, поэтому
подчиненному серверу требуется анализировать запрос, чтобы узнать это.
Чтобы избежать лишнего синтаксического анализа, для которого требуется
прерывать выполнение запросов, исключение таблицы в настоящее время
реализуется путем посылки запроса к стандартному анализатору MySQL для
упрощенного синтаксического анализа. Если анализатор обнаружит, что
таблица должна игнорироваться, выполнение запроса будет остановлено и
выдано сообщение об успехе. Этот подход несколько неэффективен, при
его применении чаще возникают ошибки и, кроме того, имеются две
известные ошибки в версии 3.23.49. Первая может возникнуть из-за того,
что поскольку анализатор автоматически открывает таблицу при анализе
некоторых запросов, игнорируемая таблица должна существовать на
подчиненном сервере. Другая ошибка заключается в том, что при
частичном обновлении игнорируемой таблицы поток подчиненного сервера
не заметит, что таблица должна игнорироваться, и приостановит процесс
репликации. Несмотря на то что вышеупомянутые ошибки концептуально
очень просто исправить, для этого придется изменить достаточно много
кода, что поставит под угрозу состояние стабильности ветви 3.23. Если
описанные случаи непосредственно имеют отношение к вашему приложению
(а это довольно редкий случай) - используйте опцию <code>slave-skip-errors</code>,
чтобы дать указание серверу продолжать репликации, игнорируя эти
ошибки.
</ul>



<H3><A NAME="Replication_Options" HREF="manual.ru_toc.html#Replication_Options">4.10.5  Опции репликации в файле <tt>`my.cnf'</tt></A></H3>

<P>
Для использования репликации рекомендуется MySQL 3.23.33 или выше. С более
ранними версиями тоже можно работать, но в них имеются ошибки и
отсутствуют некоторые возможности. Если у вас не самая последняя версия
MySQL, то в ней может не оказаться некоторых из упомянутых в данном
разделе опций. Все опции, появившиеся в ветви 4.0, сопровождаются
примечанием, в котором это указано. В противном случае, если интересующая
вас опция не присутствует в версии 3.23, но действительно необходима,
пожалуйста, замените версию на самую новую ветвь 3.23.

</P>
<P>
Не следует забывать о том, что ветвь 4.0 все еще находится в стадии
альфа-разработки, поэтому некоторые функции могут работать не так гладко,
как хотелось бы. Новые возможности, появившиеся в 4.0, рекомендуется
использовать так, чтобы в случае возникновения проблемы не нарушилась
работа приложения.

</P>
<P>
Как на головном, так и на подчиненном серверах нужно использовать опцию
<code>server-id</code>. Она устанавливает уникальный идентификатор репликации. Нужно
выбрать уникальное значение из диапазона от 1 до 2^32-1 для каждого
головного и подчиненного сервера, например: <code>server-id=3</code> 

</P>
<P>
В следующей таблице представлены опции, которые можно использовать для
головного сервера.

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Опция</strong> </TD><TD> <strong>Описание</strong>

</TD></TR>
<TR><TD><code>log-bin=filename</code> </TD><TD>
Указывает местоположение двоичного журнала обновлений, в котором будут вестись
записи. Обратите внимание: если передаваемый параметр имеет расширение
(например <code>log-bin=/mysql/logs/replication.log</code>), то в случае вызова
команды <code>FLUSH LOGS</code> версии MySQL ниже 3.23.24 не будут правильно работать
во время репликации. Эта проблема устранена в версии 3.23.25. Теперь, если
используется такой способ определения имени журнала, команда <code>FLUSH LOGS</code>
для двоичных журналов будет игнорироваться. Для очистки журнала выполните
команду <code>FLUSH MASTER</code> и не забудьте запустить команду <code>FLUSH SLAVE</code>
на всех подчиненных серверах. В версии 3.23.26 или выше нужно использовать для
этого команды <code>RESET MASTER</code> и <code>RESET SLAVE</code> 
Вы можете использовать эту опци. если вы хотите иметь имя, которое будет независимо
от имени хоста (может быть полезно, скажем, если вы переименуете ваш сервер в один прекрасный день).

</TD></TR>
<TR><TD><code>log-bin-index=filename</code> </TD><TD>
Так как пользователь может выполнять
команду <code>FLUSH LOG</code>, нужно знать, какой
журнал является активным в настоящее
время, а также какие журналы
использовались ранее и в какой
последовательности они сменялись. Эта
информация сохранена в индексном файле
двоичного журнала, имя которого по
умолчанию <tt>`имя_хоста.index'</tt>. Имя и
содержимое данного файла не следует
изменять.

Пример: <code>log-bin-index=db.index</code> 

</TD></TR>
<TR><TD><code>sql-bin-update-same</code> </TD><TD>
Если включена данная опция, то при
установке значения переменной <code>SQL_LOG_BIN</code>
это же значение будет автоматически
установлено и для переменной
<code>SQL_LOG_UPDATE</code>, и наоборот.

</TD></TR>
<TR><TD><code>binlog-do-db=database_name</code> </TD><TD>
Указывает головному серверу, что он
должен вести записи об обновлениях в
двоичном журнале, если текущая база
данных - <code>database_name</code>. Все другие базы
данных игнорируются. Обратите внимание:
при использовании этой опции вы должны
быть уверены, что обновления будут
производиться только в текущей базе
данных.

Пример: <code>binlog-do-db=sales</code> 

</TD></TR>
<TR><TD><code>binlog-ignore-db=database_name</code> </TD><TD>
Указывает головному серверу, что если
текущая база данных - <code>database_name</code>, то
записи об обновлениях не должны вестись в
двоичном журнале. Обратите внимание: при
использовании этой опции вы должны быть
уверены, что обновления будут
производиться только в текущей базе
данных.

Пример: <code>binlog-ignore-db=accounting</code> 
</TD></TR>
</TABLE>

<P>
В следующей таблице представлены опции, которые можно использовать для
подчиненного сервера:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Опция</strong> </TD><TD> <strong>Описание</strong>

</TD></TR>
<TR><TD><code>master-host=host</code> </TD><TD>
Имя хоста головного сервера или IP-адрес для
репликации. Если значение этой опции не
установлено, поток подчиненного сервера не будет
запущен. Обратите внимание: установка <code>master-host</code> 
будет игнорироваться, если существует корректный
файл <tt>`master.info'</tt>. Возможно, лучше было бы назвать
эти опции как-нибудь иначе, что-то вроде
<code>bootstrap-master-host</code>, но менять их имена уже
поздно.

Пример: <code>master-host=db-master.mycompany.com</code> 

</TD></TR>
<TR><TD><code>master-user=username</code> </TD><TD>
Имя пользователя, которое подчиненный сервер будет
использовать для аутентификации при подсоединении
к головному серверу. Пользователь должен иметь
привилегию <code>FILE</code>. Если пользователь головного
сервера не установлен, будет использовано имя
пользователя <code>test</code>. Если удастся считать значение
из файла <tt>`master.info'</tt>, то оно будет иметь больший
приоритет.

Пример: <code>master-user=scott</code> 

</TD></TR>
<TR><TD><code>master-password=password</code> </TD><TD>
Пароль, который будет использоваться при
подсоединении подчиненного сервера к головному
серверу. Если этот пароль не установлен, будет
использоваться пустой пароль. Если удастся считать
значение из файла <tt>`master.info,'</tt> то оно будет иметь
больший приоритет.

Пример: <code>master-password=tiger</code> 

</TD></TR>
<TR><TD><code>master-port=portnumber</code> </TD><TD>
Порт, который слушает головной сервер. Если не он
не установлен, используется откомпилированная
установка <code>MYSQL_PORT</code>. Это должно быть значение
<code>3306</code>, если оно не было изменено при помощи опций
<code>configure</code>. Если удастся считать значение из файла
<tt>`master.info'</tt>, то оно будет иметь больший приоритет

Пример: <code>master-port=3306</code>

</TD></TR>
<TR><TD><code>master-connect-retry=seconds</code> </TD><TD>
Время ожидания в секундах для потока подчиненного
сервера перед повторением попытки установить связь
с головным сервером в случае прекращения работы
головного сервера или потери связи. По  умолчанию
- 60.

Пример: <code>master-connect-retry=60</code> 

</TD></TR>
<TR><TD><code>master-ssl</code> </TD><TD>
Доступна для версий выше 4.0.0. Включает SSL для
репликации. Это относительно новая опция, поэтому
применять ее следует осторожно.

Пример: <code>master-ssl</code>

</TD></TR>
<TR><TD><code>master-ssl-key</code> </TD><TD>
Доступна для версий выше 4.0.0. Имя файла-ключа
SSL на головном сервере. Используется только в том
случае, если включена опция <code>master-ssl</code>.

Пример: <code>master-ssl-key=SSL/master-key.pem</code>

</TD></TR>
<TR><TD><code>master-ssl-cert</code> </TD><TD>
Доступна для версий выше 4.0.0. Имя
файла-сертификата SSL. Используется только в том
случае, если включена опция <code>master-ssl</code>.

Пример: <code>master-ssl-key=SSL/master-cert.pem</code>

</TD></TR>
<TR><TD><code>master-info-file=filename</code> </TD><TD>
Местоположение файла, в который записывается
информация о том, где на головном сервере
произошла остановка во время выполнения
репликации. По умолчанию это файл <tt>`master.info'</tt> в
директории данных. Изменять это местоположение нет
необходимости.

Пример: <code>master-info-file=master.info</code>

</TD></TR>
<TR><TD><code>report-host</code> </TD><TD>
Доступна для версий выше 4.0.0. Имя хоста или
IP-адрес подчиненного сервера, который передается
головному серверу во время регистрации
подчиненного сервера. Может быть выведен командой
<code>SHOW SLAVE HOSTS</code>. Не устанавливайте эту опцию,
если не хотите, чтобы подчиненный сервер
регистрировался на головном сервере. Обратите
внимание: для того, чтобы головной сервер
установил соединение с подчиненным сервером, ему
недостаточно просто получить IP-адрес подчиненного
сервера из соединения. Из-за <code>NAT</code> и других проблем
маршрутизации IP-адрес может быть недопустимым для
подсоединения головного сервера или других хостов
к подчиненному серверу.

Пример: <code>report-host=slave1.mycompany.com</code>

</TD></TR>
<TR><TD><code>report-port</code> </TD><TD>
Доступна для версий выше 4.0.0. Порт для
соединения с подчиненным сервером, имя хоста или
IP-адрес которого были переданы головному серверу
при регистрации подчиненного сервера. Порт нужно
устанавливать лишь в том случае, когда подчиненный
сервер слушает порт, который задан не по
умолчанию, или если имеется специальный тоннель от
головного сервера или других клиентов к
подчиненному серверу. Не используйте эту опцию,
если не уверены в своих действиях.

</TD></TR>
<TR><TD><code>replicate-do-table=db_name.table_name</code> </TD><TD>
Сообщает подчиненному серверу, что он должен
реплицировать только указанную таблицу. Для
указания более чем одной таблицы директиву следует
использовать несколько раз, по одному разу для
каждой таблицы. В отличие от <code>replicate-do-db</code>,
данную опцию можно применять для обновлений, в
которых используется несколько баз данных.

Пример: <code>replicate-do-table=some_db.some_table</code>

</TD></TR>
<TR><TD><code>replicate-ignore-table=db_name.table_name</code> </TD><TD>
Указывает подчиненному серверу, что команды, обновляющие эту таблицу, 
не должны реплицироваться. Для указания
более чем одной таблицы директиву следует задавать
несколько раз, по одному разу для каждой таблицы.
В отличие от <code>replicate-do-db</code>,  данную опцию можно
применять для обновлений, в которых используется
несколько баз данных.

Пример: <code>replicate-ignore-table=db_name.some_table</code>

</TD></TR>
<TR><TD><code>replicate-wild-do-table=db_name.table_name</code> </TD><TD>
Указывает подчиненному серверу, что должны реплицироваться только те
запросы, где хоть одна из таблиц удовлетворяет указанном шаблону.  Для указания
более чем одной таблицы директиву следует задавать несколько раз, по одному
разу для каждой таблицы.  Данную опцию можно применять для обновлений, в
которых используется несколько баз данных.  Пример: при использовании
<code>replicate-wild-do-table=foo%.bar%</code> будут реплицироваться обновления
только таблиц с именами, начинающимися с ``bar'', которые находятся в базах
данных, с именами, начинаются с ``foo''.

Заметьте, что если вы используете <code>replicate-wild-do-table=foo%.%</code> тогда
это правило также распространяется и на <code>CREATE DATABASE</code> и на <code>DROP
DATABASE</code>, т.е. эти два выражения также будут реплицированы если имя базы
данных совпадет с шаблоном (<code>'foo%'</code> в этом примере; это получается из-за
того, что символ <code>%</code> становится шаблонным).

</TD></TR>
<TR><TD><code>replicate-wild-ignore-table=db_name.table_name</code> </TD><TD>
Указывает подчиненному серверу, запросы, где используется одна из перечисленных здесь таблиц, 
реплицироваться не должны. Для указания более чем
одной подлежащей игнорированию таблицы директиву
следует задавать несколько раз, по одному разу для
каждой таблицы. Данную опцию можно применять для
обновлений, в которых используется несколько баз
данных. Например, при использовании
<code>replicate-wild-do-table=foo%.bar%</code> не будут
реплицироваться обновления всех таблиц,
начинающихся на ``bar'', в базах данных, имена
которых начинаются на ``foo''.

</TD></TR>
<TR><TD><code>replicate-ignore-db=database_name</code> </TD><TD>
Сообщает подчиненному серверу, что не следует реплицировать ни 
один запрос, в котором текущая база данных - <code>database_name</code>.  Чтобы
указать более одной базы данных, директиву следует использовать несколько раз,
по одному разу для каждой базы данных. 

Вы не должны использовать эту директиву,
если вы используете кросс-табличные обновления, и не хотите чтобы 
эти обновления реплицировались. 

Основная причина такого поведения заключается в том, что очень трудно 
из самой команды понять, должен ли этот запрос реплицироваться или нет. 
Например, если вы используете многотабличное удаление или многотабличное обновление
в MySQL 4.x, которое охватывает более чем одну базу данных.
Кроме того, достаточно быстро можно проверить, является ли текущая база данных 
соответствующей, т.к. эта проверка выполняется только на момент соединения или смены базы данных. 

Если такие обновления необходимо производить, убедитесь, что у вас установлена
версия MySQL 3.23.28 или выше и используйте
<code>replicate-ignore-db=db_name.%</code>.

Пример: <code>replicate-ignore-db=some_db</code> 

</TD></TR>
<TR><TD><code>replicate-do-db=database_name</code> </TD><TD>
Сообщает подчиненному серверу, что реплицироваться
должна только указанная база данных. Чтобы указать
более одной базы данных, директиву следует
использовать несколько раз, по одному разу для
каждой базы данных. Заметьте, что не будут реплицироваться
обновления, охватывающие несколько баз данных, такие как
<code>UPDATE some_db.some_table SET foo='bar'</code> при том, что выбрана другая база данных или не выбрана вовсе.

Если такие обновления необходимо производить, убедитесь, что у вас установлена
версия MySQL 3.23.28 или выше и используйте
<code>replicate-wild-do-table=db_name.%</code>.

Пример: <code>replicate-do-db=some_db</code>

</TD></TR>
<TR><TD><code>log-slave-updates</code> </TD><TD>
Указывает подчиненному серверу, чтобы тот вел
записи об обновлениях, происходящих на подчиненном
сервере, в двоичном журнале. По умолчанию эта
опция выключена. Ее следует включить, если
требуется организовать подчиненные серверы в
гирляндную цепь.

</TD></TR>
<TR><TD><code>replicate-rewrite-db=from_name-&#62;to_name</code> </TD><TD>
Обновления производятся не в подлинную базу
данных, а в базу данных с именем, указанным в
опции.

Пример: <code>replicate-rewrite-db=master_db_name-&#62;slave_db_name</code> 

</TD></TR>
<TR><TD><code>slave-skip-errors= [err_code1,err_code2,... | all]</code> </TD><TD>
Доступна только в версии 3.23.47 и выше. Сообщает
потоку  подчиненного сервера, что он должен
продолжать репликацию, если запрос возвращает
ошибку, указанную в списке. Обычно при
возникновении ошибки выполнение реплицирование
прекращается, чтобы пользователь мог вручную
исправить несоответствия в данных. Не используйте
данную опцию, если вы до конца не разобрались в
причинах возникновения ошибок. Если не было
допущено ошибок при установке репликации, нет
ошибок в клиентских программах и нет никаких
ошибок непосредственно в MySQL, то прекращения
работы из-за ошибки происходить не должно.
Неразборчивое применение данной опции может
привести к тому, что подчиненный сервер окажется
безнадежно не синхронизированным с головным
сервером, и вы будете тщетно ломать себе голову
над тем, каким образом это случилось. Код ошибок
можно получить в сообщениях об ошибках в журнале
ошибок и в выводе команды <code>SHOW SLAVE STATUS</code>.
Полный список сообщений об ошибках можно найти в
файле исходного дистрибутива
<tt>`Docs/mysqld_error.txt'</tt>. Можно также (но не нужно)
использовать значение <code>all</code> (хотя этого делать
настоятельно не рекомендуется) - тогда будут
игнорироваться все сообщения об ошибках и за
процессом переброски данных наблюдения не будет.
Само собой разумеется, при использовании этой
опции целостность данных ставится под угрозу. В
этом случае просьба не жаловаться, если данные на
подчиненном сервере не будут соответствовать
данным на головном сервере, - вас предупреждали.

Пример: <code>slave-skip-errors=1062,1053</code> или
<code>slave-skip-errors=all</code>

</TD></TR>
<TR><TD><code>skip-slave-start</code> </TD><TD>
Указывает компьютеру, на котором установлен
подчиненный сервер, что при его запуске не должен
запускаться подчиненный сервер. Пользователь может
запустить его позже при помощи команды <code>SLAVE START</code>.                                          

</TD></TR>
<TR><TD><code>slave_compressed_protocol=#</code> </TD><TD>
Если 1, то использовать сжание в клиент/серверном протоколе связи, 
если оба, и сервер и клиент, поддерживают сжатие. 

</TD></TR>
<TR><TD><code>slave_net_timeout=#</code> </TD><TD>
Время ожидания (в секундах) дополнительных данных
от головного сервера, после чего чтение будет
прервано.
</TD></TR>
</TABLE>



<H3><A NAME="Replication_SQL" HREF="manual.ru_toc.html#Replication_SQL">4.10.6  SQL-команды, относящиеся к репликации</A></H3>

<P>
<A NAME="IDX833"></A>
<A NAME="IDX834"></A>
<A NAME="IDX835"></A>

</P>
<P>
Управление репликацией производится командами SQL. Ниже приводится краткое
описание команд:

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Команда</strong> </TD><TD> <strong>Описание</strong>

</TD></TR>
<TR><TD><code>SLAVE START</code> </TD><TD> Запускает поток подчиненного сервера (подчиненный сервер)

</TD></TR>
<TR><TD><code>SLAVE STOP</code> </TD><TD> Завершает поток подчиненного сервера. Также как и <code>SLAVE START</code>, этот оператор можно использовать с опциями
<code>IO_THREAD</code> и <code>SQL_THREAD</code>. (подчиненный сервер)

</TD></TR>
<TR><TD><code>SET SQL_LOG_BIN=0</code> </TD><TD> Блокирует ведение записей в журналах
обновлений, если пользователь имеет привилегию <code>SUPER</code>. В противном случае ничего
не выполняет (головной сервер)

</TD></TR>
<TR><TD><code>SET SQL_LOG_BIN=1</code> </TD><TD> Отменяет блокировку ведения записей в
журналах обновлений, если пользователь имеет привилегию <code>SUPER</code>. В противном
случае ничего не выполняет (головной сервер)

</TD></TR>
<TR><TD><code>SET GLOBAL SQL_SLAVE_SKIP_COUNTER=n</code> </TD><TD> Пропускает последующие n событий
на головном сервере. Опция допустима, если поток подчиненного сервера не
запущен, в противном случае будет выдана ошибка. Полезна для восстановления
после сбоев репликации.

</TD></TR>
<TR><TD><code>RESET MASTER</code> </TD><TD> Удаляет все двоичные журналы, перечисленные в
индексном файле, и делает индексный файл двоичных журналов пустым. Для версий
ниже 3.23.26 используйте команду <code>FLUSH SLAVE</code> (головной сервер)

</TD></TR>
<TR><TD><code>RESET SLAVE</code> </TD><TD> Заставляет подчиненный сервер "забыть" свою
точку положения репликации в журналах головного сервера. Для версий ниже
3.23.26 эта команда называется <code>FLUSH SLAVE</code> (подчиненный сервер)

</TD></TR>
<TR><TD><code>LOAD TABLE tblname FROM MASTER</code> </TD><TD> Загружает копию таблицы из
головного на подчиненный сервер. Используется главным образом для отладки
команды <code>LOAD DATA FROM MASTER</code>, но некоторые "пользователи-гурманы" могут найти
ей и другие применения. Если вы относите себя к числу обычных, не отягощенных
хакерскими амбициями пользователей, данную опцию применять не стоит.
Требуется, чтобы у пользователя репликации, использущегося в соединении с головным
сервером, присутствовали привилегии <code>RELOAD</code> и <code>SUPER</code> на головном сервере. 
(подчиненный  сервер).

</TD></TR>
<TR><TD><code>LOAD DATA FROM MASTER</code> </TD><TD> Присутствует в версиях выше 4.0.0.
Создает образ головного сервера и копирует его на подчиненный сервер. 
Требуется, чтобы у пользователя репликации, использущегося в соединении с головным
сервером, присутствовали привилегии <code>RELOAD</code> и <code>SUPER</code> на головном сервере.
Обновляет
значения <code>MASTER_LOG_FILE</code> и <code>MASTER_LOG_POS</code> таким образом, чтобы подчиненный
сервер начинал репликацию из конкретной позиции. Будет обрабатывать ограничения
таблиц и баз данных, указанные в опциях <code>replicate-*</code>. При этом, пока происходит
создание образа, могут использоваться лишь таблицы <code>MyISAM</code> и требуется
глобальная блокировка чтения на головном сервере. В будущем планируется
обеспечить работу этой команды с таблицами <code>InnoDB</code> и устранить необходимость
глобальной блокировки чтения при помощи  интерактивного резервного копирования,
не требующего блокировки.

Заметьте, <code>LOAD DATA FROM MASTER</code> <strong>НЕ</strong> копирует ни одну таблицу в
базе данных mysql.  Это сделано для того, чтобы было легко управлять разными
пользователями на головном и подчиненном серверах. 

</TD></TR>
<TR><TD><code>CHANGE MASTER TO master_def_list</code> </TD><TD>

Заменяет параметры головного сервера значениями, заданными в списке
<code>master_def_list</code>, и перезапускает поток подчиненного сервера. <code>master_def_list</code> -
это список с разделителем-запятой, содержащий значения <code>master_def</code>, где
<code>master_def</code> - одно из следующих значений: <code>MASTER_HOST, MASTER_USER,
MASTER_PASSWORD, MASTER_PORT, MASTER_CONNECT_RETRY, MASTER_LOG_FILE,
MASTER_LOG_POS</code>. Например:


<pre>
CHANGE MASTER TO
   MASTER_HOST='master2.mycompany.com',
   MASTER_USER='replication',
   MASTER_PASSWORD='bigs3cret',
   MASTER_PORT=3306,
   MASTER_LOG_FILE='master2-bin.001',
   MASTER_LOG_POS=4;
</pre>

Следует указывать только те значения, которые подлежат изменению. Не указанные
значения останутся неизменными, за исключением тех случаев, когда изменяется
хост или порт. В этом случае подчиненный сервер считает, что поскольку
изменяется хост или порт, головной сервер становится другим. Следовательно,
старые значения и точки положения в журнале будут автоматически заменены на
значение пустой строки и <code>0</code> соответственно (начальные значения). Обратите
внимание: если подчиненный сервер перезапускается, он сохраняет "память" о
своем последнем головном сервере. Если это нежелательно, можно перед
перезапуском удалить файл <tt>`master.info'</tt> - тогда подчиненный сервер будет
считывать информацию о своем головном сервере из файла <tt>`my.cnf'</tt> или из командной
строки. Эта команда используется для настройки подчиненного сервера при наличии
образа головного сервера, а также записей из журнала и сдвига головного
сервера, которые соответствуют образу. Можно выполнить команду


<pre>
CHANGE MASTER TO
   MASTER_LOG_FILE='log_name_on_master',
   MASTER_LOG_POS=log_offset_on_master 
</pre>

на подчиненном сервере после восстановления образа (подчиненный сервер)

</TD></TR>
<TR><TD><code>SHOW MASTER STATUS</code> </TD><TD> Выводит информацию о состоянии головного
сервера, исходя из информации в двоичных журналах (головной сервер)

</TD></TR>
<TR><TD><code>SHOW SLAVE HOSTS</code> </TD><TD> Присутствует в версии 4.0.0 и выше. Выводит
список подчиненных серверов, связанных в текущее время с головным сервером
(подчиненный сервер)

</TD></TR>
<TR><TD><code>SHOW SLAVE STATUS</code> </TD><TD> Выводит информацию о состоянии существенных
параметров потока подчиненного сервера (головной сервер)

</TD></TR>
<TR><TD><code>SHOW MASTER LOGS</code> </TD><TD> Присутствует только начиная с версии
3.23.28.  Выводит список двоичных журналов головного сервера. Эту команду
следует использовать перед вызовом команды <code>PURGE MASTER LOGS TO</code> для определения
того, какие из журналов можно удалить  (головной сервер)

</TD></TR>
<TR><TD><code>SHOW BINLOG EVENTS [ IN 'logname' ] [ FROM pos ] [LIMIT [offset,] rows ]</code>
@tab Показывает события в двоичном журнале обновлений. Преимущественно
применяется для тестирования/отладки, но может также использоваться и для
обычных клиентов, по какой-либо причине нуждающихся в чтении содержимого
двоичных журналов (головной сервер).

</TD></TR>
<TR><TD><code>SHOW NEW MASTER FOR SLAVE
WITH
MASTER_LOG_FILE='logfile'
AND MASTER_LOG_POS=pos AND
MASTER_LOG_SEQ=log_seq AND
MASTER_SERVER_ID=server_id</code> </TD><TD> 
Эта команда используется, когда подчиненному
серверу, связанному с головным сервером,
который, возможно, является "мертвым" или
недоступным, нужно отключить репликации на
другом подчиненном сервере, связанном с тем же головным сервером. Команда
возвратит пересчитанные координаты репликации (имя файла журнала и позицию в
нем), и вывод этой команды может использоваться в последующей команде
<code>CHANGE MASTER TO</code>. Обычным пользователям данная команда, как правило,
никогда не понадобится: она главным образом служит для внутреннего
использования в отказобезопасном репликационном коде. В будущем возможны
изменения синтаксиса опции, если будет найден более интуитивно понятный способ
описания этой операции.

</TD></TR>
<TR><TD><code>PURGE MASTER LOGS TO 'logname'</code> </TD><TD>
Присутствует начиная с версии 3.23.28.
Удаляет все журналы репликации, которые
перечислены в индексном файле журналов до
передаваемого журнала, и удаляет их из
индексного файла журналов. Таким образом
передаваемый журнал становится первым в
индексном файле журналов. Пример:


<pre>
PURGE MASTER LOGS TO 'mysql-bin.010'
</pre>

Эта команда не выполнит никаких действий и
возвратит ошибку, если имеется активный
подчиненный сервер, который в текущее время
читает данные из одного из журналов, который
должен быть удален. Однако если имеется
бездействующий подчиненный сервер и
происходит удаление одного из журналов,
который он хочет прочитать, то после того,
как подчиненный сервер "поднимется", он
станет неспособным к репликации. Команда
может быть безопасно выполнена на подчиненных
серверах во время процесса репликации - не
нужно останавливать процесс. Сначала
необходимо проверить все подчиненные серверы
при помощи команды <code>SHOW SLAVE STATUS</code>, чтобы
увидеть, какой журнал используется, затем
вывести список журналов головного сервера при
помощи команды <code>SHOW MASTER LOGS</code>, найти самый
ранний журнал среди всех подчиненных серверов
(если все подчиненные серверы получили
последние обновления, это будет последний
журнал в списке), сделать резервные копии
всех журналов, которые должны быть удалены
(необязательно), и очистить все до целевого
журнала.
</TD></TR>
</TABLE>



<H3><A NAME="Replication_FAQ" HREF="manual.ru_toc.html#Replication_FAQ">4.10.7  Часто задаваемые вопросы по репликации</A></H3>

<P>
<strong>Вопрос:</strong> Как сконфигурировать подчиненный сервер, если головной сервер уже
запущен, и я не хочу его останавливать?

</P>
<P>
<strong>Ответ:</strong> Есть несколько возможностей. Если имеется резервная копия головного
сервера в некоторой точке, имя двоичного журнала и сдвиг (от вывода <code>SHOW
MASTER STATUS</code>), соответствующий образу, выполните следующие действия:

</P>

<ul>
<LI>

Удостоверьтесь, что подчиненному серверу назначен уникальный
идентификатор.

<LI>

Выполните  команды  <code>CHANGE MASTER TO MASTER_HOST='master-host-name',
MASTER_USER='master-user-name', MASTER_PASSWORD='master-pass',
MASTER_LOG_FILE='recorded-log-name', MASTER_LOG_POS=recorded_log_pos</code>

<LI>

Выполните команду <code>SLAVE START</code>
</ul>

<P>
Если нет резервной копии головного сервера, существует быстрый способ
создать ее в той же последовательности действий:

</P>

<ul>
<code>FLUSH TABLES WITH READ LOCK</code>

<LI>

<code>gtar zcf /tmp/backup.tar.gz /var/lib/mysql</code> (или разновидность данной
команды)

<LI>

<code>SHOW MASTER STATUS</code> - удостоверьтесь в том что вывод этой команды
сохранен - он пригодится позже

<LI>

<code>UNLOCK TABLES</code>
</ul>

<P>
После этого следуйте инструкциям для случая, когда имеется образ, имя
двоичного журнала и сдвиг. Можно использовать один и тот же образ для
конфигурации нескольких подчиненных серверов. Пока существуют двоичные
журналы головного сервера, установить подчиненный сервер можно через
несколько дней, а то и через месяц - при наличии образа головного сервера.
Теоретически промежуток ожидания может быть бесконечным. На практике
существуют два ограничения - дисковое пространство головного сервера,
которое будет занято старыми журналами, и время, которое потребуется
подчиненному серверу, чтобы догнать головной сервер.

</P>
<P>
В версии 4.0.0 и выше можно также использовать команду <code>LOAD DATA FROM
MASTER</code>. Это удобная команда, которая создает образ, восстанавливает его на
подчиненном сервере и сразу же корректирует имя журнала и сдвиг на
подчиненном сервере. Именно команду <code>LOAD DATA FROM MASTER</code> можно
рекомендовать как способ установки подчиненного сервера. Имейте в виду,
однако, что при использовании данной команды чтение может быть блокировано
на долгое время. В настоящее время эта команда еще не реализована
настолько эффективно, как бы нам хотелось. Если имеются большие таблицы,
пока лучше использовать локальный архив tar после выполнения команды <code>FLUSH
TABLES WITH READ LOCK</code>.

</P>
<P>
<code>В</code>: Должен ли подчиненный сервер постоянно быть подсоединен к головному
серверу?

</P>
<P>
<code>О</code>: Нет, не должен. Можно прекращать работу подчиненного сервера или
оставлять его отсоединенным на несколько часов или даже дней, затем
повторно подгонять подчиненный сервер к произошедшим обновлениям, и
затем снова отсоединять или останавливать его на некоторое время.
Таким образом можно, например, использовать установку
"головной-подчиненный"  через коммутационную связь, работающую в
течение коротких периодов времени. При такой реализации, однако,
нельзя гарантировать, что в какое-либо заданное время подчиненный
сервер будет синхронизирован с головным сервером, если вы для этого не
примете специальных мер. В будущем будет добавлена опция для
блокировки головного сервера до тех пор, пока хотя бы один подчиненный
сервер находится в синхронизации с ним.

</P>
<P>
<code>В</code>: Как заставить головной сервер блокировать обновления, пока
происходит соединение с подчиненным сервером?

</P>
<P>
<code>О</code>: Выполните следующие команды:

</P>

<ul>

<LI>

Головной  сервер: <code>FLUSH TABLES WITH READ LOCK</code>
<LI>

Головной сервер: <code>SHOW MASTER STATUS</code> - запомните имя журнала и сдвиг
<LI>

Подчиненный сервер: <code>SELECT MASTER_POS_WAIT('recorded_log_name',
recorded_log_offset</code>) После выполнения этой команды подчиненный сервер
будет синхронизирован с головным сервером
<LI>

Головной сервер: <code>UNLOCK TABLES</code> - теперь головной сервер может
продолжить обновления.
</ul>

<P>
<code>В</code>: Почему иногда после перезапуска подчиненного сервера я вижу более
одного потока <code>Binlog_Dump</code> на головном сервере?

</P>
<P>
<code>О:</code> Поток <code>Binlog_Dump</code> является непрерывным процессом, который
обрабатывается сервером следующим способом:

</P>

<ul>
<LI>

Осуществляется захват обновлений.

<LI>

Если не остается больше обновлений, входит в число
<code>pthread_cond_wait()</code>, откуда его можно "пробудить", выполнив
следующее обновление, или уничтожить.

<LI>

После пробуждения проверяется причина пробуждения. Если нет причины
прекращения цикла, цикл <code>Binlog_dump</code> продолжается.

<LI>

При возникновении какой-либо фатальной ошибки, такой как обнаружение
"мертвого" клиента, цикл прекращается.
</ul>

<P>
Таким образом, если поток подчиненного сервера прекратится на подчиненном
сервере, соответствующий поток <code>Binlog_Dump</code> на головном сервере не будет
замечать этого, пока не произойдет по крайней мере одного обновления на
головном сервере (или уничтожения потока), которое необходимо, чтобы
пробудить его из числа <code>pthread_cond_wait()</code>. Тем временем подчиненный
сервер может открыть другое соединение, результатом которого будет другой
поток <code>Binlog_Dump</code>.

</P>
<P>
Эта проблема не должна присутствовать в версии 3.23.26 и более поздних
версиях. В версии 3.23.26 для каждого репликационного сервера добавляется
идентификатор <code>server-id</code>, и теперь все старые процессы-зомби на головном
сервере уничтожаются при присоединении нового репликационного потока из
того же самого подчиненного сервера.

</P>
<P>
<code>В</code>: Как прокручивать журналы репликации?

</P>
<P>
<code>О</code>: В версии 3.23.28 нужно использовать команду <code>PURGE MASTER LOGS TO</code> после
определения тех журналов, которые должны быть удалены, и выборочно сделать
резервные копии этих журналов. В более ранних версиях этот процесс намного
более трудоемкий, и не может быть безопасно выполнен без остановки всех
подчиненных серверов, если планируется повторное использование имен
журналов. Нужно будет остановить потоки подчиненного сервера,
отредактировать индексный файл двоичного журнала, удалить все старые
журналы, перезапустить головной сервер, запустить потоки подчиненного
сервера и затем удалить файлы старых журналов.

</P>
<P>
<code>В</code>: Как сделать апгрейд сервера во время репликации?

</P>
<P>
<code>О</code>: Если модернизируемая версия ниже 3.23.26, нужно лишь блокировать
таблицы головного сервера, позволить подчиненному серверу подогнать
обновления, затем выполнить команду <code>FLUSH MASTER</code> на головном сервере и
команду <code>FLUSH SLAVE</code> на подчиненном сервере, чтобы очистить журналы,
затем перезапустить новые версии на головном и подчиненном серверах.
Обратите внимание: подчиненный сервер может останавливаться на
некоторое время - пока головной сервер записывает в журнал все
обновления, подчиненный сервер будет способен подогнать обновления как
только сможет начать работу и подсоединиться к головному серверу.

</P>
<P>
В версиях выше 3.23.26 осуществляется блокировка протокола репликации для
обновлений. Таким образом можно делать апгрейд до более свежей версии 3.23
головного и подчиненного серверов динамически. Помимо этого, на головном и
подчиненном серверах могут быть запущены различающиеся версии MySQL, если
обе версии выше 3.23.26.

</P>
<P>
<code>Q</code>: Какие проблемы могут возникать при установке двухсторонней
репликации?

</P>
<P>
<code>A</code>: В настоящее время для репликаций MySQL не поддерживается никакого
протокола блокировки между головным и подчиненным сервером, который
обеспечивал бы неделимость распределенных (междусерверных) обновлений.
Другими словами, клиент A может делать обновления на головном сервере
1, и в это же время, перед тем, как эти обновления скопируются на
головной сервер 2, клиент B может делать обновления на головном
сервере 2, из-за которых обновления клиента A будут выполняться не
так, как на головном сервере 1 компании. Таким образом, когда
обновления, сделанные клиентом A, будут перенесены на головной сервер
2, таблицы, полученные в результате, будут отличаться от таблиц на
головном сервере 1. В этом случае таблицы на двух серверах будут
разными, даже если обновления, произошедшие на головном сервере 2,
также будут скопированы на головной сервер 1. Отсюда следует, что не
стоит соединять в цепочку два сервера двусторонней репликационной
связью, если вы не уверены, что обновления будут безопасно выполняться
в любом порядке, или если вы не обрабатываете каким-либо образом такие
неупорядоченные обновления где-либо в клиентском коде.

</P>
<P>
Важно понять также и то, что если двухсторонний механизм репликации и
повышает производительность, то не настолько, что это могло бы отразиться
на обновлениях. Каждый из серверов должен выполнять такое же количество
обновлений, как и один сервер, разве что уменьшатся конфликты при
блокировках, потому что обновления, происходящие на другом сервере, будут
сериализованы в одном потоке подчиненного сервера. Эта выгода, тем не
менее, может быть компенсирована задержками в сети.

</P>
<P>
<A NAME="IDX836"></A>
<A NAME="IDX837"></A>
<code>Q</code>: Как использовать репликацию для повышения производительности
системы?

</P>
<P>
<code>A</code>: Установите один сервер как головной и направляйте все записи к
нему, а также сконфигурируйте такое количество подчиненных серверов,
на какое у вас хватит средств и дискового пространства, и распределите
чтение между головным сервером и подчиненными серверами. Можно также
запустить подчиненные серверы с опциями <code>--skip-bdb</code>,
<code>--low-priority-updates</code> и <code>--delay-key-write=ALL</code>, чтобы
получить увеличение скорости на подчиненном сервере. В данном случае
подчиненный сервер для повышения скорости будет использовать
нетранзакционные таблицы <code>MyISAM</code> вместо таблиц <code>BDB</code>.

</P>
<P>
<code>Q</code>: Что нужно сделать, чтобы подготовить свой клиентский код для
использования репликации, повышающей производительность?

</P>
<P>
<code>A</code>: Если та часть вашего кода, которая отвечает за доступ к базе
данных, является достаточно абстрактной и модульной, преобразование ее
для работы с установленной репликацией произойдет очень гладко и
просто - для этого нужно лишь изменить реализацию доступа для чтения к
базе данных от некоторого подчиненного сервера или головного сервера
так, чтобы запись всегда производилась на головной сервер. Если же ваш
код не имеет такого уровня абстракции, то установка системы репликации
окажется для вас хорошей и мотивированной возможностью почистить свой
код. Начните с создания библиотеки или оболочки со следующими
функциями:

</P>

<ul>
<LI><code>Safe_writer_connect()</code>

<LI><code>Safe_reader_connect()</code>

<LI><code>Safe_reader_query()</code>

<LI><code>Safe_writer_query()</code>

</ul>

<P>
Префикс <code>safe_</code> означает, что функция будет нести ответственность за
обработку всех возникающих ошибок.

</P>
<P>
После этого нужно преобразовать клиентский код так, чтобы он использовал
библиотеку  оболочки. Вначале все это покажется лишней головной болью, но
в конечном счете ваши усилия окупятся. Все приложения, построенные в
соответствии с приведенной выше схемой, смогут "приобщиться" к
преимуществам решения один головной/много подчиненных. Код будет гораздо
легче поддерживать, а добавление опций поиска неисправностей станет
тривиальным. К примеру, если вам захочется узнать, какой запрос среди
многих тысяч возвращает ошибку или реализовать регистрацию
продолжительности выполнения каждого запроса, то понадобится изменить
всего пару функций. Если у вас уже написано много кода, то для
автоматизации задачи его преобразования можно использовать написанную
Монти  утилиту <code>replace</code>, которая имеется в стандартном дистрибутиве MySQL,
или написать собственный сценарий на Perl. Остается надеяться, что ваш код
удовлетворяет некоторой распознаваемой схеме. В противном случае будет
лучше переписать его каким-либо образом, или, по крайней мере, вручную
подогнать его под схему.

</P>
<P>
Обратите внимание: имена функций, конечно же, можно использовать любые.
Важно иметь унифицированный интерфейс для подключения для чтения,
подсоединения для записи, выполнения чтения и выполнения записи.

</P>
<P>
<code>Q</code>: В каких случаях репликация MySQL может улучшить производительность
системы, и насколько?

</P>
<P>
<code>A</code>: Механизм репликации MySQL наиболее эффективен для системы, где чтение
производится часто, а запись - редко. Теоретически, используя установку
один головной/много подчиненных, можно наращивать ее, добавляя подчиненные
серверы, пока не исчерпается пропускная способность сети или количество
обновлений не вырастет настолько, что головной сервер не сможет
обрабатывать их.

</P>
<P>
Чтобы определить какое количество подчиненных серверов можно установить,
прежде чем выгоды от дополнительных ресурсов не перестанут оправдывать
затраты, и насколько увеличится производительность вашего сайта, нужно
знать структуру запросов и опытным путем (тестированием) определить связь
между производительностью чтения (количество считываний за секунду, или
<code>max_reads</code>) и записи (<code>max_writes</code>) на типовом головном сервере и типовом
подчиненном сервере. В приведенном примере показан достаточно упрощенный
подсчет того, что можно получить, используя механизм репликации для
предполагаемой системы.

</P>
<P>
Предположим, что загрузка системы состоит из 10% операций записи и 90%
операций чтения, и известно что <code>max_reads = 1200 - 2 * max_writes</code>, или
другими словами, наша система, не делая записей, может делать 1200
операций чтения за секунду, средняя скорость записи вдвое ниже, чем
средняя скорость чтения,  а зависимость между этими величинами линейная.
Предположим, что головной сервер и подчиненный сервер имеют одинаковую
мощность, и имеется N подчиненных серверов и 1 головной. Тогда для каждого
сервера (головного или подчиненного) имеем:

</P>
<P>
<code>reads = 1200 - 2 * writes</code> (по результатам тестирования)

</P>
<P>
<code>reads = 9 * writes / (N + 1)</code> (операции чтения распределяются по серверам,
но запись выполняются на всех серверах)

</P>
<P>
<code>9 * writes/(N+1) + 2 * writes = 1200</code>

</P>
<P>
<code>writes = 1200/(2 + 9/(N+1)</code>

</P>
<P>
Таким образом, если N = 0, что означает отсутствие репликации, система
может обрабатывать 1200/11, т.е. около 109 записей в секунду (а число
операций чтения, в соответствии с нашими допущениями для данной системы,
будет в 9 раз больше, чем число операций записи).

</P>
<P>
Если N = 1, можно получить 184 операций записи в секунду.

</P>
<P>
Если N = 8, можно получить до 400 операций записи в секунду.

</P>
<P>
Если N = 17, то - 480 операций записи в секунду.

</P>
<P>
В конечном счете, если N приближается к бесконечности (а бюджет к минус
бесконечности), можно получить около 600 записей в секунду, при этом
производительность системы увеличится приблизительно в 5,5 раз. Однако при
использовании лишь 8 серверов производительность уже увеличивается почти в
4 раза.

</P>
<P>
Обратите внимание: в приведенных вычислениях мы принимали, что сеть имеет
неограниченную пропускную способность, и пренебрегали некоторыми другими
факторами, которые могут оказаться существенными для системы. Во многих
случаях такие подсчеты могут и не дать точного прогноза того, как
отразится на системе добавление N подчиненных серверов. Однако определить,
улучшат ли репликации производительность вашей системы, а если да, то
насколько, вам помогут ответы на следующие вопросы:

</P>

<ul>
<LI>

Каково отношение числа операций чтения к числу операций записи в вашей
системе?

<LI>

Насколько увеличится количество записей, которые сможет обрабатывать
один сервер, при уменьшении количества операций чтения?

<LI>

Сколько подчиненных серверов можно установить при текущей пропускной
способности сети?
</ul>

<P>
<code>Q</code>: Как использовать репликацию для обеспечения избыточности и хорошей
доступности?

</P>
<P>
<code>A</code>: С учетом сегодняшних возможностей репликации нужно будет установить
головной сервер и подчиненный сервер (или несколько подчиненных
серверов), и написать сценарий для мониторинга головного сервера - для
определения, включен ли он, и уведомления приложения и подчиненных
серверов об изменениях головного сервера в случае ошибки. Ниже
приведено несколько советов:

</P>

<ul>
<LI>

Для уведомления подчиненного сервера об изменениях головного сервера
используйте команду <code>CHANGE MASTER TO</code>.

<LI>

Хороший способ информирования приложений о местоположении головного
сервера - иметь на головном сервере динамической компонент DNS. При
использовании <code>bind</code> для динамического обновления DNS можно применять
<code>nsupdate</code>.

<LI>

Запустите подчиненные серверы с опцией <code>log-bin</code>, но без
<code>log-slave-updates</code>. Таким образом подчиненный сервер будет готов стать
головным сервером после выполнения команд <code>STOP SLAVE; RESET MASTER</code> и 
<code>CHANGE MASTER TO</code>  на других подчиненных серверах. Указание этой опции 
обеспечит также возможность перехвата ложных обновлений, которые могут
происходить из-за ошибочной конфигурации подчиненного сервера (в
идеале можно настроить права доступа таким образом, чтобы никакой
клиент не мог производить обновления на подчиненном сервере иначе, чем
через поток подчиненного сервера) в сочетании с ошибками в клиентских
программах (они никогда не должны производить обновления на
подчиненном сервере непосредственно).
</ul>

<P>
В настоящее время мы работаем над интеграцией системы автоматического
выбора головного сервера в MySQL, но пока эта функция не будет готова,
придется создавать собственные средства контроля.

</P>

<P>
<strong>Q</strong>: Каким образом подчиненный сервер сохраняет информацию о том, где он находится на головном сервер? 

</P>
<P>
<strong>A</strong>: Подчиненный сервер использует файл в каталоге данных, определенный 
в опции <code>master-info-file=filename</code>. В этом файле находится вся информация, 
необходимая подчиненному сервер для запроса новых обновлений. Этот файл содержит следующую информацию: 

</P>
<TABLE BORDER WIDTH="100%">
<TR><TD><strong>Номер строки</strong> </TD><TD> <strong>Описание</strong>
</TD></TR>
<TR><TD>1 </TD><TD> Имя файла двоичного журнала
</TD></TR>
<TR><TD>2 </TD><TD> Позиция в файле журнала
</TD></TR>
<TR><TD>3 </TD><TD> Удаленный компьютер (головной сервер)
</TD></TR>
<TR><TD>4 </TD><TD> Пользователь
</TD></TR>
<TR><TD>5 </TD><TD> Пароль
</TD></TR>
<TR><TD>6 </TD><TD> Порт
</TD></TR>
<TR><TD>7 </TD><TD> Интервал в секундах между соединениями
</TD></TR>
</TABLE>



<H3><A NAME="Replication_Problems" HREF="manual.ru_toc.html#Replication_Problems">4.10.8  Поиск неисправностей репликации</A></H3>

<P>
Если вы следовали инструкциям, но установленный механизм репликации не
работает, прежде всего следует искать пользовательские ошибки. Выполните
следующие проверки:

</P>

<ul>
<LI>

Производит ли головной сервер записи в двоичный журнал? Проверьте это
при помощи команды <code>SHOW MASTER STATUS</code>. Если да, значение <code>Position</code>
будет отличным от нуля. Если нет, проверьте, запущен ли головной
сервер с опцией <code>log-bin</code> и установлен ли <code>server-id</code>.

<LI>

Запущен ли подчиненный сервер? Проверьте это при помощи команды <code>SHOW
SLAVE STATUS</code>. Ответ находится в столбце <code>Slave_running</code>. Если нет,
проверьте опции подчиненного сервера и просмотрите сообщения в журнале
ошибок.

<LI>

Если подчиненный сервер запущен, установил ли он соединение с головным
сервером? Выполните команду <code>SHOW PROCESSLIST</code>, найдите поток, которому
соответствует значение <code>system user</code> в столбце <code>User</code> и <code>none</code> в столбце
<code>Host</code>, и проверьте столбец <code>State</code>. Если в нем находится значение
<code>connecting to master</code>, проверьте привилегии для пользователя репликации
на головном сервере, имя хоста головного сервера, установку DNS,
посмотрите, запущен ли головной сервер в текущее время, доступен ли он
для подчиненного сервера. После этого, если все окажется в порядке,
просмотрите журналы ошибок.

<LI>

Если подчиненный сервер был запущен, но затем остановился, посмотрите
на вывод команды <code>SHOW SLAVE STATUS</code> и проверьте журналы ошибок. Такое
обычно случается, когда некоторый запрос, успешно выполняющийся на
головном сервере, не выполняется на подчиненном. Если создан
корректный образ головного сервера и данные на подчиненном сервере
обновлялись только через поток подчиненного сервера, этого происходить
не должно. Но если все же такое случилось - значит, имеет место
ошибка; как сообщить о ней, читайте ниже.

<LI>

Если запрос, успешно выполняемый на головном сервере, не выполняется
на подчиненном, и нельзя выполнить полную ресинхронизацию базы данных
(ее стоит выполнить), попробуйте сделать следующее:


<ul>
<LI>

Сначала проверьте: возможно где-либо случайно оказалась ненужная
запись. Разберитесь, как она оказалась там, затем удалите ее, и
выполните команду <code>SLAVE START</code>.

<LI>

Если вы проделали все, о чем написано выше, и ничего не помогло или
этого сделать нельзя, попытайтесь понять, будет ли безопасно выполнить
обновления вручную (если необходимо) и после этого игнорировать
следующий запрос от головного сервера.

<LI>

Если вы решили пропустить следующий запрос, выполните команды <code>SET GLOBAL
SQL_SLAVE_SKIP_COUNTER=1; SLAVE START;</code> чтобы пропустить запрос, не
использующий функции <code>AUTO_INCREMENT</code> или <code>LAST_INSERT_ID()</code>. В противном
случае выполните команды <code>SET GLOBAL SQL_SLAVE_SKIP_COUNTER=2; SLAVE START</code>.
Причина того, что запросы, использующие функции <code>AUTO_INCREMENT</code> или
<code>LAST_INSERT_ID()</code>, обрабатываются по-другому, заключается в том, что
они создают два события в двоичном журнале головного сервера.

<LI>

Если вы уверены, что подчиненный сервер был успешно запущен и
синхронизирован с головным сервером, а также что обновления таблиц не
производились вне потока подчиненного сервера, пришлите нам отчет об
ошибке, и вам не потребуется опять повторять описанные выше уловки.
</ul>

<LI>

Удостоверьтесь, что вы не внесли старой ошибки при апгрейде MySQL до
более новой версии.

<LI>

Если ничего не помогает, просмотрите журналы ошибок. Если журналы
большие, выполните команду <code>grep -i slave /path/to/your-log.err</code> на
подчиненном сервере. Искать ошибку на головном сервере - не лучшая
идея, поскольку в его журналах находятся лишь системные ошибки общего
характера; если это возможно, он посылает ошибку на подчиненный
сервер, когда что-либо происходит не так, как надо.
</ul>

<P>
Если вы убедились, что пользовательская ошибка здесь ни при чем, однако
механизм репликации по-прежнему не работает или работает нестабильно,
пришло время начать работу над отчетом об ошибке. Вы должны предоставить
нам столько информации, сколько нужно, чтобы отследить ошибку. Пожалуйста,
уделите отчету об ошибке нужное количество времени и усилий, чтобы сделать
его хорошо. В идеале мы хотели бы иметь контрольный пример в формате,
который находится в каталоге <tt>`mysql-test/t/rpl*'</tt> исходного дерева. Отослав
такой контрольный пример, в большинстве случаев можно рассчитывать на
получение патча в течение одного-двух дней, хотя, конечно, это время может
варьироваться в зависимости от множества факторов.

</P>
<P>
Еще один хороший способ проинформировать нас об ошибке - написать простую
программу с легко конфигурируемыми параметрами соединения для головного и
подчиненного серверов, в которой будет продемонстрирована проблема наших
систем. Программа может быть написана на Perl или на C, в зависимости от
того, какой язык вы знаете лучше.

</P>
<P>
Подготовив информацию об ошибке одним из двух способов, используйте
утилиту <code>mysqlbug</code>, чтобы создать отчет об ошибке, и пошлите его по адресу
<a HREF="mailto:bugs@lists.mysql.com">bugs@lists.mysql.com</a>. Если же вы имеете дело с фантомом - проблемой,
которая имеет место, но вы по какой-либо причине не можете ее
воспроизвести по желанию:

</P>

<ul>
<LI>

Убедитесь, что эта проблема не вызвана пользовательской ошибкой.
Например, при обновлении подчиненного сервера вне потока подчиненного
сервера данные будут не синхронизированы, и могут быть нарушения
уникальных ключей при обновлениях. В этом случае поток подчиненного
сервера остановится и будет ждать, пока таблицы не будут очищены
вручную, для приведения их в синхронизированный режим.

<LI>

Запустите подчиненный сервер с опциями <code>log-slave-updates</code> и <code>log-bin</code> -
при этом в журнал будет заноситься информация обо всех обновлениях,
происходящих на подчиненном сервере.

<LI>

Сохраните все доказательства наличия ошибки перед сбросом репликации.
Если у нас нет информации о проблеме, или имеется только отрывочная
информация, потребуется время, чтобы найти источник проблемы. Вы
должны собрать следующие "свидетельства":


<ul>
<LI>Все двоичные журналы головного сервера

<LI>Весь двоичный журнал подчиненного сервера

<LI>Вывод команды <code>SHOW MASTER STATUS</code> на головном сервере во время

обнаружения проблемы

<LI>Вывод команды <code>SHOW SLAVE STATUS</code> на головном сервере во время

обнаружения проблемы

<LI>Журналы ошибок головного сервера и подчиненного сервера

</ul>

<LI>

Для изучения двоичных журналов используйте утилиту <code>mysqlbinlog</code>. Таким
образом можно находить проблемные запросы, например:


<pre>
mysqlbinlog -j pos_from_slave_status /path/to/log_from_slave_status | head
</pre>

</ul>

<P>
Собрав "свидетельства" о проблеме-фантоме, попробуйте сначала
организовать их в отдельный контрольный пример. После этого сообщите о
проблеме по адресу <a HREF="mailto:bugs@lists.mysql.com">bugs@lists.mysql.com</a>, описав эту проблему во всех
подробностях.
<P><HR><P>
Go to the <A HREF="manual.ru_Introduction.html">first</A>, <A HREF="manual.ru_Tutorial.html">previous</A>, <A HREF="manual.ru_MySQL_Optimisation.html">next</A>, <A HREF="manual.ru_Concept_Index.html">last</A> section, <A HREF="manual.ru_toc.html">table of contents</A>.
 </BODY>
 </HTML>
