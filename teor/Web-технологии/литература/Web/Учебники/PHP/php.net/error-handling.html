<!doctype HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"><html><head><TITLE>Обработка Ошибок</TITLE>
<meta http-equiv="Content-Language" content="ru"><meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<LINK REL="stylesheet" HREF="style.css"></HEAD>
<body><TABLE BORDER="0" WIDTH="100%" HEIGHT="100%"><TR><TD COLSPAN="3">
<TABLE BGCOLOR="#CCCCFF" BORDER="0" WIDTH="100%"><TR><TD><TABLE WIDTH="100%" BORDER="0" CELLPADDING="3"><TR>
<TH COLSPAN="3">Учебник РНР</TH></TR><TR><TD WIDTH="10%"><A HREF="features.html">Назад</A></TD>
<TD WIDTH="80%"></TD><TD WIDTH="10%" ALIGN="right"><A HREF="images.html">Вперёд</A></TD></TR></TABLE>
</TD></TR><TR BGCOLOR="#333366"><TD><IMG SRC="imag/spacer.gif" BORDER="0" width="1" height="1"><BR>
</TD></TR></TABLE></TD></TR><TR><TD><IMG SRC="imag/spacer.gif" WIDTH="10" HEIGHT="1"></TD><TD HEIGHT="100%" VALIGN="TOP" WIDTH="100%">
<H1><A NAME="features.error-handling">Глава 15. Обработка ошибок</A></H1>
<P>В РНР есть несколько типов ошибок и предупреждений:<A NAME="AEN5669"></A><h6>Таблица 15-1. Типы ошибок PHP</h6><TABLE BORDER="1"><TR><TH>Значение</TH>
<TH>Константа</TH><TH>Описание</TH><TH>Примечание</TH></TR><TR><TD>1</TD><TD>E_ERROR</TD>
<TD>фатальные ошибки времени выполнения</TD><TD>&nbsp;</TD></TR><TR><TD>2</TD><TD>E_WARNING</TD>
<TD>предупреждения времени выполнения (нефатальные ошибки)</TD><TD>&nbsp;</TD></TR><TR><TD>4</TD>
<TD>E_PARSE</TD><TD>ошибки разбора времени компиляции</TD><TD>&nbsp;</TD></TR><TR><TD>8</TD>
<TD>E_NOTICE  </TD><TD>уведомления времени выполнения (менее серьёзные, чем предупреждения)</TD>
<TD>&nbsp;</TD></TR><TR><TD>16</TD><TD>E_CORE_ERROR</TD><TD>фатальные ошибки при начальном старте PHP</TD>
<TD>только PHP 4</TD></TR><TR><TD>32</TD><TD>E_CORE_WARNING</TD><TD>предупреждения (нефатальные ошибки) при начальном старте РНР</TD>
<TD>только PHP 4</TD></TR><TR><TD>64</TD><TD>E_COMPILE_ERROR</TD><TD>фатальные ошибки времени компиляции</TD>
<TD>только PHP 4</TD></TR><TR><TD>128</TD><TD>E_COMPILE_WARNING</TD><TD>предупреждения времени компиляции (нефатальные ошибки)</TD>
<TD>только PHP 4</TD></TR><TR><TD>256</TD><TD>E_USER_ERROR</TD><TD>генерируемое пользователем сообщение об ошибке</TD>
<TD>только PHP 4</TD></TR><TR><TD>512</TD><TD>E_USER_WARNING</TD><TD>генерируемое пользователем предупреждение</TD>
<TD>только PHP 4</TD></TR><TR><TD>1024</TD><TD>E_USER_NOTICE </TD><TD>генерируемое пользователем уведомление</TD>
<TD>только PHP 4</TD></TR><TR><TD>&nbsp;</TD><TD>E_ALL</TD><TD>всё вышеуказанное, как поддерживаемое</TD>
<TD>&nbsp;</TD></TR></TABLE>
<P>Вышеуказанные значения (цифровые или символьные) используются для построения 
битовой маски, которая специфицирует выводимое сообщение об ошибке. Вы можете 
использовать <a href="operators.bitwise.html">битовые 
операции</a> для маскирования определённых типов ошибок. Обратите внимание, 
что только&nbsp; '|', '~', '!' и '&#38;' будут понятны в <TT>php.ini</TT> и что никакие битовые
операции не будут понятны в <TT>php3.ini</TT>.</P>
<P>В PHP 4 значением по умолчанию для <A HREF="configuration.html#ini.error-reporting">error_reporting</A>
будет <TT>E_ALL &#38; ~E_NOTICE</TT>, что означает отображение всех ошибок и предупреждений, которые не имеют 
уровень E_NOTICE-level. В PHP 3 значение по умолчанию <TT>(E_ERROR | E_WARNING | E_PARSE)</TT>
означает то же самое. Заметьте, однако, что, поскольку константы не поддерживаются в PHP 3 в файле
<TT>php3.ini</TT>, установка <A HREF="configuration.html#ini.error-reporting">error_reporting</A>
должна выполняться цифрами; то есть <TT>7 </TT>по умолчанию.</P>
<P>Начальное значение может быть изменено в ini-файле директивой <A HREF="configuration.html#ini.error-reporting">
error_reporting</A>, в вашем Apache <TT>httpd.conf</TT>-файле директивой
php_error_reporting (php3_error_reporting для PHP 3) и, наконец, оно может 
быть установлено на этапе прогона скрипта функцией <A HREF="f/error-reporting.html">
<B>error_reporting()</B></A>.</P><TABLE CLASS="warning" BORDER="1" WIDTH="100%"><TR><th>Предупреждение!</th></TR>
<TR><TD><P>При обновлении кода или серверов с PHP 3 до PHP 4 вы должны проверить эти установки и вызовы
<B><A HREF="f/error-reporting.html">error_reporting()</A></B>, либо можете отключить
вывод сообщений о новых типах ошибок, особенно о E_COMPILE_ERROR.  
Это может привести к появлению пустых документов без какого-либо сообщения о причине и месте возникновения проблемы.</P>
</TD></TR></TABLE><P>Все <a href="expressions.html">выражения РНР</a> могут 
также вызываться с префиксом "@", который отключает сообщения об ошибках для 
данного конкретного выражения.  Если ошибка возникает в ходе вычисления такого выражения и
<A HREF="configuration.html#ini.track-errors">track_errors</A> включена,
вы можете найти сообщение об ошибке в глобальной переменной <TT>$php_errormsg</TT>.</P>
<BLOCKQUOTE><P><B>Примечание: </B>префикс <A HREF="operators.errorcontrol.html">@ error-control-операции</A>
не отключает вывод сообщений, которые являются результатом ошибок разбора.</P></BLOCKQUOTE>
<TABLE CLASS="warning" BORDER="1" WIDTH="100%"><TR><th>Предупреждение!</th></TR><TR><TD>
<P>В настоящее время префикс <A HREF="operators.errorcontrol.html">@ error-control-операции </A>
отключает даже сообщения о критических ошибках, которые прерывают выполнение 
скрипта. Помимо прочего, это означает, что, если вы используете
<A HREF="operators.errorcontrol.html">@</A> для подавления ошибок из определённой
функции и она недоступна или неправильно написана, скрипт накроется без указания причины.</P></TD></TR></TABLE>
<P>Ниже дан пример использования возможностей РНР по обработке ошибок. Мы 
определяем функцию обработки ошибок, которая записывает лог-информацию в файл (используя XML-формат) 
и уведомляет разработчика по e-mail при возникновении критической ошибки в логике.
<TABLE WIDTH="100%" BORDER="0"><TR><TD><h5><A NAME="AEN5769"></A>Пример 15-1. Обработка ошибок в скриптах</h5>
<TABLE BORDER="0" BGCOLOR="#E0E0E0" CELLPADDING="5"><TR><TD><PRE>&#60;?php
// делаем нашу собственную обработку ошибок
error_reporting(0);

// пользовательская функция обработки ошибок
function userErrorHandler ($errno, $errmsg, $filename, $linenum, $vars) {

    // штамп времени для вхождения ошибки
    $dt = date("Y-m-d H:i:s (T)");

    // определяем ассоциативный массив строки ошибки;
    // в реальности мы должны рассматривать только
    // 2,8,256,512 и 1024
    $errortype = array (
                1   =&#62;  "Error",
                2   =&#62;  "Warning!",
                4   =&#62;  "Parsing Error",
                8   =&#62;  "Notice",
                16  =&#62;  "Core Error",
                32  =&#62;  "Core Warning!",
                64  =&#62;  "Compile Error",
                128 =&#62;  "Compile Warning!",
                256 =&#62;  "User Error",
                512 =&#62;  "User Warning!",
                1024=&#62;  "User Notice"
                );
    // установить ошибки, для которых vartrace будет сохраняться
    $user_errors = array(E_USER_ERROR, E_USER_WARNING, E_USER_NOTICE);
    
    $err = "&#60;errorentry&#62;\n";
    $err .= "\t&#60;datetime&#62;".$dt."&#60;/datetime&#62;\n";
    $err .= "\t&#60;errornum&#62;".$errno."&#60;/errornum&#62;\n";
    $err .= "\t&#60;errortype&#62;".$errortype[$errno]."&#60;/errortype&#62;\n";
    $err .= "\t&#60;errormsg&#62;".$errmsg."&#60;/errormsg&#62;\n";
    $err .= "\t&#60;scriptname&#62;".$filename."&#60;/scriptname&#62;\n";
    $err .= "\t&#60;scriptlinenum&#62;".$linenum."&#60;/scriptlinenum&#62;\n";

    if (in_array($errno, $user_errors))
        $err .= "\t&#60;vartrace&#62;".wddx_serialize_value($vars,"Variables")."&#60;/vartrace&#62;\n";
    $err .= "&#60;/errorentry&#62;\n\n";
    
    // для тестирования
    // echo $err;

    // сохранить в error log и e-mail, если имеется критическая пользовательская ошибка
    error_log($err, 3, "/usr/local/php4/error.log");
    if ($errno == E_USER_ERROR)
        mail("phpdev@example.com","Critical User Error",$err);
}


function distance ($vect1, $vect2) {
    if (!is_array($vect1) || !is_array($vect2)) {
        trigger_error("Incorrect parameters, arrays expected", E_USER_ERROR);
        return NULL;
    }

    if (count($vect1) != count($vect2)) {
        trigger_error("Vectors need to be of the same size", E_USER_ERROR);
        return NULL;
    }

    for ($i=0; $i&#60;count($vect1); $i++) {
        $c1 = $vect1[$i]; $c2 = $vect2[$i];
        $d = 0.0;
        if (!is_numeric($c1)) {
            trigger_error("Coordinate $i in vector 1 is not a number, using zero", 
                            E_USER_WARNING);
            $c1 = 0.0;
        }
        if (!is_numeric($c2)) {
            trigger_error("Coordinate $i in vector 2 is not a number, using zero", 
                            E_USER_WARNING);
            $c2 = 0.0;
        }
        $d += $c2*$c2 - $c1*$c1;
    }
    return sqrt($d);
}

$old_error_handler = set_error_handler("userErrorHandler");

// неопределённая константа, генерируется предупреждение
$t = I_AM_NOT_DEFINED;

// определяем некоторые "векторы"
$a = array(2,3,"foo");
$b = array(5.5, 4.3, -1.6);
$c = array (1,-3);

// генерируется пользовательская ошибка
$t1 = distance($c,$b)."\n";

// генерируется ещё одна пользовательская ошибка
$t2 = distance($b,"i am not an array")."\n";

// генерируется предупреждение
$t3 = distance($a,$b)."\n";

?&#62;</PRE></TD></TR></TABLE></TD></TR></TABLE><p>Это лишь простой пример, показывающий, как использовать 
<A HREF="f/ref.errorfunc.html">Функции обработки ошибок и логинга</A>.</p>
<P>См. также <A HREF="f/error-reporting.html"><B>error_reporting()</B></A>,
<A HREF="f/error-log.html"><B>error_log()</B></A>,
<A HREF="f/set-error-handler.html"><B>set_error_handler()</B></A>,
<A HREF="f/restore-error-handler.html"><B>restore_error_handler()</B></A>, 
<A HREF="f/trigger-error.html"><B>trigger_error()</B></A>,
<A HREF="f/user-error.html"><B>user_error()</B></A></P></TD><TD><IMG SRC="imag/spacer.gif" WIDTH="10" HEIGHT="1">
</TD></TR><TR><TD COLSPAN="3"><TABLE BGCOLOR="#CCCCFF" BORDER="0" WIDTH="100%"><TR BGCOLOR="#333366"><TD>
<IMG SRC="imag/spacer.gif" BORDER="0" width="1" height="1"><BR></TD></TR><TR><TD>
<TABLE WIDTH="100%" BORDER="0" CELLPADDING="3"><TR><TD WIDTH="33%" VALIGN="top">
<A HREF="features.html">Назад</A></TD><th WIDTH="34%" VALIGN="top">
<A HREF="index.html">Оглавление</A></th><TD WIDTH="33%" ALIGN="right" VALIGN="top">
<A HREF="images.html">Вперёд</A></TD></TR><TR><TD WIDTH="33%" VALIGN="top">Возможности</TD>
<th WIDTH="34%" VALIGN="top"><a href="features.html">Вверх</a></th>
<TD WIDTH="33%" ALIGN="right" VALIGN="top">Создание изображений<br>и работа с ними</TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE>
</BODY></HTML>