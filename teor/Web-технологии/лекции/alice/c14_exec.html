<html>
<title>Выполнение команд на сервере и взаимодействие с СУБД</title>
<meta name=keywords content="">
<meta name=description content="">

<body>
<table align=center width=90%>
<tr><td>

<table align=center width=100%>
<tr>
<td width=33%><a href="c14_str.html" tppabs="http://alice.stup.ac.ru/~dvn/uproc/books/site_tarasov/c14_str.html">Переполнение буфера и работа со строками.</a>
<td width=33% align=center><a href="index.html" tppabs="http://alice.stup.ac.ru/~dvn/uproc/books/site_tarasov/index.html">Оглавление</a>
<td width=33% align=right><a href="c14_file.html" tppabs="http://alice.stup.ac.ru/~dvn/uproc/books/site_tarasov/c14_file.html">Работа с файловой системой.</a>
</table>



<h3>Выполнение команд на сервере, работа с файлами и СУБД</h3>
<p align="justify">
Помимо размера переменных необходимо проверять их актуальность, т.е. 
принадлежность к определенному типу данных и допустимому диапазону значений.
Например, рост, вес и цена не могут быть отрицательными, а адрес электронной
почты, адрес сайта и телефон имеют строго определенный формат и допустимый набор
символов. 
<br>
Наиболее важным и распространенным случаем проверки допустимости значения параметра
является использование данного параметра при выполнение команды на сервере, отправки 
запроса в базу данных или же при любом другом взаимодействие CGI-скрипта со внешней
средой. Совсем недавно мною была обнаружена такого рода ошибка на нашем веб-сайте
<a href="javascript:if(confirm('http://perl.org.ru/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://perl.org.ru/'" tppabs="http://perl.org.ru/">http://perl.org.ru</a>. На этом сайте уже более полугода
работал скрипт, который позволял получать справку по различным командам. <br>
<img src="c10perl.jpg" tppabs="http://alice.stup.ac.ru/~dvn/uproc/books/site_tarasov/images/c10perl.jpg"><br>
Посетитель 
сайта вводил команду в поле ввода и нажимал кнопку показать. Запрос отправлялся на сервер,
где CGI-скрипт выполнял команду 'man $userparam'. Параметр пользователя фильтровался на
разные спецсимволы типа "';| и т.п. Но на амперсанд (&) фильтра не было, поэтому когда
я ввел: "rm&&ls -l", мне после справки на команду rm, сервер выдал содержание текущей
директории. Два &&  для Unix shell служат разделителем команд, и Unix shell выполняет
команды разделенные && последовательно.
Злоумышленник дал бы другую команду: "ls&&rm -r /". Для тех, кто не знаком с
операционной системой Unix, 'rm -r /' означает рекурсивное удаление всех данных сервера.
В нашем случае такая команда не привела бы к полному удалению всех данных, т.к. данная
программа выполняется c правами определенного пользователя и были бы удалены только данные
этого пользователя.
Дмитрий Нечволод, специалист по информационной безопасности из 
Digital Infinity (http://diginf.ru), рассказал мне более интересную историю, когда
на сервере предоставляющем бесплатные акаунты типа chat.ru при регистрации в поле логин
он ввел что-то наподобие: "username&&rm -r /". В этом случае при заведение нового
пользователя CGI-скрипт должен работать с правами суперпользователя (администратора)
и в данном случае было удалено все содержимое сервера.
Далее приведен список символов, которые необходимо фильтровать при выполнение команд
в Unix shell: &;`'\"|*?~<>^()[]{}$\n\r. Еще лучше построить алгоритм фильтрации не по
принципу, что не запрещено, то разрешено, а наоборот, т.е. пропускать только допустимые
символы, например буквы и цифры. При вызове в языке Си функций system, popen и любых других,
тщательно проверяйте, что вы им передаете в качестве параметров, т.к. это наиболее страшная
дыра в безопасности CGI-программ. 
<br><br>
Особо хочется заострить внимание на связи с базами данных. При выполнении SQL-запросов
тоже необходимо производить фильтрацию CGI-параметров на допустимость значений, а также
экранировать спецсимволы. Например, при работе MS Access необходимо экранировать апостроф, заменяя
его на двойной апостроф. Помимо апострофа есть и другие спецсимволы языка SQL, например %.
В MySQL API есть функции mysql_escape_string и mysql_real_escape_string(), 
которые экранируют специальные символы в строке. Но эти функции экранируют только следующие символы в строке:
(ASCII 0), '\n', '\r', '\', ''', '"', и Control-Z. При использовании CGI-параметра в условии
WHERE или HAVING есть еще два символа, которые необходимо экранировать - это '%' и '_'.
При выполнении запроса SELECT * FROM tablename WHERE login='_fox' будет выдана не одна запись
со значением логина '_fox', а все записи с логинами из четырех символов, где последнии 
три символа fox. Если при выполнении запроса типа SELECT такого рода ошибка быстро обнаружится,
то при выполнении запроса типа DELETE, ошибка скорее всего будет обнаружена не сразу, и самое
главное, что последствия уже будут катастрофическими.



</table>
<table width="700" border="0" cellspacing="0" cellpadding="0" align="center" bgcolor="#FFFFFF">
  <tr> 
    <td align="left" rowspan="2" valign=bottom>
    <a href="javascript:if(confirm('http://rb2.design.ru/cgi-bin/href/itsoft?497  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://rb2.design.ru/cgi-bin/href/itsoft?497'" tppabs="http://rb2.design.ru/cgi-bin/href/itsoft?497" target=_top>
    <img src="itsoft-497" tppabs="http://rb2.design.ru/cgi-bin/banner/itsoft?497" width=100 height=100 border=0 alt="RB2 Network.">
    </a>
    <td align="center">

<script language="JavaScript">js=10;</script><script language="JavaScript1.1">
js=11;</script><script language="JavaScript1.2">js=12</script>
<script language="JavaScript1.3">js=13;</script>

<script language="JavaScript">
d=document;n=navigator;s=screen;d.cookie="testparam=testvalue";
d.write('<img width=1 height=1 src="http://itsoft.ru/common/counter?id=1' +
'&r='+escape(d.referrer)+
'&n='+escape(n.appName)+
'&v='+escape(navigator.appVersion)+
'&c='+(d.cookie?"1":"0")+
'&f='+((self!=top)?"1":"0")+
'&j='+(n.javaEnabled()?"1":"0")+
'&x='+s.width+
'&y='+s.height+
'&d='+(s.colorDepth?s.colorDepth:s.pixelDepth)+
'&js='+js+
'&o='+n.platform+'&'+Math.random()+'">');
</script>


<!--TopList COUNTER--> 
      <script language="JavaScript" type="text/javascript"><!--
d=document;js=10;a='';a+=';r='+escape(d.referrer)
//--></script>
      <script language="JavaScript1.1" type="text/javascript"><!--
js=11;a+=';j='+navigator.javaEnabled()
//--></script>
      <script language="JavaScript1.2" type="text/javascript"><!--
js=12;s=screen;a+=';s='+s.width+'*'+s.height
a+=';d='+(s.colorDepth?s.colorDepth:s.pixelDepth)
//--></script>
      <script language="JavaScript1.3" type="text/javascript"><!--
js=13//--></script>
      <script language="JavaScript" type="text/javascript"><!--
d.write('<img src="http://top.list.ru/counter'+
'?id=50234;js='+js+a+'" alt="" height=1 width=1>')
if(js>11)d.write('<'+'!-- ')//--></script>
      <noscript><img
src="counter-js=na;id=50234" tppabs="http://top.list.ru/counter?js=na;id=50234"
height=1 width=1 alt=""></noscript> 
      <script language="JavaScript" type="text/javascript"><!--
if(js>11)d.write('--'+'>')
//--></script>
      <!--TopList COUNTER-->

</td>
<td align="right"  rowspan="2" valign=bottom>
    <a href="javascript:if(confirm('http://rb2.design.ru/cgi-bin/href/itsoft?497  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://rb2.design.ru/cgi-bin/href/itsoft?497'" tppabs="http://rb2.design.ru/cgi-bin/href/itsoft?497" target=_top>
    <img src="itsoft-497" tppabs="http://rb2.design.ru/cgi-bin/banner/itsoft?497" width=100 height=100 border=0 alt="RB2 Network.">
    </a>
    
</td>
  </tr>
<tr><td align="center" style="font-size:9px; font-family:Verdana, Arial, Helvetica, sans-serif;">
<iframe src="itsoft-497-1" tppabs="http://rb1.rotabanner.com/cgi-bin/iframe/itsoft?497"
 width=468 height=60 marginwidth=0 marginheight=0 scrolling=no 
 frameborder=0><a href="javascript:if(confirm('http://rb1.rotabanner.com/cgi-bin/href/itsoft?497  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://rb1.rotabanner.com/cgi-bin/href/itsoft?497'" tppabs="http://rb1.rotabanner.com/cgi-bin/href/itsoft?497" 
 target=_top><img src="itsoft-497-2" tppabs="http://rb1.rotabanner.com/cgi-bin/banner/itsoft?497" 
 alt="RB1" width=468 height=60 border=0 ismap></a></iframe>

</body>
</html>