<html>
<title>Отображаем сообщения из базы</title>
<meta name=keywords content="ODBC MS Access SQL Visual C C++ MFC CDatabase CRecordset CGI">

<body>
<table align=center width=90%>
<tr><td>


<table align=center width=100%>
<tr>
<td width=33%><a href="c11_add.html" tppabs="http://alice.stup.ac.ru/~dvn/uproc/books/site_tarasov/c11_add.html">Добавляем сообщения в базу</a>
<td width=33% align=center><a href="index.html" tppabs="http://alice.stup.ac.ru/~dvn/uproc/books/site_tarasov/index.html">Оглавление</a>
<td width=33% align=right><a href="c11_sql.html" tppabs="http://alice.stup.ac.ru/~dvn/uproc/books/site_tarasov/c11_sql.html">Выполняем SQL-запросы к базе данных</a>
</table>


<h3>Отображаем сообщения из базы</h3>
<p align=justify>
Следующим шагом будет написание CGI-программы, которая выдает сообщения из 
базы данных. Вызываться эта программа будет несколько иначе. Добавьте
в файл /gb/index.html после HTML-формы следующую строчку:
<pre>
&lt;!--#include virtual="/cgi-bin/gbshow.exe?dsn=gb"--&gt;
</pre>
<p align=justify>
При запросе пользователем файла /gb/index.html будет вызвана CGI-программа
/cgi-bin/gbshow.exe и ей методом GET будет передан параметр dsn. Более подробно 
технологию Server Side Includes мы рассматривали в шестой главе.
<br>
Описанным выше образом создайте проект с названием gbshow.
Код функции _tmain приведен ниже:
<pre>
#include &lt;itcgi.h&gt;

CWinApp theApp;

using namespace std;


int _tmain(int argc, TCHAR* argv[], TCHAR* envp[])
{
//Если не удается подключить библиотеку MFC, то завершаем работу
        if (!AfxWinInit(::GetModuleHandle(NULL), NULL, ::GetCommandLine(), 0))
        return -1;



CDatabase  db; //объект db для связи с базой данных
CString dsn;   // dsn нашей базы данных и SQL-запрос
CString HTML;  //шаблон HTML-сообщения


//dsn получаем из CGI-запроса, см. выше 
GetParamByName("dsn", dsn);


//соединяемся с базой данных
//в случае ошибки переходим на метку LABEL_END см. ниже
try
{
 db.OpenEx("DSN="+dsn, CDatabase::noOdbcDialog);
}
catch(CDBException* e) 
{
 //Если не удалось соединится с базой, выдаем сообщение
 //об ошибке и выходим.

 printError("Error: %s\nState: %s\n", e-&gt;m_strError, e-&gt;m_strStateNativeOrigin);
 goto LABEL_END;
}


//Инициализируем HTML-шаблон сообщения
HTML="&lt;br&gt;&lt;br&gt;\
&lt;table align=center width=100% bgcolor=#000000 cellspacing=1 cellpadding=2&gt;\
&lt;tr&gt;\
    &lt;td bgcolor=#EEEEEE  width=85%&gt;&lt;img src=\"%%smile%%\"&gt; %%subj%%\
&lt;tr&gt;\
   &lt;td bgcolor=#FFFFFF&gt;\
      &lt;p align=justify&gt;%%it_text%%\
      &lt;div align=right&gt;%%it_date%%&lt;br&gt;\
      &lt;a href=\"mailto:%%email%%\"&gt;%%name%%&lt;/a&gt;&lt;br&gt;\
      &lt;a href=\"http://%%http%%\"&gt;http://%%http%%&lt;/a&gt;\
      &lt;/div&gt;\
&lt;/table&gt;";


//печатаем HTTP-заголовок
printf("Content-type: text/html\n\n");

//получаем записи из таблицы базы данных
//первый параметр db - объект для связи с базой
//второй SQL-запрос
//третий HTML-шаблон одной записи, в шаблоне названия
//полей должны соответствовать названиям в таблице базы данных
//поля в шаблоне могут идти в любом порядке и повторяться несколько раз
GetHTMLFromSQL(db, "SELECT * FROM message", HTML, 0);

//после выполнения функции GetHTMLFromSQL
// в переменной HTML будет сохранен результат SQL-запроса

printf("%s", HTML);



LABEL_END:
if (db.IsOpen())
         db.Close();

return 0;
}
</pre>

Соберите проект и скопируйте файл gbshow.exe в папку /cgi-bin вашего веб-сайта.
В броузере откройте страницу гостевой книги http://yoursite.ru/gb/index.html и вы увидите сообщения
из гостевой книги. 



</table>
<table width="700" border="0" cellspacing="0" cellpadding="0" align="center" bgcolor="#FFFFFF">
  <tr> 
    <td align="left" rowspan="2" valign=bottom>
<!-- Russian LinkExchange code START - BANNER #1 (100x100)-->
  <iframe src="erle.cgi-69019-bn=0-9252" tppabs="http://10e2.linkexchange.ru/cgi-bin/erle.cgi?69019-bn=0?9252" 
  frameborder=0 vspace=0 hspace=0 width=100 height=100 
  marginwidth=0 marginheight=0 scrolling=no>
  <a href="javascript:if(confirm('http://10e2.linkexchange.ru/users/069019/goto.map?bn=0  \n\nThis file was not retrieved by Teleport Pro, because it did not meet the project\'s file type specifications.  \n\nDo you want to open it from the server?'))window.location='http://10e2.linkexchange.ru/users/069019/goto.map?bn=0'" tppabs="http://10e2.linkexchange.ru/users/069019/goto.map?bn=0" target=_top> 
  <img src="rle.cgi-69019-bn=0-9252" tppabs="http://10e2.linkexchange.ru/cgi-bin/rle.cgi?69019-bn=0?9252"
  alt="RLE Banner Network" border=0 height=100 width=100></a> 
  </iframe> 
<!-- Russian LinkExchange code END --> 
    <td align="center">

<script language="JavaScript">js=10;</script><script language="JavaScript1.1">
js=11;</script><script language="JavaScript1.2">js=12</script>
<script language="JavaScript1.3">js=13;</script>

<script language="JavaScript">
d=document;n=navigator;s=screen;d.cookie="testparam=testvalue";
d.write('<img width=1 height=1 src="http://itsoft.ru/common/counter?id=1' +
'&r='+escape(d.referrer)+
'&n='+escape(n.appName)+
'&v='+escape(navigator.appVersion)+
'&c='+(d.cookie?"1":"0")+
'&f='+((self!=top)?"1":"0")+
'&j='+(n.javaEnabled()?"1":"0")+
'&x='+s.width+
'&y='+s.height+
'&d='+(s.colorDepth?s.colorDepth:s.pixelDepth)+
'&js='+js+
'&o='+n.platform+'&'+Math.random()+'">');
</script>


<!--TopList COUNTER--> 
      <script language="JavaScript" type="text/javascript"><!--
d=document;js=10;a='';a+=';r='+escape(d.referrer)
//--></script>
      <script language="JavaScript1.1" type="text/javascript"><!--
js=11;a+=';j='+navigator.javaEnabled()
//--></script>
      <script language="JavaScript1.2" type="text/javascript"><!--
js=12;s=screen;a+=';s='+s.width+'*'+s.height
a+=';d='+(s.colorDepth?s.colorDepth:s.pixelDepth)
//--></script>
      <script language="JavaScript1.3" type="text/javascript"><!--
js=13//--></script>
      <script language="JavaScript" type="text/javascript"><!--
d.write('<img src="http://top.list.ru/counter'+
'?id=50234;js='+js+a+'" alt="" height=1 width=1>')
if(js>11)d.write('<'+'!-- ')//--></script>
      <noscript><img
src="counter-js=na;id=50234" tppabs="http://top.list.ru/counter?js=na;id=50234"
height=1 width=1 alt=""></noscript> 
      <script language="JavaScript" type="text/javascript"><!--
if(js>11)d.write('--'+'>')
//--></script>
      <!--TopList COUNTER-->

</td>
<td align="right"  rowspan="2" valign=bottom>
<!-- Russian LinkExchange code START - BANNER #2 (100x100)-->
  <iframe src="erle.cgi-69019-bn=1-Rnd_Num" tppabs="http://10e2.linkexchange.ru/cgi-bin/erle.cgi?69019-bn=1?Rnd_Num" 
  frameborder=0 vspace=0 hspace=0 width=100 height=100 
  marginwidth=0 marginheight=0 scrolling=no>
  <a href="javascript:if(confirm('http://10e2.linkexchange.ru/users/069019/goto.map?bn=1  \n\nThis file was not retrieved by Teleport Pro, because it did not meet the project\'s file type specifications.  \n\nDo you want to open it from the server?'))window.location='http://10e2.linkexchange.ru/users/069019/goto.map?bn=1'" tppabs="http://10e2.linkexchange.ru/users/069019/goto.map?bn=1" target=_top> 
  <img src="rle.cgi-69019-bn=1-Rnd_Num" tppabs="http://10e2.linkexchange.ru/cgi-bin/rle.cgi?69019-bn=1?Rnd_Num" 
  alt="RLE Banner Network" border=0 height=100 width=100></a> 
  </iframe> 
<!-- Russian LinkExchange code END --> 
    
</td>
  </tr>
<tr><td align="center" style="font-size:9px; font-family:Verdana, Arial, Helvetica, sans-serif;">
<iframe src="erle.cgi-51599-9252" tppabs="http://www.linkexchange.ru/cgi-bin/erle.cgi?51599?9252" frameborder=0 
    vspace=0 hspace=0 width=468 height=60 marginwidth=0 marginheight=0 scrolling=no>
    <a href="javascript:if(confirm('http://www.linkexchange.ru/users/goto.map  \n\nThis file was not retrieved by Teleport Pro, because it did not meet the project\'s file type specifications.  \n\nDo you want to open it from the server?'))window.location='http://www.linkexchange.ru/users/goto.map'" tppabs="http://www.linkexchange.ru/users/goto.map" target=_top>
    <img src="rle.cgi-51599-9252" tppabs="http://www.linkexchange.ru/cgi-bin/rle.cgi?51599?9252" alt="RLE Banner Network" border=0 height=60 width=468></a>
    </iframe>

<!-- Russian LinkExchange code START - BANNER #1 (120x60)-->
  <iframe src="erle.cgi-69021-bn=0-9252" tppabs="http://btn2.linkexchange.ru/cgi-bin/erle.cgi?69021-bn=0?9252"
  frameborder=0 vspace=0 hspace=0 width=120 height=60 
  marginwidth=0 marginheight=0 scrolling=no>
  <a href="javascript:if(confirm('http://btn2.linkexchange.ru/users/069021/goto.map?bn=0  \n\nThis file was not retrieved by Teleport Pro, because it did not meet the project\'s file type specifications.  \n\nDo you want to open it from the server?'))window.location='http://btn2.linkexchange.ru/users/069021/goto.map?bn=0'" tppabs="http://btn2.linkexchange.ru/users/069021/goto.map?bn=0" target=_top> 
  <img src="rle.cgi-69021-bn=0-9252" tppabs="http://btn2.linkexchange.ru/cgi-bin/rle.cgi?69021-bn=0?9252"
  alt="RLE Banner Network" border=0 height=60 width=120></a> 
  </iframe> 
<!-- Russian LinkExchange code END --> 
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<!-- Russian LinkExchange code START - BANNER #2 (120x60)-->
  <iframe src="erle.cgi-69021-bn=1-9252" tppabs="http://btn2.linkexchange.ru/cgi-bin/erle.cgi?69021-bn=1?9252"
  frameborder=0 vspace=0 hspace=0 width=120 height=60 
  marginwidth=0 marginheight=0 scrolling=no>
  <a href="javascript:if(confirm('http://btn2.linkexchange.ru/users/069021/goto.map?bn=1  \n\nThis file was not retrieved by Teleport Pro, because it did not meet the project\'s file type specifications.  \n\nDo you want to open it from the server?'))window.location='http://btn2.linkexchange.ru/users/069021/goto.map?bn=1'" tppabs="http://btn2.linkexchange.ru/users/069021/goto.map?bn=1" target=_top> 
  <img src="rle.cgi-69021-bn=1-9252" tppabs="http://btn2.linkexchange.ru/cgi-bin/rle.cgi?69021-bn=1?9252"
  alt="RLE Banner Network" border=0 height=60 width=120></a> 
  </iframe> 
<!-- Russian LinkExchange code END --> 
</td></tr>
</table>

</body>
</html>