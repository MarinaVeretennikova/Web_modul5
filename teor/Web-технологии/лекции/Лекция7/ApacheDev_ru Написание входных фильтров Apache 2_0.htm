<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0060)http://www.apachedev.ru/modules.php?name=Pages&go=page&pid=8 -->
<HTML><HEAD><TITLE>ApacheDev.ru Написание входных фильтров Apache 2.0</TITLE>
<META content="text/html; charset=windows-1251" http-equiv=Content-Type>
<META content=0 http-equiv=EXPIRES>
<META content=DOCUMENT name=RESOURCE-TYPE>
<META content=GLOBAL name=DISTRIBUTION>
<META content=ApacheDev.ru name=AUTHOR>
<META content="Copyright (c) by ApacheDev.ru" name=COPYRIGHT>
<META 
content="Apache, apache, Апач, апач, настройка apache, разработка под apache, модули apache, module, modules, mod, скачать apache, установка apache, php, mysql, настройка сервера apache, http server, ant, cocoon, db, excalibur, forrest, geronimo, gump, incubator, xml, http сервер, http, https, apache download, apache 2.0, asp apache, сервер, server, ssh, документация apache, взлом apache, устройство apache, perl, active perl, apache win32, ssi, apache server, ssl, conf, tomcat, APR, apr, htaccess, opensll, phpmyadmin, php4, mod_perl, httpd, webalizer, webdav, php3, mod_ssl, apache2, activeperl, mod_dav, http, cgi, contents, virtual host, postgresql, redirect, localhost, allow, cocoon, jakarta, deny, 8080, tomcat, mod_gzip, standalone" 
name=KEYWORDS>
<META 
content="Это пятая статья Райна Блума (Ryan Bloom). Рассказывает о написании входных фильтров для Apache 2.0." 
name=DESCRIPTION>
<META content="INDEX, FOLLOW" name=ROBOTS>
<META content="1 DAYS" name=REVISIT-AFTER>
<META content=GENERAL name=RATING>
<META content="MSHTML 5.00.3700.6699" name=GENERATOR><LINK 
href="ApacheDev_ru Написание входных фильтров Apache 2_0.files/style.css" 
rel=StyleSheet type=text/css></HEAD>
<BODY aLink=#d5ae83 bgColor=#ffffff link=#363636 text=#000000 
vLink=#363636><BR><BR>
<TABLE align=center bgColor=#ffffff border=0 cellPadding=0 cellSpacing=0 
width=750>
  <TBODY>
  <TR>
    <TD bgColor=#f3e1af><IMG 
  src="themes/Karate/images/tophighlight.gif"></TD></TR></TBODY></TABLE>
<TABLE align=center bgColor=#ffffff border=0 cellPadding=0 cellSpacing=0 
width=750>
  <TBODY>
  <TR vAlign=center>
    <TD align=left bgColor=#f3e1af width=400>&nbsp;<A 
      href="http://www.apachedev.ru/index.php" 
      style="FONT-SIZE: 12px; FONT-WEIGHT: bold; TEXT-DECORATION: none"><IMG 
      alt="Welcome to ApacheDev.ru!" 
    src="themes/ApacheDev/images/logo.gif"></A></TD></TR></TBODY></TABLE>
<TABLE align=center bgColor=#fefefe border=0 cellPadding=0 cellSpacing=0 
width=750>
  <TBODY>
  <TR>
    <TD bgColor=#000000 colSpan=4><IMG alt="" border=0 height=1 hspace=0 
      src="themes/ApacheDev/images/pixel.gif" width=1></TD></TR>
  <TR bgColor=#efce6b vAlign=center>
    <TD noWrap width="15%">
      <FORM action=modules.php?name=Search method=post><FONT class=content 
      color=#000000><B>&nbsp;Поиск </B><INPUT name=query 
    size=14></FONT></FORM></TD>
    <TD align=middle height=20 width="60%"><FONT class=content>&nbsp; </FONT>
    <TD align=right width="25%"><FONT class=content>
      <SCRIPT type=text/javascript>

<!--   // Array ofmonth Names
var monthNames = new Array( "January","February","March","April","May","June","July","August","September","October","November","December");
var now = new Date();
thisYear = now.getYear();
if(thisYear < 1900) {thisYear += 1900}; // corrections if Y2K display problem
document.write(monthNames[now.getMonth()] + " " + now.getDate() + ", " + thisYear);
// -->

</SCRIPT>
      </FONT></TD>
    <TD>&nbsp;</TD></TR>
  <TR>
    <TD bgColor=#000000 colSpan=4><IMG alt="" border=0 height=1 hspace=0 
      src="themes/ApacheDev/images/pixel.gif" width=1></TD></TR></TBODY></TABLE>
<TABLE align=center bgColor=#ffffff border=0 cellPadding=0 cellSpacing=0 
width=750>
  <TBODY>
  <TR vAlign=top>
    <TD bgColor=#f3e1af><IMG alt="" border=0 height=3 
      src="themes/ApacheDev/images/pixel.gif" width=1></TD></TR>
  <TR vAlign=top>
    <TD bgColor=#ffffff><IMG alt="" border=0 height=5 
      src="themes/ApacheDev/images/pixel.gif" width=1></TD></TR></TBODY></TABLE><BR>
<TABLE align=center bgColor=#ffffff border=0 cellPadding=0 cellSpacing=0 
width=750>
  <TBODY>
  <TR vAlign=top>
    <TD bgColor=#eeeeee vAlign=top width=150>
      <TABLE bgColor=#000000 border=0 cellPadding=1 cellSpacing=0 width=150>
        <TBODY>
        <TR>
          <TD>
            <TABLE bgColor=#f3e1af border=0 cellPadding=3 cellSpacing=0 
            width="100%">
              <TBODY>
              <TR>
                <TD align=left><FONT class=content 
                  color=#363636><B>Навигация</B></FONT> 
        </TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
      <TABLE border=0 cellPadding=3 cellSpacing=0 width=150>
        <TBODY>
        <TR vAlign=top>
          <TD><STRONG><BIG>·</BIG></STRONG> <A 
            href="http://www.apachedev.ru/index.php">Главная</A><BR><STRONG><BIG>·</BIG></STRONG> 
            <A 
            href="http://www.apachedev.ru/modules.php?name=Topics">Новости</A><BR><STRONG><BIG>·</BIG></STRONG> 
            <A 
            href="http://www.apachedev.ru/modules.php?name=Pages">Статьи</A><BR><STRONG><BIG>·</BIG></STRONG> 
            <A href="http://www.apachedev.ru/modules.php?name=Files">Каталог 
            файлов</A><BR><STRONG><BIG>·</BIG></STRONG> <A 
            href="http://www.apachedev.ru/modules.php?name=Web_Links">Ссылки</A><BR><STRONG><BIG>·</BIG></STRONG> 
            <A 
            href="http://www.apachedev.ru/modules.php?name=Search">Поиск</A><BR><STRONG><BIG>·</BIG></STRONG> 
            <A 
            href="http://www.apachedev.ru/modules.php?name=Feedback">Контакт</A> 
          </TD></TR></TBODY></TABLE><BR>
      <TABLE bgColor=#000000 border=0 cellPadding=1 cellSpacing=0 width=150>
        <TBODY>
        <TR>
          <TD>
            <TABLE bgColor=#f3e1af border=0 cellPadding=3 cellSpacing=0 
            width="100%">
              <TBODY>
              <TR>
                <TD align=left><FONT class=content 
                  color=#363636><B>Рекомендуем</B></FONT> 
        </TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
      <TABLE border=0 cellPadding=3 cellSpacing=0 width=150>
        <TBODY>
        <TR vAlign=top>
          <TD>
            <DIV align=center>
            <SCRIPT type=text/javascript><!--
google_ad_client = "pub-1719997141905626";
google_ad_width = 120;
google_ad_height = 240;
google_ad_format = "120x240_as";
google_ad_type = "text";
google_ad_channel ="";
google_color_border = "000000";
google_color_bg = "F0F0F0";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></SCRIPT>

            <SCRIPT 
            src="ApacheDev_ru Написание входных фильтров Apache 2_0.files/show_ads.js" 
            type=text/javascript>
</SCRIPT>
            </DIV></TD></TR></TBODY></TABLE><BR>
      <TABLE bgColor=#000000 border=0 cellPadding=1 cellSpacing=0 width=150>
        <TBODY>
        <TR>
          <TD>
            <TABLE bgColor=#f3e1af border=0 cellPadding=3 cellSpacing=0 
            width="100%">
              <TBODY>
              <TR>
                <TD align=left><FONT class=content 
                  color=#363636><B>Правописание</B></FONT> 
          </TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
      <TABLE border=0 cellPadding=3 cellSpacing=0 width=150>
        <TBODY>
        <TR vAlign=top>
          <TD>
            <CENTER><IFRAME frameBorder=0 height=31 id=orphus scrolling=no 
            src="ApacheDev_ru Написание входных фильтров Apache 2_0.files/ads.htm" 
            width=88></IFRAME><BR>Выделите в тексте ошибку и нажмите 
            Ctrl+Enter</CENTER></TD></TR></TBODY></TABLE><BR>
      <TABLE bgColor=#000000 border=0 cellPadding=1 cellSpacing=0 width=150>
        <TBODY>
        <TR>
          <TD>
            <TABLE bgColor=#f3e1af border=0 cellPadding=3 cellSpacing=0 
            width="100%">
              <TBODY>
              <TR>
                <TD align=left><FONT class=content 
                  color=#363636><B>Статистика</B></FONT> 
        </TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
      <TABLE border=0 cellPadding=3 cellSpacing=0 width=150>
        <TBODY>
        <TR vAlign=top>
          <TD>
            <DIV align=center><!-- SpyLOG f:0211 -->
            <SCRIPT language=javascript><!--
Md=document;Mnv=navigator;Mp=1;
Mn=(Mnv.appName.substring(0,2)=="Mi")?0:1;Mrn=Math.random();
Mt=(new Date()).getTimezoneOffset();
Mz="p="+Mp+"&rn="+Mrn+"&t="+Mt;
Md.cookie="b=b";Mc=0;if(Md.cookie)Mc=1;Mz+='&c='+Mc;
Msl="1.0";
//--></SCRIPT>

            <SCRIPT language=javascript1.1><!--
Mpl="";Msl="1.1";Mj = (Mnv.javaEnabled()?"Y":"N");Mz+='&j='+Mj;
//--></SCRIPT>

            <SCRIPT language=javascript1.2><!--         
Msl="1.2";
//--></SCRIPT>

            <SCRIPT language=javascript1.3><!--
Msl="1.3";//--></SCRIPT>

            <SCRIPT language=javascript><!--
Mu="u6485.81.spylog.com";My="";
My+="<a href='http://"+Mu+"/cnt?cid=648581&f=3&p="+Mp+"&rn="+Mrn+"' target='_blank'>";
My+="<img src='http://"+Mu+"/cnt?cid=648581&"+Mz+"&sl="+Msl+"&r="+escape(Md.referrer)+"&pg="+escape(window.location.href)+"' border=0  width=88 height=31  alt='SpyLOG'>";
My+="</a>";Md.write(My);//--></SCRIPT>
            <NOSCRIPT><A 
            href="http://u6485.81.spylog.com/cnt?cid=648581&amp;f=3&amp;p=1" 
            target=_blank><IMG alt=SpyLOG border=0 height=31 
            src="http://u6485.81.spylog.com/cnt?cid=648581&amp;p=1" width=88> 
            </A></NOSCRIPT><!-- SpyLOG  -->
            <DIV></DIV></DIV></TD></TR></TBODY></TABLE><BR>
      <TABLE bgColor=#000000 border=0 cellPadding=1 cellSpacing=0 width=150>
        <TBODY>
        <TR>
          <TD>
            <TABLE bgColor=#f3e1af border=0 cellPadding=3 cellSpacing=0 
            width="100%">
              <TBODY>
              <TR>
                <TD align=left><FONT class=content 
                  color=#363636><B>Экспорт</B></FONT> 
        </TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
      <TABLE border=0 cellPadding=3 cellSpacing=0 width=150>
        <TBODY>
        <TR vAlign=top>
          <TD>
            <DIV align=center><A href="http://www.apachedev.ru/export.xml"><IMG 
            border=0 src="/images/rss.gif"></A></DIV></TD></TR></TBODY></TABLE><BR></TD>
    <TD><IMG alt="" border=0 height=1 src="themes/Karate/images/pixel.gif" 
      width=15></TD>
    <TD width="100%">
      <TABLE bgColor=#efce68 border=0 cellPadding=0 cellSpacing=1 
        width="100%"><TBODY>
        <TR>
          <TD>
            <TABLE bgColor=#efefef border=0 cellPadding=8 cellSpacing=1 
            width="100%">
              <TBODY>
              <TR>
                <TD>
                  <CENTER>
                  <FORM name=gocat>
                  <TABLE>
                    <TBODY>
                    <TR>
                      <TD><SELECT name=cat 
                        onchange=location.href=gocat.cat.options[selectedIndex].value><OPTION 
                          selected value="">Выбор категории</OPTION><OPTION 
                          value=modules.php?name=Pages&amp;go=showcat&amp;cid=16>The 
                          Apache Modeling Project</OPTION><OPTION 
                          value=modules.php?name=Pages&amp;go=showcat&amp;cid=5>Архитектура 
                          Apache</OPTION><OPTION 
                          value=modules.php?name=Pages&amp;go=showcat&amp;cid=17>Безопасность</OPTION><OPTION 
                          value=modules.php?name=Pages&amp;go=showcat&amp;cid=6>Модули 
                          Apache</OPTION><OPTION 
                          value=modules.php?name=Pages&amp;go=showcat&amp;cid=14>Основы 
                          Apache</OPTION><OPTION 
                          value=modules.php?name=Pages>Начало 
                        раздела</OPTION></SELECT></TD></TR></TBODY></TABLE></FORM>
                  <HR>
                  <B>Основы Apache</B><BR>Установка. Настройка. Базовые 
                  принципы.</CENTER></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE><BR>
      <TABLE bgColor=#efce68 border=0 cellPadding=0 cellSpacing=1 
        width="100%"><TBODY>
        <TR>
          <TD>
            <TABLE bgColor=#efefef border=0 cellPadding=8 cellSpacing=1 
            width="100%">
              <TBODY>
              <TR>
                <TD>
                  <H2 align=center>Написание входных фильтров Apache 2.0</H2>
                  <P align=left>Автор: Райн Блум (Ryan Bloom)<BR>Перевод: 
                  ApacheDev.ru <BR></P>
                  <DIV align=right><A 
                  href="http://www.apachedev.ru/%20http://www.onlamp.com/pub/a/apache/2001/09/20/apache_2.html">Оригинал 
                  статьи</A></DIV>
                  <P>В предыдущих двух статьях мы обсуждали написание выходных 
                  фильтров для Apache 2.0. В этой статье, мы сфокусируемся на 
                  входных фильтрах. Эти два типа фильтров очень похожи и много 
                  концепций, которые мы уже рассмотрели для выходных фильтров, 
                  могут быть успешно перенесены на входные фильтры. Тем не 
                  менее, входные фильтры достаточно отличаются от выходных, 
                  поэтому важно посвятить им отдельную статью. </P>
                  <P>Первое отличие между входными и выходными фильтрами 
                  заключается в том, что существует два различных типа входных 
                  фильтров - те, которые фильтруют запрос полностью и те, 
                  которые фильтруют только тела запросов. То есть разработчик в 
                  первом случае может фильтровать как заголовки, так и тело 
                  запроса, тогда как во втором случае можно фильтровать только 
                  тело запроса. Пример, который мы рассмотрим сегодня, изменяет 
                  заголовки каждого запроса. </P>
                  <P>Второе отличие заключается в вызове фильтров. Функций, 
                  аналогичных виду <FONT color=#9999ff><I>ap_f*</I></FONT>, 
                  которые мы рассмотрели в прошлой статье, нет. Это означает, 
                  что разработчикам, которые пишут входные фильтры, необходимо 
                  обрабатывать блоки и бригады напрямую.</P>
                  <P>Последнее отличие заключается в порядке, в котором фильтры 
                  изменяют данные. Для выходных фильтров, вначале стартовал 
                  генератор контента, генерируя основные данные, и передавал эти 
                  данные вниз по стеку фильтров. В конце стека фильтров, данные 
                  отсылались в сеть, и пустая бригада возвращалась обратно в 
                  стек. </P>
                  <TABLE align=left border=1 cellPadding=1 cellSpacing=2 
                  style="BORDER-BOTTOM: rgb(204,204,204) 1px solid; BORDER-LEFT: rgb(204,204,204) 1px solid; BORDER-RIGHT: rgb(204,204,204) 1px solid; BORDER-TOP: rgb(204,204,204) 1px solid; MARGIN: 8px" 
                  width=250>
                    <TBODY>
                    <TR>
                      <TD bgColor=#ffffff 
                      style="BORDER-BOTTOM: medium none; BORDER-LEFT: medium none; BORDER-RIGHT: medium none; BORDER-TOP: medium none" 
                      vAlign=top width=250>
                        <P class=smalltext><A 
                        href="http://bolero.ru//cgi-bin/basket.cgi?act_add=yes&amp;pid=22237080&amp;num=1&amp;partner=apachedev&amp;new=1"><IMG 
                        align=left alt="Администрирование Apache." border=0 
                        src="/images/books/2.jpg"></A> <B><A 
                        href="http://bolero.ru//cgi-bin/basket.cgi?act_add=yes&amp;pid=22237080&amp;num=1&amp;partner=apachedev&amp;new=1">Администрирование 
                        Apache</A></B><BR>М. Арнольд и др.<BR>ЛОРИ, 432 стр. 
                        <BR>Цена: 169,00 руб. <BR><A 
                        href="http://bolero.ru//cgi-bin/dsc.cgi?22237080&amp;partner=apachedev&amp;new=1">Подробнее</A> 
                        <A 
                        href="http://bolero.ru//cgi-bin/basket.cgi?act_add=yes&amp;pid=22237080&amp;num=1&amp;partner=apachedev&amp;new=1">Купить</A> 
                        </P></TD></TR></TBODY></TABLE>
                  <P>Входные фильтры работают наоборот. Первая вещь, которая 
                  делается в функции, получившей данные из сети, это вызов 
                  функции <FONT color=#9999ff><I>ap_get_brigade()</I></FONT> с 
                  пустой бригадой. Затем функция передает бригаду следующему 
                  фильтру, и так до тех пор, пока последний фильтр в стеке не 
                  получить пустую бригаду. Затем последний фильтр заполняет 
                  бригаду данными и возвращает ее предыдущему фильтру. 
                  Предыдущий фильтр изменяет эти данные и возвращает их, и так 
                  до тех пор, пока первоначальная функция не вернет заполненную 
                  бригаду. </P>
                  <P>Осталось одна функция, которую мы не рассмотрели - это 
                  <FONT color=#9999ff><I>ap_get_brigade()</I></FONT>. Эта 
                  функция вызывает следующий фильтр в стеке. Она имеет 4 
                  аргумента: </P>
                  <P><I><FONT color=#9999ff>apr_status_t 
                  ap_get_brigade(ap_filter_t *filter, apr_bucket_brigade 
                  *bucket, ap_input_mode_t mode, apr_size_t *readbytes); 
                  </FONT></I></P>
                  <P>Первый аргумент - это следующий фильтр в стеке. Второй - 
                  это бригада, используемая для хранения данных, полученных из 
                  сети. Помните, что этот аргумент всегда пустой, при первом 
                  вызове функции, и он наполняется только после выполнения <FONT 
                  color=#9999ff><I>ap_get_brigade</I></FONT>. Третий аргумент - 
                  это режим, определяющий, как данные будут читаются из фильтра. 
                  Есть три значения этого параметра: AP_MODE_BLOCKING, 
                  AP_MODE_NONBLOCKING и AP_MODE_PEEK. Два первых понятны по 
                  смыслу - мы либо читаем из сети в блокирующем, либо в 
                  неблокирующем режиме. Третий режим более сложный. После 
                  поступления первого запроса, серверу необходимо определить, 
                  придет ли следующий запрос от того же сокета. Если запрос 
                  придет, то Apache не отсылает завершающий блок ответа 
                  немедленно, а ждет, пока второй запрос обработается полностью. 
                  Это делается для оптимального использования пропускной 
                  способности сети. Большинство фильтров могут игнорировать этот 
                  параметр, если он установлен в AP_MODE_PEEK, сервер возьмет на 
                  себя заботу о корректном возврате информации вместе с пустой 
                  бригадой. Последний параметр, <FONT 
                  color=#9999ff><I>readbytes</I></FONT>, это количество байт 
                  запрошенных из сети на входе, и количество байт переданных 
                  выходу. Он используется для информирования запрашиваемой 
                  функции о том, сколько информации доступно для обработки. Если 
                  значение равно 0, то входные фильтры вернут одну строку 
                  данных. </P>
                  <P>Сейчас, когда мы изучили основы входных фильтров, давайте 
                  взглянем на детали. Как и в предыдущей статье, дан пример 
                  модуля, который реализует входной фильтр описанный ниже. Этот 
                  модуль был создан после Лондонской конференции ApacheCon. На 
                  этом мероприятии раздавались диски посетителям. Проблема была 
                  в том, что диски были созданы под Windows, поэтому все HTML 
                  файлы использовали обратные слэши и пробелы в URL вместо 
                  переднего слэша и %20. Это сделало диски непригодными для всех 
                  платформ, кроме Windows. Так как большинство посетителей не 
                  использовали Windows, то они не могли ознакомиться с 
                  содержанием диска. Для решения этой проблемы, я создал простой 
                  Apache 2.0 модуль, который корректировал поступающие запросы. 
                  </P>
                  <P>Итак, давайте проанализируем входной фильтр ApacheCon: </P>
                  <P><I><FONT color=#9999ff>static apr_status_t 
                  apcon_filter_in(ap_filter_t *f, apr_bucket_brigade *b, 
                  ap_input_mode_t mode, apr_size_t *readbytes)<BR>{<BR>const 
                  char *str;<BR>const char *begin; <BR>int length;<BR>apr_bucket 
                  *e;<BR>apr_bucket *d;<BR>char data[256];<BR>int 
                  i,j;</FONT></I></P>
                  <P>Мы начали с объявления всех необходимых фильтру переменных. 
                  Каждая из этих переменных станет очевидной, когда мы полностью 
                  разберем фильтр. </P>
                  <P><I><FONT color=#9999ff>ap_get_brigade(f-&gt;next, b, mode, 
                  readbytes); </FONT></I></P>
                  <P>Я повторю снова, что самый первый вызов в каждом входном 
                  фильтре, должен быть <FONT 
                  color=#9999ff><I>ap_get_brigade</I></FONT>. </P>
                  <P><I><FONT color=#9999ff>e = APR_BRIGADE_FIRST(b); 
                  </FONT></I></P>
                  <P><FONT color=#9999ff><I>if (e-&gt;type == NULL) { <BR>return 
                  APR_SUCCESS; <BR>}</I></FONT></P>
                  <P>Когда у нас есть бригада, то следующая вещь, которую мы 
                  должны сделать, это получить доступ к первому блоку в этой 
                  бригаде. Если тип этого блока null, что означает, что бригада 
                  пустая, то нам остается только вернуть APR_SUCCESS остальным 
                  фильтрам.</P>
                  <P><FONT color=#9999ff><I>apr_bucket_read(e, &amp;str, 
                  &amp;length, 1); </I></FONT></P>
                  <P><FONT color=#9999ff><I>if (strncmp("GET ", str, strlen("GET 
                  "))) { <BR>return APR_SUCCESS; <BR>}<BR>apr_bucket_split(e, 
                  strlen("GET "));<BR>e = APR_BUCKET_NEXT(e); </I></FONT></P>
                  <P>Здесь мы уже знаем, что у нас есть корректная бригада и что 
                  она содержит данные. Следующий маг, который мы должны сделать, 
                  это прочитать из блока строку данных, которую мы сможем 
                  обработать. В нашем случае, фильтр очень простой и 
                  обрабатывает только GET запросы. Итак, мы знаем, что имеем GET 
                  запрос, далее мы разбиваем блок так, чтобы только отделить URL 
                  и версию HTTP. </P>
                  <P><I><FONT color=#9999ff>apr_bucket_read(e, &amp;str, 
                  &amp;length, 1);<BR><FONT color=#66cc00>/* это должно 
                  работать, потому что мы работает только с HTTP/1.0 или 
                  HTTP/1.1 */ </FONT><BR>begin = str + (strlen(str) - 3); <BR>do 
                  { <BR>begin--;<BR>} while (strncmp("HTTP", begin, 4) 
                  &amp;&amp; (begin &gt; str));<BR>apr_bucket_split(e, begin - 
                  str - 1); </FONT></I></P>
                  <P>Данный сегмент отделяет URL от HTTP версии. Нас не 
                  интересует версия протокола HTTP, но фильтру необходимо 
                  отделить URL от всего остального.</P>
                  <P><FONT color=#9999ff><I>apr_bucket_read(e, &amp;str, 
                  &amp;length, 1); <BR>i = 0;<BR>j = 0;<BR>while (i &lt; length) 
                  { <BR>if (str[i] == ' ') { <BR>data[j++] = '%';<BR>data[j++] = 
                  '2'; <BR>data[j++] = '0';<BR>i++;<BR>} <BR>else if (str[i] == 
                  '') {<BR>data[j++] = '/';<BR>i++;<BR>}<BR>else { <BR>data[j++] 
                  = str[i++];<BR>}<BR>}</I></FONT></P>
                  <P>Тут мы изменяем полный URL и копируем его в новую строку, 
                  заменяя пробелы на %20 и "" на "/". </P>
                  <P><I><FONT color=#9999ff>d = 
                  apr_bucket_transient_create(data, 
                  j);<BR>apr_bucket_setaside(d, f-&gt;c-&gt;pool); 
                  <BR>APR_BUCKET_INSERT_AFTER(e, d); 
                  <BR>APR_BUCKET_REMOVE(e);<BR>apr_bucket_destroy(e);<BR>return 
                  APR_SUCCESS;<BR>}</FONT></I></P>
                  <TABLE align=right border=1 cellPadding=1 cellSpacing=2 
                  style="BORDER-BOTTOM: rgb(204,204,204) 1px solid; BORDER-LEFT: rgb(204,204,204) 1px solid; BORDER-RIGHT: rgb(204,204,204) 1px solid; BORDER-TOP: rgb(204,204,204) 1px solid; MARGIN: 8px" 
                  width=250>
                    <TBODY>
                    <TR>
                      <TD bgColor=#ffffff 
                      style="BORDER-BOTTOM: medium none; BORDER-LEFT: medium none; BORDER-RIGHT: medium none; BORDER-TOP: medium none" 
                      vAlign=top width=250>
                        <P class=smalltext><A 
                        href="http://bolero.ru//cgi-bin/basket.cgi?act_add=yes&amp;pid=25572577&amp;num=1&amp;partner=apachedev&amp;new=1"><IMG 
                        align=left 
                        alt="Использование Linux, Apache, MySQL и PHP для разработки Web-приложений" 
                        border=0 src="/images/books/3.gif"></A> <B><A 
                        href="http://bolero.ru//cgi-bin/basket.cgi?act_add=yes&amp;pid=25572577&amp;num=1&amp;partner=apachedev&amp;new=1">Использование 
                        Linux, Apache, MySQL и PHP для разработки 
                        Web-приложений</A></B><BR>Ли Джеймс<BR>432 стр. 
                        <BR>Цена: 278,00 руб. <BR><A 
                        href="http://bolero.ru//cgi-bin/dsc.cgi?25572577&amp;partner=apachedev&amp;new=1">Подробнее</A> 
                        <A 
                        href="http://bolero.ru//cgi-bin/basket.cgi?act_add=yes&amp;pid=25572577&amp;num=1&amp;partner=apachedev&amp;new=1">Купить</A> 
                        </P></TD></TR></TBODY></TABLE>
                  <P>В конце, мы записываем новый URL в блок и вставляем этот 
                  блок в бригаду. Этот фильтр немного некорректен, потому что 
                  главной его задачей было обучение. В нем мы используем 
                  временный (transient) блок и затем вызываем <FONT 
                  color=#9999ff><I>apr_bucket_setaside</I></FONT>. Это сделано 
                  для того, чтобы показать механизм <FONT 
                  color=#9999ff><I>apr_bucket_setaside</I></FONT>. Вставка блока 
                  производиться после вставки оригинального блока, и затем 
                  оригинальный блок удаляется. <BR>Для испытания этого модуля, 
                  необходимо сконфигурировать сервер с опцией <FONT 
                  color=#9999ff><I>-with-module=filters:/path/to/mod_apachecon</I></FONT>. 
                  Это скопирует модуль в дерево исходников сервера и добавит его 
                  в сборку системы. Этот фильтр активизируется автоматически и 
                  работает при каждом запросе. Легчайший путь для проверки, это 
                  подключиться по <FONT color=#9999ff><I>telnet</I></FONT> к 
                  серверу и отправить запрос на файл такой как:</P>
                  <P><FONT color=#9999ff><I>GET foo bar HTTP/1.0 </I></FONT></P>
                  <P>Убедитесь, что вы получили файл "foo bar" в вашу 
                  DocumentRoot директорию. В следующий раз, мы побеседуем о том 
                  как писать модули, которые могут быть расширены другими 
                  модулями. </P>
                  <CENTER></CENTER>
                  <HR>
                  Дата публикации: 09/04/2005<BR>Прочитано: 826 
                  раз<BR><B>Дополнительно на данную тему:</B>
                  <HR>
                  <IMG border=0 height=14 
                  src="modules/Pages/images/page_pic.gif" width=10> <A 
                  href="http://www.apachedev.ru/modules.php?name=Pages&amp;go=page&amp;pid=4" 
                  style="TEXT-DECORATION: none"><B>Установка Apache 
                  2.0</B></A><BR><IMG border=0 height=14 
                  src="modules/Pages/images/page_pic.gif" width=10> <A 
                  href="http://www.apachedev.ru/modules.php?name=Pages&amp;go=page&amp;pid=5" 
                  style="TEXT-DECORATION: none"><B>Переход с сервера Apache 1.3 
                  на Apache 2.0</B></A><BR><IMG border=0 height=14 
                  src="modules/Pages/images/page_pic.gif" width=10> <A 
                  href="http://www.apachedev.ru/modules.php?name=Pages&amp;go=page&amp;pid=6" 
                  style="TEXT-DECORATION: none"><B>Написание фильтров для Apache 
                  2.0</B></A><BR><IMG border=0 height=14 
                  src="modules/Pages/images/page_pic.gif" width=10> <A 
                  href="http://www.apachedev.ru/modules.php?name=Pages&amp;go=page&amp;pid=7" 
                  style="TEXT-DECORATION: none"><B>Написание выходных фильтров 
                  Apache 2.0</B></A><BR><IMG border=0 height=14 
                  src="modules/Pages/images/page_pic.gif" width=10> <A 
                  href="http://www.apachedev.ru/modules.php?name=Pages&amp;go=page&amp;pid=9" 
                  style="TEXT-DECORATION: none"><B>Модули Apache 
                  2.0</B></A><BR><IMG border=0 height=14 
                  src="modules/Pages/images/page_pic.gif" width=10> <A 
                  href="http://www.apachedev.ru/modules.php?name=Pages&amp;go=page&amp;pid=10" 
                  style="TEXT-DECORATION: none"><B>Основы управления ресурсами в 
                  Apache: APR Пулы 
        (pools)</B></A><BR></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE><BR>
      <TABLE bgColor=#efce68 border=0 cellPadding=0 cellSpacing=1 
        width="100%"><TBODY>
        <TR>
          <TD>
            <TABLE bgColor=#efefef border=0 cellPadding=8 cellSpacing=1 
            width="100%">
              <TBODY>
              <TR>
                <TD>
                  <CENTER><A href="javascript:history.go(-1)">Назад</A> | <A 
                  href="http://www.apachedev.ru/modules.php?name=Pages">Начало</A> 
                  | <A 
                  href="http://www.apachedev.ru/modules.php?name=Pages&amp;go=page&amp;pid=8#">Наверх</A></CENTER></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
<TABLE align=center bgColor=#000000 border=0 cellPadding=0 cellSpacing=0 
width=750>
  <TBODY>
  <TR>
    <TD height=5 width=750><IMG alt="" border=0 height=5 
      src="themes/ApacheDev/images/bottombar.gif" width=750></TD></TR>
  <TR>
    <TD width="100%"><IMG alt="" border=0 height=1 
      src="themes/ApacheDev/images/pixel.gif" 
width=1></TD></TR></TBODY></TABLE><BR><BR>
<TABLE align=center border=0 cellPadding=0 cellSpacing=0 width=750>
  <TBODY>
  <TR align=middle>
    <TD colSpan=3 width="100%"><FONT class=footmsg>Web site engine code is 
      Copyright © 2003 by <A href="http://phpnuke.org/"><FONT 
      class=footmsg_l>PHP-Nuke</FONT></A>. All Rights Reserved. PHP-Nuke is Free 
      Software released under the <A href="http://www.gnu.org/"><FONT 
      class=footmsg_l>GNU/GPL license</FONT></A>.<BR>Открытие страницы: 0.13 
      секунды<BR></FONT></TR></TBODY></TABLE></BODY></HTML>
